<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>BoundaryPanel.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Nov 28, 2015 2:34:31 PM)</a> &gt; <a href="../../index.html" class="el_group">wekaproject</a> &gt; <a href="../index.html" class="el_bundle">src/src/main/java</a> &gt; <a href="index.source.html" class="el_package">weka.gui.boundaryvisualizer</a> &gt; <span class="el_source">BoundaryPanel.java</span></div><h1>BoundaryPanel.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/*</span>
 *    This program is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program; if not, write to the Free Software
 *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

/*
 *   BoundaryPanel.java
 *   Copyright (C) 2002 University of Waikato, Hamilton, New Zealand
 *
 */

package weka.gui.boundaryvisualizer;

import weka.classifiers.Classifier;
import weka.core.FastVector;
import weka.core.Instance;
import weka.core.Instances;
import weka.core.Utils;
import weka.gui.visualize.JPEGWriter;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.RenderingHints;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileInputStream;
import java.io.ObjectInputStream;
import java.util.Iterator;
import java.util.Locale;
import java.util.Random;
import java.util.Vector;

import javax.imageio.IIOImage;
import javax.imageio.ImageIO;
import javax.imageio.ImageWriteParam;
import javax.imageio.ImageWriter;
import javax.imageio.plugins.jpeg.JPEGImageWriteParam;
import javax.imageio.stream.ImageOutputStream;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.ToolTipManager;

/**
 * BoundaryPanel. A class to handle the plotting operations
 * associated with generating a 2D picture of a classifier's decision
 * boundaries.
 *
 * @author &lt;a href=&quot;mailto:mhall@cs.waikato.ac.nz&quot;&gt;Mark Hall&lt;/a&gt;
 * @version $Revision: 7883 $
 * @since 1.0
 * @see JPanel
 */
<span class="nc" id="L72">public class BoundaryPanel</span>
  extends JPanel {

  /** for serialization */
  private static final long serialVersionUID = -8499445518744770458L;
  
  /** default colours for classes */
<span class="nc" id="L79">  public static final Color [] DEFAULT_COLORS = {</span>
<span class="nc" id="L80">    Color.red,</span>
<span class="nc" id="L81">    Color.green,</span>
<span class="nc" id="L82">    Color.blue,</span>
<span class="nc" id="L83">    new Color(0, 255, 255), // cyan</span>
<span class="nc" id="L84">    new Color(255, 0, 255), // pink</span>
<span class="nc" id="L85">    new Color(255, 255, 0), // yellow</span>
<span class="nc" id="L86">    new Color(255, 255, 255), //white</span>
<span class="nc" id="L87">    new Color(0, 0, 0)};</span>
    
  /** The distance we can click away from a point in the GUI and still remove it. */
  public static final double REMOVE_POINT_RADIUS = 7.0;

<span class="nc" id="L92">  protected FastVector m_Colors = new FastVector();</span>

  /** training data */
  protected Instances m_trainingData;

  /** distribution classifier to use */
  protected Classifier m_classifier;

  /** data generator to use */
  protected DataGenerator m_dataGenerator;

  /** index of the class attribute */
<span class="nc" id="L104">  private int m_classIndex = -1;</span>

  // attributes for visualizing on
  protected int m_xAttribute;
  protected int m_yAttribute;

  // min, max and ranges of these attributes
  protected double m_minX;
  protected double m_minY;
  protected double m_maxX;
  protected double m_maxY;
  private double m_rangeX;
  private double m_rangeY;

  // pixel width and height in terms of attribute values
  protected double m_pixHeight;
  protected double m_pixWidth;

  /** used for offscreen drawing */
<span class="nc" id="L123">  protected Image m_osi = null;</span>

  // width and height of the display area
  protected int m_panelWidth;
  protected int m_panelHeight;

  // number of samples to take from each region in the fixed dimensions
<span class="nc" id="L130">  protected int m_numOfSamplesPerRegion = 2;</span>

  // number of samples per kernel = base ^ (# non-fixed dimensions)
  protected int m_numOfSamplesPerGenerator;
<span class="nc" id="L134">  protected double m_samplesBase = 2.0;</span>

  /** listeners to be notified when plot is complete */
<span class="nc" id="L137">  private Vector m_listeners = new Vector();</span>

  /**
   * small inner class for rendering the bitmap on to
   */
  private class PlotPanel
    extends JPanel {

    /** for serialization */
    private static final long serialVersionUID = 743629498352235060L;
    
<span class="nc" id="L148">    public PlotPanel() {</span>
<span class="nc" id="L149">      this.setToolTipText(&quot;&quot;);</span>
<span class="nc" id="L150">    }</span>
    
    public void paintComponent(Graphics g) {
<span class="nc" id="L153">      super.paintComponent(g);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">      if (m_osi != null) {</span>
<span class="nc" id="L155">	g.drawImage(m_osi,0,0,this);</span>
      }
<span class="nc" id="L157">    }</span>
    
    public String getToolTipText(MouseEvent event) {
<span class="nc bnc" id="L160" title="All 2 branches missed.">      if (m_probabilityCache == null) {</span>
<span class="nc" id="L161">	return null;</span>
      }
      
<span class="nc bnc" id="L164" title="All 2 branches missed.">      if (m_probabilityCache[event.getY()][event.getX()] == null) {</span>
<span class="nc" id="L165">	return null;</span>
      }
      
<span class="nc" id="L168">      String pVec = Messages.getInstance().getString(&quot;BoundaryPanel_GetToolTipText_Text_First&quot;) + Utils.doubleToString(convertFromPanelX((double)event.getX()), 2) </span>
<span class="nc" id="L169">      				+ Messages.getInstance().getString(&quot;BoundaryPanel_GetToolTipText_Text_Second&quot;) + Utils.doubleToString(convertFromPanelY((double)event.getY()), 2)</span>
<span class="nc" id="L170">      				+ Messages.getInstance().getString(&quot;BoundaryPanel_GetToolTipText_Text_Third&quot;);</span>
      
      // construct a string holding the probability vector
<span class="nc bnc" id="L173" title="All 2 branches missed.">      for (int i = 0; i &lt; m_trainingData.classAttribute().numValues(); i++) {</span>
<span class="nc" id="L174">    	  pVec += Utils.doubleToString(m_probabilityCache[event.getY()][event.getX()][i], 3)+&quot; &quot;;</span>
      }
<span class="nc" id="L176">      return pVec;</span>
    }
  }

  /** the actual plotting area */
<span class="nc" id="L181">  private PlotPanel m_plotPanel = new PlotPanel();</span>

  /** thread for running the plotting operation in */
<span class="nc" id="L184">  private Thread m_plotThread = null;</span>

  /** Stop the plotting thread */
<span class="nc" id="L187">  protected boolean m_stopPlotting = false;</span>

  /** Stop any replotting threads */
<span class="nc" id="L190">  protected boolean m_stopReplotting = false;</span>

  // Used by replotting threads to pause and resume the main plot thread
<span class="nc" id="L193">  private Double m_dummy = new Double(1.0);</span>
<span class="nc" id="L194">  private boolean m_pausePlotting = false;</span>
  /** what size of tile is currently being plotted */
<span class="nc" id="L196">  private int m_size = 1;</span>
  /** is the main plot thread performing the initial coarse tiling */
  private boolean m_initialTiling;

  /** A random number generator  */
<span class="nc" id="L201">  private Random m_random = null;</span>

  /** cache of probabilities for fast replotting */
  protected double [][][] m_probabilityCache;

  /** plot the training data */
<span class="nc" id="L207">  protected boolean m_plotTrainingData = true;</span>

  /**
   * Creates a new &lt;code&gt;BoundaryPanel&lt;/code&gt; instance.
   *
   * @param panelWidth the width in pixels of the panel
   * @param panelHeight the height in pixels of the panel
   */
<span class="nc" id="L215">  public BoundaryPanel(int panelWidth, int panelHeight) {</span>
<span class="nc" id="L216">    ToolTipManager.sharedInstance().setDismissDelay(Integer.MAX_VALUE);</span>
<span class="nc" id="L217">    m_panelWidth = panelWidth;</span>
<span class="nc" id="L218">    m_panelHeight = panelHeight;</span>
<span class="nc" id="L219">    setLayout(new BorderLayout());</span>
<span class="nc" id="L220">    m_plotPanel.setMinimumSize(new Dimension(m_panelWidth, m_panelHeight));</span>
<span class="nc" id="L221">    m_plotPanel.setPreferredSize(new Dimension(m_panelWidth, m_panelHeight));</span>
<span class="nc" id="L222">    m_plotPanel.setMaximumSize(new Dimension(m_panelWidth, m_panelHeight));</span>
<span class="nc" id="L223">    add(m_plotPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L224">    setPreferredSize(m_plotPanel.getPreferredSize());</span>
<span class="nc" id="L225">    setMaximumSize(m_plotPanel.getMaximumSize());</span>
<span class="nc" id="L226">    setMinimumSize(m_plotPanel.getMinimumSize());</span>

<span class="nc" id="L228">    m_random = new Random(1);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">    for (int i = 0; i &lt; DEFAULT_COLORS.length; i++) {</span>
<span class="nc" id="L230">      m_Colors.addElement(new Color(DEFAULT_COLORS[i].getRed(),</span>
<span class="nc" id="L231">				    DEFAULT_COLORS[i].getGreen(),</span>
<span class="nc" id="L232">				    DEFAULT_COLORS[i].getBlue()));</span>
    }
<span class="nc" id="L234">    m_probabilityCache = new double[m_panelHeight][m_panelWidth][];</span>
    
<span class="nc" id="L236">  }</span>

  /**
   * Set the number of points to uniformly sample from a region (fixed
   * dimensions).
   *
   * @param num an &lt;code&gt;int&lt;/code&gt; value
   */
  public void setNumSamplesPerRegion(int num) {
<span class="nc" id="L245">    m_numOfSamplesPerRegion = num;</span>
<span class="nc" id="L246">  }</span>

  /**
   * Get the number of points to sample from a region (fixed dimensions).
   *
   * @return an &lt;code&gt;int&lt;/code&gt; value
   */
  public int getNumSamplesPerRegion() {
<span class="nc" id="L254">    return m_numOfSamplesPerRegion;</span>
  }

  /**
   * Set the base for computing the number of samples to obtain from each
   * generator. number of samples = base ^ (# non fixed dimensions)
   *
   * @param ksb a &lt;code&gt;double&lt;/code&gt; value
   */
  public void setGeneratorSamplesBase(double ksb) {
<span class="nc" id="L264">    m_samplesBase = ksb;</span>
<span class="nc" id="L265">  }</span>

  /**
   * Get the base used for computing the number of samples to obtain from
   * each generator
   *
   * @return a &lt;code&gt;double&lt;/code&gt; value
   */
  public double getGeneratorSamplesBase() {
<span class="nc" id="L274">    return m_samplesBase;</span>
  }

  /**
   * Set up the off screen bitmap for rendering to
   */
  protected void initialize() {
<span class="nc" id="L281">    int iwidth = m_plotPanel.getWidth();</span>
<span class="nc" id="L282">    int iheight = m_plotPanel.getHeight();</span>
    //    System.err.println(iwidth+&quot; &quot;+iheight);
<span class="nc" id="L284">    m_osi = m_plotPanel.createImage(iwidth, iheight);</span>
<span class="nc" id="L285">    Graphics m = m_osi.getGraphics();</span>
<span class="nc" id="L286">    m.fillRect(0,0,iwidth,iheight);</span>
<span class="nc" id="L287">  }</span>

  /**
   * Stop the plotting thread
   */
  public void stopPlotting() {
<span class="nc" id="L293">    m_stopPlotting = true;</span>
    try {
<span class="nc" id="L295">    	m_plotThread.join(100);</span>
<span class="nc" id="L296">    } catch (Exception e){};</span>
<span class="nc" id="L297">  }</span>

  /** Set up the bounds of our graphic based by finding the smallest reasonable
      area in the instance space to surround our data points.
  */
  public void computeMinMaxAtts() {
<span class="nc" id="L303">    m_minX = Double.MAX_VALUE;</span>
<span class="nc" id="L304">    m_minY = Double.MAX_VALUE;</span>
<span class="nc" id="L305">    m_maxX = Double.MIN_VALUE;</span>
<span class="nc" id="L306">    m_maxY = Double.MIN_VALUE;</span>
    
<span class="nc" id="L308">    boolean allPointsLessThanOne = true;</span>
    
<span class="nc bnc" id="L310" title="All 2 branches missed.">    if (m_trainingData.numInstances() == 0) {</span>
<span class="nc" id="L311">      m_minX = m_minY = 0.0;</span>
<span class="nc" id="L312">      m_maxX = m_maxY = 1.0;</span>
    }
    else
    {
<span class="nc bnc" id="L316" title="All 2 branches missed.">	for (int i = 0; i &lt; m_trainingData.numInstances(); i++) {</span>
<span class="nc" id="L317">		Instance inst = m_trainingData.instance(i);</span>
<span class="nc" id="L318">		double x = inst.value(m_xAttribute);</span>
<span class="nc" id="L319">		double y = inst.value(m_yAttribute);</span>
<span class="nc bnc" id="L320" title="All 4 branches missed.">		if (!Instance.isMissingValue(x) &amp;&amp; !Instance.isMissingValue(y)) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (x &lt; m_minX) {</span>
<span class="nc" id="L322">			m_minX = x;</span>
			}
<span class="nc bnc" id="L324" title="All 2 branches missed.">			if (x &gt; m_maxX) {</span>
<span class="nc" id="L325">			m_maxX = x;</span>
			}
		
<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (y &lt; m_minY) {</span>
<span class="nc" id="L329">			m_minY = y;</span>
			}
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (y &gt; m_maxY) {</span>
<span class="nc" id="L332">			m_maxY = y;</span>
			}
<span class="nc bnc" id="L334" title="All 4 branches missed.">			if (x &gt; 1.0 || y &gt; 1.0)</span>
<span class="nc" id="L335">				allPointsLessThanOne = false;</span>
		}
	}
    }
    
<span class="nc bnc" id="L340" title="All 2 branches missed.">    if (m_minX == m_maxX)</span>
<span class="nc" id="L341">    	m_minX = 0;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">    if (m_minY == m_maxY)</span>
<span class="nc" id="L343">    	m_minY = 0;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">    if (m_minX == Double.MAX_VALUE)</span>
<span class="nc" id="L345">    	m_minX = 0;</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">    if (m_minY == Double.MAX_VALUE)</span>
<span class="nc" id="L347">    	m_minY = 0;</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">    if (m_maxX == Double.MIN_VALUE)</span>
<span class="nc" id="L349">    	m_maxX = 1;</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">    if (m_maxY == Double.MIN_VALUE)</span>
<span class="nc" id="L351">    	m_maxY = 1;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">    if (allPointsLessThanOne) {</span>
//    	m_minX = m_minY = 0.0;
<span class="nc" id="L354">    	m_maxX = m_maxY = 1.0;</span>
    }
    
    
    
<span class="nc" id="L359">    m_rangeX = (m_maxX - m_minX);</span>
<span class="nc" id="L360">    m_rangeY = (m_maxY - m_minY);</span>
    
<span class="nc" id="L362">    m_pixWidth = m_rangeX / (double)m_panelWidth;</span>
<span class="nc" id="L363">    m_pixHeight = m_rangeY / (double) m_panelHeight;</span>
<span class="nc" id="L364">  }</span>

  /**
   * Return a random x attribute value contained within
   * the pix'th horizontal pixel
   *
   * @param pix the horizontal pixel number
   * @return a value in attribute space
   */
  private double getRandomX(int pix) {

<span class="nc" id="L375">    double minPix =  m_minX + (pix * m_pixWidth);</span>

<span class="nc" id="L377">    return minPix + m_random.nextDouble() * m_pixWidth;</span>
  }

  /**
   * Return a random y attribute value contained within
   * the pix'th vertical pixel
   *
   * @param pix the vertical pixel number
   * @return a value in attribute space
   */
  private double getRandomY(int pix) {
    
<span class="nc" id="L389">    double minPix = m_minY + (pix * m_pixHeight);</span>
    
<span class="nc" id="L391">    return minPix +  m_random.nextDouble() * m_pixHeight;</span>
  }
  
  /**
   * Start the plotting thread
   *
   * @exception Exception if an error occurs
   */
  public void start() throws Exception {
<span class="nc" id="L400">    m_numOfSamplesPerGenerator = </span>
<span class="nc" id="L401">      (int)Math.pow(m_samplesBase, m_trainingData.numAttributes()-3);</span>

<span class="nc" id="L403">    m_stopReplotting = true;</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">    if (m_trainingData == null) {</span>
<span class="nc" id="L405">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_Start_Error_NoTrainingDataSet_Text&quot;));</span>
    }
<span class="nc bnc" id="L407" title="All 2 branches missed.">    if (m_classifier == null) {</span>
<span class="nc" id="L408">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_Start_Error_NoClassifierSet_Text&quot;));</span>
    }
<span class="nc bnc" id="L410" title="All 2 branches missed.">    if (m_dataGenerator == null) {</span>
<span class="nc" id="L411">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_Start_Error_NoDataGeneratorSet_Text&quot;));</span>
    }
<span class="nc bnc" id="L413" title="All 2 branches missed.">    if (m_trainingData.attribute(m_xAttribute).isNominal() || </span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">	m_trainingData.attribute(m_yAttribute).isNominal()) {</span>
<span class="nc" id="L415">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_Start_Error_VisualizationDimensionsMustBeNumeric_Text&quot;));</span>
    }
    
<span class="nc" id="L418">    computeMinMaxAtts();</span>
    
<span class="nc" id="L420">    startPlotThread();</span>
    /*if (m_plotThread == null) {
      m_plotThread = new PlotThread();
      m_plotThread.setPriority(Thread.MIN_PRIORITY);
      m_plotThread.start();
    }*/
<span class="nc" id="L426">  }</span>
  
  // Thread for main plotting operation
<span class="nc" id="L429">  protected class PlotThread extends Thread {</span>
    double [] m_weightingAttsValues;
    boolean [] m_attsToWeightOn;
    double [] m_vals;
    double [] m_dist;
    Instance m_predInst;
    public void run() {

<span class="nc" id="L437">      m_stopPlotting = false;</span>
      try {
<span class="nc" id="L439">        initialize();</span>
<span class="nc" id="L440">        repaint();</span>
        
        // train the classifier
<span class="nc" id="L443">        m_probabilityCache = new double[m_panelHeight][m_panelWidth][];</span>
<span class="nc" id="L444">        m_classifier.buildClassifier(m_trainingData);</span>
        
        // build DataGenerator
<span class="nc" id="L447">        m_attsToWeightOn = new boolean[m_trainingData.numAttributes()];</span>
<span class="nc" id="L448">        m_attsToWeightOn[m_xAttribute] = true;</span>
<span class="nc" id="L449">        m_attsToWeightOn[m_yAttribute] = true;</span>
	      
<span class="nc" id="L451">        m_dataGenerator.setWeightingDimensions(m_attsToWeightOn);</span>
	      
<span class="nc" id="L453">        m_dataGenerator.buildGenerator(m_trainingData);</span>

        // generate samples
<span class="nc" id="L456">        m_weightingAttsValues = new double [m_attsToWeightOn.length];</span>
<span class="nc" id="L457">        m_vals = new double[m_trainingData.numAttributes()];</span>
<span class="nc" id="L458">        m_predInst = new Instance(1.0, m_vals);</span>
<span class="nc" id="L459">        m_predInst.setDataset(m_trainingData);</span>

	
<span class="nc" id="L462">        m_size = 1 &lt;&lt; 4;  // Current sample region size</span>
	
<span class="nc" id="L464">	m_initialTiling = true;</span>
        // Display the initial coarse image tiling.
      abortInitial:
<span class="nc bnc" id="L467" title="All 2 branches missed.">        for (int i = 0; i &lt;= m_panelHeight; i += m_size) {   </span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">          for (int j = 0; j &lt;= m_panelWidth; j += m_size) {   </span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">	    if (m_stopPlotting) {</span>
<span class="nc" id="L470">	      break abortInitial;</span>
	    }
<span class="nc bnc" id="L472" title="All 2 branches missed.">	    if (m_pausePlotting) {</span>
<span class="nc" id="L473">	      synchronized (m_dummy) {</span>
		try {
<span class="nc" id="L475">		  m_dummy.wait();</span>
<span class="nc" id="L476">		} catch (InterruptedException ex) {</span>
<span class="nc" id="L477">		  m_pausePlotting = false;</span>
		}
	      }
	    }
<span class="nc" id="L481">            plotPoint(j, i, m_size, m_size, </span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">		      calculateRegionProbs(j, i), (j == 0));</span>
          }
        }
<span class="nc bnc" id="L485" title="All 2 branches missed.">	if (!m_stopPlotting) {</span>
<span class="nc" id="L486">	  m_initialTiling = false;</span>
	}
        
        // Sampling and gridding loop
<span class="nc" id="L490">        int size2 = m_size / 2;</span>
        abortPlot: 
<span class="nc bnc" id="L492" title="All 2 branches missed.">        while (m_size &gt; 1) { // Subdivide down to the pixel level</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">          for (int i = 0; i &lt;= m_panelHeight; i += m_size) {</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">            for (int j = 0; j &lt;= m_panelWidth; j += m_size) {</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">              if (m_stopPlotting) {</span>
<span class="nc" id="L496">                break abortPlot;</span>
              }
<span class="nc bnc" id="L498" title="All 2 branches missed.">	      if (m_pausePlotting) {</span>
<span class="nc" id="L499">		synchronized (m_dummy) {</span>
		  try {
<span class="nc" id="L501">		    m_dummy.wait();</span>
<span class="nc" id="L502">		  } catch (InterruptedException ex) {</span>
<span class="nc" id="L503">		    m_pausePlotting = false;</span>
		  }
		}
	      }
<span class="nc bnc" id="L507" title="All 4 branches missed.">              boolean update = (j == 0 &amp;&amp; i % 2 == 0);</span>
              // Draw the three new subpixel regions
<span class="nc" id="L509">              plotPoint(j, i + size2, size2, size2, </span>
<span class="nc" id="L510">			calculateRegionProbs(j, i + size2), update);</span>
<span class="nc" id="L511">              plotPoint(j + size2, i + size2, size2, size2, </span>
<span class="nc" id="L512">			calculateRegionProbs(j + size2, i + size2), update);</span>
<span class="nc" id="L513">              plotPoint(j + size2, i, size2, size2, </span>
<span class="nc" id="L514">			calculateRegionProbs(j + size2, i), update);</span>
            }
          }
          // The new region edge length is half the old edge length
<span class="nc" id="L518">          m_size = size2;</span>
<span class="nc" id="L519">          size2 = size2 / 2;</span>
        }
<span class="nc" id="L521">	update();</span>
	

	/*
        // Old method without sampling.
        abortPlot: 
        for (int i = 0; i &lt; m_panelHeight; i++) {
          for (int j = 0; j &lt; m_panelWidth; j++) {
            if (m_stopPlotting) {
              break abortPlot;
            }
            plotPoint(j, i, calculateRegionProbs(j, i), (j == 0));
          }
        }
        */


<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (m_plotTrainingData) {</span>
<span class="nc" id="L539">          plotTrainingData();</span>
        }
	      
<span class="nc" id="L542">      } catch (Exception ex) {</span>
<span class="nc" id="L543">        ex.printStackTrace();</span>
<span class="nc" id="L544">	JOptionPane.showMessageDialog(null, Messages.getInstance().getString(&quot;BoundaryPanel_PlotThread_JOptionPaneShowMessageDialog_Text_Front&quot;) + ex.getMessage() + Messages.getInstance().getString(&quot;BoundaryPanel_PlotThread_JOptionPaneShowMessageDialog_Text_End&quot;));</span>
<span class="nc" id="L545">      } finally {</span>
<span class="nc" id="L546">        m_plotThread = null;</span>
        // notify any listeners that we are finished
        Vector l;
<span class="nc" id="L549">        ActionEvent e = new ActionEvent(this, 0, &quot;&quot;);</span>
<span class="nc" id="L550">        synchronized(this) {</span>
<span class="nc" id="L551">          l = (Vector)m_listeners.clone();</span>
        }
<span class="nc bnc" id="L553" title="All 6 branches missed.">        for (int i = 0; i &lt; l.size(); i++) {</span>
<span class="nc" id="L554">          ActionListener al = (ActionListener)l.elementAt(i);</span>
<span class="nc" id="L555">          al.actionPerformed(e);</span>
        }
<span class="nc" id="L557">      }</span>
<span class="nc" id="L558">    }</span>
    
    private double [] calculateRegionProbs(int j, int i) throws Exception {
<span class="nc" id="L561">      double [] sumOfProbsForRegion = </span>
<span class="nc" id="L562">	new double [m_trainingData.classAttribute().numValues()];</span>

<span class="nc bnc" id="L564" title="All 2 branches missed.">      for (int u = 0; u &lt; m_numOfSamplesPerRegion; u++) {</span>
      
<span class="nc" id="L566">        double [] sumOfProbsForLocation = </span>
<span class="nc" id="L567">	  new double [m_trainingData.classAttribute().numValues()];</span>
      
<span class="nc" id="L569">        m_weightingAttsValues[m_xAttribute] = getRandomX(j);</span>
<span class="nc" id="L570">        m_weightingAttsValues[m_yAttribute] = getRandomY(m_panelHeight-i-1);</span>
      
<span class="nc" id="L572">        m_dataGenerator.setWeightingValues(m_weightingAttsValues);</span>
      
<span class="nc" id="L574">        double [] weights = m_dataGenerator.getWeights();</span>
<span class="nc" id="L575">        double sumOfWeights = Utils.sum(weights);</span>
<span class="nc" id="L576">        int [] indices = Utils.sort(weights);</span>
      
        // Prune 1% of weight mass
<span class="nc" id="L579">        int [] newIndices = new int[indices.length];</span>
<span class="nc" id="L580">        double sumSoFar = 0; </span>
<span class="nc" id="L581">        double criticalMass = 0.99 * sumOfWeights;</span>
<span class="nc" id="L582">        int index = weights.length - 1; int counter = 0;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        for (int z = weights.length - 1; z &gt;= 0; z--) {</span>
<span class="nc" id="L584">          newIndices[index--] = indices[z];</span>
<span class="nc" id="L585">          sumSoFar += weights[indices[z]];</span>
<span class="nc" id="L586">          counter++;</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">          if (sumSoFar &gt; criticalMass) {</span>
<span class="nc" id="L588">            break;</span>
          }
        }
<span class="nc" id="L591">        indices = new int[counter];</span>
<span class="nc" id="L592">        System.arraycopy(newIndices, index + 1, indices, 0, counter);</span>
      
<span class="nc bnc" id="L594" title="All 2 branches missed.">        for (int z = 0; z &lt; m_numOfSamplesPerGenerator; z++) {</span>
        
<span class="nc" id="L596">          m_dataGenerator.setWeightingValues(m_weightingAttsValues);</span>
<span class="nc" id="L597">          double [][] values = m_dataGenerator.generateInstances(indices);</span>
        
<span class="nc bnc" id="L599" title="All 2 branches missed.">          for (int q = 0; q &lt; values.length; q++) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">            if (values[q] != null) {</span>
<span class="nc" id="L601">              System.arraycopy(values[q], 0, m_vals, 0, m_vals.length);</span>
<span class="nc" id="L602">              m_vals[m_xAttribute] = m_weightingAttsValues[m_xAttribute];</span>
<span class="nc" id="L603">              m_vals[m_yAttribute] = m_weightingAttsValues[m_yAttribute];</span>
            
              // classify the instance
<span class="nc" id="L606">              m_dist = m_classifier.distributionForInstance(m_predInst);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">              for (int k = 0; k &lt; sumOfProbsForLocation.length; k++) {</span>
<span class="nc" id="L608">                sumOfProbsForLocation[k] += (m_dist[k] * weights[q]); </span>
              }
            }
          }
        }
      
<span class="nc bnc" id="L614" title="All 2 branches missed.">        for (int k = 0; k &lt; sumOfProbsForRegion.length; k++) {</span>
<span class="nc" id="L615">          sumOfProbsForRegion[k] += (sumOfProbsForLocation[k] * </span>
<span class="nc" id="L616">				     sumOfWeights); </span>
        }
      }
    
      // average
<span class="nc" id="L621">      Utils.normalize(sumOfProbsForRegion);</span>

      // cache
<span class="nc bnc" id="L624" title="All 4 branches missed.">      if ((i &lt; m_panelHeight) &amp;&amp; (j &lt; m_panelWidth)) {</span>
<span class="nc" id="L625">        m_probabilityCache[i][j] = new double[sumOfProbsForRegion.length];</span>
<span class="nc" id="L626">        System.arraycopy(sumOfProbsForRegion, 0, m_probabilityCache[i][j], </span>
<span class="nc" id="L627">			 0, sumOfProbsForRegion.length);</span>
      }
		
<span class="nc" id="L630">      return sumOfProbsForRegion;</span>
    }
  }

  /** Render the training points on-screen.
  */
  public void plotTrainingData() {
    
<span class="nc" id="L638">    Graphics2D osg = (Graphics2D)m_osi.getGraphics();</span>
<span class="nc" id="L639">    Graphics g = m_plotPanel.getGraphics();</span>
<span class="nc" id="L640">    osg.setRenderingHint(RenderingHints.KEY_ANTIALIASING,</span>
<span class="nc" id="L641">                         RenderingHints.VALUE_ANTIALIAS_ON);</span>
<span class="nc" id="L642">    double xval = 0; double yval = 0;</span>
    
<span class="nc bnc" id="L644" title="All 2 branches missed.">    for (int i = 0; i &lt; m_trainingData.numInstances(); i++) {</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">      if (!m_trainingData.instance(i).isMissing(m_xAttribute) &amp;&amp;</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">          !m_trainingData.instance(i).isMissing(m_yAttribute)) {</span>
	  
<span class="nc bnc" id="L648" title="All 2 branches missed.">	if (m_trainingData.instance(i).isMissing(m_classIndex)) //jimmy.</span>
<span class="nc" id="L649">		continue; //don't plot if class is missing. TODO could we plot it differently instead?</span>
	
<span class="nc" id="L651">        xval = m_trainingData.instance(i).value(m_xAttribute);</span>
<span class="nc" id="L652">        yval = m_trainingData.instance(i).value(m_yAttribute);</span>
       
<span class="nc" id="L654">        int panelX = convertToPanelX(xval);</span>
<span class="nc" id="L655">        int panelY = convertToPanelY(yval);</span>
<span class="nc" id="L656">        Color ColorToPlotWith = </span>
<span class="nc" id="L657">          ((Color)m_Colors.elementAt((int)m_trainingData.instance(i).</span>
<span class="nc" id="L658">                                     value(m_classIndex) % m_Colors.size()));</span>
	
<span class="nc bnc" id="L660" title="All 2 branches missed.">        if (ColorToPlotWith.equals(Color.white)) {</span>
<span class="nc" id="L661">          osg.setColor(Color.black);</span>
        } else {
<span class="nc" id="L663">          osg.setColor(Color.white);</span>
        }
<span class="nc" id="L665">        osg.fillOval(panelX-3, panelY-3, 7, 7);</span>
<span class="nc" id="L666">        osg.setColor(ColorToPlotWith);</span>
<span class="nc" id="L667">        osg.fillOval(panelX-2, panelY-2, 5, 5);</span>
      }
    }
<span class="nc" id="L670">    g.drawImage(m_osi,0,0,m_plotPanel);</span>
<span class="nc" id="L671">  }</span>
  
  /** Convert an X coordinate from the instance space to the panel space.
  */
  private int convertToPanelX(double xval) {
<span class="nc" id="L676">    double temp = (xval - m_minX) / m_rangeX;</span>
<span class="nc" id="L677">    temp = temp * (double) m_panelWidth;</span>

<span class="nc" id="L679">    return (int)temp;</span>
  }

  /** Convert a Y coordinate from the instance space to the panel space.
  */
  private int convertToPanelY(double yval) {
<span class="nc" id="L685">    double temp = (yval - m_minY) / m_rangeY;</span>
<span class="nc" id="L686">    temp = temp * (double) m_panelHeight;</span>
<span class="nc" id="L687">    temp = m_panelHeight - temp;</span>
    
<span class="nc" id="L689">    return (int)temp;</span>
  }
  
  /** Convert an X coordinate from the panel space to the instance space.
  */
  private double convertFromPanelX(double pX) {
<span class="nc" id="L695">    pX /= (double) m_panelWidth;</span>
<span class="nc" id="L696">    pX *= m_rangeX;</span>
<span class="nc" id="L697">    return pX + m_minX;</span>
  }

  /** Convert a Y coordinate from the panel space to the instance space.
  */
  private double convertFromPanelY(double pY) {
<span class="nc" id="L703">    pY  = m_panelHeight - pY;</span>
<span class="nc" id="L704">    pY /= (double) m_panelHeight;</span>
<span class="nc" id="L705">    pY *= m_rangeY;</span>
    
<span class="nc" id="L707">    return pY + m_minY;</span>
  }


  /** Plot a point in our visualization on-screen.
  */
  protected  void plotPoint(int x, int y, double [] probs, boolean update) {
<span class="nc" id="L714">    plotPoint(x, y, 1, 1, probs, update);</span>
<span class="nc" id="L715">  }</span>
  
  /** Plot a point in our visualization on-screen.
  */
  private void plotPoint(int x, int y, int width, int height, 
			 double [] probs, boolean update) {

    // draw a progress line
<span class="nc" id="L723">    Graphics osg = m_osi.getGraphics();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">    if (update) {</span>
<span class="nc" id="L725">      osg.setXORMode(Color.white);</span>
<span class="nc" id="L726">      osg.drawLine(0, y, m_panelWidth-1, y);</span>
<span class="nc" id="L727">      update();</span>
<span class="nc" id="L728">      osg.drawLine(0, y, m_panelWidth-1, y);</span>
    }

    // plot the point
<span class="nc" id="L732">    osg.setPaintMode();</span>
<span class="nc" id="L733">    float [] colVal = new float[3];</span>
    
<span class="nc" id="L735">    float [] tempCols = new float[3];</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">    for (int k = 0; k &lt; probs.length; k++) {</span>
<span class="nc" id="L737">      Color curr = (Color)m_Colors.elementAt(k % m_Colors.size());</span>

<span class="nc" id="L739">      curr.getRGBColorComponents(tempCols);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">      for (int z = 0 ; z &lt; 3; z++) {</span>
<span class="nc" id="L741">        colVal[z] += probs[k] * tempCols[z];</span>
      }
    }

<span class="nc bnc" id="L745" title="All 2 branches missed.">    for (int z = 0; z &lt; 3; z++) {</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">      if (colVal[z] &lt; 0) {</span>
<span class="nc" id="L747">	colVal[z] = 0;</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">      } else if (colVal[z] &gt; 1) {</span>
<span class="nc" id="L749">	colVal[z] = 1;</span>
      }
    }
    
<span class="nc" id="L753">    osg.setColor(new Color(colVal[0], </span>
<span class="nc" id="L754">                           colVal[1], </span>
<span class="nc" id="L755">                           colVal[2]));</span>
<span class="nc" id="L756">    osg.fillRect(x, y, width, height);</span>
<span class="nc" id="L757">  }</span>
  
  /** Update the rendered image.
  */
  private void update() {
<span class="nc" id="L762">    Graphics g = m_plotPanel.getGraphics();</span>
<span class="nc" id="L763">    g.drawImage(m_osi, 0, 0, m_plotPanel);</span>
<span class="nc" id="L764">  }</span>

  /**
   * Set the training data to use
   *
   * @param trainingData the training data
   * @exception Exception if an error occurs
   */
  public void setTrainingData(Instances trainingData) throws Exception {

<span class="nc" id="L774">    m_trainingData = trainingData;</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">    if (m_trainingData.classIndex() &lt; 0) {</span>
<span class="nc" id="L776">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetTrainingData_Error_Text&quot;));</span>
    }
<span class="nc" id="L778">    m_classIndex = m_trainingData.classIndex();</span>
<span class="nc" id="L779">  }</span>
  
  /** Adds a training instance to the visualization dataset.
  */
  public void addTrainingInstance(Instance instance) {
  	
<span class="nc bnc" id="L785" title="All 2 branches missed.">  	if (m_trainingData == null) {</span>
		//TODO
<span class="nc" id="L787">		System.err.println(Messages.getInstance().getString(&quot;BoundaryPanel_AddTrainingInstance_Error_Text&quot;));</span>
	}
  	
<span class="nc" id="L790">  	m_trainingData.add(instance);</span>
<span class="nc" id="L791">  }</span>

  /**
   * Register a listener to be notified when plotting completes
   *
   * @param newListener the listener to add
   */
  public void addActionListener(ActionListener newListener) {
<span class="nc" id="L799">    m_listeners.add(newListener);</span>
<span class="nc" id="L800">  }</span>
  
  /**
   * Remove a listener
   *
   * @param removeListener the listener to remove
   */
  public void removeActionListener(ActionListener removeListener) {
<span class="nc" id="L808">    m_listeners.removeElement(removeListener);</span>
<span class="nc" id="L809">  }</span>
  
  /**
   * Set the classifier to use.
   *
   * @param classifier the classifier to use
   */
  public void setClassifier(Classifier classifier) {
<span class="nc" id="L817">    m_classifier = classifier;</span>
<span class="nc" id="L818">  }</span>
  
  /**
   * Set the data generator to use for generating new instances
   *
   * @param dataGenerator the data generator to use
   */
  public void setDataGenerator(DataGenerator dataGenerator) {
<span class="nc" id="L826">    m_dataGenerator = dataGenerator;</span>
<span class="nc" id="L827">  }</span>
  
  /**
   * Set the x attribute index
   *
   * @param xatt index of the attribute to use on the x axis
   * @exception Exception if an error occurs
   */
  public void setXAttribute(int xatt) throws Exception {
<span class="nc bnc" id="L836" title="All 2 branches missed.">    if (m_trainingData == null) {</span>
<span class="nc" id="L837">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetXAttribute_Error_Text_First&quot;));</span>
    }
<span class="nc bnc" id="L839" title="All 2 branches missed.">    if (xatt &lt; 0 || </span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">        xatt &gt; m_trainingData.numAttributes()) {</span>
<span class="nc" id="L841">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetXAttribute_Error_Text_Second&quot;));</span>
    }
<span class="nc bnc" id="L843" title="All 2 branches missed.">    if (m_trainingData.attribute(xatt).isNominal()) {</span>
<span class="nc" id="L844">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetXAttribute_Error_Text_Third&quot;));</span>
    }
    /*if (m_trainingData.numDistinctValues(xatt) &lt; 2) {
      throw new Exception(&quot;Too few distinct values for X attribute &quot;
                          +&quot;(BoundaryPanel)&quot;);
    }*/ //removed by jimmy. TESTING!
<span class="nc" id="L850">    m_xAttribute = xatt;</span>
<span class="nc" id="L851">  }</span>

  /**
   * Set the y attribute index
   *
   * @param yatt index of the attribute to use on the y axis
   * @exception Exception if an error occurs
   */
  public void setYAttribute(int yatt) throws Exception {
<span class="nc bnc" id="L860" title="All 2 branches missed.">    if (m_trainingData == null) {</span>
<span class="nc" id="L861">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetYAttribute_Error_Text_First&quot;));</span>
    }
<span class="nc bnc" id="L863" title="All 2 branches missed.">    if (yatt &lt; 0 || </span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">        yatt &gt; m_trainingData.numAttributes()) {</span>
<span class="nc" id="L865">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetYAttribute_Error_Text_Second&quot;));</span>
    }
<span class="nc bnc" id="L867" title="All 2 branches missed.">    if (m_trainingData.attribute(yatt).isNominal()) {</span>
<span class="nc" id="L868">      throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SetYAttribute_Error_Text_Third&quot;));</span>
    }
    /*if (m_trainingData.numDistinctValues(yatt) &lt; 2) {
      throw new Exception(&quot;Too few distinct values for Y attribute &quot;
                          +&quot;(BoundaryPanel)&quot;);
    }*/ //removed by jimmy. TESTING!
<span class="nc" id="L874">    m_yAttribute = yatt;</span>
<span class="nc" id="L875">  }</span>
  
  /**
   * Set a vector of Color objects for the classes
   *
   * @param colors a &lt;code&gt;FastVector&lt;/code&gt; value
   */
  public void setColors(FastVector colors) {
<span class="nc" id="L883">    synchronized (m_Colors) {</span>
<span class="nc" id="L884">      m_Colors = colors;</span>
    }
    //replot(); //commented by jimmy
<span class="nc" id="L887">    update(); //added by jimmy</span>
<span class="nc" id="L888">  }</span>

  /**
   * Set whether to superimpose the training data
   * plot
   *
   * @param pg a &lt;code&gt;boolean&lt;/code&gt; value
   */
  public void setPlotTrainingData(boolean pg) {
<span class="nc" id="L897">    m_plotTrainingData = pg;</span>
<span class="nc" id="L898">  }</span>

  /**
   * Returns true if training data is to be superimposed
   *
   * @return a &lt;code&gt;boolean&lt;/code&gt; value
   */
  public boolean getPlotTrainingData() {
<span class="nc" id="L906">    return m_plotTrainingData;</span>
  }
  
  /**
   * Get the current vector of Color objects used for the classes
   *
   * @return a &lt;code&gt;FastVector&lt;/code&gt; value
   */
  public FastVector getColors() {
<span class="nc" id="L915">    return m_Colors;</span>
  }
  
  /**
   * Quickly replot the display using cached probability estimates
   */
  public void replot() {
<span class="nc bnc" id="L922" title="All 2 branches missed.">    if (m_probabilityCache[0][0] == null) {</span>
<span class="nc" id="L923">      return;</span>
    }
<span class="nc" id="L925">    m_stopReplotting = true;</span>
<span class="nc" id="L926">    m_pausePlotting = true;</span>
    // wait 300 ms to give any other replot threads a chance to halt
    try {
<span class="nc" id="L929">      Thread.sleep(300);</span>
<span class="nc" id="L930">    } catch (Exception ex) {}</span>

<span class="nc" id="L932">    final Thread replotThread = new Thread() {</span>
        public void run() {
<span class="nc" id="L934">          m_stopReplotting = false;</span>
<span class="nc" id="L935">	  int size2 = m_size / 2;</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">          finishedReplot: for (int i = 0; i &lt; m_panelHeight; i += m_size) {</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">            for (int j = 0; j &lt; m_panelWidth; j += m_size) {</span>
<span class="nc bnc" id="L938" title="All 4 branches missed.">              if (m_probabilityCache[i][j] == null || m_stopReplotting) {</span>
<span class="nc" id="L939">                break finishedReplot;</span>
              }

<span class="nc bnc" id="L942" title="All 4 branches missed.">	      boolean update = (j == 0 &amp;&amp; i % 2 == 0);</span>
<span class="nc bnc" id="L943" title="All 4 branches missed.">	      if (i &lt; m_panelHeight &amp;&amp; j &lt; m_panelWidth) {</span>
		// Draw the three new subpixel regions or single course tiling
<span class="nc bnc" id="L945" title="All 4 branches missed.">		if (m_initialTiling || m_size == 1) {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">		  if (m_probabilityCache[i][j] == null) {</span>
<span class="nc" id="L947">		    break finishedReplot;</span>
		  }
<span class="nc" id="L949">		  plotPoint(j, i, m_size, m_size, </span>
<span class="nc" id="L950">			    m_probabilityCache[i][j], update);</span>
		} else {
<span class="nc bnc" id="L952" title="All 2 branches missed.">		  if (m_probabilityCache[i+size2][j] == null) {</span>
<span class="nc" id="L953">		    break finishedReplot;</span>
		  }
<span class="nc" id="L955">		  plotPoint(j, i + size2, size2, size2, </span>
<span class="nc" id="L956">			    m_probabilityCache[i + size2][j], update);</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">		  if (m_probabilityCache[i+size2][j+size2] == null) {</span>
<span class="nc" id="L958">		    break finishedReplot;</span>
		  }
<span class="nc" id="L960">		  plotPoint(j + size2, i + size2, size2, size2, </span>
<span class="nc" id="L961">			    m_probabilityCache[i + size2][j + size2], update);</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">		  if (m_probabilityCache[i][j+size2] == null) {</span>
<span class="nc" id="L963">		    break finishedReplot;</span>
		  }
<span class="nc" id="L965">		  plotPoint(j + size2, i, size2, size2, </span>
<span class="nc" id="L966">			    m_probabilityCache[i + size2][j], update);</span>
		}
	      }
	    }
          }
<span class="nc" id="L971">	  update();</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">          if (m_plotTrainingData) {</span>
<span class="nc" id="L973">            plotTrainingData();</span>
          }
<span class="nc" id="L975">	  m_pausePlotting = false;</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">	  if (!m_stopPlotting) {</span>
<span class="nc" id="L977">	    synchronized (m_dummy) {</span>
<span class="nc" id="L978">	      m_dummy.notifyAll();</span>
	    }
	  }
<span class="nc" id="L981">        }</span>
      };
    
<span class="nc" id="L984">    replotThread.start();      </span>
<span class="nc" id="L985">  }</span>

  protected void saveImage(String fileName) {
    BufferedImage	bi;
    Graphics2D 		gr2;
    ImageWriter 	writer;
    Iterator 		iter;
    ImageOutputStream 	ios;
    ImageWriteParam 	param;

    try {
      // render image
<span class="nc" id="L997">      bi  = new BufferedImage(m_panelWidth, m_panelHeight, BufferedImage.TYPE_INT_RGB);</span>
<span class="nc" id="L998">      gr2 = bi.createGraphics();</span>
<span class="nc" id="L999">      gr2.drawImage(m_osi, 0, 0, m_panelWidth, m_panelHeight, null);</span>

      // get jpeg writer
<span class="nc" id="L1002">      writer = null;</span>
<span class="nc" id="L1003">      iter   = ImageIO.getImageWritersByFormatName(&quot;jpg&quot;);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">      if (iter.hasNext())</span>
<span class="nc" id="L1005">	writer = (ImageWriter) iter.next();</span>
      else
<span class="nc" id="L1007">	throw new Exception(Messages.getInstance().getString(&quot;BoundaryPanel_SaveImage_Error_Text&quot;));</span>

      // prepare output file
<span class="nc" id="L1010">      ios = ImageIO.createImageOutputStream(new File(fileName));</span>
<span class="nc" id="L1011">      writer.setOutput(ios);</span>

      // set the quality
<span class="nc" id="L1014">      param = new JPEGImageWriteParam(Locale.getDefault());</span>
<span class="nc" id="L1015">      param.setCompressionMode(ImageWriteParam.MODE_EXPLICIT) ;</span>
<span class="nc" id="L1016">      param.setCompressionQuality(1.0f);</span>

      // write the image
<span class="nc" id="L1019">      writer.write(null, new IIOImage(bi, null, null), param);</span>

      // cleanup
<span class="nc" id="L1022">      ios.flush();</span>
<span class="nc" id="L1023">      writer.dispose();</span>
<span class="nc" id="L1024">      ios.close();    </span>
    }
<span class="nc" id="L1026">    catch (Exception e) {</span>
<span class="nc" id="L1027">      e.printStackTrace();</span>
    }
<span class="nc" id="L1029">  }</span>
  
  /** Adds a training instance to our dataset, based on the coordinates of the mouse on the panel.
      This method sets the x and y attributes and the class (as defined by classAttIndex), and sets
      all other values as Missing.
   *  @param mouseX the x coordinate of the mouse, in pixels.
   *  @param mouseY the y coordinate of the mouse, in pixels.
   *  @param classAttIndex the index of the attribute that is currently selected as the class attribute.
   *  @param classValue the value to set the class to in our new point.
   */
  public void addTrainingInstanceFromMouseLocation(int mouseX, int mouseY, int classAttIndex, double classValue) {
  	//convert to coordinates in the training instance space.
<span class="nc" id="L1041">	double x = convertFromPanelX(mouseX);</span>
<span class="nc" id="L1042">	double y = convertFromPanelY(mouseY);</span>
	
	//build the training instance
<span class="nc" id="L1045">	Instance newInstance = new Instance(m_trainingData.numAttributes());</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">	for (int i = 0; i &lt; newInstance.numAttributes(); i++) {</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">		if (i == classAttIndex) {</span>
<span class="nc" id="L1048">			newInstance.setValue(i,classValue);</span>
		}
<span class="nc bnc" id="L1050" title="All 2 branches missed.">		else if (i == m_xAttribute)</span>
<span class="nc" id="L1051">			newInstance.setValue(i,x);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">		else if (i == m_yAttribute)</span>
<span class="nc" id="L1053">			newInstance.setValue(i,y);</span>
<span class="nc" id="L1054">		else newInstance.setMissing(i);</span>
	}
	
	//add it to our data set.
<span class="nc" id="L1058">	addTrainingInstance(newInstance);</span>
<span class="nc" id="L1059">  }</span>
  
  /** Deletes all training instances from our dataset.
  */
  public void removeAllInstances() {
<span class="nc bnc" id="L1064" title="All 2 branches missed.">  	if (m_trainingData != null)</span>
	{
<span class="nc" id="L1066">  		m_trainingData.delete();</span>
<span class="nc" id="L1067">		try { initialize();} catch (Exception e) {};</span>
	}
	
<span class="nc" id="L1070">  }</span>
  
  /** Removes a single training instance from our dataset, if there is one that is close enough
      to the specified mouse location.
  */
  public void removeTrainingInstanceFromMouseLocation(int mouseX, int mouseY) {
  	
	//convert to coordinates in the training instance space.
<span class="nc" id="L1078">	double x = convertFromPanelX(mouseX);</span>
<span class="nc" id="L1079">	double y = convertFromPanelY(mouseY);</span>
	
<span class="nc" id="L1081">	int bestIndex = -1;</span>
<span class="nc" id="L1082">	double bestDistanceBetween = Integer.MAX_VALUE;</span>
	
	//find the closest point.
<span class="nc bnc" id="L1085" title="All 2 branches missed.">	for (int i = 0; i &lt; m_trainingData.numInstances(); i++) {</span>
<span class="nc" id="L1086">		Instance current = m_trainingData.instance(i);</span>
<span class="nc" id="L1087">		double distanceBetween = (current.value(m_xAttribute) - x) * (current.value(m_xAttribute) - x) + (current.value(m_yAttribute) - y) * (current.value(m_yAttribute) - y); // won't bother to sqrt, just used square values.</span>
		
<span class="nc bnc" id="L1089" title="All 2 branches missed.">		if (distanceBetween &lt; bestDistanceBetween)</span>
		{
<span class="nc" id="L1091">			bestIndex = i;</span>
<span class="nc" id="L1092">			bestDistanceBetween = distanceBetween;</span>
		}
	}
<span class="nc bnc" id="L1095" title="All 2 branches missed.">	if (bestIndex == -1)</span>
<span class="nc" id="L1096">		return;</span>
<span class="nc" id="L1097">	Instance best = m_trainingData.instance(bestIndex);</span>
<span class="nc" id="L1098">	double panelDistance = (convertToPanelX(best.value(m_xAttribute)) - mouseX) * (convertToPanelX(best.value(m_xAttribute)) - mouseX)</span>
<span class="nc" id="L1099">		+ (convertToPanelY(best.value(m_yAttribute)) - mouseY) * (convertToPanelY(best.value(m_yAttribute)) - mouseY);</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">	if (panelDistance &lt; REMOVE_POINT_RADIUS * REMOVE_POINT_RADIUS) {//the best point is close enough. (using squared distances)</span>
<span class="nc" id="L1101">		m_trainingData.delete(bestIndex);</span>
	}
<span class="nc" id="L1103">  }</span>
  
  /** Starts the plotting thread.  Will also create it if necessary.
  */
  public void startPlotThread() {
<span class="nc bnc" id="L1108" title="All 2 branches missed.">  	if (m_plotThread == null) { //jimmy</span>
<span class="nc" id="L1109">      		m_plotThread = new PlotThread();</span>
<span class="nc" id="L1110">      		m_plotThread.setPriority(Thread.MIN_PRIORITY);</span>
<span class="nc" id="L1111">      		m_plotThread.start();</span>
    	}
<span class="nc" id="L1113">  }</span>
  
  /** Adds a mouse listener.
  */
  public void addMouseListener(MouseListener l) {
<span class="nc" id="L1118">  	m_plotPanel.addMouseListener(l);</span>
<span class="nc" id="L1119">  }</span>
  
  /** Gets the minimum x-coordinate bound, in training-instance units (not mouse coordinates).
  */
  public double getMinXBound() {
<span class="nc" id="L1124">  	return m_minX;</span>
  }
  
  /** Gets the minimum y-coordinate bound, in training-instance units (not mouse coordinates).
  */
  public double getMinYBound() {
<span class="nc" id="L1130">  	return m_minY;</span>
  }
  
  /** Gets the maximum x-coordinate bound, in training-instance units (not mouse coordinates).
  */
  public double getMaxXBound() {
<span class="nc" id="L1136">  	return m_maxX;</span>
  }
  
  /** Gets the maximum x-coordinate bound, in training-instance units (not mouse coordinates).
  */
  public double getMaxYBound() {
<span class="nc" id="L1142">  	return m_maxY;</span>
  }

  /**
   * Main method for testing this class
   *
   * @param args a &lt;code&gt;String[]&lt;/code&gt; value
   */
  public static void main (String [] args) {
    try {
<span class="nc bnc" id="L1152" title="All 2 branches missed.">      if (args.length &lt; 8) {</span>
<span class="nc" id="L1153">	System.err.println(Messages.getInstance().getString(&quot;BoundaryPanel_Main_Error_Text_First&quot;));</span>
<span class="nc" id="L1154">	System.exit(1);</span>
      }
<span class="nc" id="L1156">      final javax.swing.JFrame jf = </span>
<span class="nc" id="L1157">	new javax.swing.JFrame(Messages.getInstance().getString(&quot;BoundaryPanel_Main_Title_JFrame_Text&quot;));</span>
<span class="nc" id="L1158">      jf.getContentPane().setLayout(new BorderLayout());</span>

<span class="nc" id="L1160">      System.err.println(Messages.getInstance().getString(&quot;BoundaryPanel_Main_Error_Text_Second&quot;) + args[0]);</span>
<span class="nc" id="L1161">      java.io.Reader r = new java.io.BufferedReader(</span>
<span class="nc" id="L1162">			 new java.io.FileReader(args[0]));</span>
<span class="nc" id="L1163">      final Instances i = new Instances(r);</span>
<span class="nc" id="L1164">      i.setClassIndex(Integer.parseInt(args[1]));</span>

      //      bv.setClassifier(new Logistic());
<span class="nc" id="L1167">      final int xatt = Integer.parseInt(args[2]);</span>
<span class="nc" id="L1168">      final int yatt = Integer.parseInt(args[3]);</span>
<span class="nc" id="L1169">      int base = Integer.parseInt(args[4]);</span>
<span class="nc" id="L1170">      int loc = Integer.parseInt(args[5]);</span>

<span class="nc" id="L1172">      int bandWidth = Integer.parseInt(args[6]);</span>
<span class="nc" id="L1173">      int panelWidth = Integer.parseInt(args[7]);</span>
<span class="nc" id="L1174">      int panelHeight = Integer.parseInt(args[8]);</span>

<span class="nc" id="L1176">      final String classifierName = args[9];</span>
<span class="nc" id="L1177">      final BoundaryPanel bv = new BoundaryPanel(panelWidth,panelHeight);</span>
<span class="nc" id="L1178">      bv.addActionListener(new ActionListener() {</span>
	  public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1180">	    String classifierNameNew = </span>
<span class="nc" id="L1181">	      classifierName.substring(classifierName.lastIndexOf('.')+1, </span>
<span class="nc" id="L1182">				       classifierName.length());</span>
<span class="nc" id="L1183">	    bv.saveImage(classifierNameNew+&quot;_&quot;+i.relationName()</span>
<span class="nc" id="L1184">			 +&quot;_X&quot;+xatt+&quot;_Y&quot;+yatt+&quot;.jpg&quot;);</span>
<span class="nc" id="L1185">	  }</span>
	});

<span class="nc" id="L1188">      jf.getContentPane().add(bv, BorderLayout.CENTER);</span>
<span class="nc" id="L1189">      jf.setSize(bv.getMinimumSize());</span>
      //      jf.setSize(200,200);
<span class="nc" id="L1191">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
	  public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L1193">	    jf.dispose();</span>
<span class="nc" id="L1194">	    System.exit(0);</span>
<span class="nc" id="L1195">	  }</span>
	});

<span class="nc" id="L1198">      jf.pack();</span>
<span class="nc" id="L1199">      jf.setVisible(true);</span>
      //      bv.initialize();
<span class="nc" id="L1201">      bv.repaint();</span>
      

<span class="nc" id="L1204">      String [] argsR = null;</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">      if (args.length &gt; 10) {</span>
<span class="nc" id="L1206">	argsR = new String [args.length-10];</span>
<span class="nc bnc" id="L1207" title="All 2 branches missed.">	for (int j = 10; j &lt; args.length; j++) {</span>
<span class="nc" id="L1208">	  argsR[j-10] = args[j];</span>
	}
      }
<span class="nc" id="L1211">      Classifier c = Classifier.forName(args[9], argsR);</span>
<span class="nc" id="L1212">      KDDataGenerator dataGen = new KDDataGenerator();</span>
<span class="nc" id="L1213">      dataGen.setKernelBandwidth(bandWidth);</span>
<span class="nc" id="L1214">      bv.setDataGenerator(dataGen);</span>
<span class="nc" id="L1215">      bv.setNumSamplesPerRegion(loc);</span>
<span class="nc" id="L1216">      bv.setGeneratorSamplesBase(base);</span>
<span class="nc" id="L1217">      bv.setClassifier(c);</span>
<span class="nc" id="L1218">      bv.setTrainingData(i);</span>
<span class="nc" id="L1219">      bv.setXAttribute(xatt);</span>
<span class="nc" id="L1220">      bv.setYAttribute(yatt);</span>

      try {
	// try and load a color map if one exists
<span class="nc" id="L1224">	FileInputStream fis = new FileInputStream(&quot;colors.ser&quot;);</span>
<span class="nc" id="L1225">	ObjectInputStream ois = new ObjectInputStream(fis);</span>
<span class="nc" id="L1226">	FastVector colors = (FastVector)ois.readObject();</span>
<span class="nc" id="L1227">	bv.setColors(colors);	</span>
<span class="nc" id="L1228">      } catch (Exception ex) {</span>
<span class="nc" id="L1229">	System.err.println(Messages.getInstance().getString(&quot;BoundaryPanel_Main_Error_Text_Third&quot;));</span>
      }
<span class="nc" id="L1231">      bv.start();</span>
<span class="nc" id="L1232">    } catch (Exception ex) {</span>
<span class="nc" id="L1233">      ex.printStackTrace();</span>
    }
<span class="nc" id="L1235">  }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (Nov 28, 2015 2:34:31 PM)</div></body></html>