<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>SimpleCLIPanel.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Nov 28, 2015 2:34:31 PM)</a> &gt; <a href="../../index.html" class="el_group">wekaproject</a> &gt; <a href="../index.html" class="el_bundle">src/src/main/java</a> &gt; <a href="index.source.html" class="el_package">weka.gui</a> &gt; <span class="el_source">SimpleCLIPanel.java</span></div><h1>SimpleCLIPanel.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/*</span>
 *    This program is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program; if not, write to the Free Software
 *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

/*
 *    SimpleCLIPanel.java
 *    Copyright (C) University of Waikato, Hamilton, New Zealand
 *
 */

package weka.gui;

import weka.core.ClassDiscovery;
import weka.core.Trie;
import weka.core.Utils;

import java.awt.BorderLayout;
import java.awt.Container;
import java.awt.Cursor;
import java.awt.Font;
import java.awt.Frame;
import java.awt.Window;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.awt.event.WindowEvent;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStreamReader;
import java.io.LineNumberReader;
import java.io.PipedInputStream;
import java.io.PipedOutputStream;
import java.io.PrintStream;
import java.io.Reader;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.Collections;
import java.util.HashSet;
import java.util.Properties;
import java.util.Vector;

import javax.swing.JFrame;
import javax.swing.JInternalFrame;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;

/**
 * Creates a very simple command line for invoking the main method of
 * classes. System.out and System.err are redirected to an output area.
 * Features a simple command history -- use up and down arrows to move
 * through previous commmands. This gui uses only AWT (i.e. no Swing).
 *
 * @author Len Trigg (trigg@cs.waikato.ac.nz)
 * @author FracPete (fracpete at waikato dot ac dot nz)
 * @version $Revision: 7059 $
 */
<span class="nc" id="L74">public class SimpleCLIPanel</span>
  extends JPanel
  implements ActionListener {
  
  /** for serialization. */
  private static final long serialVersionUID = -7377739469759943231L;
  
  /** The filename of the properties file. */
<span class="nc" id="L82">  protected static String FILENAME = &quot;SimpleCLI.props&quot;;</span>
  
  /** The default location of the properties file. */
<span class="nc" id="L85">  protected static String PROPERTY_FILE = &quot;weka/gui/&quot; + FILENAME;</span>
  
  /** Contains the SimpleCLI properties. */
  protected static Properties PROPERTIES;

  static {
    // Allow a properties file in the current directory to override
    try {
<span class="nc" id="L93">      PROPERTIES = Utils.readProperties(PROPERTY_FILE);</span>
<span class="nc" id="L94">      java.util.Enumeration keys = </span>
<span class="nc" id="L95">	(java.util.Enumeration) PROPERTIES.propertyNames();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">      if (!keys.hasMoreElements()) {</span>
<span class="nc" id="L97">	throw new Exception(</span>
<span class="nc" id="L98">	    Messages.getInstance().getString(&quot;SimpleCLIPanel_Exception_Text_First&quot;));</span>
      }
    }
<span class="nc" id="L101">    catch (Exception ex) {</span>
<span class="nc" id="L102">      JOptionPane.showMessageDialog(</span>
<span class="nc" id="L103">	  null,</span>
<span class="nc" id="L104">	  Messages.getInstance().getString(&quot;SimpleCLIPanel_Exception_JOptionPaneShowMessageDialog_Text_First&quot;)</span>
<span class="nc" id="L105">	  + PROPERTY_FILE </span>
<span class="nc" id="L106">	  + Messages.getInstance().getString(&quot;SimpleCLIPanel_Exception_JOptionPaneShowMessageDialog_Text_Second&quot;) </span>
<span class="nc" id="L107">	  + System.getProperties().getProperty(&quot;user.home&quot;) </span>
<span class="nc" id="L108">	  + Messages.getInstance().getString(&quot;SimpleCLIPanel_Exception_JOptionPaneShowMessageDialog_Text_Third&quot;),</span>
<span class="nc" id="L109">	  Messages.getInstance().getString(&quot;SimpleCLIPanel_Exception_JOptionPaneShowMessageDialog_Text_Fourth&quot;),</span>
<span class="nc" id="L110">	  JOptionPane.ERROR_MESSAGE);</span>
    }
  }
  
  /** The output area canvas added to the frame. */
<span class="nc" id="L115">  protected JTextArea m_OutputArea = new JTextArea();</span>

  /** The command input area. */
<span class="nc" id="L118">  protected JTextField m_Input = new JTextField();</span>

  /** The history of commands entered interactively. */
<span class="nc" id="L121">  protected Vector m_CommandHistory = new Vector();</span>

  /** The current position in the command history. */
<span class="nc" id="L124">  protected int m_HistoryPos = 0;</span>

  /** The new output stream for System.out. */
<span class="nc" id="L127">  protected PipedOutputStream m_POO = new PipedOutputStream();</span>

  /** The new output stream for System.err. */
<span class="nc" id="L130">  protected PipedOutputStream m_POE = new PipedOutputStream();</span>

  /** The thread that sends output from m_POO to the output box. */
  protected Thread m_OutRedirector;

  /** The thread that sends output from m_POE to the output box. */
  protected Thread m_ErrRedirector;

  /** The thread currently running a class main method. */
  protected Thread m_RunThread;

  /** The commandline completion. */
  protected CommandlineCompletion m_Completion;
  
  /**
   * A class that sends all lines from a reader to a TextArea component.
   * 
   * @author Len Trigg (trigg@cs.waikato.ac.nz)
   * @version $Revision: 7059 $
   */
  class ReaderToTextArea extends Thread {

    /** The reader being monitored. */
    protected LineNumberReader m_Input;

    /** The output text component. */
    protected JTextArea m_Output;
    
    /**
     * Sets up the ReaderToTextArea.
     *
     * @param input the Reader to monitor
     * @param output the TextArea to send output to
     */
<span class="nc" id="L164">    public ReaderToTextArea(Reader input, JTextArea output) {</span>
<span class="nc" id="L165">      setDaemon(true);</span>
<span class="nc" id="L166">      m_Input = new LineNumberReader(input);</span>
<span class="nc" id="L167">      m_Output = output;</span>
<span class="nc" id="L168">    }</span>

    /**
     * Sit here listening for lines of input and appending them straight
     * to the text component.
     */
    public void run() {

<span class="nc" id="L176">      while (true) {</span>
	try {
<span class="nc" id="L178">	  m_Output.append(m_Input.readLine() + '\n');</span>
<span class="nc" id="L179">	  m_Output.setCaretPosition(m_Output.getDocument().getLength());</span>
<span class="nc" id="L180">	} catch (Exception ex) {</span>
	  try {
<span class="nc" id="L182">	    sleep(100);</span>
<span class="nc" id="L183">	  } catch (Exception e) {</span>
	  }
	}
      }
    }
  }

  /**
   * A class that handles running the main method of the class
   * in a separate thread.
   * 
   * @author Len Trigg (trigg@cs.waikato.ac.nz)
   * @version $Revision: 7059 $
   */
  class ClassRunner extends Thread {

    /** Stores the main method to call. */
    protected Method m_MainMethod;

    /** Stores the command line arguments to pass to the main method. */
    String[] m_CommandArgs;
    
    /**
     * Sets up the class runner thread.
     *
     * @param theClass the Class to call the main method of
     * @param commandArgs an array of Strings to use as command line args
     * @throws Exception if an error occurs
     */
<span class="nc" id="L212">    public ClassRunner(Class theClass, String [] commandArgs)</span>
      throws Exception {
      
<span class="nc" id="L215">      setDaemon(true);</span>
<span class="nc" id="L216">      Class[] argTemplate = {String[].class};</span>
<span class="nc" id="L217">      m_CommandArgs = commandArgs;</span>
<span class="nc" id="L218">      m_MainMethod = theClass.getMethod(&quot;main&quot;, argTemplate);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (((m_MainMethod.getModifiers() &amp; Modifier.STATIC) == 0)</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">	  || (m_MainMethod.getModifiers() &amp; Modifier.PUBLIC) == 0) {</span>
<span class="nc" id="L221">	throw new NoSuchMethodException(Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Exception_NoSuchMethodException_Text_First&quot;) +</span>
<span class="nc" id="L222">					theClass.getName() +</span>
<span class="nc" id="L223">					Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Exception_NoSuchMethodException_Text_Second&quot;));</span>
      }
<span class="nc" id="L225">    }</span>

    /**
     * Starts running the main method.
     */
    public void run() {
<span class="nc" id="L231">      PrintStream outOld = null;</span>
<span class="nc" id="L232">      PrintStream outNew = null;</span>
<span class="nc" id="L233">      String outFilename = null;</span>
      
      // is the output redirected?
<span class="nc bnc" id="L236" title="All 2 branches missed.">      if (m_CommandArgs.length &gt; 2) {</span>
<span class="nc" id="L237">	String action = m_CommandArgs[m_CommandArgs.length - 2];</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">	if (action.equals(&quot;&gt;&quot;)) {</span>
<span class="nc" id="L239">	  outOld = System.out;</span>
	  try {
<span class="nc" id="L241">	    outFilename = m_CommandArgs[m_CommandArgs.length - 1];</span>
	    // since file may not yet exist, command-line completion doesn't
	    // work, hence replace &quot;~&quot; manually with home directory
<span class="nc bnc" id="L244" title="All 2 branches missed.">	    if (outFilename.startsWith(&quot;~&quot;))</span>
<span class="nc" id="L245">	      outFilename = outFilename.replaceFirst(&quot;~&quot;, System.getProperty(&quot;user.home&quot;));</span>
<span class="nc" id="L246">	    outNew = new PrintStream(new File(outFilename));</span>
<span class="nc" id="L247">	    System.setOut(outNew);</span>
<span class="nc" id="L248">	    m_CommandArgs[m_CommandArgs.length - 2] = &quot;&quot;;</span>
<span class="nc" id="L249">	    m_CommandArgs[m_CommandArgs.length - 1] = &quot;&quot;;</span>
	    // some main methods check the length of the &quot;args&quot; array
	    // -&gt; removed the two empty elements at the end
<span class="nc" id="L252">	    String[] newArgs = new String[m_CommandArgs.length - 2];</span>
<span class="nc" id="L253">	    System.arraycopy(m_CommandArgs, 0, newArgs, 0, m_CommandArgs.length - 2);</span>
<span class="nc" id="L254">	    m_CommandArgs = newArgs;</span>
	  }
<span class="nc" id="L256">	  catch (Exception e) {</span>
<span class="nc" id="L257">	    System.setOut(outOld);</span>
<span class="nc" id="L258">	    outOld = null;</span>
	  }
	}
      }
      
      try {
<span class="nc" id="L264">	Object[] args = {m_CommandArgs};</span>
<span class="nc" id="L265">	m_MainMethod.invoke(null, args);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">	if (isInterrupted()) {</span>
<span class="nc" id="L267">	  System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Run_Error_Text_First&quot;));</span>
	}
<span class="nc" id="L269">      } catch (Exception ex) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">	if (ex.getMessage() == null) {</span>
<span class="nc" id="L271">	  System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Run_Error_Text_Second&quot;));</span>
	} else {
<span class="nc" id="L273">	  System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Run_Error_Text_Third&quot;) + ex.getMessage());</span>
	}
<span class="nc" id="L275">      } finally {</span>
<span class="nc" id="L276">	m_RunThread = null;</span>
<span class="nc" id="L277">      }</span>
      
      // restore old System.out stream
<span class="nc bnc" id="L280" title="All 2 branches missed.">      if (outOld != null) {</span>
<span class="nc" id="L281">	outNew.flush();</span>
<span class="nc" id="L282">	outNew.close();</span>
<span class="nc" id="L283">	System.setOut(outOld);</span>
<span class="nc" id="L284">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Run_Text_First&quot;) + outFilename + Messages.getInstance().getString(&quot;SimpleCLIPanel_ClassRunner_Run_Text_Second&quot;));</span>
      }
<span class="nc" id="L286">    }</span>
  }

  /**
   * A class for commandline completion of classnames.
   * 
   * @author  FracPete (fracpete at waikato dot ac dot nz)
   * @version $Revision: 7059 $
   */
  public static class CommandlineCompletion {
    
    /** all the available packages. */
    protected static Vector&lt;String&gt; m_Packages;

    /** a trie for storing the packages. */
    protected static Trie m_Trie;
    
    /** debug mode on/off. */
<span class="nc" id="L304">    protected boolean m_Debug = false;</span>
    
    /**
     * default constructor.
     */
    public CommandlineCompletion() {
<span class="nc" id="L310">      super();</span>
      
      // build incremental list of packages
<span class="nc bnc" id="L313" title="All 2 branches missed.">      if (m_Packages == null) {</span>
	// get all packages
<span class="nc" id="L315">	Vector list = ClassDiscovery.findPackages();</span>
	
	// create incremental list
<span class="nc" id="L318">	HashSet&lt;String&gt; set = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">	for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L320">	  String[] parts = ((String) list.get(i)).split(&quot;\\.&quot;);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">	  for (int n = 1; n &lt; parts.length; n++) {</span>
<span class="nc" id="L322">	    String pkg = &quot;&quot;;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">	    for (int m = 0; m &lt;= n; m++) {</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">	      if (m &gt; 0)</span>
<span class="nc" id="L325">		pkg += &quot;.&quot;;</span>
<span class="nc" id="L326">	      pkg += parts[m];</span>
	    }
<span class="nc" id="L328">	    set.add(pkg);</span>
	  }
	}
	
	// init packages
<span class="nc" id="L333">	m_Packages = new Vector&lt;String&gt;();</span>
<span class="nc" id="L334">	m_Packages.addAll(set);</span>
<span class="nc" id="L335">	Collections.sort(m_Packages);</span>
	
<span class="nc" id="L337">	m_Trie = new Trie();</span>
<span class="nc" id="L338">	m_Trie.addAll(m_Packages);</span>
      }
<span class="nc" id="L340">    }</span>
    
    /**
     * returns whether debug mode is on.
     * 
     * @return		true if debug is on
     */
    public boolean getDebug() {
<span class="nc" id="L348">      return m_Debug;</span>
    }
    
    /**
     * sets debug mode on/off.
     * 
     * @param value	if true then debug mode is on
     */
    public void setDebug(boolean value) {
<span class="nc" id="L357">      m_Debug = value;</span>
<span class="nc" id="L358">    }</span>
    
    /**
     * tests whether the given partial string is the name of a class with
     * classpath - it basically tests, whether the string consists only
     * of alphanumeric literals, underscores and dots.
     * 
     * @param partial	the string to test
     * @return		true if it looks like a classname
     */
    public boolean isClassname(String partial) {
<span class="nc bnc" id="L369" title="All 2 branches missed.">      return (partial.replaceAll(&quot;[a-zA-Z0-9\\-\\.]*&quot;, &quot;&quot;).length() == 0);</span>
    }
    
    /**
     * returns the packages part of the partial classname.
     * 
     * @param partial	the partial classname
     * @return		the package part of the partial classname
     */
    public String getPackage(String partial) {
      String	result;
      int	i;
      boolean	wasDot;
      char	c;
      
<span class="nc" id="L384">      result = &quot;&quot;;</span>
<span class="nc" id="L385">      wasDot = false;</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">      for (i = 0; i &lt; partial.length(); i++) {</span>
<span class="nc" id="L387">	c = partial.charAt(i);</span>
	
	// start of classname?
<span class="nc bnc" id="L390" title="All 6 branches missed.">	if (wasDot &amp;&amp; ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z'))) {</span>
<span class="nc" id="L391">	  break;</span>
	}
	// package/class separator
<span class="nc bnc" id="L394" title="All 2 branches missed.">	else if (c == '.') {</span>
<span class="nc" id="L395">	  wasDot = true;</span>
<span class="nc" id="L396">	  result += &quot;&quot; + c;</span>
	}
	// regular char
	else {
<span class="nc" id="L400">	  wasDot = false;</span>
<span class="nc" id="L401">	  result += &quot;&quot; + c;</span>
	}
      }

      // remove trailing &quot;.&quot;
<span class="nc bnc" id="L406" title="All 2 branches missed.">      if (result.endsWith(&quot;.&quot;))</span>
<span class="nc" id="L407">	result = result.substring(0, result.length() - 1);</span>
      
<span class="nc" id="L409">      return result;</span>
    }
    
    /**
     * returns the classname part of the partial classname.
     * 
     * @param partial	the partial classname
     * @return		the class part of the classname
     */
    public String getClassname(String partial) {
      String	result;
      String	pkg;
      
<span class="nc" id="L422">      pkg = getPackage(partial);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">      if (pkg.length() + 1 &lt; partial.length())</span>
<span class="nc" id="L424">	result = partial.substring(pkg.length() + 1);</span>
      else
<span class="nc" id="L426">	result = &quot;&quot;;</span>
      
<span class="nc" id="L428">      return result;</span>
    }
    
    /**
     * returns all the file/dir matches with the partial search string.
     * 
     * @param partial	the partial search string
     * @return		all the matches
     */
    public Vector&lt;String&gt; getFileMatches(String partial) {
      Vector&lt;String&gt;	result;
      File		file;
      File		dir;
      File[]		files;
      int		i;
      String		prefix;
      boolean		caseSensitive;
      String		name;
      boolean		match;
      
<span class="nc" id="L448">      result = new Vector&lt;String&gt;();</span>

      // is the OS case-sensitive?
<span class="nc bnc" id="L451" title="All 2 branches missed.">      caseSensitive = (File.separatorChar != '\\');</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">      if (m_Debug)</span>
<span class="nc" id="L453">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetFileMatches_Text_First&quot;) + caseSensitive);</span>
      
      // is &quot;~&quot; used for home directory? -&gt; replace with actual home directory
<span class="nc bnc" id="L456" title="All 2 branches missed.">      if (partial.startsWith(&quot;~&quot;))</span>
<span class="nc" id="L457">	partial = System.getProperty(&quot;user.home&quot;) + partial.substring(1);</span>
      
      // determine dir and possible prefix
<span class="nc" id="L460">      file   = new File(partial);</span>
<span class="nc" id="L461">      dir    = null;</span>
<span class="nc" id="L462">      prefix = null;</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">      if (file.exists()) {</span>
	// determine dir to read
<span class="nc bnc" id="L465" title="All 2 branches missed.">	if (file.isDirectory()) {</span>
<span class="nc" id="L466">	  dir    = file;</span>
<span class="nc" id="L467">	  prefix = null;  // retrieve all</span>
	}
	else {
<span class="nc" id="L470">	  dir    = file.getParentFile();</span>
<span class="nc" id="L471">	  prefix = file.getName();</span>
	}
      }
      else {
<span class="nc" id="L475">	dir    = file.getParentFile();</span>
<span class="nc" id="L476">	prefix = file.getName();</span>
      }

<span class="nc bnc" id="L479" title="All 2 branches missed.">      if (m_Debug)</span>
<span class="nc" id="L480">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetFileMatches_Text_Second&quot;) + dir + Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetFileMatches_Text_Third&quot;) + prefix);</span>
      
      // list all files in dir
<span class="nc bnc" id="L483" title="All 2 branches missed.">      if (dir != null) {</span>
<span class="nc" id="L484">	files = dir.listFiles();</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">	if (files != null) {</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">	  for (i = 0; i &lt; files.length; i++) {</span>
<span class="nc" id="L487">	    name = files[i].getName();</span>

	    // does the name match?
<span class="nc bnc" id="L490" title="All 4 branches missed.">	    if ((prefix != null) &amp;&amp; caseSensitive)</span>
<span class="nc" id="L491">	      match = name.startsWith(prefix);</span>
<span class="nc bnc" id="L492" title="All 4 branches missed.">	    else if ((prefix != null) &amp;&amp; !caseSensitive)</span>
<span class="nc" id="L493">	      match = name.toLowerCase().startsWith(prefix.toLowerCase());</span>
	    else
<span class="nc" id="L495">	      match = true;</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">	    if (match) {</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">	      if (prefix != null) {</span>
<span class="nc" id="L499">		result.add(partial.substring(0, partial.length() - prefix.length()) + name);</span>
	      }
	      else {
<span class="nc bnc" id="L502" title="All 4 branches missed.">		if (partial.endsWith(&quot;\\&quot;) || partial.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L503">		  result.add(partial + name);</span>
		else
<span class="nc" id="L505">		  result.add(partial + File.separator + name);</span>
	      }
	    }
	  }
	}
	else {
<span class="nc" id="L511">	  System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetFileMatches_Error_Text&quot;) + partial);</span>
	}
      }
      
      // sort the result
<span class="nc bnc" id="L516" title="All 2 branches missed.">      if (result.size() &gt; 1)</span>
<span class="nc" id="L517">	Collections.sort(result);</span>
      
      // print results
<span class="nc bnc" id="L520" title="All 2 branches missed.">      if (m_Debug) {</span>
<span class="nc" id="L521">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetFileMatches_Text_Third&quot;));</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">	for (i = 0; i &lt; result.size(); i++)</span>
<span class="nc" id="L523">	  System.out.println(result.get(i));</span>
      }
      
<span class="nc" id="L526">      return result;</span>
    }
    
    /**
     * returns all the class/package matches with the partial search string.
     * 
     * @param partial	the partial search string
     * @return		all the matches
     */
    public Vector&lt;String&gt; getClassMatches(String partial) {
      String		pkg;
      String		cls;
      Vector&lt;String&gt; 	result;
      Vector&lt;String&gt; 	list;
      int		i;
      int		index;
      Trie		tmpTrie;
      HashSet		set;
      String		tmpStr;
      
<span class="nc" id="L546">      pkg = getPackage(partial);</span>
<span class="nc" id="L547">      cls = getClassname(partial);</span>
      
<span class="nc bnc" id="L549" title="All 2 branches missed.">      if (getDebug())</span>
<span class="nc" id="L550">	System.out.println(</span>
<span class="nc" id="L551">			Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetClassMatches_Text_First&quot;) + partial + Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetClassMatches_Text_Second&quot;) + pkg + Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetClassMatches_Text_Third&quot;) + cls);</span>

<span class="nc" id="L553">      result = new Vector&lt;String&gt;();</span>

      // find all packages that start with that string
<span class="nc bnc" id="L556" title="All 2 branches missed.">      if (cls.length() == 0) {</span>
<span class="nc" id="L557">	list = m_Trie.getWithPrefix(pkg);</span>
<span class="nc" id="L558">	set  = new HashSet();</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">	for (i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L560">	  tmpStr = list.get(i);</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">	  if (tmpStr.length() &lt; partial.length())</span>
<span class="nc" id="L562">	    continue;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">	  if (tmpStr.equals(partial))</span>
<span class="nc" id="L564">	    continue;</span>
	  
<span class="nc" id="L566">	  index  = tmpStr.indexOf('.', partial.length() + 1);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">	  if (index &gt; -1)</span>
<span class="nc" id="L568">	    set.add(tmpStr.substring(0, index));</span>
	  else
<span class="nc" id="L570">	    set.add(tmpStr);</span>
	}

<span class="nc" id="L573">	result.addAll(set);</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">	if (result.size() &gt; 1)</span>
<span class="nc" id="L575">	  Collections.sort(result);</span>
      }

      // find all classes that start with that string
<span class="nc" id="L579">      list = ClassDiscovery.find(Object.class, pkg);</span>
<span class="nc" id="L580">      tmpTrie = new Trie();</span>
<span class="nc" id="L581">      tmpTrie.addAll(list);</span>
<span class="nc" id="L582">      list = tmpTrie.getWithPrefix(partial);</span>
<span class="nc" id="L583">      result.addAll(list);</span>
      
      // sort the result
<span class="nc bnc" id="L586" title="All 2 branches missed.">      if (result.size() &gt; 1)</span>
<span class="nc" id="L587">	Collections.sort(result);</span>

      // print results
<span class="nc bnc" id="L590" title="All 2 branches missed.">      if (m_Debug) {</span>
<span class="nc" id="L591">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetClassMatches_Text_Fifth&quot;));</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">	for (i = 0; i &lt; result.size(); i++)</span>
<span class="nc" id="L593">	  System.out.println(result.get(i));</span>
      }
      
<span class="nc" id="L596">      return result;</span>
    }
    
    /**
     * returns all the matches with the partial search string, files or
     * classes.
     * 
     * @param partial	the partial search string
     * @return		all the matches
     */
    public Vector&lt;String&gt; getMatches(String partial) {
<span class="nc bnc" id="L607" title="All 2 branches missed.">      if (isClassname(partial))</span>
<span class="nc" id="L608">	return getClassMatches(partial);</span>
      else
<span class="nc" id="L610">	return getFileMatches(partial);</span>
    }
    
    /**
     * returns the common prefix for all the items in the list.
     * 
     * @param list	the list to return the common prefix for
     * @return		the common prefix of all the items
     */
    public String getCommonPrefix(Vector&lt;String&gt; list) {
      String	result;
      Trie	trie;
      
<span class="nc" id="L623">      trie = new Trie();</span>
<span class="nc" id="L624">      trie.addAll(list);</span>
<span class="nc" id="L625">      result = trie.getCommonPrefix();</span>
      
<span class="nc bnc" id="L627" title="All 2 branches missed.">      if (m_Debug)</span>
<span class="nc" id="L628">	System.out.println(list + Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetCommonPrefix_Text_First&quot;) + result + Messages.getInstance().getString(&quot;SimpleCLIPanel_CommandlineCompletion_GetCommonPrefix_Text_Second&quot;));</span>
      
<span class="nc" id="L630">      return result;</span>
    }
  }
  
  /**
   * Constructor.
   *
   * @throws Exception if an error occurs
   */
<span class="nc" id="L639">  public SimpleCLIPanel() throws Exception {</span>
    
<span class="nc" id="L641">    setLayout(new BorderLayout());</span>
<span class="nc" id="L642">    add(new JScrollPane(m_OutputArea), Messages.getInstance().getString(&quot;SimpleCLIPanel_JScrollPane_Text_First&quot;));</span>
<span class="nc" id="L643">    add(m_Input, Messages.getInstance().getString(&quot;SimpleCLIPanel_JScrollPane_Text_Second&quot;));</span>

<span class="nc" id="L645">    m_Input.setFont(new Font(&quot;Monospaced&quot;, Font.PLAIN, 12));</span>
<span class="nc" id="L646">    m_Input.addActionListener(this);</span>
<span class="nc" id="L647">    m_Input.setFocusTraversalKeysEnabled(false);</span>
<span class="nc" id="L648">    m_Input.addKeyListener(new KeyAdapter() {</span>
      public void keyPressed(KeyEvent e) {
<span class="nc" id="L650">	doHistory(e);</span>
<span class="nc" id="L651">	doCommandlineCompletion(e);</span>
<span class="nc" id="L652">      }</span>
    });
<span class="nc" id="L654">    m_OutputArea.setEditable(false);</span>
<span class="nc" id="L655">    m_OutputArea.setFont(new Font(&quot;Monospaced&quot;, Font.PLAIN, 12));</span>
    // Redirect System.out to the text area
    //    System.out.println(&quot;Redirecting System.out&quot;);
<span class="nc" id="L658">    PipedInputStream pio = new PipedInputStream(m_POO);</span>
<span class="nc" id="L659">    System.setOut(new PrintStream(m_POO));</span>
<span class="nc" id="L660">    Reader r = new InputStreamReader(pio);</span>
<span class="nc" id="L661">    m_OutRedirector = new ReaderToTextArea(r, m_OutputArea);</span>
<span class="nc" id="L662">    m_OutRedirector.start();</span>

    // Redirect System.err to the text area
    //    System.err.println(&quot;Redirecting System.err&quot;);
<span class="nc" id="L666">    PipedInputStream pie = new PipedInputStream(m_POE);</span>
<span class="nc" id="L667">    System.setErr(new PrintStream(m_POE));</span>
<span class="nc" id="L668">    r = new InputStreamReader(pie);</span>
<span class="nc" id="L669">    m_ErrRedirector = new ReaderToTextArea(r, m_OutputArea);</span>
<span class="nc" id="L670">    m_ErrRedirector.start();</span>

<span class="nc" id="L672">    m_Completion = new CommandlineCompletion();</span>
    
<span class="nc" id="L674">    System.out.println(</span>
<span class="nc" id="L675">    Messages.getInstance().getString(&quot;SimpleCLIPanel_JScrollPane_Text_Third&quot;)</span>
<span class="nc" id="L676">	+ File.separator </span>
<span class="nc" id="L677">	+ Messages.getInstance().getString(&quot;SimpleCLIPanel_JScrollPane_Text_Fouth&quot;));</span>
<span class="nc" id="L678">    runCommand(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Text&quot;));</span>
    
<span class="nc" id="L680">    loadHistory();</span>
<span class="nc" id="L681">  }</span>

  /**
   * Executes a simple cli command.
   *
   * @param commands the command string
   * @throws Exception if an error occurs
   */
  public void runCommand(String commands) throws Exception {

<span class="nc" id="L691">    System.out.println(&quot;&gt; &quot; + commands + '\n');</span>
<span class="nc" id="L692">    System.out.flush();</span>
<span class="nc" id="L693">    String [] commandArgs = Utils.splitOptions(commands);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">    if (commandArgs.length == 0) {</span>
<span class="nc" id="L695">      return;</span>
    }
<span class="nc bnc" id="L697" title="All 2 branches missed.">    if (commandArgs[0].equals(&quot;java&quot;)) {</span>
      // Execute the main method of a class
<span class="nc" id="L699">      commandArgs[0] = &quot;&quot;;</span>
      try {
<span class="nc bnc" id="L701" title="All 2 branches missed.">	if (commandArgs.length == 1) {</span>
<span class="nc" id="L702">	  throw new Exception(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Exception_Text_First&quot;));</span>
	}
<span class="nc" id="L704">	String className = commandArgs[1];</span>
<span class="nc" id="L705">	commandArgs[1] = &quot;&quot;;</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">	if (m_RunThread != null) {</span>
<span class="nc" id="L707">	  throw new Exception(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Exception_Text_Second&quot;));</span>
	}
<span class="nc" id="L709">	Class theClass = Class.forName(className);</span>

	// some classes expect a fixed order of the args, i.e., they don't
	// use Utils.getOption(...) =&gt; create new array without first two
	// empty strings (former &quot;java&quot; and &quot;&lt;classname&gt;&quot;)
<span class="nc" id="L714">	Vector argv = new Vector();</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">	for (int i = 2; i &lt; commandArgs.length; i++)</span>
<span class="nc" id="L716">	  argv.add(commandArgs[i]);</span>
  
<span class="nc" id="L718">	m_RunThread = new ClassRunner(theClass, (String[]) argv.toArray(new String[argv.size()]));</span>
<span class="nc" id="L719">	m_RunThread.setPriority(Thread.MIN_PRIORITY); // UI has most priority</span>
<span class="nc" id="L720">	m_RunThread.start();	</span>
<span class="nc" id="L721">      } catch (Exception ex) {</span>
<span class="nc" id="L722">	System.err.println(ex.getMessage());</span>
      }

<span class="nc bnc" id="L725" title="All 2 branches missed.">    } else if (commandArgs[0].equals(&quot;cls&quot;)) {</span>
      // Clear the text area
<span class="nc" id="L727">      m_OutputArea.setText(&quot;&quot;);</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">    } else if (commandArgs[0].equals(&quot;history&quot;)) {</span>
<span class="nc" id="L729">      System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Text_First&quot;));</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">      for (int i = 0; i &lt; m_CommandHistory.size(); i++)</span>
<span class="nc" id="L731">	System.out.println(m_CommandHistory.get(i));</span>
<span class="nc" id="L732">      System.out.println();</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">    } else if (commandArgs[0].equals(&quot;break&quot;)) {</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">      if (m_RunThread == null) {</span>
<span class="nc" id="L735">	System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_First&quot;));</span>
      } else {
<span class="nc" id="L737">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Text_Second&quot;));</span>
<span class="nc" id="L738">	m_RunThread.interrupt();</span>
      }
<span class="nc bnc" id="L740" title="All 2 branches missed.">    } else if (commandArgs[0].equals(&quot;kill&quot;)) {</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">      if (m_RunThread == null) {</span>
<span class="nc" id="L742">	System.err.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Second&quot;));</span>
      } else {
<span class="nc" id="L744">	System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Text_Third&quot;));</span>
<span class="nc" id="L745">	m_RunThread.stop();</span>
<span class="nc" id="L746">	m_RunThread = null;</span>
      }
<span class="nc bnc" id="L748" title="All 2 branches missed.">    } else if (commandArgs[0].equals(&quot;exit&quot;)) {</span>
      // Shut down
      // determine parent
<span class="nc" id="L751">      Container parent = getParent();</span>
<span class="nc" id="L752">      Container frame = null;</span>
<span class="nc" id="L753">      boolean finished = false;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">      while (!finished) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">	if (    (parent instanceof JFrame) </span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">	     || (parent instanceof Frame) </span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">	     || (parent instanceof JInternalFrame) ) {</span>
<span class="nc" id="L758">	  frame = parent;</span>
<span class="nc" id="L759">	  finished = true;</span>
	}
	
<span class="nc bnc" id="L762" title="All 2 branches missed.">	if (!finished) {</span>
<span class="nc" id="L763">	  parent = parent.getParent();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">	  finished = (parent == null);</span>
	}
      }
      // fire the frame close event
<span class="nc bnc" id="L768" title="All 2 branches missed.">      if (frame != null) {</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">	if (frame instanceof JInternalFrame)</span>
<span class="nc" id="L770">	  ((JInternalFrame) frame).doDefaultCloseAction();</span>
	else
<span class="nc" id="L772">	  ((Window) frame).dispatchEvent(</span>
<span class="nc" id="L773">	      new WindowEvent(</span>
<span class="nc" id="L774">		  (Window) frame, WindowEvent.WINDOW_CLOSING));</span>
      }
      
    } else {
<span class="nc bnc" id="L778" title="All 2 branches missed.">      boolean help = ((commandArgs.length &gt; 1)</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">		      &amp;&amp; commandArgs[0].equals(&quot;help&quot;));</span>
<span class="nc bnc" id="L780" title="All 4 branches missed.">      if (help &amp;&amp; commandArgs[1].equals(&quot;java&quot;)) {</span>
<span class="nc" id="L781">	System.err.println(</span>
<span class="nc" id="L782">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Third&quot;) </span>
<span class="nc" id="L783">	    + File.separator </span>
<span class="nc" id="L784">	    + Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Fourth&quot;));</span>
<span class="nc bnc" id="L785" title="All 4 branches missed.">      } else if (help &amp;&amp; commandArgs[1].equals(&quot;break&quot;)) {</span>
<span class="nc" id="L786">	System.err.println(</span>
<span class="nc" id="L787">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Fifth&quot;));</span>
<span class="nc bnc" id="L788" title="All 4 branches missed.">      } else if (help &amp;&amp; commandArgs[1].equals(&quot;kill&quot;)) {</span>
<span class="nc" id="L789">	System.err.println(</span>
<span class="nc" id="L790">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Sixth&quot;));</span>
<span class="nc bnc" id="L791" title="All 4 branches missed.">      } else if (help &amp;&amp; commandArgs[1].equals(&quot;cls&quot;)) {</span>
<span class="nc" id="L792">	System.err.println(</span>
<span class="nc" id="L793">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Seventh&quot;));</span>
<span class="nc bnc" id="L794" title="All 4 branches missed.">      } else if (help &amp;&amp; commandArgs[1].equals(&quot;history&quot;)) {</span>
<span class="nc" id="L795">	System.err.println(</span>
<span class="nc" id="L796">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Eighth&quot;));</span>
<span class="nc bnc" id="L797" title="All 4 branches missed.">      } else if (help &amp;&amp; commandArgs[1].equals(&quot;exit&quot;)) {</span>
<span class="nc" id="L798">	System.err.println(</span>
<span class="nc" id="L799">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Nineth&quot;));</span>
      } else {
	// Print a help message
<span class="nc" id="L802">	System.err.println(</span>
<span class="nc" id="L803">			Messages.getInstance().getString(&quot;SimpleCLIPanel_RunCommand_Error_Text_Tenth&quot;));</span>
      }
    }
<span class="nc" id="L806">  }</span>

  /**
   * Changes the currently displayed command line when certain keys
   * are pressed. The up arrow moves back through history entries
   * and the down arrow moves forward through history entries.
   *
   * @param e a value of type 'KeyEvent'
   */
  public void doHistory(KeyEvent e) {
    
<span class="nc bnc" id="L817" title="All 2 branches missed.">    if (e.getSource() == m_Input) {</span>
<span class="nc bnc" id="L818" title="All 3 branches missed.">      switch (e.getKeyCode()) {</span>
      case KeyEvent.VK_UP:
<span class="nc bnc" id="L820" title="All 2 branches missed.">	if (m_HistoryPos &gt; 0) {</span>
<span class="nc" id="L821">	  m_HistoryPos--;</span>
<span class="nc" id="L822">	  String command = (String) m_CommandHistory.elementAt(m_HistoryPos);</span>
<span class="nc" id="L823">	  m_Input.setText(command);</span>
	}
<span class="nc" id="L825">	break;</span>
      case KeyEvent.VK_DOWN:
<span class="nc bnc" id="L827" title="All 2 branches missed.">	if (m_HistoryPos &lt; m_CommandHistory.size()) {</span>
<span class="nc" id="L828">	  m_HistoryPos++;</span>
<span class="nc" id="L829">	  String command = &quot;&quot;;</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">	  if (m_HistoryPos &lt; m_CommandHistory.size()) {</span>
<span class="nc" id="L831">	    command = (String) m_CommandHistory.elementAt(m_HistoryPos);</span>
	  }
<span class="nc" id="L833">	  m_Input.setText(command);</span>
	}
<span class="nc" id="L835">	break;</span>
      default:
	break;
      }
    }
<span class="nc" id="L840">  }</span>

  /**
   * performs commandline completion on packages and classnames.
   * 
   * @param e a value of type 'KeyEvent'
   */
  public void doCommandlineCompletion(KeyEvent e) {
<span class="nc bnc" id="L848" title="All 2 branches missed.">    if (e.getSource() == m_Input) {</span>
<span class="nc bnc" id="L849" title="All 3 branches missed.">      switch (e.getKeyCode()) {</span>
	// completion
	case KeyEvent.VK_TAB:
<span class="nc bnc" id="L852" title="All 2 branches missed.">	  if (e.getModifiers() == 0) {</span>
	    // it might take a while before we determined all of the possible
	    // matches (Java doesn't have an application wide cursor handling??)
<span class="nc" id="L855">	    m_Input.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L856">	    m_OutputArea.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>

	    try {
<span class="nc" id="L859">	      String txt = m_Input.getText();</span>

	      // java call?
<span class="nc bnc" id="L862" title="All 2 branches missed.">	      if (txt.trim().startsWith(&quot;java &quot;)) {</span>
<span class="nc" id="L863">		int pos = m_Input.getCaretPosition();</span>
<span class="nc" id="L864">		int nonNameCharPos = -1;</span>
		// find first character not part of a name, back from current position
		// i.e., &quot; or blank
<span class="nc bnc" id="L867" title="All 2 branches missed.">		for (int i = pos - 1; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">		  if (    (txt.charAt(i) == '&quot;') </span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">		      || (txt.charAt(i) == ' ') ) {</span>
<span class="nc" id="L870">		    nonNameCharPos = i;</span>
<span class="nc" id="L871">		    break;</span>
		  }
		}

<span class="nc bnc" id="L875" title="All 2 branches missed.">		if (nonNameCharPos &gt; -1) {</span>
<span class="nc" id="L876">		  String search = txt.substring(nonNameCharPos + 1, pos);</span>

		  // find matches and common prefix
<span class="nc" id="L879">		  Vector&lt;String&gt; list = m_Completion.getMatches(search);</span>
<span class="nc" id="L880">		  String common = m_Completion.getCommonPrefix(list);</span>

		  // just extending by separator is not a real extension
<span class="nc bnc" id="L883" title="All 2 branches missed.">		  if ((search.toLowerCase() + File.separator).equals(common.toLowerCase()))</span>
<span class="nc" id="L884">		    common = search;</span>

		  // can we complete the string?
<span class="nc bnc" id="L887" title="All 2 branches missed.">		  if (common.length() &gt; search.length()) {</span>
		    try {
<span class="nc" id="L889">		      m_Input.getDocument().remove(nonNameCharPos + 1, search.length());</span>
<span class="nc" id="L890">		      m_Input.getDocument().insertString(nonNameCharPos + 1, common, null);</span>
		    }
<span class="nc" id="L892">		    catch (Exception ex) {</span>
<span class="nc" id="L893">		      ex.printStackTrace();</span>
		    }
		  }
		  // ambigiuous? -&gt; print matches
<span class="nc bnc" id="L897" title="All 2 branches missed.">		  else if (list.size() &gt; 1) {</span>
<span class="nc" id="L898">		    System.out.println(Messages.getInstance().getString(&quot;SimpleCLIPanel_DoCommandlineCompletion_Text&quot;));</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">		    for (int i = 0; i &lt; list.size(); i++)</span>
<span class="nc" id="L900">		      System.out.println(&quot;  &quot; + list.get(i));</span>
		  }
		  else {
		    // nothing found, don't do anything
		  }
		}
	      }
	    }
<span class="nc" id="L908">	    finally {</span>
	      // set cursor back to default
<span class="nc" id="L910">	      m_Input.setCursor(null);</span>
<span class="nc" id="L911">	      m_OutputArea.setCursor(null);</span>
<span class="nc" id="L912">	    }</span>
	  }
<span class="nc" id="L914">	  break;</span>

	// delete last part up to next blank or dot
	case KeyEvent.VK_BACK_SPACE:
<span class="nc bnc" id="L918" title="All 2 branches missed.">	  if (e.getModifiers() == KeyEvent.ALT_MASK) {</span>
<span class="nc" id="L919">	    String txt = m_Input.getText();</span>
<span class="nc" id="L920">	    int pos    = m_Input.getCaretPosition();</span>
	    
	    // skip whitespaces
<span class="nc" id="L923">	    int start = pos;</span>
<span class="nc" id="L924">	    start--;</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">	    while (start &gt;= 0) {</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">	      if (    (txt.charAt(start) == '.') </span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">		   || (txt.charAt(start) == ' ') </span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">		   || (txt.charAt(start) == '\\')</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">		   || (txt.charAt(start) == '/') )</span>
<span class="nc" id="L930">		start--;</span>
	      else
		break;
	    }
	    
	    // find first blank or dot back from position
<span class="nc" id="L936">	    int newPos = -1;</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">	    for (int i = start; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">	      if (    (txt.charAt(i) == '.') </span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">		   || (txt.charAt(i) == ' ')</span>
<span class="nc bnc" id="L940" title="All 2 branches missed.">		   || (txt.charAt(i) == '\\') </span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">		   || (txt.charAt(i) == '/') ) {</span>
<span class="nc" id="L942">		newPos = i;</span>
<span class="nc" id="L943">		break;</span>
	      }
	    }

	    // remove string
	    try {
<span class="nc" id="L949">	      m_Input.getDocument().remove(newPos + 1, pos - newPos - 1);</span>
	    }
<span class="nc" id="L951">	    catch (Exception ex) {</span>
<span class="nc" id="L952">	      ex.printStackTrace();</span>
	    }
	  }
	  break;
      }
    }
<span class="nc" id="L958">  }</span>
  
  /**
   * Only gets called when return is pressed in the input area, which
   * starts the command running.
   *
   * @param e a value of type 'ActionEvent'
   */
  public void actionPerformed(ActionEvent e) {

    try {
<span class="nc bnc" id="L969" title="All 2 branches missed.">      if (e.getSource() == m_Input) {</span>
<span class="nc" id="L970">	String command = m_Input.getText();</span>
<span class="nc" id="L971">	int last = m_CommandHistory.size() - 1;</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">	if ((last &lt; 0)</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">	    || !command.equals((String)m_CommandHistory.elementAt(last))) {</span>
<span class="nc" id="L974">	  m_CommandHistory.addElement(command);</span>
<span class="nc" id="L975">	  saveHistory();</span>
	}
<span class="nc" id="L977">	m_HistoryPos = m_CommandHistory.size();</span>
<span class="nc" id="L978">	runCommand(command);</span>
	
<span class="nc" id="L980">	m_Input.setText(&quot;&quot;);</span>
      }
<span class="nc" id="L982">    } catch (Exception ex) {</span>
<span class="nc" id="L983">      System.err.println(ex.getMessage());</span>
    }
<span class="nc" id="L985">  }</span>

  /**
   * loads the command history from the user's properties file.
   */
  protected void loadHistory() {
    int 	size;
    int		i;
    String	cmd;
    
<span class="nc" id="L995">    size = Integer.parseInt(PROPERTIES.getProperty(&quot;HistorySize&quot;, &quot;50&quot;));</span>

<span class="nc" id="L997">    m_CommandHistory.clear();</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">    for (i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L999">      cmd = PROPERTIES.getProperty(&quot;Command&quot; + i, &quot;&quot;);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">      if (cmd.length() != 0)</span>
<span class="nc" id="L1001">	m_CommandHistory.add(cmd);</span>
      else 
	break;
    }
    
<span class="nc" id="L1006">    m_HistoryPos = m_CommandHistory.size();</span>
<span class="nc" id="L1007">  }</span>
  
  /**
   * saves the current command history in the user's home directory.
   */
  protected void saveHistory() {
    int 			size;
    int				from;
    int				i;
    String			filename;
    BufferedOutputStream	stream;
    
<span class="nc" id="L1019">    size = Integer.parseInt(PROPERTIES.getProperty(&quot;HistorySize&quot;, &quot;50&quot;));</span>
    
    // determine first command to save
<span class="nc" id="L1022">    from = m_CommandHistory.size() - size;</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">    if (from &lt; 0)</span>
<span class="nc" id="L1024">      from = 0;</span>

    // fill properties
<span class="nc" id="L1027">    PROPERTIES.setProperty(&quot;HistorySize&quot;, &quot;&quot; + size);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">    for (i = from; i &lt; m_CommandHistory.size(); i++)</span>
<span class="nc" id="L1029">      PROPERTIES.setProperty(&quot;Command&quot; + (i-from), (String) m_CommandHistory.get(i));</span>
    
    try {
<span class="nc" id="L1032">      filename = System.getProperties().getProperty(&quot;user.home&quot;) + File.separatorChar + FILENAME;</span>
<span class="nc" id="L1033">      stream = new BufferedOutputStream(new FileOutputStream(filename));</span>
<span class="nc" id="L1034">      PROPERTIES.store(stream, &quot;SimpleCLI&quot;);</span>
<span class="nc" id="L1035">      stream.close();</span>
    }
<span class="nc" id="L1037">    catch (Exception e) {</span>
<span class="nc" id="L1038">      e.printStackTrace();</span>
    }
<span class="nc" id="L1040">  }</span>
  
  /**
   * Main method for testing this class.
   * 
   * @param args 	commandline arguments - ignored
   * @throws Exception	if initialization fails
   */
  public static void main(String[] args) throws Exception {
<span class="nc" id="L1049">    SimpleCLIPanel panel = new SimpleCLIPanel();</span>
<span class="nc" id="L1050">    JFrame f = new JFrame();</span>
<span class="nc" id="L1051">    f.setTitle(Messages.getInstance().getString(&quot;SimpleCLIPanel_Main_JFrame_SetText_Text&quot;));</span>
<span class="nc" id="L1052">    f.getContentPane().add(panel);</span>
<span class="nc" id="L1053">    f.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L1054">    f.pack();</span>
<span class="nc" id="L1055">    f.setSize(600, 500);</span>
<span class="nc" id="L1056">    f.setVisible(true);</span>
<span class="nc" id="L1057">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (Nov 28, 2015 2:34:31 PM)</div></body></html>