<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>KnowledgeFlowApp.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Nov 28, 2015 2:34:31 PM)</a> &gt; <a href="../../index.html" class="el_group">wekaproject</a> &gt; <a href="../index.html" class="el_bundle">src/src/main/java</a> &gt; <a href="index.source.html" class="el_package">weka.gui.beans</a> &gt; <span class="el_source">KnowledgeFlowApp.java</span></div><h1>KnowledgeFlowApp.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/*</span>
 *    This program is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program; if not, write to the Free Software
 *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

/*
 *    KnowledgeFlowApp.java
 *    Copyright (C) 2005 University of Waikato, Hamilton, New Zealand
 *
 */

package weka.gui.beans;

import java.awt.BorderLayout;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridLayout;
import java.awt.Image;
import java.awt.MenuItem;
import java.awt.Point;
import java.awt.PopupMenu;
import java.awt.Rectangle;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.InputEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseMotionAdapter;
import java.awt.image.BufferedImage;
import java.beans.BeanInfo;
import java.beans.Beans;
import java.beans.Customizer;
import java.beans.EventSetDescriptor;
import java.beans.IntrospectionException;
import java.beans.Introspector;
import java.beans.MethodDescriptor;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.beans.beancontext.BeanContextChild;
import java.beans.beancontext.BeanContextSupport;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.LineNumberReader;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.lang.reflect.Method;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Properties;
import java.util.StringTokenizer;
import java.util.TreeMap;
import java.util.Vector;

import javax.swing.Box;
import javax.swing.ButtonGroup;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTabbedPane;
import javax.swing.JTextArea;
import javax.swing.JToggleButton;
import javax.swing.JToolBar;
import javax.swing.JWindow;
import javax.swing.filechooser.FileFilter;

import weka.core.ClassloaderUtil;
import weka.core.Copyright;
import weka.core.Environment;
import weka.core.EnvironmentHandler;
import weka.core.Memory;
import weka.core.SerializedObject;
import weka.core.Utils;
import weka.core.xml.KOML;
import weka.core.xml.XStream;
import weka.gui.ExtensionFileFilter;
import weka.gui.GenericObjectEditor;
import weka.gui.GenericPropertiesCreator;
import weka.gui.HierarchyPropertyParser;
import weka.gui.LookAndFeel;
import weka.gui.beans.xml.XMLBeans;
import weka.gui.visualize.PrintablePanel;

/**
 * Main GUI class for the KnowledgeFlow. Modifications to allow interoperability
 * with swt provided by Davide Zerbetto (davide dot zerbetto at eng dot it).
 * 
 * @author Mark Hall
 * @version $Revision: 9495 $
 * @since 1.0
 * @see JPanel
 * @see PropertyChangeListener
 */
<span class="nc" id="L126">public class KnowledgeFlowApp extends JPanel implements PropertyChangeListener {</span>

  /** for serialization */
  private static final long serialVersionUID = -7064906770289728431L;

  /**
   * Location of the property file for the KnowledgeFlowApp
   */
<span class="nc" id="L134">  protected static String PROPERTY_FILE = &quot;weka/gui/beans/Beans.props&quot;;</span>

  /** Contains the editor properties */
  protected static Properties BEAN_PROPERTIES;

  private static ArrayList&lt;Properties&gt; BEAN_PLUGINS_PROPERTIES;

  /**
   * Holds the details needed to construct button bars for various supported
   * classes of weka algorithms/tools
   */
<span class="nc" id="L145">  private static Vector TOOLBARS = new Vector();</span>

  /**
   * Loads KnowledgeFlow properties and any plugins (adds jars to the classpath)
   */
  public static void loadProperties() {
<span class="nc bnc" id="L151" title="All 2 branches missed.">    if (BEAN_PROPERTIES == null) {</span>
<span class="nc" id="L152">      System.out.println(Messages.getInstance().getString(</span>
<span class="nc" id="L153">          &quot;KnowledgeFlowApp_LoadProperties_Text_First&quot;));</span>
      /** Loads the configuration property file */
      // static {
      // Allow a properties file in the current directory to override
      try {
<span class="nc" id="L158">        BEAN_PROPERTIES = Utils.readProperties(PROPERTY_FILE);</span>
<span class="nc" id="L159">        java.util.Enumeration keys = BEAN_PROPERTIES.propertyNames();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (!keys.hasMoreElements()) {</span>
<span class="nc" id="L161">          throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L162">              &quot;KnowledgeFlowApp_LoadProperties_Exception_Text_First&quot;)</span>
<span class="nc" id="L163">              + Messages.getInstance().getString(</span>
<span class="nc" id="L164">                  &quot;KnowledgeFlowApp_LoadProperties_Exception_Text_Second&quot;)</span>
<span class="nc" id="L165">              + PROPERTY_FILE</span>
<span class="nc" id="L166">              + Messages.getInstance().getString(</span>
<span class="nc" id="L167">                  &quot;KnowledgeFlowApp_LoadProperties_Exception_Text_Third&quot;)</span>
<span class="nc" id="L168">              + System.getProperties().getProperty(&quot;user.home&quot;)</span>
<span class="nc" id="L169">              + Messages.getInstance().getString(</span>
<span class="nc" id="L170">                  &quot;KnowledgeFlowApp_LoadProperties_Exception_Text_Fourth&quot;));</span>
        }
<span class="nc" id="L172">      } catch (Exception ex) {</span>
        JOptionPane
<span class="nc" id="L174">            .showMessageDialog(</span>
<span class="nc" id="L175">                null,</span>
<span class="nc" id="L176">                ex.getMessage(),</span>
                Messages
<span class="nc" id="L178">                    .getInstance()</span>
<span class="nc" id="L179">                    .getString(</span>
<span class="nc" id="L180">                        &quot;KnowledgeFlowApp_LoadProperties_Exception_JOptionPaneShowMessageDialog_Text&quot;),</span>
<span class="nc" id="L181">                JOptionPane.ERROR_MESSAGE);</span>
      }

      // try and load any plugin beans properties
<span class="nc" id="L185">      File pluginDir = new File(System.getProperty(&quot;user.home&quot;)</span>
<span class="nc" id="L186">          + File.separator + &quot;.knowledgeFlow&quot; + File.separator + &quot;plugins&quot;);</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">      if (pluginDir.exists() &amp;&amp; pluginDir.isDirectory()) {</span>
<span class="nc" id="L188">        BEAN_PLUGINS_PROPERTIES = new ArrayList&lt;Properties&gt;();</span>
        // How many sub-dirs are there?
<span class="nc" id="L190">        File[] contents = pluginDir.listFiles();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">        for (int i = 0; i &lt; contents.length; i++) {</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">          if (contents[i].isDirectory() &amp;&amp; contents[i].listFiles().length &gt; 0) {</span>
            try {
<span class="nc" id="L194">              Properties tempP = new Properties();</span>
<span class="nc" id="L195">              File propFile = new File(contents[i].getPath() + File.separator</span>
<span class="nc" id="L196">                  + &quot;Beans.props&quot;);</span>
<span class="nc" id="L197">              tempP.load(new FileInputStream(propFile));</span>
<span class="nc" id="L198">              BEAN_PLUGINS_PROPERTIES.add(tempP);</span>

              // Now try and add all jar files in this directory to the
              // classpath
<span class="nc" id="L202">              File anyJars[] = contents[i].listFiles();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">              for (int j = 0; j &lt; anyJars.length; j++) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (anyJars[j].getPath().endsWith(&quot;.jar&quot;)) {</span>
<span class="nc" id="L205">                  System.out.println(Messages.getInstance().getString(</span>
<span class="nc" id="L206">                      &quot;KnowledgeFlowApp_LoadProperties_Text_Second&quot;)</span>
<span class="nc" id="L207">                      + anyJars[j].getPath()</span>
<span class="nc" id="L208">                      + Messages.getInstance().getString(</span>
<span class="nc" id="L209">                          &quot;KnowledgeFlowApp_LoadProperties_Text_Third&quot;));</span>
<span class="nc" id="L210">                  ClassloaderUtil.addFile(anyJars[j].getPath());</span>
                }
              }
<span class="nc" id="L213">            } catch (Exception ex) {</span>
              // Don't make a fuss
<span class="nc" id="L215">              System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L216">                  &quot;KnowledgeFlowApp_LoadProperties_Error_Text_First&quot;)</span>
<span class="nc" id="L217">                  + contents[i].getPath());</span>
            }
          }
          // BEAN_PLUGINS_PROPERTIES = new Properties();
          // BEAN_PLUGINS_PROPERTIES.load(new FileInputStream(pluginDir));
        }
      } else {
        // make the plugin directory for the user
<span class="nc" id="L225">        pluginDir.mkdir();</span>
      }
    }
<span class="nc" id="L228">  }</span>

  /**
   * Initializes the temporary files necessary to construct the toolbars from.
   */
  private static void init() {
<span class="nc" id="L234">    System.out.println(Messages.getInstance().getString(</span>
<span class="nc" id="L235">        &quot;KnowledgeFlowApp_Init_Text_First&quot;));</span>

    try {
<span class="nc" id="L238">      TreeMap wrapList = new TreeMap();</span>
<span class="nc" id="L239">      GenericPropertiesCreator creator = new GenericPropertiesCreator();</span>
<span class="nc" id="L240">      Properties GEOProps = null;</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">      if (creator.useDynamic()) {</span>
<span class="nc" id="L243">        creator.execute(false);</span>
        /*
         * now process the keys in the GenericObjectEditor.props. For each key
         * that has an entry in the Beans.props associating it with a bean
         * component a button tool bar will be created
         */
<span class="nc" id="L249">        GEOProps = creator.getOutputProperties();</span>
      } else {
        // Read the static information from the GenericObjectEditor.props
<span class="nc" id="L252">        GEOProps = Utils.readProperties(&quot;weka/gui/GenericObjectEditor.props&quot;);</span>
      }
<span class="nc" id="L254">      Enumeration en = GEOProps.propertyNames();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">      while (en.hasMoreElements()) {</span>
<span class="nc" id="L256">        String geoKey = (String) en.nextElement();</span>

        // try to match this key with one in the Beans.props file
<span class="nc" id="L259">        String beanCompName = BEAN_PROPERTIES.getProperty(geoKey);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (beanCompName != null) {</span>
          // add details necessary to construct a button bar for this class
          // of algorithms
<span class="nc" id="L263">          Vector newV = new Vector();</span>
          // check for a naming alias for this toolbar
<span class="nc" id="L265">          String toolBarNameAlias = BEAN_PROPERTIES.getProperty(geoKey</span>
<span class="nc" id="L266">              + &quot;.alias&quot;);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">          String toolBarName = (toolBarNameAlias != null) ? toolBarNameAlias</span>
<span class="nc" id="L268">              : geoKey.substring(geoKey.lastIndexOf('.') + 1, geoKey.length());</span>

          // look for toolbar ordering information for this wrapper type
<span class="nc" id="L271">          String order = BEAN_PROPERTIES.getProperty(geoKey + &quot;.order&quot;);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">          Integer intOrder = (order != null) ? new Integer(order)</span>
<span class="nc" id="L273">              : new Integer(0);</span>

          // Name for the toolbar (name of weka algorithm class)
<span class="nc" id="L276">          newV.addElement(toolBarName);</span>
          // Name of bean capable of handling this class of algorithm
<span class="nc" id="L278">          newV.addElement(beanCompName);</span>

          // add the root package for this key
<span class="nc" id="L281">          String rootPackage = geoKey.substring(0, geoKey.lastIndexOf('.'));</span>

<span class="nc" id="L283">          newV.addElement(rootPackage);</span>

          // All the weka algorithms of this class of algorithm
<span class="nc" id="L286">          String wekaAlgs = GEOProps.getProperty(geoKey);</span>

<span class="nc" id="L288">          Hashtable roots = GenericObjectEditor.sortClassesByRoot(wekaAlgs);</span>
<span class="nc" id="L289">          Hashtable hpps = new Hashtable();</span>
<span class="nc" id="L290">          Enumeration enm = roots.keys();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">          while (enm.hasMoreElements()) {</span>
<span class="nc" id="L292">            String root = (String) enm.nextElement();</span>
<span class="nc" id="L293">            String classes = (String) roots.get(root);</span>
<span class="nc" id="L294">            weka.gui.HierarchyPropertyParser hpp = new weka.gui.HierarchyPropertyParser();</span>
<span class="nc" id="L295">            hpp.build(classes, &quot;, &quot;);</span>
            // System.err.println(hpp.showTree());
<span class="nc" id="L297">            hpps.put(root, hpp);</span>
          }

          // ------ test the HierarchyPropertyParser
          /*
           * weka.gui.HierarchyPropertyParser hpp = new
           * weka.gui.HierarchyPropertyParser(); hpp.build(wekaAlgs, &quot;, &quot;);
           * 
           * System.err.println(hpp.showTree());
           */
          // ----- end test the HierarchyPropertyParser
          // newV.addElement(hpp); // add the hierarchical property parser
<span class="nc" id="L309">          newV.addElement(hpps); // add the hierarchical property parser</span>

<span class="nc" id="L311">          StringTokenizer st = new StringTokenizer(wekaAlgs, &quot;, &quot;);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">          while (st.hasMoreTokens()) {</span>
<span class="nc" id="L313">            String current = st.nextToken().trim();</span>
<span class="nc" id="L314">            newV.addElement(current);</span>
          }
<span class="nc" id="L316">          wrapList.put(intOrder, newV);</span>
          // TOOLBARS.addElement(newV);
        }
      }
<span class="nc" id="L320">      Iterator keysetIt = wrapList.keySet().iterator();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">      while (keysetIt.hasNext()) {</span>
<span class="nc" id="L322">        Integer key = (Integer) keysetIt.next();</span>
<span class="nc" id="L323">        Vector newV = (Vector) wrapList.get(key);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">        if (newV != null) {</span>
<span class="nc" id="L325">          TOOLBARS.addElement(newV);</span>
        }
      }
<span class="nc" id="L328">    } catch (Exception ex) {</span>
      JOptionPane
<span class="nc" id="L330">          .showMessageDialog(</span>
<span class="nc" id="L331">              null,</span>
<span class="nc" id="L332">              Messages</span>
<span class="nc" id="L333">                  .getInstance()</span>
<span class="nc" id="L334">                  .getString(</span>
<span class="nc" id="L335">                      &quot;KnowledgeFlowApp_Init_Exception_JOptionPaneShowMessageDialog_Text_First&quot;)</span>
<span class="nc" id="L336">                  + System.getProperties().getProperty(&quot;user.home&quot;)</span>
<span class="nc" id="L337">                  + Messages</span>
<span class="nc" id="L338">                      .getInstance()</span>
<span class="nc" id="L339">                      .getString(</span>
<span class="nc" id="L340">                          &quot;KnowledgeFlowApp_Init_Exception_JOptionPaneShowMessageDialog_Text_Second&quot;),</span>
              Messages
<span class="nc" id="L342">                  .getInstance()</span>
<span class="nc" id="L343">                  .getString(</span>
<span class="nc" id="L344">                      &quot;KnowledgeFlowApp_Init_Exception_JOptionPaneShowMessageDialog_Text_Third&quot;),</span>
<span class="nc" id="L345">              JOptionPane.ERROR_MESSAGE);</span>
    }

    try {
<span class="nc" id="L349">      String standardToolBarNames = BEAN_PROPERTIES</span>
<span class="nc" id="L350">          .getProperty(&quot;weka.gui.beans.KnowledgeFlow.standardToolBars&quot;);</span>
<span class="nc" id="L351">      StringTokenizer st = new StringTokenizer(standardToolBarNames, &quot;, &quot;);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">      while (st.hasMoreTokens()) {</span>
<span class="nc" id="L353">        String tempBarName = st.nextToken().trim();</span>
        // construct details for this toolbar
<span class="nc" id="L355">        Vector newV = new Vector();</span>
        // add the name of the toolbar
<span class="nc" id="L357">        newV.addElement(tempBarName);</span>

        // indicate that this is a standard toolbar (no wrapper bean)
<span class="nc" id="L360">        newV.addElement(&quot;null&quot;);</span>
<span class="nc" id="L361">        String toolBarContents = BEAN_PROPERTIES</span>
<span class="nc" id="L362">            .getProperty(&quot;weka.gui.beans.KnowledgeFlow.&quot; + tempBarName);</span>
<span class="nc" id="L363">        StringTokenizer st2 = new StringTokenizer(toolBarContents, &quot;, &quot;);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        while (st2.hasMoreTokens()) {</span>
<span class="nc" id="L365">          String tempBeanName = st2.nextToken().trim();</span>
<span class="nc" id="L366">          newV.addElement(tempBeanName);</span>
        }
<span class="nc" id="L368">        TOOLBARS.addElement(newV);</span>
      }
<span class="nc" id="L370">    } catch (Exception ex) {</span>
      JOptionPane
<span class="nc" id="L372">          .showMessageDialog(</span>
<span class="nc" id="L373">              null,</span>
<span class="nc" id="L374">              ex.getMessage(),</span>
              Messages
<span class="nc" id="L376">                  .getInstance()</span>
<span class="nc" id="L377">                  .getString(</span>
<span class="nc" id="L378">                      &quot;KnowledgeFlowApp_Init_Exception_JOptionPaneShowMessageDialog_Text_Fourth&quot;),</span>
<span class="nc" id="L379">              JOptionPane.ERROR_MESSAGE);</span>
    }
<span class="nc" id="L381">  }</span>

  /**
   * Used for displaying the bean components and their visible connections
   * 
   * @author &lt;a href=&quot;mailto:mhall@cs.waikato.ac.nz&quot;&gt;Mark Hall&lt;/a&gt;
   * @version $Revision: 9495 $
   * @since 1.0
   * @see PrintablePanel
   */
<span class="nc" id="L391">  protected class BeanLayout extends PrintablePanel {</span>

    /** for serialization */
    private static final long serialVersionUID = -146377012429662757L;

    @Override
    public void paintComponent(Graphics gx) {
<span class="nc" id="L398">      super.paintComponent(gx);</span>
<span class="nc" id="L399">      BeanInstance.paintLabels(gx);</span>
<span class="nc" id="L400">      BeanConnection.paintConnections(gx);</span>
      // BeanInstance.paintConnections(gx);
<span class="nc bnc" id="L402" title="All 2 branches missed.">      if (m_mode == CONNECTING) {</span>
<span class="nc" id="L403">        gx.drawLine(m_startX, m_startY, m_oldX, m_oldY);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">      } else if (m_mode == SELECTING) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        gx.drawRect((m_startX &lt; m_oldX) ? m_startX : m_oldX,</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            (m_startY &lt; m_oldY) ? m_startY : m_oldY,</span>
<span class="nc" id="L407">            Math.abs(m_oldX - m_startX), Math.abs(m_oldY - m_startY));</span>
      }
<span class="nc" id="L409">    }</span>

    @Override
    public void doLayout() {
<span class="nc" id="L413">      super.doLayout();</span>
<span class="nc" id="L414">      Vector comps = BeanInstance.getBeanInstances();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">      for (int i = 0; i &lt; comps.size(); i++) {</span>
<span class="nc" id="L416">        BeanInstance bi = (BeanInstance) comps.elementAt(i);</span>
<span class="nc" id="L417">        JComponent c = (JComponent) bi.getBean();</span>
<span class="nc" id="L418">        Dimension d = c.getPreferredSize();</span>
<span class="nc" id="L419">        c.setBounds(bi.getX(), bi.getY(), d.width, d.height);</span>
<span class="nc" id="L420">        c.revalidate();</span>
      }
<span class="nc" id="L422">    }</span>
  }

  // Used for measuring and splitting icon labels
  // over multiple lines
  FontMetrics m_fontM;

  // constants for operations in progress
  protected static final int NONE = 0;
  protected static final int MOVING = 1;
  protected static final int CONNECTING = 2;
  protected static final int ADDING = 3;
  protected static final int SELECTING = 4;

  // which operation is in progress
<span class="nc" id="L437">  private int m_mode = NONE;</span>

  /** the extension for the user components, when serialized to XML */
  protected final static String USERCOMPONENTS_XML_EXTENSION = &quot;.xml&quot;;

  /**
   * Button group to manage all toolbar buttons
   */
<span class="nc" id="L445">  private final ButtonGroup m_toolBarGroup = new ButtonGroup();</span>

  /**
   * Holds the selected toolbar bean
   */
  private Object m_toolBarBean;

  /**
   * The layout area
   */
<span class="nc" id="L455">  private final BeanLayout m_beanLayout = new BeanLayout();</span>

  /**
   * Tabbed pane to hold tool bars
   */
<span class="nc" id="L460">  private final JTabbedPane m_toolBars = new JTabbedPane();</span>

  /**
   * Stuff relating to plugin beans
   */
<span class="nc" id="L465">  private JToolBar m_pluginsToolBar = null;</span>
<span class="nc" id="L466">  private Box m_pluginsBoxPanel = null;</span>

  /**
   * Stuff relating to user created meta beans
   */
<span class="nc" id="L471">  private JToolBar m_userToolBar = null;</span>
<span class="nc" id="L472">  private Box m_userBoxPanel = null;</span>
<span class="nc" id="L473">  private final Vector m_userComponents = new Vector();</span>
<span class="nc" id="L474">  private boolean m_firstUserComponentOpp = true;</span>

  private JToggleButton m_pointerB;
  private JButton m_saveB;
  private JButton m_loadB;
  private JButton m_stopB;
  private JButton m_helpB;
  private JButton m_newB;

  /**
   * Reference to bean being manipulated
   */
  private BeanInstance m_editElement;

  /**
   * Event set descriptor for the bean being manipulated
   */
  private EventSetDescriptor m_sourceEventSetDescriptor;

  /**
   * Used to record screen coordinates during move, select and connect
   * operations
   */
  private int m_oldX, m_oldY;
  private int m_startX, m_startY;

  /** The file chooser for selecting layout files */
<span class="nc" id="L501">  protected JFileChooser m_FileChooser = new JFileChooser(new File(</span>
<span class="nc" id="L502">      System.getProperty(&quot;user.dir&quot;)));</span>

<span class="nc" id="L504">  protected LogPanel m_logPanel = new LogPanel();// new LogPanel(null, true);</span>

<span class="nc" id="L506">  protected BeanContextSupport m_bcSupport = new BeanContextSupport();</span>

  /** the extension for the serialized setups (Java serialization) */
  public final static String FILE_EXTENSION = &quot;.kf&quot;;

  /** the extension for the serialized setups (Java serialization) */
  public final static String FILE_EXTENSION_XML = &quot;.kfml&quot;;

  /**
   * A filter to ensure only KnowledgeFlow files in binary format get shown in
   * the chooser
   */
<span class="nc" id="L518">  protected FileFilter m_KfFilter = new ExtensionFileFilter(FILE_EXTENSION,</span>
<span class="nc" id="L519">      Messages.getInstance().getString(&quot;KnowledgeFlowApp_KfFilter_Text_First&quot;)</span>
<span class="nc" id="L520">          + FILE_EXTENSION</span>
<span class="nc" id="L521">          + Messages.getInstance().getString(</span>
<span class="nc" id="L522">              &quot;KnowledgeFlowApp_KfFilter_Text_Second&quot;));</span>

  /**
   * A filter to ensure only KnowledgeFlow files in KOML format get shown in the
   * chooser
   */
<span class="nc" id="L528">  protected FileFilter m_KOMLFilter = new ExtensionFileFilter(</span>
<span class="nc" id="L529">      KOML.FILE_EXTENSION + &quot;kf&quot;, Messages.getInstance().getString(</span>
<span class="nc" id="L530">          &quot;KnowledgeFlowApp_KOMLFilter_Text_Second&quot;)</span>
<span class="nc" id="L531">          + KOML.FILE_EXTENSION</span>
<span class="nc" id="L532">          + Messages.getInstance().getString(</span>
<span class="nc" id="L533">              &quot;KnowledgeFlowApp_KOMLFilter_Text_Third&quot;));</span>

  /**
   * A filter to ensure only KnowledgeFlow files in XStream format get shown in
   * the chooser
   */
<span class="nc" id="L539">  protected FileFilter m_XStreamFilter = new ExtensionFileFilter(</span>
<span class="nc" id="L540">      XStream.FILE_EXTENSION + &quot;kf&quot;, Messages.getInstance().getString(</span>
<span class="nc" id="L541">          &quot;KnowledgeFlowApp_XStreamFilter_Text_Second&quot;)</span>
<span class="nc" id="L542">          + XStream.FILE_EXTENSION</span>
<span class="nc" id="L543">          + Messages.getInstance().getString(</span>
<span class="nc" id="L544">              &quot;KnowledgeFlowApp_XStreamFilter_Text_Third&quot;));</span>

  /**
   * A filter to ensure only KnowledgeFlow layout files in XML format get shown
   * in the chooser
   */
<span class="nc" id="L550">  protected FileFilter m_XMLFilter = new ExtensionFileFilter(</span>
<span class="nc" id="L551">      FILE_EXTENSION_XML, Messages.getInstance().getString(</span>
<span class="nc" id="L552">          &quot;KnowledgeFlowApp_XMLFilter_Text_First&quot;)</span>
<span class="nc" id="L553">          + FILE_EXTENSION_XML</span>
<span class="nc" id="L554">          + Messages.getInstance().getString(</span>
<span class="nc" id="L555">              &quot;KnowledgeFlowApp_XMLFilter_Text_Second&quot;));</span>

  /** the scrollbar increment of the layout scrollpane */
<span class="nc" id="L558">  protected int m_ScrollBarIncrementLayout = 20;</span>

  /** the scrollbar increment of the components scrollpane */
<span class="nc" id="L561">  protected int m_ScrollBarIncrementComponents = 50;</span>

  /** the flow layout width */
<span class="nc" id="L564">  protected int m_FlowWidth = 1024;</span>

  /** the flow layout height */
<span class="nc" id="L567">  protected int m_FlowHeight = 768;</span>

  /** the preferred file extension */
<span class="nc" id="L570">  protected String m_PreferredExtension = FILE_EXTENSION;</span>

  /** whether to store the user components in XML or in binary format */
<span class="nc" id="L573">  protected boolean m_UserComponentsInXML = false;</span>

  /** Environment variables for the current flow */
<span class="nc" id="L576">  protected Environment m_flowEnvironment = new Environment();</span>

  /**
   * Set the environment variables to use. NOTE: loading a new layout resets
   * back to the default set of variables
   * 
   * @param env
   */
  public void setEnvironment(Environment env) {
<span class="nc" id="L585">    m_flowEnvironment = env;</span>
<span class="nc" id="L586">    setEnvironment();</span>
<span class="nc" id="L587">  }</span>

  private void setEnvironment() {
    // pass m_flowEnvironment to all components
    // that implement EnvironmentHandler
<span class="nc" id="L592">    Vector beans = BeanInstance.getBeanInstances();</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">    for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L594">      Object temp = ((BeanInstance) beans.elementAt(i)).getBean();</span>

<span class="nc bnc" id="L596" title="All 2 branches missed.">      if (temp instanceof EnvironmentHandler) {</span>
<span class="nc" id="L597">        ((EnvironmentHandler) temp).setEnvironment(m_flowEnvironment);</span>
      }
    }
<span class="nc" id="L600">  }</span>

  /**
   * Creates a new &lt;code&gt;KnowledgeFlowApp&lt;/code&gt; instance.
   */
  // modifications by Zerbetto
  // public KnowledgeFlowApp() {
<span class="nc" id="L607">  public KnowledgeFlowApp(boolean showFileMenu) {</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">    if (BEAN_PROPERTIES == null) {</span>
<span class="nc" id="L609">      loadProperties();</span>
<span class="nc" id="L610">      init();</span>
    }

<span class="nc" id="L613">    m_showFileMenu = showFileMenu;</span>

    // end modifications by Zerbetto
    // Grab a fontmetrics object
<span class="nc" id="L617">    JWindow temp = new JWindow();</span>
<span class="nc" id="L618">    temp.setVisible(true);</span>
<span class="nc" id="L619">    temp.getGraphics().setFont(new Font(null, Font.PLAIN, 9));</span>
<span class="nc" id="L620">    m_fontM = temp.getGraphics().getFontMetrics();</span>
<span class="nc" id="L621">    temp.setVisible(false);</span>

    // some GUI defaults
    try {
<span class="nc" id="L625">      m_ScrollBarIncrementLayout = Integer.parseInt(BEAN_PROPERTIES</span>
<span class="nc" id="L626">          .getProperty(&quot;ScrollBarIncrementLayout&quot;, &quot;&quot;</span>
<span class="nc" id="L627">              + m_ScrollBarIncrementLayout));</span>
<span class="nc" id="L628">      m_ScrollBarIncrementComponents = Integer.parseInt(BEAN_PROPERTIES</span>
<span class="nc" id="L629">          .getProperty(&quot;ScrollBarIncrementComponents&quot;, &quot;&quot;</span>
<span class="nc" id="L630">              + m_ScrollBarIncrementComponents));</span>
<span class="nc" id="L631">      m_FlowWidth = Integer.parseInt(BEAN_PROPERTIES.getProperty(&quot;FlowWidth&quot;,</span>
<span class="nc" id="L632">          &quot;&quot; + m_FlowWidth));</span>
<span class="nc" id="L633">      m_FlowHeight = Integer.parseInt(BEAN_PROPERTIES.getProperty(&quot;FlowHeight&quot;,</span>
<span class="nc" id="L634">          &quot;&quot; + m_FlowHeight));</span>
<span class="nc" id="L635">      m_PreferredExtension = BEAN_PROPERTIES.getProperty(&quot;PreferredExtension&quot;,</span>
<span class="nc" id="L636">          m_PreferredExtension);</span>
<span class="nc" id="L637">      m_UserComponentsInXML = Boolean.valueOf(</span>
<span class="nc" id="L638">          BEAN_PROPERTIES.getProperty(&quot;UserComponentsInXML&quot;, &quot;&quot;</span>
<span class="nc" id="L639">              + m_UserComponentsInXML)).booleanValue();</span>
<span class="nc" id="L640">    } catch (Exception ex) {</span>
<span class="nc" id="L641">      ex.printStackTrace();</span>
    }

    // FileChooser
<span class="nc" id="L645">    m_FileChooser.addChoosableFileFilter(m_KfFilter);</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">    if (KOML.isPresent()) {</span>
<span class="nc" id="L647">      m_FileChooser.addChoosableFileFilter(m_KOMLFilter);</span>
    }
<span class="nc bnc" id="L649" title="All 2 branches missed.">    if (XStream.isPresent()) {</span>
<span class="nc" id="L650">      m_FileChooser.addChoosableFileFilter(m_XStreamFilter);</span>
    }

<span class="nc" id="L653">    m_FileChooser.addChoosableFileFilter(m_XMLFilter);</span>

<span class="nc bnc" id="L655" title="All 2 branches missed.">    if (m_PreferredExtension.equals(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L656">      m_FileChooser.setFileFilter(m_XMLFilter);</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">    } else if (KOML.isPresent()</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">        &amp;&amp; m_PreferredExtension.equals(KOML.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L659">      m_FileChooser.setFileFilter(m_KOMLFilter);</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">    } else if (XStream.isPresent()</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">        &amp;&amp; m_PreferredExtension.equals(XStream.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L662">      m_FileChooser.setFileFilter(m_XStreamFilter);</span>
    } else {
<span class="nc" id="L664">      m_FileChooser.setFileFilter(m_KfFilter);</span>
    }
<span class="nc" id="L666">    m_FileChooser.setFileSelectionMode(JFileChooser.FILES_ONLY);</span>

<span class="nc" id="L668">    m_bcSupport.setDesignTime(true);</span>
<span class="nc" id="L669">    m_beanLayout.setLayout(null);</span>

    // handle mouse events
<span class="nc" id="L672">    m_beanLayout.addMouseListener(new MouseAdapter() {</span>

      @Override
      public void mousePressed(MouseEvent me) {
<span class="nc bnc" id="L676" title="All 2 branches missed.">        if (m_toolBarBean == null) {</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">          if (((me.getModifiers() &amp; InputEvent.BUTTON1_MASK) == InputEvent.BUTTON1_MASK)</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">              &amp;&amp; m_mode == NONE) {</span>
<span class="nc" id="L679">            BeanInstance bi = BeanInstance.findInstance(me.getPoint());</span>
<span class="nc" id="L680">            JComponent bc = null;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">            if (bi != null) {</span>
<span class="nc" id="L682">              bc = (JComponent) (bi.getBean());</span>
            }
<span class="nc bnc" id="L684" title="All 4 branches missed.">            if (bc != null &amp;&amp; (bc instanceof Visible)) {</span>
<span class="nc" id="L685">              m_editElement = bi;</span>
<span class="nc" id="L686">              m_oldX = me.getX();</span>
<span class="nc" id="L687">              m_oldY = me.getY();</span>
<span class="nc" id="L688">              m_mode = MOVING;</span>
            }
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (m_mode != MOVING) {</span>
<span class="nc" id="L691">              m_mode = SELECTING;</span>
<span class="nc" id="L692">              m_oldX = me.getX();</span>
<span class="nc" id="L693">              m_oldY = me.getY();</span>
<span class="nc" id="L694">              m_startX = m_oldX;</span>
<span class="nc" id="L695">              m_startY = m_oldY;</span>
<span class="nc" id="L696">              Graphics2D gx = (Graphics2D) m_beanLayout.getGraphics();</span>
<span class="nc" id="L697">              gx.setXORMode(java.awt.Color.white);</span>
              // gx.drawRect(m_oldX, m_oldY, m_oldX, m_oldY);
              // gx.drawLine(m_startX, m_startY, m_startX, m_startY);
<span class="nc" id="L700">              gx.dispose();</span>
<span class="nc" id="L701">              m_mode = SELECTING;</span>
            }
          }
        }
<span class="nc" id="L705">      }</span>

      @Override
      public void mouseReleased(MouseEvent me) {
<span class="nc bnc" id="L709" title="All 4 branches missed.">        if (m_editElement != null &amp;&amp; m_mode == MOVING) {</span>
<span class="nc" id="L710">          m_editElement = null;</span>
<span class="nc" id="L711">          revalidate();</span>
<span class="nc" id="L712">          m_beanLayout.repaint();</span>
<span class="nc" id="L713">          m_mode = NONE;</span>
        }
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (m_mode == SELECTING) {</span>
<span class="nc" id="L716">          revalidate();</span>
<span class="nc" id="L717">          m_beanLayout.repaint();</span>
<span class="nc" id="L718">          m_mode = NONE;</span>

<span class="nc" id="L720">          checkSubFlow(m_startX, m_startY, me.getX(), me.getY());</span>
        }
<span class="nc" id="L722">      }</span>

      @Override
      public void mouseClicked(MouseEvent me) {
<span class="nc" id="L726">        BeanInstance bi = BeanInstance.findInstance(me.getPoint());</span>
<span class="nc bnc" id="L727" title="All 4 branches missed.">        if (m_mode == ADDING || m_mode == NONE) {</span>
          // try and popup a context sensitive menu if we have
          // been clicked over a bean.
<span class="nc bnc" id="L730" title="All 2 branches missed.">          if (bi != null) {</span>
<span class="nc" id="L731">            JComponent bc = (JComponent) bi.getBean();</span>
            // if we've been double clicked, then popup customizer
            // as long as we're not a meta bean
<span class="nc bnc" id="L734" title="All 4 branches missed.">            if (me.getClickCount() == 2 &amp;&amp; !(bc instanceof MetaBean)) {</span>
              try {
<span class="nc" id="L736">                Class custClass = Introspector.getBeanInfo(bc.getClass())</span>
<span class="nc" id="L737">                    .getBeanDescriptor().getCustomizerClass();</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">                if (custClass != null) {</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">                  if (bc instanceof BeanCommon) {</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    if (!((BeanCommon) bc).isBusy()) {</span>
<span class="nc" id="L741">                      popupCustomizer(custClass, bc);</span>
                    }
                  } else {
<span class="nc" id="L744">                    popupCustomizer(custClass, bc);</span>
                  }
                }
<span class="nc" id="L747">              } catch (IntrospectionException ex) {</span>
<span class="nc" id="L748">                ex.printStackTrace();</span>
              }
<span class="nc bnc" id="L750" title="All 2 branches missed.">            } else if (((me.getModifiers() &amp; InputEvent.BUTTON1_MASK) != InputEvent.BUTTON1_MASK)</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">                || me.isAltDown()) {</span>
<span class="nc" id="L752">              doPopup(me.getPoint(), bi, me.getX(), me.getY());</span>
            }
          } else {
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (((me.getModifiers() &amp; InputEvent.BUTTON1_MASK) != InputEvent.BUTTON1_MASK)</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                || me.isAltDown()) {</span>
              // find connections if any close to this point
<span class="nc" id="L758">              int delta = 10;</span>
<span class="nc" id="L759">              deleteConnectionPopup(</span>
<span class="nc" id="L760">                  BeanConnection.getClosestConnections(</span>
<span class="nc" id="L761">                      new Point(me.getX(), me.getY()), delta), me.getX(),</span>
<span class="nc" id="L762">                  me.getY());</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">            } else if (m_toolBarBean != null) {</span>
              // otherwise, if a toolbar button is active then
              // add the component
<span class="nc" id="L766">              addComponent(me.getX(), me.getY());</span>
            }
          }
        }

<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (m_mode == CONNECTING) {</span>
          // turn off connecting points and remove connecting line
<span class="nc" id="L773">          m_beanLayout.repaint();</span>
<span class="nc" id="L774">          Vector beanInstances = BeanInstance.getBeanInstances();</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">          for (int i = 0; i &lt; beanInstances.size(); i++) {</span>
<span class="nc" id="L776">            JComponent bean = (JComponent) ((BeanInstance) beanInstances</span>
<span class="nc" id="L777">                .elementAt(i)).getBean();</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (bean instanceof Visible) {</span>
<span class="nc" id="L779">              ((Visible) bean).getVisual().setDisplayConnectors(false);</span>
            }
          }

<span class="nc bnc" id="L783" title="All 2 branches missed.">          if (bi != null) {</span>
<span class="nc" id="L784">            boolean doConnection = false;</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">            if (!(bi.getBean() instanceof BeanCommon)) {</span>
<span class="nc" id="L786">              doConnection = true;</span>
            } else {
              // Give the target bean a chance to veto the proposed
              // connection
<span class="nc" id="L790">              if (((BeanCommon) bi.getBean()).</span>
              // connectionAllowed(m_sourceEventSetDescriptor.getName())) {
<span class="nc bnc" id="L792" title="All 2 branches missed.">                  connectionAllowed(m_sourceEventSetDescriptor)) {</span>
<span class="nc" id="L793">                doConnection = true;</span>
              }
            }
<span class="nc bnc" id="L796" title="All 2 branches missed.">            if (doConnection) {</span>
              // attempt to connect source and target beans

<span class="nc bnc" id="L799" title="All 2 branches missed.">              if (bi.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L800">                BeanConnection.doMetaConnection(m_editElement, bi,</span>
<span class="nc" id="L801">                    m_sourceEventSetDescriptor, m_beanLayout);</span>
              } else {
<span class="nc" id="L803">                BeanConnection bc = new BeanConnection(m_editElement, bi,</span>
<span class="nc" id="L804">                    m_sourceEventSetDescriptor);</span>
              }
            }
<span class="nc" id="L807">            m_beanLayout.repaint();</span>
          }
<span class="nc" id="L809">          m_mode = NONE;</span>
<span class="nc" id="L810">          m_editElement = null;</span>
<span class="nc" id="L811">          m_sourceEventSetDescriptor = null;</span>
        }
<span class="nc" id="L813">      }</span>
    });

<span class="nc" id="L816">    m_beanLayout.addMouseMotionListener(new MouseMotionAdapter() {</span>

      @Override
      public void mouseDragged(MouseEvent me) {
<span class="nc bnc" id="L820" title="All 4 branches missed.">        if (m_editElement != null &amp;&amp; m_mode == MOVING) {</span>
<span class="nc" id="L821">          ImageIcon ic = ((Visible) m_editElement.getBean()).getVisual()</span>
<span class="nc" id="L822">              .getStaticIcon();</span>
<span class="nc" id="L823">          int width = ic.getIconWidth() / 2;</span>
<span class="nc" id="L824">          int height = ic.getIconHeight() / 2;</span>

          /*
           * m_editElement.setX(m_oldX-width);
           * m_editElement.setY(m_oldY-height);
           */

<span class="nc" id="L831">          m_editElement.setXY(m_oldX - width, m_oldY - height);</span>
<span class="nc" id="L832">          m_beanLayout.repaint();</span>

          // note the new points
<span class="nc" id="L835">          m_oldX = me.getX();</span>
<span class="nc" id="L836">          m_oldY = me.getY();</span>
        }
<span class="nc bnc" id="L838" title="All 2 branches missed.">        if (m_mode == SELECTING) {</span>
<span class="nc" id="L839">          m_beanLayout.repaint();</span>
<span class="nc" id="L840">          m_oldX = me.getX();</span>
<span class="nc" id="L841">          m_oldY = me.getY();</span>
        }
<span class="nc" id="L843">      }</span>

      @Override
      public void mouseMoved(MouseEvent e) {
<span class="nc bnc" id="L847" title="All 2 branches missed.">        if (m_mode == CONNECTING) {</span>
<span class="nc" id="L848">          m_beanLayout.repaint();</span>
          // note the new coordinates
<span class="nc" id="L850">          m_oldX = e.getX();</span>
<span class="nc" id="L851">          m_oldY = e.getY();</span>
        }
<span class="nc" id="L853">      }</span>
    });

<span class="nc" id="L856">    String date = (new SimpleDateFormat(&quot;EEEE, d MMMM yyyy&quot;))</span>
<span class="nc" id="L857">        .format(new Date());</span>
<span class="nc" id="L858">    m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L859">        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_LogMessage_Text_First&quot;));</span>
<span class="nc" id="L860">    m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L861">        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_LogMessage_Text_Second&quot;));</span>
<span class="nc" id="L862">    m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L863">        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_LogMessage_Text_Third&quot;)</span>
<span class="nc" id="L864">        + Copyright.getToYear()</span>
<span class="nc" id="L865">        + &quot; &quot;</span>
<span class="nc" id="L866">        + Copyright.getOwner()</span>
<span class="nc" id="L867">        + &quot;, &quot;</span>
<span class="nc" id="L868">        + Copyright.getAddress());</span>
<span class="nc" id="L869">    m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L870">        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_LogMessage_Text_Fourth&quot;)</span>
<span class="nc" id="L871">        + Copyright.getURL());</span>
<span class="nc" id="L872">    m_logPanel.logMessage(date);</span>
<span class="nc" id="L873">    m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L874">        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_StatusMessage_Text_First&quot;));</span>
<span class="nc" id="L875">    m_logPanel.getStatusTable().addMouseListener(new MouseAdapter() {</span>
      @Override
      public void mouseClicked(MouseEvent e) {
<span class="nc bnc" id="L878" title="All 2 branches missed.">        if (m_logPanel.getStatusTable().rowAtPoint(e.getPoint()) == 0) {</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">          if (((e.getModifiers() &amp; InputEvent.BUTTON1_MASK) != InputEvent.BUTTON1_MASK)</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">              || e.isAltDown()) {</span>
<span class="nc" id="L881">            System.gc();</span>
<span class="nc" id="L882">            Runtime currR = Runtime.getRuntime();</span>
<span class="nc" id="L883">            long freeM = currR.freeMemory();</span>
<span class="nc" id="L884">            long totalM = currR.totalMemory();</span>
<span class="nc" id="L885">            long maxM = currR.maxMemory();</span>
<span class="nc" id="L886">            m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L887">                &quot;KnowledgeFlowApp_MouseClicked_LogPanel_LogMessage_Text_Fifth&quot;)</span>
<span class="nc" id="L888">                + String.format(&quot;%,d&quot;, freeM)</span>
<span class="nc" id="L889">                + &quot; / &quot;</span>
<span class="nc" id="L890">                + String.format(&quot;%,d&quot;, totalM)</span>
<span class="nc" id="L891">                + &quot; / &quot;</span>
<span class="nc" id="L892">                + String.format(&quot;%,d&quot;, maxM));</span>
<span class="nc" id="L893">            m_logPanel</span>
<span class="nc" id="L894">                .statusMessage(Messages</span>
<span class="nc" id="L895">                    .getInstance()</span>
<span class="nc" id="L896">                    .getString(</span>
<span class="nc" id="L897">                        &quot;KnowledgeFlowApp_MouseClicked_LogPanel_StatusMessage_Text_Second&quot;)</span>
<span class="nc" id="L898">                    + String.format(&quot;%,d&quot;, freeM)</span>
<span class="nc" id="L899">                    + &quot; / &quot;</span>
<span class="nc" id="L900">                    + String.format(&quot;%,d&quot;, totalM)</span>
<span class="nc" id="L901">                    + &quot; / &quot;</span>
<span class="nc" id="L902">                    + String.format(&quot;%,d&quot;, maxM));</span>
          }
        }
<span class="nc" id="L905">      }</span>
    });

<span class="nc" id="L908">    JPanel p1 = new JPanel();</span>
<span class="nc" id="L909">    p1.setLayout(new BorderLayout());</span>
<span class="nc" id="L910">    p1.setBorder(javax.swing.BorderFactory.createCompoundBorder(</span>
        javax.swing.BorderFactory
<span class="nc" id="L912">            .createTitledBorder(Messages</span>
<span class="nc" id="L913">                .getInstance()</span>
<span class="nc" id="L914">                .getString(</span>
<span class="nc" id="L915">                    &quot;KnowledgeFlowApp_P1_JPanel_BorderFactoryCreateTitledBorder_Text&quot;)),</span>
<span class="nc" id="L916">        javax.swing.BorderFactory.createEmptyBorder(0, 5, 5, 5)));</span>
<span class="nc" id="L917">    final JScrollPane js = new JScrollPane(m_beanLayout);</span>
<span class="nc" id="L918">    p1.add(js, BorderLayout.CENTER);</span>
<span class="nc" id="L919">    js.getVerticalScrollBar().setUnitIncrement(m_ScrollBarIncrementLayout);</span>
<span class="nc" id="L920">    js.getHorizontalScrollBar().setUnitIncrement(m_ScrollBarIncrementLayout);</span>

<span class="nc" id="L922">    setLayout(new BorderLayout());</span>

<span class="nc" id="L924">    add(p1, BorderLayout.CENTER);</span>
<span class="nc" id="L925">    m_beanLayout.setSize(m_FlowWidth, m_FlowHeight);</span>
<span class="nc" id="L926">    Dimension d = m_beanLayout.getPreferredSize();</span>
<span class="nc" id="L927">    m_beanLayout.setMinimumSize(d);</span>
<span class="nc" id="L928">    m_beanLayout.setMaximumSize(d);</span>
<span class="nc" id="L929">    m_beanLayout.setPreferredSize(d);</span>

<span class="nc" id="L931">    Dimension d2 = new Dimension(100, 170);</span>
<span class="nc" id="L932">    m_logPanel.setPreferredSize(d2);</span>
<span class="nc" id="L933">    m_logPanel.setMinimumSize(d2);</span>
<span class="nc" id="L934">    add(m_logPanel, BorderLayout.SOUTH);</span>

<span class="nc" id="L936">    setUpToolBars();</span>
<span class="nc" id="L937">    loadUserComponents();</span>
<span class="nc" id="L938">  }</span>

  private Image loadImage(String path) {
<span class="nc" id="L941">    Image pic = null;</span>
    // Modified by Zerbetto
    // java.net.URL imageURL = ClassLoader.getSystemResource(path);
<span class="nc" id="L944">    java.net.URL imageURL = this.getClass().getClassLoader().getResource(path);</span>

    // end modifications
<span class="nc bnc" id="L947" title="All 2 branches missed.">    if (imageURL == null) {</span>
      // System.err.println(&quot;Warning: unable to load &quot;+path);
    } else {
<span class="nc" id="L950">      pic = Toolkit.getDefaultToolkit().getImage(imageURL);</span>
    }
<span class="nc" id="L952">    return pic;</span>
  }

  /**
   * Describe &lt;code&gt;setUpToolBars&lt;/code&gt; method here.
   */
  private void setUpToolBars() {
<span class="nc" id="L959">    JPanel toolBarPanel = new JPanel();</span>
<span class="nc" id="L960">    toolBarPanel.setLayout(new BorderLayout());</span>

    // modifications by Zerbetto
    // first construct the toolbar for saving, loading etc
<span class="nc bnc" id="L964" title="All 2 branches missed.">    if (m_showFileMenu) {</span>
<span class="nc" id="L965">      JToolBar fixedTools = new JToolBar();</span>
<span class="nc" id="L966">      fixedTools.setOrientation(JToolBar.VERTICAL);</span>
<span class="nc" id="L967">      m_saveB = new JButton(new ImageIcon(loadImage(BeanVisual.ICON_PATH</span>
          + &quot;Save24.gif&quot;)));
<span class="nc" id="L969">      m_saveB.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L970">          &quot;KnowledgeFlowApp_SaveB_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L971">      m_loadB = new JButton(new ImageIcon(loadImage(BeanVisual.ICON_PATH</span>
          + &quot;Open24.gif&quot;)));
<span class="nc" id="L973">      m_loadB.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L974">          &quot;KnowledgeFlowApp_LoadB_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L975">      m_newB = new JButton(new ImageIcon(loadImage(BeanVisual.ICON_PATH</span>
          + &quot;New24.gif&quot;)));
<span class="nc" id="L977">      m_newB.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L978">          &quot;KnowledgeFlowApp_NewB_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L979">      fixedTools.add(m_newB);</span>
<span class="nc" id="L980">      fixedTools.add(m_saveB);</span>
<span class="nc" id="L981">      fixedTools.add(m_loadB);</span>

<span class="nc" id="L983">      m_saveB.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L985">          saveLayout();</span>
<span class="nc" id="L986">        }</span>
      });

<span class="nc" id="L989">      m_loadB.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L991">          m_flowEnvironment = new Environment();</span>
<span class="nc" id="L992">          loadLayout();</span>
<span class="nc" id="L993">        }</span>
      });

<span class="nc" id="L996">      m_newB.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L998">          clearLayout();</span>
<span class="nc" id="L999">        }</span>
      });

<span class="nc" id="L1002">      fixedTools.setFloatable(false);</span>
<span class="nc" id="L1003">      toolBarPanel.add(fixedTools, BorderLayout.WEST);</span>
    }

<span class="nc" id="L1006">    m_stopB = new JButton(new ImageIcon(loadImage(BeanVisual.ICON_PATH</span>
        + &quot;Stop24.gif&quot;)));
<span class="nc" id="L1008">    m_helpB = new JButton(new ImageIcon(loadImage(BeanVisual.ICON_PATH</span>
        + &quot;Help24.gif&quot;)));
<span class="nc" id="L1010">    m_stopB.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L1011">        &quot;KnowledgeFlowApp_StopB_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L1012">    m_helpB.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L1013">        &quot;KnowledgeFlowApp_HelpB_SetToolTipText_Text&quot;));</span>

<span class="nc" id="L1015">    Image tempI = loadImage(BeanVisual.ICON_PATH + &quot;Pointer.gif&quot;);</span>
<span class="nc" id="L1016">    m_pointerB = new JToggleButton(new ImageIcon(tempI));</span>
<span class="nc" id="L1017">    m_pointerB.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1019">        m_toolBarBean = null;</span>
<span class="nc" id="L1020">        m_mode = NONE;</span>
<span class="nc" id="L1021">        setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc" id="L1022">      }</span>
    });

    // Dimension dP = m_saveB.getPreferredSize();
    // Dimension dM = m_saveB.getMaximumSize();
    // Dimension dP = m_stopB.getPreferredSize();
    // Dimension dM = m_stopB.getMaximumSize();
    // m_pointerB.setPreferredSize(dP);
    // m_pointerB.setMaximumSize(dM);
<span class="nc" id="L1031">    m_toolBarGroup.add(m_pointerB);</span>

<span class="nc" id="L1033">    JToolBar fixedTools2 = new JToolBar();</span>
<span class="nc" id="L1034">    fixedTools2.setOrientation(JToolBar.VERTICAL);</span>
<span class="nc" id="L1035">    fixedTools2.setFloatable(false);</span>
<span class="nc" id="L1036">    fixedTools2.add(m_pointerB);</span>
<span class="nc" id="L1037">    fixedTools2.add(m_helpB);</span>
<span class="nc" id="L1038">    fixedTools2.add(m_stopB);</span>
    // m_helpB.setPreferredSize(dP);
    // m_helpB.setMaximumSize(dP);
<span class="nc" id="L1041">    m_helpB.setSize(m_pointerB.getSize().width, m_pointerB.getSize().height);</span>
<span class="nc" id="L1042">    toolBarPanel.add(fixedTools2, BorderLayout.EAST);</span>
    // end modifications by Zerbetto
<span class="nc" id="L1044">    m_stopB.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1046">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1047">            &quot;KnowledgeFlowApp_StopB_LogPanel_StatusMessage_Text_First&quot;));</span>
<span class="nc" id="L1048">        stopFlow();</span>
<span class="nc" id="L1049">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1050">            &quot;KnowledgeFlowApp_StopB_LogPanel_StatusMessage_Text_Second&quot;));</span>
<span class="nc" id="L1051">      }</span>
    });

<span class="nc" id="L1054">    m_helpB.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L1056">        popupHelp();</span>
<span class="nc" id="L1057">      }</span>
    });

<span class="nc" id="L1060">    final int STANDARD_TOOLBAR = 0;</span>
<span class="nc" id="L1061">    final int WEKAWRAPPER_TOOLBAR = 1;</span>

<span class="nc" id="L1063">    int toolBarType = STANDARD_TOOLBAR;</span>

    // set up wrapper toolbars
<span class="nc bnc" id="L1066" title="All 2 branches missed.">    for (int i = 0; i &lt; TOOLBARS.size(); i++) {</span>
<span class="nc" id="L1067">      Vector tempBarSpecs = (Vector) TOOLBARS.elementAt(i);</span>

      // name for the tool bar
<span class="nc" id="L1070">      String tempBarName = (String) tempBarSpecs.elementAt(0);</span>

      // Used for weka leaf packages
<span class="nc" id="L1073">      Box singletonHolderPanel = null;</span>

      // name of the bean component to handle this class of weka algorithms
<span class="nc" id="L1076">      String tempBeanCompName = (String) tempBarSpecs.elementAt(1);</span>

      // a JPanel holding an instantiated bean + label ready to be added
      // to the current toolbar
      JPanel tempBean;

      // the root package for weka algorithms
<span class="nc" id="L1083">      String rootPackage = &quot;&quot;;</span>
<span class="nc" id="L1084">      weka.gui.HierarchyPropertyParser hpp = null;</span>
<span class="nc" id="L1085">      Hashtable hpps = null;</span>

      // Is this a wrapper toolbar?
<span class="nc bnc" id="L1088" title="All 2 branches missed.">      if (tempBeanCompName.compareTo(&quot;null&quot;) != 0) {</span>
<span class="nc" id="L1089">        tempBean = null;</span>
<span class="nc" id="L1090">        toolBarType = WEKAWRAPPER_TOOLBAR;</span>
<span class="nc" id="L1091">        rootPackage = (String) tempBarSpecs.elementAt(2);</span>
        // hpp = (weka.gui.HierarchyPropertyParser)tempBarSpecs.elementAt(3);
<span class="nc" id="L1093">        hpps = (Hashtable) tempBarSpecs.elementAt(3);</span>

        try {
          // modifications by Zerbetto
          // Beans.instantiate(null, tempBeanCompName);
<span class="nc" id="L1098">          Beans.instantiate(this.getClass().getClassLoader(), tempBeanCompName);</span>

          // end modifications by Zerbetto
<span class="nc" id="L1101">        } catch (Exception ex) {</span>
          // ignore
<span class="nc" id="L1103">          System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1104">              &quot;KnowledgeFlowApp_Error_Text&quot;)</span>
<span class="nc" id="L1105">              + tempBeanCompName);</span>

<span class="nc" id="L1107">          break;</span>
        }
      } else {
<span class="nc" id="L1110">        toolBarType = STANDARD_TOOLBAR;</span>
      }

      // a toolbar to hold buttons---one for each algorithm
<span class="nc" id="L1114">      JToolBar tempToolBar = new JToolBar();</span>

      // System.err.println(tempToolBar.getLayout());
      // tempToolBar.setLayout(new FlowLayout());
<span class="nc" id="L1118">      int z = 2;</span>

<span class="nc bnc" id="L1120" title="All 2 branches missed.">      if (toolBarType == WEKAWRAPPER_TOOLBAR) {</span>
<span class="nc" id="L1121">        Enumeration enm = hpps.keys();</span>

<span class="nc bnc" id="L1123" title="All 2 branches missed.">        while (enm.hasMoreElements()) {</span>
<span class="nc" id="L1124">          String root = (String) enm.nextElement();</span>
<span class="nc" id="L1125">          String userPrefix = &quot;&quot;;</span>
<span class="nc" id="L1126">          hpp = (HierarchyPropertyParser) hpps.get(root);</span>

<span class="nc bnc" id="L1128" title="All 2 branches missed.">          if (!hpp.goTo(rootPackage)) {</span>
<span class="nc" id="L1129">            System.out.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1130">                &quot;KnowledgeFlowApp_Text_First&quot;));</span>
            // System.exit(1);
<span class="nc" id="L1132">            userPrefix = root + &quot;.&quot;;</span>
          }

<span class="nc" id="L1135">          String[] primaryPackages = hpp.childrenValues();</span>

<span class="nc bnc" id="L1137" title="All 2 branches missed.">          for (int kk = 0; kk &lt; primaryPackages.length; kk++) {</span>
<span class="nc" id="L1138">            hpp.goToChild(primaryPackages[kk]);</span>

            // check to see if this is a leaf - if so then there are no
            // sub packages
<span class="nc bnc" id="L1142" title="All 2 branches missed.">            if (hpp.isLeafReached()) {</span>
<span class="nc bnc" id="L1143" title="All 2 branches missed.">              if (singletonHolderPanel == null) {</span>
<span class="nc" id="L1144">                singletonHolderPanel = Box.createHorizontalBox();</span>
<span class="nc" id="L1145">                singletonHolderPanel.setBorder(javax.swing.BorderFactory</span>
<span class="nc" id="L1146">                    .createTitledBorder(tempBarName));</span>
              }

<span class="nc" id="L1149">              String algName = hpp.fullValue();</span>
<span class="nc" id="L1150">              tempBean = instantiateToolBarBean(true, tempBeanCompName, algName);</span>

<span class="nc bnc" id="L1152" title="All 2 branches missed.">              if (tempBean != null) {</span>
                // tempToolBar.add(tempBean);
<span class="nc" id="L1154">                singletonHolderPanel.add(tempBean);</span>
              }

<span class="nc" id="L1157">              hpp.goToParent();</span>
            } else {
              // make a titledborder JPanel to hold all the schemes in this
              // package
              // JPanel holderPanel = new JPanel();
<span class="nc" id="L1162">              Box holderPanel = Box.createHorizontalBox();</span>
<span class="nc" id="L1163">              holderPanel.setBorder(javax.swing.BorderFactory</span>
<span class="nc" id="L1164">                  .createTitledBorder(userPrefix + primaryPackages[kk]));</span>
<span class="nc" id="L1165">              processPackage(holderPanel, tempBeanCompName, hpp);</span>
<span class="nc" id="L1166">              tempToolBar.add(holderPanel);</span>
            }
          }

<span class="nc bnc" id="L1170" title="All 2 branches missed.">          if (singletonHolderPanel != null) {</span>
<span class="nc" id="L1171">            tempToolBar.add(singletonHolderPanel);</span>
<span class="nc" id="L1172">            singletonHolderPanel = null;</span>
          }
        }
      } else {
<span class="nc" id="L1176">        Box holderPanel = Box.createHorizontalBox();</span>
<span class="nc" id="L1177">        holderPanel.setBorder(javax.swing.BorderFactory</span>
<span class="nc" id="L1178">            .createTitledBorder(tempBarName));</span>

<span class="nc bnc" id="L1180" title="All 2 branches missed.">        for (int j = z; j &lt; tempBarSpecs.size(); j++) {</span>
<span class="nc" id="L1181">          tempBean = null;</span>
<span class="nc" id="L1182">          tempBeanCompName = (String) tempBarSpecs.elementAt(j);</span>
<span class="nc" id="L1183">          tempBean = instantiateToolBarBean(</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">              (toolBarType == WEKAWRAPPER_TOOLBAR), tempBeanCompName, &quot;&quot;);</span>

<span class="nc bnc" id="L1186" title="All 2 branches missed.">          if (tempBean != null) {</span>
            // set tool tip text (if any)
            // setToolTipText(tempBean)
<span class="nc" id="L1189">            holderPanel.add(tempBean);</span>
          }
        }

<span class="nc" id="L1193">        tempToolBar.add(holderPanel);</span>
      }

<span class="nc" id="L1196">      JScrollPane tempJScrollPane = createScrollPaneForToolBar(tempToolBar);</span>
      // ok, now create tabbed pane to hold this toolbar
<span class="nc" id="L1198">      m_toolBars.addTab(tempBarName, null, tempJScrollPane, tempBarName);</span>
    }

    // Any plugin components to process?
<span class="nc bnc" id="L1202" title="All 4 branches missed.">    if (BEAN_PLUGINS_PROPERTIES != null &amp;&amp; BEAN_PLUGINS_PROPERTIES.size() &gt; 0) {</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">      for (int i = 0; i &lt; BEAN_PLUGINS_PROPERTIES.size(); i++) {</span>
<span class="nc" id="L1204">        Properties tempP = BEAN_PLUGINS_PROPERTIES.get(i);</span>
<span class="nc" id="L1205">        JPanel tempBean = null;</span>
<span class="nc" id="L1206">        String components = tempP</span>
<span class="nc" id="L1207">            .getProperty(&quot;weka.gui.beans.KnowledgeFlow.Plugins&quot;);</span>
<span class="nc" id="L1208">        StringTokenizer st2 = new StringTokenizer(components, &quot;, &quot;);</span>

<span class="nc bnc" id="L1210" title="All 2 branches missed.">        while (st2.hasMoreTokens()) {</span>
<span class="nc" id="L1211">          String tempBeanCompName = st2.nextToken().trim();</span>
<span class="nc" id="L1212">          tempBean = instantiateToolBarBean(false, tempBeanCompName, &quot;&quot;);</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">          if (m_pluginsToolBar == null) {</span>
            // need to create the plugins tab and toolbar
<span class="nc" id="L1215">            setUpPluginsToolBar();</span>
          }
<span class="nc" id="L1217">          m_pluginsBoxPanel.add(tempBean);</span>
        }
      }
    }

<span class="nc" id="L1222">    toolBarPanel.add(m_toolBars, BorderLayout.CENTER);</span>

    // add(m_toolBars, BorderLayout.NORTH);
<span class="nc" id="L1225">    add(toolBarPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L1226">  }</span>

  private void stopFlow() {
<span class="nc" id="L1229">    Vector components = BeanInstance.getBeanInstances();</span>

<span class="nc bnc" id="L1231" title="All 2 branches missed.">    for (int i = 0; i &lt; components.size(); i++) {</span>
<span class="nc" id="L1232">      Object temp = ((BeanInstance) components.elementAt(i)).getBean();</span>

<span class="nc bnc" id="L1234" title="All 2 branches missed.">      if (temp instanceof BeanCommon) {</span>
<span class="nc" id="L1235">        ((BeanCommon) temp).stop();</span>
      }
    }
<span class="nc" id="L1238">  }</span>

  private JScrollPane createScrollPaneForToolBar(JToolBar tb) {
<span class="nc" id="L1241">    JScrollPane tempJScrollPane = new JScrollPane(tb,</span>
<span class="nc" id="L1242">        JScrollPane.VERTICAL_SCROLLBAR_NEVER,</span>
<span class="nc" id="L1243">        JScrollPane.HORIZONTAL_SCROLLBAR_ALWAYS);</span>

<span class="nc" id="L1245">    Dimension d = tb.getPreferredSize();</span>
<span class="nc" id="L1246">    tempJScrollPane.setMinimumSize(new Dimension((int) d.getWidth(), (int) (d</span>
<span class="nc" id="L1247">        .getHeight() + 15)));</span>
<span class="nc" id="L1248">    tempJScrollPane.setPreferredSize(new Dimension((int) d.getWidth(), (int) (d</span>
<span class="nc" id="L1249">        .getHeight() + 15)));</span>
<span class="nc" id="L1250">    tempJScrollPane.getHorizontalScrollBar().setUnitIncrement(</span>
<span class="nc" id="L1251">        m_ScrollBarIncrementComponents);</span>

<span class="nc" id="L1253">    return tempJScrollPane;</span>
  }

  private void processPackage(JComponent holderPanel, String tempBeanCompName,
      weka.gui.HierarchyPropertyParser hpp) {
<span class="nc bnc" id="L1258" title="All 2 branches missed.">    if (hpp.isLeafReached()) {</span>
      // instantiate a bean and add it to the holderPanel
      // System.err.println(&quot;Would add &quot;+hpp.fullValue());
<span class="nc" id="L1261">      String algName = hpp.fullValue();</span>
<span class="nc" id="L1262">      JPanel tempBean = instantiateToolBarBean(true, tempBeanCompName, algName);</span>
<span class="nc bnc" id="L1263" title="All 2 branches missed.">      if (tempBean != null) {</span>
<span class="nc" id="L1264">        holderPanel.add(tempBean);</span>
      }
<span class="nc" id="L1266">      hpp.goToParent();</span>
<span class="nc" id="L1267">      return;</span>
    }
<span class="nc" id="L1269">    String[] children = hpp.childrenValues();</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">    for (int i = 0; i &lt; children.length; i++) {</span>
<span class="nc" id="L1271">      hpp.goToChild(children[i]);</span>
<span class="nc" id="L1272">      processPackage(holderPanel, tempBeanCompName, hpp);</span>
    }
<span class="nc" id="L1274">    hpp.goToParent();</span>
<span class="nc" id="L1275">  }</span>

  /**
   * Instantiates a bean for display in the toolbars
   * 
   * @param wekawrapper true if the bean to be instantiated is a wekawrapper
   * @param tempBeanCompName the name of the bean to instantiate
   * @param algName holds the name of a weka algorithm to configure the bean
   *          with if it is a wekawrapper bean
   * @return a JPanel holding the instantiated (and configured bean)
   */
  private JPanel instantiateToolBarBean(boolean wekawrapper,
      String tempBeanCompName, String algName) {
    Object tempBean;
<span class="nc bnc" id="L1289" title="All 2 branches missed.">    if (wekawrapper) {</span>
      try {
        // modifications by Zerbetto
        // tempBean = Beans.instantiate(null, tempBeanCompName);
<span class="nc" id="L1293">        tempBean = Beans.instantiate(this.getClass().getClassLoader(),</span>
<span class="nc" id="L1294">            tempBeanCompName);</span>

        // end modifications by Zerbetto
<span class="nc" id="L1297">      } catch (Exception ex) {</span>
<span class="nc" id="L1298">        System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1299">            &quot;KnowledgeFlowApp_InstantiateToolBarBean_Error_Text_First&quot;)</span>
<span class="nc" id="L1300">            + tempBeanCompName + &quot;KnowledgeFlowApp.instantiateToolBarBean()&quot;);</span>
<span class="nc" id="L1301">        return null;</span>
      }
<span class="nc bnc" id="L1303" title="All 2 branches missed.">      if (tempBean instanceof WekaWrapper) {</span>
        // algName = (String)tempBarSpecs.elementAt(j);
<span class="nc" id="L1305">        Class c = null;</span>
        try {
<span class="nc" id="L1307">          c = Class.forName(algName);</span>
<span class="nc" id="L1308">        } catch (Exception ex) {</span>
<span class="nc" id="L1309">          System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1310">              &quot;KnowledgeFlowApp_InstantiateToolBarBean_Error_Text_Third&quot;)</span>
<span class="nc" id="L1311">              + algName);</span>
<span class="nc" id="L1312">          return null;</span>
        }
        try {
<span class="nc" id="L1315">          Object o = c.newInstance();</span>
<span class="nc" id="L1316">          ((WekaWrapper) tempBean).setWrappedAlgorithm(o);</span>
<span class="nc" id="L1317">        } catch (Exception ex) {</span>
<span class="nc" id="L1318">          System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1319">              &quot;KnowledgeFlowApp_InstantiateToolBarBean_Error_Text_Fourth&quot;)</span>
<span class="nc" id="L1320">              + tempBeanCompName</span>
<span class="nc" id="L1321">              + Messages.getInstance().getString(</span>
<span class="nc" id="L1322">                  &quot;KnowledgeFlowApp_InstantiateToolBarBean_Error_Text_Fifth&quot;)</span>
<span class="nc" id="L1323">              + algName);</span>
<span class="nc" id="L1324">          return null;</span>
        }
      }
    } else {
      try {
        // modifications by Zerbetto
        // tempBean = Beans.instantiate(null, tempBeanCompName);
<span class="nc" id="L1331">        tempBean = Beans.instantiate(this.getClass().getClassLoader(),</span>
<span class="nc" id="L1332">            tempBeanCompName);</span>

        // end modifications
<span class="nc" id="L1335">      } catch (Exception ex) {</span>
<span class="nc" id="L1336">        ex.printStackTrace();</span>
<span class="nc" id="L1337">        System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1338">            &quot;KnowledgeFlowApp_InstantiateToolBarBean_Error_Text_Sixth&quot;)</span>
<span class="nc" id="L1339">            + tempBeanCompName + &quot;KnowledgeFlowApp.setUpToolBars()&quot;);</span>
<span class="nc" id="L1340">        return null;</span>
      }
    }

<span class="nc bnc" id="L1344" title="All 2 branches missed.">    if (tempBean instanceof BeanContextChild) {</span>
<span class="nc" id="L1345">      m_bcSupport.add(tempBean);</span>
    }
<span class="nc bnc" id="L1347" title="All 2 branches missed.">    if (tempBean instanceof Visible) {</span>
<span class="nc" id="L1348">      ((Visible) tempBean).getVisual().scale(3);</span>
    }

<span class="nc" id="L1351">    return makeHolderPanelForToolBarBean(tempBeanCompName, tempBean,</span>
<span class="nc" id="L1352">        wekawrapper, algName, false);</span>
  }

  /**
   * Instantiates (by making a serialized copy) the supplied template meta bean
   * for display in the user tool bar
   * 
   * @param bean the prototype MetaBean to display in the toolbar
   */
  private JPanel instantiateToolBarMetaBean(MetaBean bean) {
    // copy the bean via serialization
<span class="nc" id="L1363">    ((Visible) bean).getVisual().removePropertyChangeListener(this);</span>
<span class="nc" id="L1364">    bean.removePropertyChangeListenersSubFlow(this);</span>
<span class="nc" id="L1365">    Object copy = null;</span>
    try {
<span class="nc" id="L1367">      SerializedObject so = new SerializedObject(bean);</span>
<span class="nc" id="L1368">      copy = so.getObject();</span>
<span class="nc" id="L1369">    } catch (Exception ex) {</span>
<span class="nc" id="L1370">      ex.printStackTrace();</span>
<span class="nc" id="L1371">      return null;</span>
    }
<span class="nc" id="L1373">    ((Visible) bean).getVisual().addPropertyChangeListener(this);</span>
<span class="nc" id="L1374">    bean.addPropertyChangeListenersSubFlow(this);</span>

<span class="nc" id="L1376">    String displayName = &quot;&quot;;</span>
    //
<span class="nc bnc" id="L1378" title="All 2 branches missed.">    if (copy instanceof Visible) {</span>
<span class="nc" id="L1379">      ((Visible) copy).getVisual().scale(3);</span>
<span class="nc" id="L1380">      displayName = ((Visible) copy).getVisual().getText();</span>
    }
<span class="nc" id="L1382">    return makeHolderPanelForToolBarBean(displayName, copy, false, null, true);</span>
  }

  private JPanel makeHolderPanelForToolBarBean(final String tempName,
      Object tempBean, boolean wekawrapper, String algName,
      final boolean metabean) {
    // ---------------------------------------
    JToggleButton tempButton;
<span class="nc" id="L1390">    final JPanel tempP = new JPanel();</span>
<span class="nc" id="L1391">    JLabel tempL = new JLabel();</span>
<span class="nc" id="L1392">    tempL.setFont(new Font(null, Font.PLAIN, 9));</span>

<span class="nc bnc" id="L1394" title="All 2 branches missed.">    String labelName = (wekawrapper == true) ? algName : tempName;</span>
<span class="nc" id="L1395">    labelName = labelName.substring(labelName.lastIndexOf('.') + 1,</span>
<span class="nc" id="L1396">        labelName.length());</span>
<span class="nc" id="L1397">    tempL.setText(&quot; &quot; + labelName + &quot; &quot;);</span>
<span class="nc" id="L1398">    tempL.setHorizontalAlignment(JLabel.CENTER);</span>
<span class="nc" id="L1399">    tempP.setLayout(new BorderLayout());</span>

<span class="nc bnc" id="L1401" title="All 2 branches missed.">    if (tempBean instanceof Visible) {</span>
<span class="nc" id="L1402">      BeanVisual bv = ((Visible) tempBean).getVisual();</span>

<span class="nc" id="L1404">      tempButton = new JToggleButton(bv.getStaticIcon());</span>
<span class="nc" id="L1405">      int width = bv.getStaticIcon().getIconWidth();</span>
<span class="nc" id="L1406">      int height = bv.getStaticIcon().getIconHeight();</span>

<span class="nc" id="L1408">      JPanel labelPanel = multiLineLabelPanel(labelName, width);</span>
<span class="nc" id="L1409">      tempP.add(labelPanel, BorderLayout.SOUTH);</span>
    } else {
<span class="nc" id="L1411">      tempButton = new JToggleButton();</span>
<span class="nc" id="L1412">      tempP.add(tempL, BorderLayout.SOUTH);</span>
    }
<span class="nc" id="L1414">    tempP.add(tempButton, BorderLayout.NORTH);</span>
    // tempP.add(tempL, BorderLayout.SOUTH);

    // holderPanel.add(tempP);
    // tempToolBar.add(tempP);
<span class="nc" id="L1419">    m_toolBarGroup.add(tempButton);</span>

    // add an action listener for the button here
<span class="nc" id="L1422">    final Object tempBN = tempBean;</span>
<span class="nc" id="L1423">    final JToggleButton fButton = tempButton;</span>
    // final JToggleButton tempButton2 = tempButton;
<span class="nc" id="L1425">    tempButton.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1427">        boolean changeCursor = true;</span>
        try {
<span class="nc" id="L1429">          m_toolBarBean = null;</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">          if (metabean) {</span>
<span class="nc bnc" id="L1431" title="All 2 branches missed.">            if ((e.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L1432">              changeCursor = false;</span>
<span class="nc" id="L1433">              m_toolBarGroup.remove(fButton);</span>
<span class="nc" id="L1434">              m_userBoxPanel.remove(tempP);</span>
<span class="nc" id="L1435">              m_userBoxPanel.revalidate();</span>
<span class="nc" id="L1436">              m_userComponents.remove(tempBN);</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">              if (m_firstUserComponentOpp) {</span>
<span class="nc" id="L1438">                installWindowListenerForSavingUserBeans();</span>
<span class="nc" id="L1439">                m_firstUserComponentOpp = false;</span>
              }
<span class="nc bnc" id="L1441" title="All 2 branches missed.">              if (m_userComponents.size() == 0) {</span>
<span class="nc" id="L1442">                m_toolBars.removeTabAt(m_toolBars.getTabCount() - 1);</span>
<span class="nc" id="L1443">                m_userToolBar = null;</span>
<span class="nc" id="L1444">                notifyIsDirty();</span>
              }
            } else {
<span class="nc" id="L1447">              SerializedObject so = new SerializedObject(tempBN);</span>
<span class="nc" id="L1448">              MetaBean copy = (MetaBean) so.getObject();</span>
              /*
               * ((Visible)copy).getVisual().
               * addPropertyChangeListener(KnowledgeFlowApp.this);
               */
<span class="nc" id="L1453">              copy.addPropertyChangeListenersSubFlow(KnowledgeFlowApp.this);</span>
<span class="nc" id="L1454">              m_toolBarBean = copy;</span>
            }
          } else {
            // modifications by Zerbetto
            // m_toolBarBean = Beans.instantiate(null, tempName);
<span class="nc" id="L1459">            m_toolBarBean = Beans.instantiate(this.getClass().getClassLoader(),</span>
<span class="nc" id="L1460">                tempName);</span>

            // end modifications
          }
<span class="nc bnc" id="L1464" title="All 2 branches missed.">          if (m_toolBarBean instanceof WekaWrapper) {</span>
<span class="nc" id="L1465">            Object wrappedAlg = ((WekaWrapper) tempBN).getWrappedAlgorithm();</span>

<span class="nc" id="L1467">            ((WekaWrapper) m_toolBarBean).setWrappedAlgorithm(wrappedAlg</span>
<span class="nc" id="L1468">                .getClass().newInstance());</span>
            // tempButton2.setSelected(false);
          }
<span class="nc bnc" id="L1471" title="All 2 branches missed.">          if (changeCursor) {</span>
<span class="nc" id="L1472">            setCursor(Cursor.getPredefinedCursor(Cursor.CROSSHAIR_CURSOR));</span>
<span class="nc" id="L1473">            m_mode = ADDING;</span>
          }
<span class="nc" id="L1475">        } catch (Exception ex) {</span>
<span class="nc" id="L1476">          System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1477">              &quot;KnowledgeFlowApp_MakeHolderPanelForToolBarBean_Error_Text&quot;));</span>
<span class="nc" id="L1478">          ex.printStackTrace();</span>
        }
<span class="nc" id="L1480">        notifyIsDirty();</span>
<span class="nc" id="L1481">      }</span>
    });

<span class="nc bnc" id="L1484" title="All 2 branches missed.">    if (tempBean instanceof MetaBean) {</span>
<span class="nc" id="L1485">      tempButton</span>
<span class="nc" id="L1486">          .setToolTipText(Messages</span>
<span class="nc" id="L1487">              .getInstance()</span>
<span class="nc" id="L1488">              .getString(</span>
<span class="nc" id="L1489">                  &quot;KnowledgeFlowApp_MakeHolderPanelForToolBarBean_TempButton_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L1490">      m_userComponents.add(tempBean);</span>
    } else {
      // set tool tip text from global info if supplied
<span class="nc" id="L1493">      String summary = getGlobalInfo(tempBean);</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">      if (summary != null) {</span>
<span class="nc" id="L1495">        int ci = summary.indexOf('.');</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">        if (ci != -1) {</span>
<span class="nc" id="L1497">          summary = summary.substring(0, ci + 1);</span>
        }
<span class="nc" id="L1499">        tempButton.setToolTipText(summary);</span>
      }
    }

    // return tempBean;
<span class="nc" id="L1504">    return tempP;</span>
  }

  private JPanel multiLineLabelPanel(String sourceL, int splitWidth) {
<span class="nc" id="L1508">    JPanel jp = new JPanel();</span>
<span class="nc" id="L1509">    Vector v = new Vector();</span>

<span class="nc" id="L1511">    int labelWidth = m_fontM.stringWidth(sourceL);</span>

<span class="nc bnc" id="L1513" title="All 2 branches missed.">    if (labelWidth &lt; splitWidth) {</span>
<span class="nc" id="L1514">      v.addElement(sourceL);</span>
    } else {
      // find mid point
<span class="nc" id="L1517">      int mid = sourceL.length() / 2;</span>

      // look for split point closest to the mid
<span class="nc" id="L1520">      int closest = sourceL.length();</span>
<span class="nc" id="L1521">      int closestI = -1;</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">      for (int i = 0; i &lt; sourceL.length(); i++) {</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">        if (sourceL.charAt(i) &lt; 'a') {</span>
<span class="nc bnc" id="L1524" title="All 2 branches missed.">          if (Math.abs(mid - i) &lt; closest) {</span>
<span class="nc" id="L1525">            closest = Math.abs(mid - i);</span>
<span class="nc" id="L1526">            closestI = i;</span>
          }
        }
      }
<span class="nc bnc" id="L1530" title="All 2 branches missed.">      if (closestI != -1) {</span>
<span class="nc" id="L1531">        String left = sourceL.substring(0, closestI);</span>
<span class="nc" id="L1532">        String right = sourceL.substring(closestI, sourceL.length());</span>
<span class="nc bnc" id="L1533" title="All 4 branches missed.">        if (left.length() &gt; 1 &amp;&amp; right.length() &gt; 1) {</span>
<span class="nc" id="L1534">          v.addElement(left);</span>
<span class="nc" id="L1535">          v.addElement(right);</span>
        } else {
<span class="nc" id="L1537">          v.addElement(sourceL);</span>
        }
      } else {
<span class="nc" id="L1540">        v.addElement(sourceL);</span>
      }
    }

<span class="nc" id="L1544">    jp.setLayout(new GridLayout(v.size(), 1));</span>
<span class="nc bnc" id="L1545" title="All 2 branches missed.">    for (int i = 0; i &lt; v.size(); i++) {</span>
<span class="nc" id="L1546">      JLabel temp = new JLabel();</span>
<span class="nc" id="L1547">      temp.setFont(new Font(null, Font.PLAIN, 9));</span>
<span class="nc" id="L1548">      temp.setText(&quot; &quot; + ((String) v.elementAt(i)) + &quot; &quot;);</span>
<span class="nc" id="L1549">      temp.setHorizontalAlignment(JLabel.CENTER);</span>
<span class="nc" id="L1550">      jp.add(temp);</span>
    }
<span class="nc" id="L1552">    return jp;</span>
  }

  private void setUpUserToolBar() {
<span class="nc" id="L1556">    m_userBoxPanel = Box.createHorizontalBox();</span>
<span class="nc" id="L1557">    m_userBoxPanel</span>
<span class="nc" id="L1558">        .setBorder(javax.swing.BorderFactory</span>
<span class="nc" id="L1559">            .createTitledBorder(Messages</span>
<span class="nc" id="L1560">                .getInstance()</span>
<span class="nc" id="L1561">                .getString(</span>
<span class="nc" id="L1562">                    &quot;KnowledgeFlowApp_SetUpUserToolBar_SetBorder_BorderFactory_CreateTitledBorder_Text&quot;)));</span>
<span class="nc" id="L1563">    m_userToolBar = new JToolBar();</span>
<span class="nc" id="L1564">    m_userToolBar.add(m_userBoxPanel);</span>
<span class="nc" id="L1565">    JScrollPane tempJScrollPane = createScrollPaneForToolBar(m_userToolBar);</span>
    // ok, now create tabbed pane to hold this toolbar

<span class="nc" id="L1568">    m_toolBars.addTab(</span>
<span class="nc" id="L1569">        Messages.getInstance().getString(</span>
<span class="nc" id="L1570">            &quot;KnowledgeFlowApp_SetUpUserToolBar_AddTab_Text_First&quot;),</span>
<span class="nc" id="L1571">        null,</span>
<span class="nc" id="L1572">        tempJScrollPane,</span>
<span class="nc" id="L1573">        Messages.getInstance().getString(</span>
<span class="nc" id="L1574">            &quot;KnowledgeFlowApp_SetUpUserToolBar_AddTab_Text_Second&quot;));</span>
<span class="nc" id="L1575">  }</span>

  private void setUpPluginsToolBar() {
<span class="nc" id="L1578">    m_pluginsBoxPanel = Box.createHorizontalBox();</span>
<span class="nc" id="L1579">    m_pluginsBoxPanel</span>
<span class="nc" id="L1580">        .setBorder(javax.swing.BorderFactory</span>
<span class="nc" id="L1581">            .createTitledBorder(Messages</span>
<span class="nc" id="L1582">                .getInstance()</span>
<span class="nc" id="L1583">                .getString(</span>
<span class="nc" id="L1584">                    &quot;KnowledgeFlowApp_SetUpPluginsToolBar_PluginsBoxPanel_SetBorder_BorderFactory_CreateTitledBorder_Text&quot;)));</span>
<span class="nc" id="L1585">    m_pluginsToolBar = new JToolBar();</span>
<span class="nc" id="L1586">    m_pluginsToolBar.add(m_pluginsBoxPanel);</span>
<span class="nc" id="L1587">    JScrollPane tempJScrollPane = createScrollPaneForToolBar(m_pluginsToolBar);</span>
    // ok, now create tabbed pane to hold this toolbar

<span class="nc" id="L1590">    m_toolBars.addTab(</span>
<span class="nc" id="L1591">        Messages.getInstance().getString(</span>
<span class="nc" id="L1592">            &quot;KnowledgeFlowApp_SetUpUserToolBar_AddTab_Text_Third&quot;),</span>
<span class="nc" id="L1593">        null,</span>
<span class="nc" id="L1594">        tempJScrollPane,</span>
<span class="nc" id="L1595">        Messages.getInstance().getString(</span>
<span class="nc" id="L1596">            &quot;KnowledgeFlowApp_SetUpUserToolBar_AddTab_Text_Fourth&quot;));</span>
<span class="nc" id="L1597">  }</span>

  /**
   * Pop up a help window
   */
  private void popupHelp() {
<span class="nc" id="L1603">    final JButton tempB = m_helpB;</span>
    try {
<span class="nc" id="L1605">      tempB.setEnabled(false);</span>
      // Modified by Zerbetto
      // InputStream inR =
      // ClassLoader.
      // getSystemResourceAsStream(&quot;weka/gui/beans/README_KnowledgeFlow&quot;);
<span class="nc" id="L1610">      InputStream inR = this.getClass().getClassLoader()</span>
<span class="nc" id="L1611">          .getResourceAsStream(&quot;weka/gui/beans/README_KnowledgeFlow&quot;);</span>

      // end modifications
<span class="nc" id="L1614">      StringBuffer helpHolder = new StringBuffer();</span>
<span class="nc" id="L1615">      LineNumberReader lnr = new LineNumberReader(new InputStreamReader(inR));</span>

      String line;

<span class="nc bnc" id="L1619" title="All 2 branches missed.">      while ((line = lnr.readLine()) != null) {</span>
<span class="nc" id="L1620">        helpHolder.append(line + &quot;\n&quot;);</span>
      }

<span class="nc" id="L1623">      lnr.close();</span>
<span class="nc" id="L1624">      final javax.swing.JFrame jf = new javax.swing.JFrame();</span>
<span class="nc" id="L1625">      jf.getContentPane().setLayout(new java.awt.BorderLayout());</span>
<span class="nc" id="L1626">      final JTextArea ta = new JTextArea(helpHolder.toString());</span>
<span class="nc" id="L1627">      ta.setFont(new Font(&quot;Monospaced&quot;, Font.PLAIN, 12));</span>
<span class="nc" id="L1628">      ta.setEditable(false);</span>
<span class="nc" id="L1629">      final JScrollPane sp = new JScrollPane(ta);</span>
<span class="nc" id="L1630">      jf.getContentPane().add(sp, java.awt.BorderLayout.CENTER);</span>
<span class="nc" id="L1631">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L1634">          tempB.setEnabled(true);</span>
<span class="nc" id="L1635">          jf.dispose();</span>
<span class="nc" id="L1636">        }</span>
      });
<span class="nc" id="L1638">      jf.setSize(600, 600);</span>
<span class="nc" id="L1639">      jf.setVisible(true);</span>

<span class="nc" id="L1641">    } catch (Exception ex) {</span>
<span class="nc" id="L1642">      tempB.setEnabled(true);</span>
    }
<span class="nc" id="L1644">  }</span>

  public void clearLayout() {
<span class="nc" id="L1647">    stopFlow(); // try and stop any running components</span>
<span class="nc" id="L1648">    BeanInstance.reset(m_beanLayout);</span>
<span class="nc" id="L1649">    BeanConnection.reset();</span>
<span class="nc" id="L1650">    m_beanLayout.revalidate();</span>
<span class="nc" id="L1651">    m_beanLayout.repaint();</span>
<span class="nc" id="L1652">    m_logPanel.clearStatus();</span>
<span class="nc" id="L1653">    m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1654">        &quot;KnowledgeFlowApp_ClearLayout_StatusMessage_Text&quot;));</span>
<span class="nc" id="L1655">  }</span>

  /**
   * Popup a context sensitive menu for the bean component
   * 
   * @param pt holds the panel coordinates for the component
   * @param bi the bean component over which the user right clicked the mouse
   * @param x the x coordinate at which to popup the menu
   * @param y the y coordinate at which to popup the menu
   * 
   *          Modified by Zerbetto: javax.swing.JPopupMenu transformed into
   *          java.awt.PopupMenu
   * 
   */
  private void doPopup(Point pt, final BeanInstance bi, int x, int y) {
<span class="nc" id="L1670">    final JComponent bc = (JComponent) bi.getBean();</span>
<span class="nc" id="L1671">    final int xx = x;</span>
<span class="nc" id="L1672">    final int yy = y;</span>
<span class="nc" id="L1673">    int menuItemCount = 0;</span>

    // modifications by Zerbetto
<span class="nc" id="L1676">    PopupMenu beanContextMenu = new PopupMenu();</span>

    // JPopupMenu beanContextMenu = new JPopupMenu();

    // beanContextMenu.insert(new JLabel(&quot;Edit&quot;,
    // SwingConstants.CENTER),
    // menuItemCount);
<span class="nc" id="L1683">    MenuItem edit = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1684">        &quot;KnowledgeFlowApp_DoPopup_Edit_MenuItem_Text&quot;));</span>
<span class="nc" id="L1685">    edit.setEnabled(false);</span>
<span class="nc" id="L1686">    beanContextMenu.insert(edit, menuItemCount);</span>
<span class="nc" id="L1687">    menuItemCount++;</span>

<span class="nc bnc" id="L1689" title="All 2 branches missed.">    if (bc instanceof MetaBean) {</span>
      // JMenuItem ungroupItem = new JMenuItem(&quot;Ungroup&quot;);
<span class="nc" id="L1691">      MenuItem ungroupItem = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1692">          &quot;KnowledgeFlowApp_DoPopup_UngroupItem_MenuItem_Text&quot;));</span>
<span class="nc" id="L1693">      ungroupItem.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
          // ungroup
<span class="nc" id="L1696">          bi.removeBean(m_beanLayout);</span>

<span class="nc" id="L1698">          Vector group = ((MetaBean) bc).getBeansInSubFlow();</span>
<span class="nc" id="L1699">          Vector associatedConnections = ((MetaBean) bc)</span>
<span class="nc" id="L1700">              .getAssociatedConnections();</span>
<span class="nc" id="L1701">          ((MetaBean) bc).restoreBeans();</span>

<span class="nc bnc" id="L1703" title="All 2 branches missed.">          for (int i = 0; i &lt; group.size(); i++) {</span>
<span class="nc" id="L1704">            BeanInstance tbi = (BeanInstance) group.elementAt(i);</span>
<span class="nc" id="L1705">            addComponent(tbi, false);</span>
<span class="nc" id="L1706">            tbi.addBean(m_beanLayout);</span>
          }

<span class="nc bnc" id="L1709" title="All 2 branches missed.">          for (int i = 0; i &lt; associatedConnections.size(); i++) {</span>
<span class="nc" id="L1710">            BeanConnection tbc = (BeanConnection) associatedConnections</span>
<span class="nc" id="L1711">                .elementAt(i);</span>
<span class="nc" id="L1712">            tbc.setHidden(false);</span>
          }

<span class="nc" id="L1715">          m_beanLayout.repaint();</span>
<span class="nc" id="L1716">          notifyIsDirty();</span>
<span class="nc" id="L1717">        }</span>
      });
<span class="nc" id="L1719">      beanContextMenu.add(ungroupItem);</span>
<span class="nc" id="L1720">      menuItemCount++;</span>

      // Add to user tab
      // JMenuItem addToUserTabItem = new JMenuItem(&quot;Add to user tab&quot;);
<span class="nc" id="L1724">      MenuItem addToUserTabItem = new MenuItem(Messages.getInstance()</span>
<span class="nc" id="L1725">          .getString(&quot;KnowledgeFlowApp_DoPopup_AddToUserTabItem_MenuItem_Text&quot;));</span>
<span class="nc" id="L1726">      addToUserTabItem.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1728">          addToUserToolBar((MetaBean) bi.getBean(), true);</span>
<span class="nc" id="L1729">          notifyIsDirty();</span>
<span class="nc" id="L1730">        }</span>
      });
<span class="nc" id="L1732">      beanContextMenu.add(addToUserTabItem);</span>
<span class="nc" id="L1733">      menuItemCount++;</span>
    }

    // JMenuItem deleteItem = new JMenuItem(&quot;Delete&quot;);
<span class="nc" id="L1737">    MenuItem deleteItem = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1738">        &quot;KnowledgeFlowApp_DoPopup_DeleteItem_MenuItem_Text&quot;));</span>
<span class="nc" id="L1739">    deleteItem.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1741">        BeanConnection.removeConnections(bi);</span>
<span class="nc" id="L1742">        bi.removeBean(m_beanLayout);</span>
<span class="nc bnc" id="L1743" title="All 2 branches missed.">        if (bc instanceof BeanCommon) {</span>
<span class="nc" id="L1744">          String key = ((BeanCommon) bc).getCustomName() + &quot;$&quot; + bc.hashCode();</span>
<span class="nc" id="L1745">          m_logPanel.statusMessage(key + &quot;|remove&quot;);</span>
        }
<span class="nc" id="L1747">        revalidate();</span>
<span class="nc" id="L1748">        notifyIsDirty();</span>
<span class="nc" id="L1749">      }</span>
    });
<span class="nc bnc" id="L1751" title="All 2 branches missed.">    if (bc instanceof BeanCommon) {</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">      if (((BeanCommon) bc).isBusy()) {</span>
<span class="nc" id="L1753">        deleteItem.setEnabled(false);</span>
      }
    }
<span class="nc" id="L1756">    beanContextMenu.add(deleteItem);</span>
<span class="nc" id="L1757">    menuItemCount++;</span>

<span class="nc bnc" id="L1759" title="All 2 branches missed.">    if (bc instanceof BeanCommon) {</span>
<span class="nc" id="L1760">      MenuItem nameItem = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1761">          &quot;KnowledgeFlowApp_DoPopup_NameItem_MenuItem_Text&quot;));</span>
<span class="nc" id="L1762">      nameItem.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1764">          String oldName = ((BeanCommon) bc).getCustomName();</span>
<span class="nc" id="L1765">          String name = JOptionPane</span>
<span class="nc" id="L1766">              .showInputDialog(</span>
<span class="nc" id="L1767">                  KnowledgeFlowApp.this,</span>
                  Messages
<span class="nc" id="L1769">                      .getInstance()</span>
<span class="nc" id="L1770">                      .getString(</span>
<span class="nc" id="L1771">                          &quot;KnowledgeFlowApp_DoPopup_Name_JOptionPane_ShowInputDialog_Text&quot;),</span>
<span class="nc" id="L1772">                  oldName);</span>
<span class="nc bnc" id="L1773" title="All 2 branches missed.">          if (name != null) {</span>
<span class="nc" id="L1774">            ((BeanCommon) bc).setCustomName(name);</span>
          }
<span class="nc" id="L1776">        }</span>
      });
<span class="nc bnc" id="L1778" title="All 2 branches missed.">      if (bc instanceof BeanCommon) {</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">        if (((BeanCommon) bc).isBusy()) {</span>
<span class="nc" id="L1780">          nameItem.setEnabled(false);</span>
        }
      }
<span class="nc" id="L1783">      beanContextMenu.add(nameItem);</span>
<span class="nc" id="L1784">      menuItemCount++;</span>
    }

    try {
      // BeanInfo [] compInfo = null;
      // JComponent [] associatedBeans = null;
<span class="nc" id="L1790">      Vector compInfo = new Vector(1);</span>
<span class="nc" id="L1791">      Vector associatedBeans = null;</span>
<span class="nc" id="L1792">      Vector outputBeans = null;</span>
<span class="nc" id="L1793">      Vector compInfoOutputs = null;</span>

<span class="nc bnc" id="L1795" title="All 2 branches missed.">      if (bc instanceof MetaBean) {</span>
<span class="nc" id="L1796">        compInfo = ((MetaBean) bc).getBeanInfoSubFlow();</span>
<span class="nc" id="L1797">        associatedBeans = ((MetaBean) bc).getBeansInSubFlow();</span>

<span class="nc" id="L1799">        outputBeans = ((MetaBean) bc).getBeansInOutputs();</span>
<span class="nc" id="L1800">        compInfoOutputs = ((MetaBean) bc).getBeanInfoOutputs();</span>
      } else {
<span class="nc" id="L1802">        compInfo.add(Introspector.getBeanInfo(bc.getClass()));</span>
<span class="nc" id="L1803">        compInfoOutputs = compInfo;</span>
      }

<span class="nc" id="L1806">      final Vector tempAssociatedBeans = associatedBeans;</span>

<span class="nc bnc" id="L1808" title="All 2 branches missed.">      if (compInfo == null) {</span>
<span class="nc" id="L1809">        System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1810">            &quot;KnowledgeFlowApp_DoPopup_Error_Text_First&quot;));</span>
      } else {
        // System.err.println(&quot;Got bean info&quot;);
<span class="nc bnc" id="L1813" title="All 2 branches missed.">        for (int zz = 0; zz &lt; compInfo.size(); zz++) {</span>
<span class="nc" id="L1814">          final int tt = zz;</span>
<span class="nc" id="L1815">          final Class custClass = ((BeanInfo) compInfo.elementAt(zz))</span>
<span class="nc" id="L1816">              .getBeanDescriptor().getCustomizerClass();</span>

<span class="nc bnc" id="L1818" title="All 2 branches missed.">          if (custClass != null) {</span>
            // System.err.println(&quot;Got customizer class&quot;);
            // popupCustomizer(custClass, bc);
            // JMenuItem custItem = null;
<span class="nc" id="L1822">            MenuItem custItem = null;</span>
<span class="nc" id="L1823">            boolean customizationEnabled = true;</span>

<span class="nc bnc" id="L1825" title="All 2 branches missed.">            if (!(bc instanceof MetaBean)) {</span>
              // custItem = new JMenuItem(&quot;Configure...&quot;);
<span class="nc" id="L1827">              custItem = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1828">                  &quot;KnowledgeFlowApp_DoPopup_CustItem_MenuItem_Text_First&quot;));</span>
<span class="nc bnc" id="L1829" title="All 2 branches missed.">              if (bc instanceof BeanCommon) {</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">                customizationEnabled = !((BeanCommon) bc).isBusy();</span>
              }
            } else {
<span class="nc" id="L1833">              String custName = custClass.getName();</span>
<span class="nc" id="L1834">              BeanInstance tbi = (BeanInstance) associatedBeans.elementAt(zz);</span>
<span class="nc bnc" id="L1835" title="All 2 branches missed.">              if (tbi.getBean() instanceof BeanCommon) {</span>
<span class="nc" id="L1836">                custName = ((BeanCommon) tbi.getBean()).getCustomName();</span>
              } else {
<span class="nc bnc" id="L1838" title="All 2 branches missed.">                if (tbi.getBean() instanceof WekaWrapper) {</span>
<span class="nc" id="L1839">                  custName = ((WekaWrapper) tbi.getBean())</span>
<span class="nc" id="L1840">                      .getWrappedAlgorithm().getClass().getName();</span>
                } else {
<span class="nc" id="L1842">                  custName = custName.substring(0,</span>
<span class="nc" id="L1843">                      custName.indexOf(&quot;Customizer&quot;));</span>
                }

<span class="nc" id="L1846">                custName = custName.substring(custName.lastIndexOf('.') + 1,</span>
<span class="nc" id="L1847">                    custName.length());</span>
              }
              // custItem = new JMenuItem(&quot;Configure: &quot;+ custName);
<span class="nc" id="L1850">              custItem = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1851">                  &quot;KnowledgeFlowApp_DoPopup_CustItem_MenuItem_Text_Second&quot;)</span>
<span class="nc" id="L1852">                  + custName);</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">              if (tbi.getBean() instanceof BeanCommon) {</span>
<span class="nc bnc" id="L1854" title="All 2 branches missed.">                customizationEnabled = !((BeanCommon) tbi.getBean()).isBusy();</span>
              }
            }

<span class="nc" id="L1858">            custItem.addActionListener(new ActionListener() {</span>
              public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L1860" title="All 2 branches missed.">                if (bc instanceof MetaBean) {</span>
<span class="nc" id="L1861">                  popupCustomizer(custClass,</span>
<span class="nc" id="L1862">                      (JComponent) ((BeanInstance) tempAssociatedBeans</span>
<span class="nc" id="L1863">                          .elementAt(tt)).getBean());</span>
                } else {
<span class="nc" id="L1865">                  popupCustomizer(custClass, bc);</span>
                }

<span class="nc" id="L1868">                notifyIsDirty();</span>
<span class="nc" id="L1869">              }</span>
            });
<span class="nc" id="L1871">            custItem.setEnabled(customizationEnabled);</span>
<span class="nc" id="L1872">            beanContextMenu.add(custItem);</span>
<span class="nc" id="L1873">            menuItemCount++;</span>
          } else {
<span class="nc" id="L1875">            System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L1876">                &quot;KnowledgeFlowApp_DoPopup_Error_Text_Second&quot;));</span>
          }
        }

<span class="nc" id="L1880">        Vector esdV = new Vector();</span>

        // for (int i = 0; i &lt; compInfoOutputs.size(); i++) {
<span class="nc bnc" id="L1883" title="All 2 branches missed.">        for (int i = 0; i &lt; compInfo.size(); i++) {</span>
<span class="nc" id="L1884">          EventSetDescriptor[] temp =</span>
          // ((BeanInfo) compInfoOutputs.elementAt(i)).getEventSetDescriptors();
<span class="nc" id="L1886">          ((BeanInfo) compInfo.elementAt(i)).getEventSetDescriptors();</span>

<span class="nc bnc" id="L1888" title="All 4 branches missed.">          if ((temp != null) &amp;&amp; (temp.length &gt; 0)) {</span>
<span class="nc" id="L1889">            esdV.add(temp);</span>
          }
        }

        // EventSetDescriptor [] esds = compInfo.getEventSetDescriptors();
        // if (esds != null &amp;&amp; esds.length &gt; 0) {
<span class="nc bnc" id="L1895" title="All 2 branches missed.">        if (esdV.size() &gt; 0) {</span>
          // beanContextMenu.insert(new JLabel(&quot;Connections&quot;,
          // SwingConstants.CENTER),
          // menuItemCount);
<span class="nc" id="L1899">          MenuItem connections = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1900">              &quot;KnowledgeFlowApp_DoPopup_Connection_MenuItem_Text&quot;));</span>
<span class="nc" id="L1901">          connections.setEnabled(false);</span>
<span class="nc" id="L1902">          beanContextMenu.insert(connections, menuItemCount);</span>
<span class="nc" id="L1903">          menuItemCount++;</span>
        }

        // final Vector finalOutputs = outputBeans;
<span class="nc" id="L1907">        final Vector finalOutputs = associatedBeans;</span>

<span class="nc bnc" id="L1909" title="All 2 branches missed.">        for (int j = 0; j &lt; esdV.size(); j++) {</span>
<span class="nc" id="L1910">          final int fj = j;</span>
<span class="nc" id="L1911">          String sourceBeanName = &quot;&quot;;</span>

<span class="nc bnc" id="L1913" title="All 2 branches missed.">          if (bc instanceof MetaBean) {</span>
            // Object sourceBean = ((BeanInstance)
            // outputBeans.elementAt(j)).getBean();
<span class="nc" id="L1916">            Object sourceBean = ((BeanInstance) associatedBeans.elementAt(j))</span>
<span class="nc" id="L1917">                .getBean();</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">            if (sourceBean instanceof BeanCommon) {</span>
<span class="nc" id="L1919">              sourceBeanName = ((BeanCommon) sourceBean).getCustomName();</span>
            } else {
<span class="nc bnc" id="L1921" title="All 2 branches missed.">              if (sourceBean instanceof WekaWrapper) {</span>
<span class="nc" id="L1922">                sourceBeanName = ((WekaWrapper) sourceBean)</span>
<span class="nc" id="L1923">                    .getWrappedAlgorithm().getClass().getName();</span>
              } else {
<span class="nc" id="L1925">                sourceBeanName = sourceBean.getClass().getName();</span>
              }

<span class="nc" id="L1928">              sourceBeanName = sourceBeanName.substring(</span>
<span class="nc" id="L1929">                  sourceBeanName.lastIndexOf('.') + 1, sourceBeanName.length());</span>
            }
<span class="nc" id="L1931">            sourceBeanName += &quot;: &quot;;</span>
          }

<span class="nc" id="L1934">          EventSetDescriptor[] esds = (EventSetDescriptor[]) esdV.elementAt(j);</span>

<span class="nc bnc" id="L1936" title="All 2 branches missed.">          for (int i = 0; i &lt; esds.length; i++) {</span>
            // System.err.println(esds[i].getName());
            // add each event name to the menu
            // JMenuItem evntItem = new JMenuItem(sourceBeanName
            // +esds[i].getName());
<span class="nc" id="L1941">            MenuItem evntItem = new MenuItem(sourceBeanName + esds[i].getName());</span>
<span class="nc" id="L1942">            final EventSetDescriptor esd = esds[i];</span>

            // Check EventConstraints (if any) here
<span class="nc" id="L1945">            boolean ok = true;</span>

<span class="nc bnc" id="L1947" title="All 2 branches missed.">            if (bc instanceof EventConstraints) {</span>
<span class="nc" id="L1948">              ok = ((EventConstraints) bc).eventGeneratable(esd.getName());</span>
            }

<span class="nc bnc" id="L1951" title="All 2 branches missed.">            if (ok) {</span>
<span class="nc" id="L1952">              evntItem.addActionListener(new ActionListener() {</span>
                public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1954">                  connectComponents(</span>
<span class="nc" id="L1955">                      esd,</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">                      (bc instanceof MetaBean) ? ((BeanInstance) finalOutputs</span>
<span class="nc" id="L1957">                          .elementAt(fj)) : bi, xx, yy);</span>
<span class="nc" id="L1958">                  notifyIsDirty();</span>
<span class="nc" id="L1959">                }</span>
              });
            } else {
<span class="nc" id="L1962">              evntItem.setEnabled(false);</span>
            }

<span class="nc" id="L1965">            beanContextMenu.add(evntItem);</span>
<span class="nc" id="L1966">            menuItemCount++;</span>
          }
        }
      }
<span class="nc" id="L1970">    } catch (IntrospectionException ie) {</span>
<span class="nc" id="L1971">      ie.printStackTrace();</span>
    }

    // System.err.println(&quot;Just before look for other options&quot;);
    // now look for other options for this bean
<span class="nc bnc" id="L1976" title="All 4 branches missed.">    if (bc instanceof UserRequestAcceptor || bc instanceof Startable) {</span>
<span class="nc" id="L1977">      Enumeration req = null;</span>

<span class="nc bnc" id="L1979" title="All 2 branches missed.">      if (bc instanceof UserRequestAcceptor) {</span>
<span class="nc" id="L1980">        req = ((UserRequestAcceptor) bc).enumerateRequests();</span>
      }

<span class="nc bnc" id="L1983" title="All 6 branches missed.">      if ((bc instanceof Startable) || (req != null &amp;&amp; req.hasMoreElements())) {</span>
        // beanContextMenu.insert(new JLabel(&quot;Actions&quot;,
        // SwingConstants.CENTER),
        // menuItemCount);
<span class="nc" id="L1987">        MenuItem actions = new MenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1988">            &quot;KnowledgeFlowApp_DoPopup_Actions_Text&quot;));</span>
<span class="nc" id="L1989">        actions.setEnabled(false);</span>
<span class="nc" id="L1990">        beanContextMenu.insert(actions, menuItemCount);</span>
<span class="nc" id="L1991">        menuItemCount++;</span>
      }

<span class="nc bnc" id="L1994" title="All 2 branches missed.">      if (bc instanceof Startable) {</span>
<span class="nc" id="L1995">        String tempS = ((Startable) bc).getStartMessage();</span>
<span class="nc" id="L1996">        insertUserOrStartableMenuItem(bc, true, tempS, beanContextMenu);</span>
      }

<span class="nc bnc" id="L1999" title="All 4 branches missed.">      while (req != null &amp;&amp; req.hasMoreElements()) {</span>
<span class="nc" id="L2000">        String tempS = (String) req.nextElement();</span>
<span class="nc" id="L2001">        insertUserOrStartableMenuItem(bc, false, tempS, beanContextMenu);</span>
<span class="nc" id="L2002">        menuItemCount++;</span>
      }
    }

    // System.err.println(&quot;Just before showing menu&quot;);
    // popup the menu
<span class="nc bnc" id="L2008" title="All 2 branches missed.">    if (menuItemCount &gt; 0) {</span>
      // beanContextMenu.show(m_beanLayout, x, y);
<span class="nc" id="L2010">      m_beanLayout.add(beanContextMenu);</span>
<span class="nc" id="L2011">      beanContextMenu.show(m_beanLayout, x, y);</span>
    }
<span class="nc" id="L2013">  }</span>

  private void insertUserOrStartableMenuItem(final JComponent bc,
      final boolean startable, String tempS, PopupMenu beanContextMenu) {

<span class="nc" id="L2018">    boolean disabled = false;</span>
<span class="nc" id="L2019">    boolean confirmRequest = false;</span>

    // check to see if this item is currently disabled
<span class="nc bnc" id="L2022" title="All 2 branches missed.">    if (tempS.charAt(0) == '$') {</span>
<span class="nc" id="L2023">      tempS = tempS.substring(1, tempS.length());</span>
<span class="nc" id="L2024">      disabled = true;</span>
    }

    // check to see if this item requires confirmation
<span class="nc bnc" id="L2028" title="All 2 branches missed.">    if (tempS.charAt(0) == '?') {</span>
<span class="nc" id="L2029">      tempS = tempS.substring(1, tempS.length());</span>
<span class="nc" id="L2030">      confirmRequest = true;</span>
    }

<span class="nc" id="L2033">    final String tempS2 = tempS;</span>

    // JMenuItem custItem = new JMenuItem(tempS2);
<span class="nc" id="L2036">    MenuItem custItem = new MenuItem(tempS2);</span>
<span class="nc bnc" id="L2037" title="All 2 branches missed.">    if (confirmRequest) {</span>
<span class="nc" id="L2038">      custItem.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
          //
<span class="nc" id="L2041">          int result = JOptionPane</span>
<span class="nc" id="L2042">              .showConfirmDialog(</span>
<span class="nc" id="L2043">                  KnowledgeFlowApp.this,</span>
<span class="nc" id="L2044">                  tempS2,</span>
                  Messages
<span class="nc" id="L2046">                      .getInstance()</span>
<span class="nc" id="L2047">                      .getString(</span>
<span class="nc" id="L2048">                          &quot;KnowledgeFlowApp_InsertUserOrStartableMenuItem_Result_JOptionPane_ShowConfirmDialog_Text&quot;),</span>
<span class="nc" id="L2049">                  JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">          if (result == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L2051">            Thread startPointThread = new Thread() {</span>
              @Override
              public void run() {
                try {
<span class="nc bnc" id="L2055" title="All 2 branches missed.">                  if (startable) {</span>
<span class="nc" id="L2056">                    boolean proceed = true;</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">                    if (m_Memory.memoryIsLow()) {</span>
<span class="nc" id="L2058">                      proceed = m_Memory.showMemoryIsLow();</span>
                    }
<span class="nc bnc" id="L2060" title="All 2 branches missed.">                    if (proceed) {</span>
<span class="nc" id="L2061">                      ((Startable) bc).start();</span>
                    }
<span class="nc bnc" id="L2063" title="All 2 branches missed.">                  } else if (bc instanceof UserRequestAcceptor) {</span>
<span class="nc" id="L2064">                    ((UserRequestAcceptor) bc).performRequest(tempS2);</span>
                  }
<span class="nc" id="L2066">                  notifyIsDirty();</span>
<span class="nc" id="L2067">                } catch (Exception ex) {</span>
<span class="nc" id="L2068">                  ex.printStackTrace();</span>
                }
<span class="nc" id="L2070">              }</span>
            };
<span class="nc" id="L2072">            startPointThread.setPriority(Thread.MIN_PRIORITY);</span>
<span class="nc" id="L2073">            startPointThread.start();</span>
          }
<span class="nc" id="L2075">        }</span>
      });
    } else {
<span class="nc" id="L2078">      custItem.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2080">          Thread startPointThread = new Thread() {</span>
            @Override
            public void run() {
              try {
<span class="nc bnc" id="L2084" title="All 2 branches missed.">                if (startable) {</span>
<span class="nc" id="L2085">                  boolean proceed = true;</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                  if (m_Memory.memoryIsLow()) {</span>
<span class="nc" id="L2087">                    proceed = m_Memory.showMemoryIsLow();</span>
                  }
<span class="nc bnc" id="L2089" title="All 2 branches missed.">                  if (proceed) {</span>
<span class="nc" id="L2090">                    ((Startable) bc).start();</span>
                  }
<span class="nc bnc" id="L2092" title="All 2 branches missed.">                } else if (bc instanceof UserRequestAcceptor) {</span>
<span class="nc" id="L2093">                  ((UserRequestAcceptor) bc).performRequest(tempS2);</span>
                }
<span class="nc" id="L2095">                notifyIsDirty();</span>
<span class="nc" id="L2096">              } catch (Exception ex) {</span>
<span class="nc" id="L2097">                ex.printStackTrace();</span>
              }
<span class="nc" id="L2099">            }</span>
          };
<span class="nc" id="L2101">          startPointThread.setPriority(Thread.MIN_PRIORITY);</span>
<span class="nc" id="L2102">          startPointThread.start();</span>
<span class="nc" id="L2103">        }</span>
      });
    }

<span class="nc bnc" id="L2107" title="All 2 branches missed.">    if (disabled) {</span>
<span class="nc" id="L2108">      custItem.setEnabled(false);</span>
    }

<span class="nc" id="L2111">    beanContextMenu.add(custItem);</span>
<span class="nc" id="L2112">  }</span>

  /**
   * Popup the customizer for this bean
   * 
   * @param custClass the class of the customizer
   * @param bc the bean to be customized
   */
  private void popupCustomizer(Class custClass, JComponent bc) {
    try {
      // instantiate
<span class="nc" id="L2123">      final Object customizer = custClass.newInstance();</span>
      // set environment **before** setting object!!
<span class="nc bnc" id="L2125" title="All 2 branches missed.">      if (customizer instanceof EnvironmentHandler) {</span>
<span class="nc" id="L2126">        ((EnvironmentHandler) customizer).setEnvironment(m_flowEnvironment);</span>
      }
<span class="nc" id="L2128">      ((Customizer) customizer).setObject(bc);</span>
<span class="nc" id="L2129">      final javax.swing.JFrame jf = new javax.swing.JFrame();</span>
<span class="nc" id="L2130">      jf.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L2131">      jf.getContentPane().add((JComponent) customizer, BorderLayout.CENTER);</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">      if (customizer instanceof CustomizerCloseRequester) {</span>
<span class="nc" id="L2133">        ((CustomizerCloseRequester) customizer).setParentFrame(jf);</span>
      }
<span class="nc" id="L2135">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc bnc" id="L2138" title="All 2 branches missed.">          if (customizer instanceof CustomizerClosingListener) {</span>
<span class="nc" id="L2139">            ((CustomizerClosingListener) customizer).customizerClosing();</span>
          }
<span class="nc" id="L2141">          jf.dispose();</span>
<span class="nc" id="L2142">        }</span>
      });
<span class="nc" id="L2144">      jf.pack();</span>
<span class="nc" id="L2145">      jf.setVisible(true);</span>
<span class="nc" id="L2146">    } catch (Exception ex) {</span>
<span class="nc" id="L2147">      ex.printStackTrace();</span>
    }
<span class="nc" id="L2149">  }</span>

  /**
   * Handles adding a custom MetaBean to the user toolbar
   * 
   * @param bean the MetaBean
   * @param installListener install a listener for window close events so as to
   *          save the user components
   */
  private void addToUserToolBar(MetaBean bean, boolean installListener) {

<span class="nc bnc" id="L2160" title="All 2 branches missed.">    if (m_userToolBar == null) {</span>
      // need to create the user tab and toolbar
<span class="nc" id="L2162">      setUpUserToolBar();</span>
    }

    // Disconnect any beans connected to the inputs or outputs
    // of this MetaBean (prevents serialization of the entire
    // KnowledgeFlow!!)
<span class="nc" id="L2168">    Vector tempRemovedConnections = new Vector();</span>
<span class="nc" id="L2169">    Vector allConnections = BeanConnection.getConnections();</span>
<span class="nc" id="L2170">    Vector inputs = bean.getInputs();</span>
<span class="nc" id="L2171">    Vector outputs = bean.getOutputs();</span>
<span class="nc" id="L2172">    Vector allComps = bean.getSubFlow();</span>

<span class="nc bnc" id="L2174" title="All 2 branches missed.">    for (int i = 0; i &lt; inputs.size(); i++) {</span>
<span class="nc" id="L2175">      BeanInstance temp = (BeanInstance) inputs.elementAt(i);</span>
      // is this input a target for some event?
<span class="nc bnc" id="L2177" title="All 2 branches missed.">      for (int j = 0; j &lt; allConnections.size(); j++) {</span>
<span class="nc" id="L2178">        BeanConnection tempC = (BeanConnection) allConnections.elementAt(j);</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">        if (tempC.getTarget() == temp) {</span>
<span class="nc" id="L2180">          tempRemovedConnections.add(tempC);</span>
        }

        // also check to see if this input is a source for
        // some target that is *not* in the subFlow
<span class="nc bnc" id="L2185" title="All 2 branches missed.">        if (tempC.getSource() == temp</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">            &amp;&amp; !bean.subFlowContains(tempC.getTarget())) {</span>
<span class="nc" id="L2187">          tempRemovedConnections.add(tempC);</span>
        }
      }
    }

<span class="nc bnc" id="L2192" title="All 2 branches missed.">    for (int i = 0; i &lt; outputs.size(); i++) {</span>
<span class="nc" id="L2193">      BeanInstance temp = (BeanInstance) outputs.elementAt(i);</span>
      // is this output a source for some target?
<span class="nc bnc" id="L2195" title="All 2 branches missed.">      for (int j = 0; j &lt; allConnections.size(); j++) {</span>
<span class="nc" id="L2196">        BeanConnection tempC = (BeanConnection) allConnections.elementAt(j);</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">        if (tempC.getSource() == temp) {</span>
<span class="nc" id="L2198">          tempRemovedConnections.add(tempC);</span>
        }
      }
    }

<span class="nc bnc" id="L2203" title="All 2 branches missed.">    for (int i = 0; i &lt; tempRemovedConnections.size(); i++) {</span>
<span class="nc" id="L2204">      BeanConnection temp = (BeanConnection) tempRemovedConnections</span>
<span class="nc" id="L2205">          .elementAt(i);</span>
<span class="nc" id="L2206">      temp.remove();</span>
    }

    // now add to user tool bar
<span class="nc" id="L2210">    JPanel tempUser = instantiateToolBarMetaBean(bean);</span>
<span class="nc" id="L2211">    m_userBoxPanel.add(tempUser);</span>
<span class="nc bnc" id="L2212" title="All 4 branches missed.">    if (installListener &amp;&amp; m_firstUserComponentOpp) {</span>
      try {
<span class="nc" id="L2214">        installWindowListenerForSavingUserBeans();</span>
<span class="nc" id="L2215">        m_firstUserComponentOpp = false;</span>
<span class="nc" id="L2216">      } catch (Exception ex) {</span>
<span class="nc" id="L2217">        ex.printStackTrace();</span>
      }
    }

    // Now reinstate any deleted connections to the original MetaBean
<span class="nc bnc" id="L2222" title="All 2 branches missed.">    for (int i = 0; i &lt; tempRemovedConnections.size(); i++) {</span>
<span class="nc" id="L2223">      BeanConnection temp = (BeanConnection) tempRemovedConnections</span>
<span class="nc" id="L2224">          .elementAt(i);</span>
<span class="nc" id="L2225">      BeanConnection newC = new BeanConnection(temp.getSource(),</span>
<span class="nc" id="L2226">          temp.getTarget(), temp.getSourceEventSetDescriptor());</span>
    }
<span class="nc" id="L2228">  }</span>

  /**
   * Popup a menu giving choices for connections to delete (if any)
   * 
   * @param closestConnections a vector containing 0 or more BeanConnections
   * @param x the x coordinate at which to popup the menu
   * @param y the y coordinate at which to popup the menu
   * 
   *          Modified by Zerbetto: javax.swing.JPopupMenu transformed into
   *          java.awt.PopupMenu
   */
  private void deleteConnectionPopup(Vector closestConnections, int x, int y) {
<span class="nc bnc" id="L2241" title="All 2 branches missed.">    if (closestConnections.size() &gt; 0) {</span>
<span class="nc" id="L2242">      int menuItemCount = 0;</span>

      // modifications by Zerbetto
      // JPopupMenu deleteConnectionMenu = new JPopupMenu();
<span class="nc" id="L2246">      PopupMenu deleteConnectionMenu = new PopupMenu();</span>

      // deleteConnectionMenu.insert(new JLabel(&quot;Delete Connection&quot;,
      // SwingConstants.CENTER),
      // menuItemCount);
<span class="nc" id="L2251">      MenuItem deleteConnection = new MenuItem(</span>
          Messages
<span class="nc" id="L2253">              .getInstance()</span>
<span class="nc" id="L2254">              .getString(</span>
<span class="nc" id="L2255">                  &quot;KnowledgeFlowApp_DeleteConnectionPopup_DeleteConnection_MenuItem_Text&quot;));</span>
<span class="nc" id="L2256">      deleteConnection.setEnabled(false);</span>
<span class="nc" id="L2257">      deleteConnectionMenu.insert(deleteConnection, menuItemCount);</span>
<span class="nc" id="L2258">      menuItemCount++;</span>

<span class="nc bnc" id="L2260" title="All 2 branches missed.">      for (int i = 0; i &lt; closestConnections.size(); i++) {</span>
<span class="nc" id="L2261">        final BeanConnection bc = (BeanConnection) closestConnections</span>
<span class="nc" id="L2262">            .elementAt(i);</span>
<span class="nc" id="L2263">        String connName = bc.getSourceEventSetDescriptor().getName();</span>

        // JMenuItem deleteItem = new JMenuItem(connName);
<span class="nc" id="L2266">        String targetName = &quot;&quot;;</span>
<span class="nc bnc" id="L2267" title="All 2 branches missed.">        if (bc.getTarget().getBean() instanceof BeanCommon) {</span>
<span class="nc" id="L2268">          targetName = ((BeanCommon) bc.getTarget().getBean()).getCustomName();</span>
        } else {
<span class="nc" id="L2270">          targetName = bc.getTarget().getBean().getClass().getName();</span>
<span class="nc" id="L2271">          targetName = targetName.substring(targetName.lastIndexOf('.') + 1,</span>
<span class="nc" id="L2272">              targetName.length());</span>
        }
<span class="nc" id="L2274">        MenuItem deleteItem = new MenuItem(connName + &quot;--&gt;&quot; + targetName);</span>
<span class="nc" id="L2275">        deleteItem.addActionListener(new ActionListener() {</span>
          public void actionPerformed(ActionEvent e) {
<span class="nc" id="L2277">            bc.remove();</span>
<span class="nc" id="L2278">            m_beanLayout.revalidate();</span>
<span class="nc" id="L2279">            m_beanLayout.repaint();</span>
<span class="nc" id="L2280">            notifyIsDirty();</span>
<span class="nc" id="L2281">          }</span>
        });
<span class="nc" id="L2283">        deleteConnectionMenu.add(deleteItem);</span>
<span class="nc" id="L2284">        menuItemCount++;</span>
      }

      // deleteConnectionMenu.show(m_beanLayout, x, y);
<span class="nc" id="L2288">      m_beanLayout.add(deleteConnectionMenu);</span>
<span class="nc" id="L2289">      deleteConnectionMenu.show(m_beanLayout, x, y);</span>
    }
<span class="nc" id="L2291">  }</span>

  /**
   * Initiates the connection process for two beans
   * 
   * @param esd the EventSetDescriptor for the source bean
   * @param bi the source bean
   * @param x the x coordinate to start connecting from
   * @param y the y coordinate to start connecting from
   */
  private void connectComponents(EventSetDescriptor esd, BeanInstance bi,
      int x, int y) {
    // record the event set descriptior for this event
<span class="nc" id="L2304">    m_sourceEventSetDescriptor = esd;</span>

<span class="nc" id="L2306">    Class listenerClass = esd.getListenerType(); // class of the listener</span>
<span class="nc" id="L2307">    JComponent source = (JComponent) bi.getBean();</span>
    // now determine which (if any) of the other beans implement this
    // listener
<span class="nc" id="L2310">    int targetCount = 0;</span>
<span class="nc" id="L2311">    Vector beanInstances = BeanInstance.getBeanInstances();</span>
<span class="nc bnc" id="L2312" title="All 2 branches missed.">    for (int i = 0; i &lt; beanInstances.size(); i++) {</span>
<span class="nc" id="L2313">      JComponent bean = (JComponent) ((BeanInstance) beanInstances.elementAt(i))</span>
<span class="nc" id="L2314">          .getBean();</span>
<span class="nc" id="L2315">      boolean connectable = false;</span>
<span class="nc" id="L2316">      boolean canContinue = false;</span>
<span class="nc bnc" id="L2317" title="All 2 branches missed.">      if (bean != source) {</span>
<span class="nc bnc" id="L2318" title="All 2 branches missed.">        if (bean instanceof MetaBean) {</span>
<span class="nc bnc" id="L2319" title="All 2 branches missed.">          if (((MetaBean) bean).canAcceptConnection(listenerClass)) {</span>
<span class="nc" id="L2320">            canContinue = true;</span>
          }
<span class="nc bnc" id="L2322" title="All 4 branches missed.">        } else if (listenerClass.isInstance(bean) &amp;&amp; bean != source) {</span>
<span class="nc" id="L2323">          canContinue = true;</span>
        }
      }
<span class="nc bnc" id="L2326" title="All 2 branches missed.">      if (canContinue) {</span>
<span class="nc bnc" id="L2327" title="All 2 branches missed.">        if (!(bean instanceof BeanCommon)) {</span>
<span class="nc" id="L2328">          connectable = true; // assume this bean is happy to receive a</span>
                              // connection
        } else {
          // give this bean a chance to veto any proposed connection via
          // the listener interface
<span class="nc" id="L2333">          if (((BeanCommon) bean).</span>
          // connectionAllowed(esd.getName())) {
<span class="nc bnc" id="L2335" title="All 2 branches missed.">              connectionAllowed(esd)) {</span>
<span class="nc" id="L2336">            connectable = true;</span>
          }
        }
<span class="nc bnc" id="L2339" title="All 2 branches missed.">        if (connectable) {</span>
<span class="nc bnc" id="L2340" title="All 2 branches missed.">          if (bean instanceof Visible) {</span>
<span class="nc" id="L2341">            targetCount++;</span>
<span class="nc" id="L2342">            ((Visible) bean).getVisual().setDisplayConnectors(true);</span>
          }
        }
      }
    }

    // have some possible beans to connect to?
<span class="nc bnc" id="L2349" title="All 2 branches missed.">    if (targetCount &gt; 0) {</span>
      // System.err.println(&quot;target count &quot;+targetCount);
<span class="nc bnc" id="L2351" title="All 2 branches missed.">      if (source instanceof Visible) {</span>
<span class="nc" id="L2352">        ((Visible) source).getVisual().setDisplayConnectors(true);</span>
      }

<span class="nc" id="L2355">      m_editElement = bi;</span>
<span class="nc" id="L2356">      Point closest = ((Visible) source).getVisual().getClosestConnectorPoint(</span>
<span class="nc" id="L2357">          new Point(x, y));</span>

<span class="nc" id="L2359">      m_startX = (int) closest.getX();</span>
<span class="nc" id="L2360">      m_startY = (int) closest.getY();</span>
<span class="nc" id="L2361">      m_oldX = m_startX;</span>
<span class="nc" id="L2362">      m_oldY = m_startY;</span>

<span class="nc" id="L2364">      Graphics2D gx = (Graphics2D) m_beanLayout.getGraphics();</span>
<span class="nc" id="L2365">      gx.setXORMode(java.awt.Color.white);</span>
<span class="nc" id="L2366">      gx.drawLine(m_startX, m_startY, m_startX, m_startY);</span>
<span class="nc" id="L2367">      gx.dispose();</span>
<span class="nc" id="L2368">      m_mode = CONNECTING;</span>
    }
<span class="nc" id="L2370">  }</span>

  private void addComponent(BeanInstance comp, boolean repaint) {
<span class="nc bnc" id="L2373" title="All 2 branches missed.">    if (comp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2374">      ((Visible) comp.getBean()).getVisual().addPropertyChangeListener(this);</span>
    }
<span class="nc bnc" id="L2376" title="All 2 branches missed.">    if (comp.getBean() instanceof BeanCommon) {</span>
<span class="nc" id="L2377">      ((BeanCommon) comp.getBean()).setLog(m_logPanel);</span>
    }
<span class="nc bnc" id="L2379" title="All 2 branches missed.">    if (comp.getBean() instanceof MetaBean) {</span>
      // re-align sub-beans
      Vector list;

<span class="nc" id="L2383">      list = ((MetaBean) comp.getBean()).getInputs();</span>
<span class="nc bnc" id="L2384" title="All 2 branches missed.">      for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L2385">        ((BeanInstance) list.get(i)).setX(comp.getX());</span>
<span class="nc" id="L2386">        ((BeanInstance) list.get(i)).setY(comp.getY());</span>
      }

<span class="nc" id="L2389">      list = ((MetaBean) comp.getBean()).getOutputs();</span>
<span class="nc bnc" id="L2390" title="All 2 branches missed.">      for (int i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L2391">        ((BeanInstance) list.get(i)).setX(comp.getX());</span>
<span class="nc" id="L2392">        ((BeanInstance) list.get(i)).setY(comp.getY());</span>
      }
    }
<span class="nc" id="L2395">    setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));</span>
<span class="nc bnc" id="L2396" title="All 2 branches missed.">    if (repaint) {</span>
<span class="nc" id="L2397">      m_beanLayout.repaint();</span>
    }
<span class="nc" id="L2399">    m_pointerB.setSelected(true);</span>
<span class="nc" id="L2400">    m_mode = NONE;</span>
<span class="nc" id="L2401">  }</span>

  private void addComponent(int x, int y) {
<span class="nc bnc" id="L2404" title="All 2 branches missed.">    if (m_toolBarBean instanceof MetaBean) {</span>
      // need to add the MetaBean's internal connections
      // to BeanConnection's vector
<span class="nc" id="L2407">      Vector associatedConnections = ((MetaBean) m_toolBarBean)</span>
<span class="nc" id="L2408">          .getAssociatedConnections();</span>
<span class="nc" id="L2409">      BeanConnection.getConnections().addAll(associatedConnections);</span>
    }

<span class="nc bnc" id="L2412" title="All 2 branches missed.">    if (m_toolBarBean instanceof BeanContextChild) {</span>
<span class="nc" id="L2413">      m_bcSupport.add(m_toolBarBean);</span>
    }
<span class="nc" id="L2415">    BeanInstance bi = new BeanInstance(m_beanLayout, m_toolBarBean, x, y);</span>
    // addBean((JComponent)bi.getBean());
<span class="nc" id="L2417">    m_toolBarBean = null;</span>
<span class="nc" id="L2418">    addComponent(bi, true);</span>
<span class="nc" id="L2419">  }</span>

  /**
   * Handles the checking of a selected set of components for suitability for
   * grouping. If suitable the user is prompted for a name and then a MetaBean
   * is used group the components.
   */
  private void checkSubFlow(int startX, int startY, int endX, int endY) {

<span class="nc bnc" id="L2428" title="All 2 branches missed.">    java.awt.Rectangle r = new java.awt.Rectangle((startX &lt; endX) ? startX</span>
<span class="nc bnc" id="L2429" title="All 2 branches missed.">        : endX, (startY &lt; endY) ? startY : endY, Math.abs(startX - endX),</span>
<span class="nc" id="L2430">        Math.abs(startY - endY));</span>
    // System.err.println(r);
<span class="nc" id="L2432">    Vector selected = BeanInstance.findInstances(r);</span>
    // System.err.println(r);
    // check if sub flow is valid
<span class="nc" id="L2435">    Vector inputs = BeanConnection.inputs(selected);</span>
<span class="nc" id="L2436">    Vector outputs = BeanConnection.outputs(selected);</span>

    // screen the inputs and outputs
<span class="nc bnc" id="L2439" title="All 4 branches missed.">    if (inputs.size() == 0 || outputs.size() == 0) {</span>
<span class="nc" id="L2440">      return;</span>
    }

    // dissallow MetaBeans in the selected set (for the
    // time being).
<span class="nc bnc" id="L2445" title="All 2 branches missed.">    for (int i = 0; i &lt; selected.size(); i++) {</span>
<span class="nc" id="L2446">      BeanInstance temp = (BeanInstance) selected.elementAt(i);</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">      if (temp.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L2448">        return;</span>
      }
    }

    // show connector dots for selected beans
<span class="nc bnc" id="L2453" title="All 2 branches missed.">    for (int i = 0; i &lt; selected.size(); i++) {</span>
<span class="nc" id="L2454">      BeanInstance temp = (BeanInstance) selected.elementAt(i);</span>
<span class="nc bnc" id="L2455" title="All 2 branches missed.">      if (temp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2456">        ((Visible) temp.getBean()).getVisual().setDisplayConnectors(true);</span>
      }
    }

    // show connector dots for input beans
<span class="nc bnc" id="L2461" title="All 2 branches missed.">    for (int i = 0; i &lt; inputs.size(); i++) {</span>
<span class="nc" id="L2462">      BeanInstance temp = (BeanInstance) inputs.elementAt(i);</span>
<span class="nc bnc" id="L2463" title="All 2 branches missed.">      if (temp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2464">        ((Visible) temp.getBean()).getVisual().setDisplayConnectors(true,</span>
<span class="nc" id="L2465">            java.awt.Color.red);</span>
      }
    }

    // show connector dots for output beans
<span class="nc bnc" id="L2470" title="All 2 branches missed.">    for (int i = 0; i &lt; outputs.size(); i++) {</span>
<span class="nc" id="L2471">      BeanInstance temp = (BeanInstance) outputs.elementAt(i);</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">      if (temp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2473">        ((Visible) temp.getBean()).getVisual().setDisplayConnectors(true,</span>
<span class="nc" id="L2474">            java.awt.Color.green);</span>
      }
    }

<span class="nc" id="L2478">    BufferedImage subFlowPreview = null;</span>
    try {
<span class="nc" id="L2480">      subFlowPreview = createImage(m_beanLayout, r);</span>
<span class="nc" id="L2481">    } catch (IOException ex) {</span>
<span class="nc" id="L2482">      ex.printStackTrace();</span>
      // drop through quietly
    }

    // Confirmation pop-up
<span class="nc" id="L2487">    int result = JOptionPane</span>
<span class="nc" id="L2488">        .showConfirmDialog(</span>
<span class="nc" id="L2489">            KnowledgeFlowApp.this,</span>
            Messages
<span class="nc" id="L2491">                .getInstance()</span>
<span class="nc" id="L2492">                .getString(</span>
<span class="nc" id="L2493">                    &quot;KnowledgeFlowApp_CheckSubFlow_Result_JOptionPane_ShowConfirmDialog_Text_First&quot;),</span>
            Messages
<span class="nc" id="L2495">                .getInstance()</span>
<span class="nc" id="L2496">                .getString(</span>
<span class="nc" id="L2497">                    &quot;KnowledgeFlowApp_CheckSubFlow_Result_JOptionPane_ShowConfirmDialog_Text_Second&quot;),</span>
<span class="nc" id="L2498">            JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L2499" title="All 2 branches missed.">    if (result == JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L2500">      Vector associatedConnections = BeanConnection</span>
<span class="nc" id="L2501">          .associatedConnections(selected);</span>

<span class="nc" id="L2503">      String name = JOptionPane</span>
<span class="nc" id="L2504">          .showInputDialog(</span>
<span class="nc" id="L2505">              KnowledgeFlowApp.this,</span>
              Messages
<span class="nc" id="L2507">                  .getInstance()</span>
<span class="nc" id="L2508">                  .getString(</span>
<span class="nc" id="L2509">                      &quot;KnowledgeFlowApp_CheckSubFlow_Result_Name_ShowConfirmDialog_Text_First&quot;),</span>
              Messages
<span class="nc" id="L2511">                  .getInstance()</span>
<span class="nc" id="L2512">                  .getString(</span>
<span class="nc" id="L2513">                      &quot;KnowledgeFlowApp_CheckSubFlow_Result_Name_ShowConfirmDialog_Text_Second&quot;));</span>
<span class="nc bnc" id="L2514" title="All 2 branches missed.">      if (name != null) {</span>
<span class="nc" id="L2515">        MetaBean group = new MetaBean();</span>
<span class="nc" id="L2516">        group.setSubFlow(selected);</span>
<span class="nc" id="L2517">        group.setAssociatedConnections(associatedConnections);</span>
<span class="nc" id="L2518">        group.setInputs(inputs);</span>
<span class="nc" id="L2519">        group.setOutputs(outputs);</span>
<span class="nc" id="L2520">        group.setSubFlowPreview(new ImageIcon(subFlowPreview));</span>
<span class="nc bnc" id="L2521" title="All 2 branches missed.">        if (name.length() &gt; 0) {</span>
          // group.getVisual().setText(name);
<span class="nc" id="L2523">          group.setCustomName(name);</span>
        }

<span class="nc bnc" id="L2526" title="All 2 branches missed.">        if (group instanceof BeanContextChild) {</span>
<span class="nc" id="L2527">          m_bcSupport.add(group);</span>
        }
<span class="nc" id="L2529">        BeanInstance bi = new BeanInstance(m_beanLayout, group, (int) r.getX()</span>
<span class="nc" id="L2530">            + (int) (r.getWidth() / 2), (int) r.getY()</span>
<span class="nc" id="L2531">            + (int) (r.getHeight() / 2));</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">        for (int i = 0; i &lt; selected.size(); i++) {</span>
<span class="nc" id="L2533">          BeanInstance temp = (BeanInstance) selected.elementAt(i);</span>
<span class="nc" id="L2534">          temp.removeBean(m_beanLayout);</span>
<span class="nc bnc" id="L2535" title="All 2 branches missed.">          if (temp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2536">            ((Visible) temp.getBean()).getVisual()</span>
<span class="nc" id="L2537">                .removePropertyChangeListener(this);</span>
          }
        }
<span class="nc bnc" id="L2540" title="All 2 branches missed.">        for (int i = 0; i &lt; associatedConnections.size(); i++) {</span>
<span class="nc" id="L2541">          BeanConnection temp = (BeanConnection) associatedConnections</span>
<span class="nc" id="L2542">              .elementAt(i);</span>
<span class="nc" id="L2543">          temp.setHidden(true);</span>
        }
<span class="nc" id="L2545">        group.shiftBeans(bi, true);</span>

<span class="nc" id="L2547">        addComponent(bi, true);</span>
      }
    }

    // hide connector dots
<span class="nc bnc" id="L2552" title="All 2 branches missed.">    for (int i = 0; i &lt; selected.size(); i++) {</span>
<span class="nc" id="L2553">      BeanInstance temp = (BeanInstance) selected.elementAt(i);</span>
<span class="nc bnc" id="L2554" title="All 2 branches missed.">      if (temp.getBean() instanceof Visible) {</span>
<span class="nc" id="L2555">        ((Visible) temp.getBean()).getVisual().setDisplayConnectors(false);</span>
      }
    }
<span class="nc" id="L2558">  }</span>

  /**
   * Accept property change events
   * 
   * @param e a &lt;code&gt;PropertyChangeEvent&lt;/code&gt; value
   */
  public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L2566">    revalidate();</span>
<span class="nc" id="L2567">    m_beanLayout.repaint();</span>
<span class="nc" id="L2568">  }</span>

  /**
   * Load a pre-saved layout
   */
  private void loadLayout() {
<span class="nc" id="L2574">    m_loadB.setEnabled(false);</span>
<span class="nc" id="L2575">    m_saveB.setEnabled(false);</span>
<span class="nc" id="L2576">    int returnVal = m_FileChooser.showOpenDialog(this);</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">    if (returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L2578">      stopFlow();</span>

      // determine filename
<span class="nc" id="L2581">      File oFile = m_FileChooser.getSelectedFile();</span>
      // set internal flow directory environment variable
<span class="nc" id="L2583">      m_flowEnvironment.addVariable(&quot;Internal.knowledgeflow.directory&quot;,</span>
<span class="nc" id="L2584">          oFile.getParent());</span>

      // add extension if necessary
<span class="nc bnc" id="L2587" title="All 2 branches missed.">      if (m_FileChooser.getFileFilter() == m_KfFilter) {</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">        if (!oFile.getName().toLowerCase().endsWith(FILE_EXTENSION)) {</span>
<span class="nc" id="L2589">          oFile = new File(oFile.getParent(), oFile.getName() + FILE_EXTENSION);</span>
        }
<span class="nc bnc" id="L2591" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_KOMLFilter) {</span>
<span class="nc bnc" id="L2592" title="All 2 branches missed.">        if (!oFile.getName().toLowerCase().endsWith(KOML.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L2593">          oFile = new File(oFile.getParent(), oFile.getName()</span>
<span class="nc" id="L2594">              + KOML.FILE_EXTENSION + &quot;kf&quot;);</span>
        }
<span class="nc bnc" id="L2596" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_XMLFilter) {</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">        if (!oFile.getName().toLowerCase().endsWith(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L2598">          oFile = new File(oFile.getParent(), oFile.getName()</span>
<span class="nc" id="L2599">              + FILE_EXTENSION_XML);</span>
        }
<span class="nc bnc" id="L2601" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_XStreamFilter) {</span>
<span class="nc" id="L2602">        if (!oFile.getName().toLowerCase()</span>
<span class="nc bnc" id="L2603" title="All 2 branches missed.">            .endsWith(XStream.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L2604">          oFile = new File(oFile.getParent(), oFile.getName()</span>
<span class="nc" id="L2605">              + XStream.FILE_EXTENSION + &quot;kf&quot;);</span>
        }
      }

      try {
<span class="nc" id="L2610">        Vector beans = new Vector();</span>
<span class="nc" id="L2611">        Vector connections = new Vector();</span>

        // KOML?
<span class="nc bnc" id="L2614" title="All 2 branches missed.">        if ((KOML.isPresent())</span>
<span class="nc" id="L2615">            &amp;&amp; (oFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">                .endsWith(KOML.FILE_EXTENSION + &quot;kf&quot;))) {</span>
<span class="nc" id="L2617">          Vector v = (Vector) KOML.read(oFile.getAbsolutePath());</span>
<span class="nc" id="L2618">          beans = (Vector) v.get(XMLBeans.INDEX_BEANINSTANCES);</span>
<span class="nc" id="L2619">          connections = (Vector) v.get(XMLBeans.INDEX_BEANCONNECTIONS);</span>
<span class="nc bnc" id="L2620" title="All 2 branches missed.">        } /* XStream */else if ((XStream.isPresent())</span>
<span class="nc" id="L2621">            &amp;&amp; (oFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2622" title="All 2 branches missed.">                .endsWith(XStream.FILE_EXTENSION + &quot;kf&quot;))) {</span>
<span class="nc" id="L2623">          Vector v = (Vector) XStream.read(oFile.getAbsolutePath());</span>
<span class="nc" id="L2624">          beans = (Vector) v.get(XMLBeans.INDEX_BEANINSTANCES);</span>
<span class="nc" id="L2625">          connections = (Vector) v.get(XMLBeans.INDEX_BEANCONNECTIONS);</span>
<span class="nc" id="L2626">        } /* XML? */else if (oFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2627" title="All 2 branches missed.">            .endsWith(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L2628">          XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport);</span>
<span class="nc" id="L2629">          Vector v = (Vector) xml.read(oFile);</span>
<span class="nc" id="L2630">          beans = (Vector) v.get(XMLBeans.INDEX_BEANINSTANCES);</span>
<span class="nc" id="L2631">          connections = (Vector) v.get(XMLBeans.INDEX_BEANCONNECTIONS);</span>
          // connections = new Vector();
        } /* binary */else {
<span class="nc" id="L2634">          InputStream is = new FileInputStream(oFile);</span>
<span class="nc" id="L2635">          ObjectInputStream ois = new ObjectInputStream(is);</span>
<span class="nc" id="L2636">          beans = (Vector) ois.readObject();</span>
<span class="nc" id="L2637">          connections = (Vector) ois.readObject();</span>
<span class="nc" id="L2638">          ois.close();</span>
        }

<span class="nc" id="L2641">        integrateFlow(beans, connections);</span>
<span class="nc" id="L2642">        setEnvironment();</span>
<span class="nc" id="L2643">        m_logPanel.clearStatus();</span>
<span class="nc" id="L2644">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2645">            &quot;KnowledgeFlowApp_LoadLayout_StatusMessage_Text_First&quot;));</span>
<span class="nc" id="L2646">      } catch (Exception ex) {</span>
<span class="nc" id="L2647">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2648">            &quot;KnowledgeFlowApp_LoadLayout_StatusMessage_Text_Second&quot;));</span>
<span class="nc" id="L2649">        m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2650">            &quot;KnowledgeFlowApp_LoadLayout_LogMessage_Text_First&quot;)</span>
<span class="nc" id="L2651">            + ex.getMessage()</span>
<span class="nc" id="L2652">            + Messages.getInstance().getString(</span>
<span class="nc" id="L2653">                &quot;KnowledgeFlowApp_LoadLayout_LogMessage_Text_Second&quot;));</span>
<span class="nc" id="L2654">        ex.printStackTrace();</span>
      }
    }
<span class="nc" id="L2657">    m_loadB.setEnabled(true);</span>
<span class="nc" id="L2658">    m_saveB.setEnabled(true);</span>
<span class="nc" id="L2659">  }</span>

  // Link the supplied beans into the KnowledgeFlow gui
  private void integrateFlow(Vector beans, Vector connections) {
<span class="nc" id="L2663">    java.awt.Color bckC = getBackground();</span>
<span class="nc" id="L2664">    m_bcSupport = new BeanContextSupport();</span>
<span class="nc" id="L2665">    m_bcSupport.setDesignTime(true);</span>

    // register this panel as a property change listener with each
    // bean
<span class="nc bnc" id="L2669" title="All 2 branches missed.">    for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L2670">      BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>
<span class="nc bnc" id="L2671" title="All 2 branches missed.">      if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L2672">        ((Visible) (tempB.getBean())).getVisual().addPropertyChangeListener(</span>
<span class="nc" id="L2673">            this);</span>

        // A workaround to account for JPanel's with their default
        // background colour not being serializable in Apple's JRE
<span class="nc" id="L2677">        ((Visible) (tempB.getBean())).getVisual().setBackground(bckC);</span>
<span class="nc" id="L2678">        ((JComponent) (tempB.getBean())).setBackground(bckC);</span>
      }
<span class="nc bnc" id="L2680" title="All 2 branches missed.">      if (tempB.getBean() instanceof BeanCommon) {</span>
<span class="nc" id="L2681">        ((BeanCommon) (tempB.getBean())).setLog(m_logPanel);</span>
      }
<span class="nc bnc" id="L2683" title="All 2 branches missed.">      if (tempB.getBean() instanceof BeanContextChild) {</span>
<span class="nc" id="L2684">        m_bcSupport.add(tempB.getBean());</span>
      }
    }
<span class="nc" id="L2687">    BeanInstance.setBeanInstances(beans, m_beanLayout);</span>
<span class="nc" id="L2688">    BeanConnection.setConnections(connections);</span>
<span class="nc" id="L2689">    m_beanLayout.revalidate();</span>
<span class="nc" id="L2690">    m_beanLayout.repaint();</span>
<span class="nc" id="L2691">  }</span>

  /**
   * Set the flow for the KnowledgeFlow to edit. Assumes that client has loaded
   * a Vector of beans and a Vector of connections. the supplied beans and
   * connections are deep-copied via serialization before being set in the
   * layout.
   * 
   * @param v a Vector containing a Vector of beans and a Vector of connections
   * @exception Exception if something goes wrong
   */
  public void setFlow(Vector v) throws Exception {
    // Vector beansCopy = null, connectionsCopy = null;
<span class="nc" id="L2704">    clearLayout();</span>
<span class="nc" id="L2705">    SerializedObject so = new SerializedObject(v);</span>
<span class="nc" id="L2706">    Vector copy = (Vector) so.getObject();</span>

<span class="nc" id="L2708">    Vector beans = (Vector) copy.elementAt(0);</span>
<span class="nc" id="L2709">    Vector connections = (Vector) copy.elementAt(1);</span>

    // reset environment variables
<span class="nc" id="L2712">    m_flowEnvironment = new Environment();</span>
<span class="nc" id="L2713">    integrateFlow(beans, connections);</span>
<span class="nc" id="L2714">  }</span>

  /**
   * Gets the current flow being edited. The flow is returned as a single Vector
   * containing two other Vectors: the beans and the connections. These two
   * vectors are deep-copied via serialization before being returned.
   * 
   * @return the current flow being edited
   */
  public Vector getFlow() throws Exception {
<span class="nc" id="L2724">    Vector v = new Vector();</span>
<span class="nc" id="L2725">    Vector beans = BeanInstance.getBeanInstances();</span>
<span class="nc" id="L2726">    Vector connections = BeanConnection.getConnections();</span>
<span class="nc" id="L2727">    detachFromLayout(beans);</span>
<span class="nc" id="L2728">    v.add(beans);</span>
<span class="nc" id="L2729">    v.add(connections);</span>

<span class="nc" id="L2731">    SerializedObject so = new SerializedObject(v);</span>
<span class="nc" id="L2732">    Vector copy = (Vector) so.getObject();</span>

    // tempWrite(beans, connections);

<span class="nc" id="L2736">    integrateFlow(beans, connections);</span>
<span class="nc" id="L2737">    return copy;</span>
  }

  /**
   * Utility method to create an image of a region of the given component
   * 
   * @param component the component to create an image of
   * @param region the region of the component to put into the image
   * @return the image
   * @throws IOException
   */
  protected static BufferedImage createImage(JComponent component,
      Rectangle region) throws IOException {
<span class="nc" id="L2750">    boolean opaqueValue = component.isOpaque();</span>
<span class="nc" id="L2751">    component.setOpaque(true);</span>
<span class="nc" id="L2752">    BufferedImage image = new BufferedImage(region.width, region.height,</span>
<span class="nc" id="L2753">        BufferedImage.TYPE_INT_RGB);</span>
<span class="nc" id="L2754">    Graphics2D g2d = image.createGraphics();</span>
<span class="nc" id="L2755">    g2d.translate(-region.getX(), -region.getY());</span>
    // g2d.setClip( region );
<span class="nc" id="L2757">    component.paint(g2d);</span>
<span class="nc" id="L2758">    g2d.dispose();</span>
<span class="nc" id="L2759">    component.setOpaque(opaqueValue);</span>

<span class="nc" id="L2761">    return image;</span>
  }

  // Remove this panel as a property changle listener from
  // each bean
  private void detachFromLayout(Vector beans) {
<span class="nc bnc" id="L2767" title="All 2 branches missed.">    for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L2768">      BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>
<span class="nc bnc" id="L2769" title="All 2 branches missed.">      if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L2770">        ((Visible) (tempB.getBean())).getVisual().removePropertyChangeListener(</span>
<span class="nc" id="L2771">            this);</span>

<span class="nc bnc" id="L2773" title="All 2 branches missed.">        if (tempB.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L2774">          ((MetaBean) tempB.getBean())</span>
<span class="nc" id="L2775">              .removePropertyChangeListenersSubFlow(this);</span>
        }

        // A workaround to account for JPanel's with their default
        // background colour not being serializable in Apple's JRE.
        // JComponents are rendered with a funky stripy background
        // under OS X using java.awt.TexturePaint - unfortunately
        // TexturePaint doesn't implement Serializable.
<span class="nc" id="L2783">        ((Visible) (tempB.getBean())).getVisual().setBackground(</span>
<span class="nc" id="L2784">            java.awt.Color.white);</span>
<span class="nc" id="L2785">        ((JComponent) (tempB.getBean())).setBackground(java.awt.Color.white);</span>
      }
    }
<span class="nc" id="L2788">  }</span>

  /**
   * Serialize the layout to a file
   */
  private void saveLayout() {
    // m_loadB.setEnabled(false);
    // m_saveB.setEnabled(false);
<span class="nc" id="L2796">    int returnVal = m_FileChooser.showSaveDialog(this);</span>
<span class="nc" id="L2797">    java.awt.Color bckC = getBackground();</span>
<span class="nc bnc" id="L2798" title="All 2 branches missed.">    if (returnVal == JFileChooser.APPROVE_OPTION) {</span>
      // temporarily remove this panel as a property changle listener from
      // each bean

<span class="nc" id="L2802">      Vector beans = BeanInstance.getBeanInstances();</span>
<span class="nc" id="L2803">      detachFromLayout(beans);</span>

      // determine filename
<span class="nc" id="L2806">      File sFile = m_FileChooser.getSelectedFile();</span>

      // add extension if necessary
<span class="nc bnc" id="L2809" title="All 2 branches missed.">      if (m_FileChooser.getFileFilter() == m_KfFilter) {</span>
<span class="nc bnc" id="L2810" title="All 2 branches missed.">        if (!sFile.getName().toLowerCase().endsWith(FILE_EXTENSION)) {</span>
<span class="nc" id="L2811">          sFile = new File(sFile.getParent(), sFile.getName() + FILE_EXTENSION);</span>
        }
<span class="nc bnc" id="L2813" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_KOMLFilter) {</span>
<span class="nc bnc" id="L2814" title="All 2 branches missed.">        if (!sFile.getName().toLowerCase().endsWith(KOML.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L2815">          sFile = new File(sFile.getParent(), sFile.getName()</span>
<span class="nc" id="L2816">              + KOML.FILE_EXTENSION + &quot;kf&quot;);</span>
        }
<span class="nc bnc" id="L2818" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_XStreamFilter) {</span>
<span class="nc" id="L2819">        if (!sFile.getName().toLowerCase()</span>
<span class="nc bnc" id="L2820" title="All 2 branches missed.">            .endsWith(XStream.FILE_EXTENSION + &quot;kf&quot;)) {</span>
<span class="nc" id="L2821">          sFile = new File(sFile.getParent(), sFile.getName()</span>
<span class="nc" id="L2822">              + XStream.FILE_EXTENSION + &quot;kf&quot;);</span>
        }
<span class="nc bnc" id="L2824" title="All 2 branches missed.">      } else if (m_FileChooser.getFileFilter() == m_XMLFilter) {</span>
<span class="nc bnc" id="L2825" title="All 2 branches missed.">        if (!sFile.getName().toLowerCase().endsWith(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L2826">          sFile = new File(sFile.getParent(), sFile.getName()</span>
<span class="nc" id="L2827">              + FILE_EXTENSION_XML);</span>
        }
      }

      // now serialize components vector and connections vector
      try {
        // KOML?
<span class="nc bnc" id="L2834" title="All 2 branches missed.">        if ((KOML.isPresent())</span>
<span class="nc" id="L2835">            &amp;&amp; (sFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2836" title="All 2 branches missed.">                .endsWith(KOML.FILE_EXTENSION + &quot;kf&quot;))) {</span>
<span class="nc" id="L2837">          Vector v = new Vector();</span>
<span class="nc" id="L2838">          v.setSize(2);</span>
<span class="nc" id="L2839">          v.set(XMLBeans.INDEX_BEANINSTANCES, beans);</span>
<span class="nc" id="L2840">          v.set(XMLBeans.INDEX_BEANCONNECTIONS, BeanConnection.getConnections());</span>
<span class="nc" id="L2841">          KOML.write(sFile.getAbsolutePath(), v);</span>
<span class="nc bnc" id="L2842" title="All 2 branches missed.">        } /* XStream */else if ((XStream.isPresent())</span>
<span class="nc" id="L2843">            &amp;&amp; (sFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2844" title="All 2 branches missed.">                .endsWith(XStream.FILE_EXTENSION + &quot;kf&quot;))) {</span>
<span class="nc" id="L2845">          Vector v = new Vector();</span>
<span class="nc" id="L2846">          v.setSize(2);</span>
<span class="nc" id="L2847">          v.set(XMLBeans.INDEX_BEANINSTANCES, beans);</span>
<span class="nc" id="L2848">          v.set(XMLBeans.INDEX_BEANCONNECTIONS, BeanConnection.getConnections());</span>
<span class="nc" id="L2849">          XStream.write(sFile.getAbsolutePath(), v);</span>
<span class="nc" id="L2850">        } /* XML? */else if (sFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L2851" title="All 2 branches missed.">            .endsWith(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L2852">          Vector v = new Vector();</span>
<span class="nc" id="L2853">          v.setSize(2);</span>
<span class="nc" id="L2854">          v.set(XMLBeans.INDEX_BEANINSTANCES, beans);</span>
<span class="nc" id="L2855">          v.set(XMLBeans.INDEX_BEANCONNECTIONS, BeanConnection.getConnections());</span>
<span class="nc" id="L2856">          XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport);</span>
          // XML flows are tagged as encoded with UTF-8
<span class="nc" id="L2858">          BufferedWriter br = new BufferedWriter(new OutputStreamWriter(</span>
<span class="nc" id="L2859">              new FileOutputStream(sFile), &quot;UTF-8&quot;));</span>
<span class="nc" id="L2860">          xml.write(br, v);</span>
        } /* binary */else {
<span class="nc" id="L2862">          OutputStream os = new FileOutputStream(sFile);</span>
<span class="nc" id="L2863">          ObjectOutputStream oos = new ObjectOutputStream(os);</span>
<span class="nc" id="L2864">          oos.writeObject(beans);</span>
<span class="nc" id="L2865">          oos.writeObject(BeanConnection.getConnections());</span>
<span class="nc" id="L2866">          oos.flush();</span>
<span class="nc" id="L2867">          oos.close();</span>
        }
<span class="nc" id="L2869">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2870">            &quot;KnowledgeFlowApp_SaveLayout_StatusMessage_Text_First&quot;));</span>

        // set the internal knowledgeflow directory environment var for this
        // flow
<span class="nc" id="L2874">        m_flowEnvironment.addVariable(&quot;Internal.knowledgeflow.directory&quot;,</span>
<span class="nc" id="L2875">            sFile.getParent());</span>
<span class="nc" id="L2876">        setEnvironment();</span>
<span class="nc" id="L2877">      } catch (Exception ex) {</span>
<span class="nc" id="L2878">        m_logPanel.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2879">            &quot;KnowledgeFlowApp_SaveLayout_StatusMessage_Text_Second&quot;));</span>
<span class="nc" id="L2880">        m_logPanel.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L2881">            &quot;KnowledgeFlowApp_SaveLayout_LogMessage_Text_First&quot;)</span>
<span class="nc" id="L2882">            + ex.getMessage()</span>
<span class="nc" id="L2883">            + Messages.getInstance().getString(</span>
<span class="nc" id="L2884">                &quot;KnowledgeFlowApp_SaveLayout_LogMessage_Text_Second&quot;));</span>
<span class="nc" id="L2885">        ex.printStackTrace();</span>
<span class="nc" id="L2886">      } finally {</span>
        // restore this panel as a property change listener in the beans
<span class="nc bnc" id="L2888" title="All 6 branches missed.">        for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L2889">          BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>
<span class="nc bnc" id="L2890" title="All 6 branches missed.">          if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L2891">            ((Visible) (tempB.getBean())).getVisual()</span>
<span class="nc" id="L2892">                .addPropertyChangeListener(this);</span>

<span class="nc bnc" id="L2894" title="All 6 branches missed.">            if (tempB.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L2895">              ((MetaBean) tempB.getBean())</span>
<span class="nc" id="L2896">                  .addPropertyChangeListenersSubFlow(this);</span>
            }
            // Restore the default background colour
<span class="nc" id="L2899">            ((Visible) (tempB.getBean())).getVisual().setBackground(bckC);</span>
<span class="nc" id="L2900">            ((JComponent) (tempB.getBean())).setBackground(bckC);</span>
          }
        }
<span class="nc" id="L2903">      }</span>
    }
    // m_saveB.setEnabled(true);
    // m_loadB.setEnabled(true);
<span class="nc" id="L2907">  }</span>

  /**
   * Save the knowledge flow into the OutputStream passed at input. Only
   * supports saving the layout data (no trained models) to XML.
   * 
   * @param out the output stream to save the layout in
   */
  public void saveLayout(OutputStream out) {
    // temporarily remove this panel as a property changle listener from
    // each bean
<span class="nc" id="L2918">    Vector beans = BeanInstance.getBeanInstances();</span>

<span class="nc bnc" id="L2920" title="All 2 branches missed.">    for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L2921">      BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>

<span class="nc bnc" id="L2923" title="All 2 branches missed.">      if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L2924">        ((Visible) (tempB.getBean())).getVisual().removePropertyChangeListener(</span>
<span class="nc" id="L2925">            this);</span>

<span class="nc bnc" id="L2927" title="All 2 branches missed.">        if (tempB.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L2928">          ((MetaBean) tempB.getBean())</span>
<span class="nc" id="L2929">              .removePropertyChangeListenersSubFlow(this);</span>
        }
      }
    }

    // now serialize components vector and connections vector
    try {
<span class="nc" id="L2936">      Vector v = new Vector();</span>
<span class="nc" id="L2937">      v.setSize(2);</span>
<span class="nc" id="L2938">      v.set(XMLBeans.INDEX_BEANINSTANCES, beans);</span>
<span class="nc" id="L2939">      v.set(XMLBeans.INDEX_BEANCONNECTIONS, BeanConnection.getConnections());</span>

<span class="nc" id="L2941">      XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport);</span>
<span class="nc" id="L2942">      xml.write(out, v);</span>
<span class="nc" id="L2943">    } catch (Exception ex) {</span>
<span class="nc" id="L2944">      ex.printStackTrace();</span>
<span class="nc" id="L2945">    } finally {</span>
      // restore this panel as a property change listener in the beans
<span class="nc bnc" id="L2947" title="All 6 branches missed.">      for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L2948">        BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>

<span class="nc bnc" id="L2950" title="All 6 branches missed.">        if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L2951">          ((Visible) (tempB.getBean())).getVisual().addPropertyChangeListener(</span>
<span class="nc" id="L2952">              this);</span>

<span class="nc bnc" id="L2954" title="All 6 branches missed.">          if (tempB.getBean() instanceof MetaBean) {</span>
<span class="nc" id="L2955">            ((MetaBean) tempB.getBean())</span>
<span class="nc" id="L2956">                .addPropertyChangeListenersSubFlow(this);</span>
          }
        }
      }
<span class="nc" id="L2960">    }</span>
<span class="nc" id="L2961">  }</span>

  private void loadUserComponents() {
<span class="nc" id="L2964">    Vector tempV = null;</span>
<span class="nc" id="L2965">    String ext = &quot;&quot;;</span>
<span class="nc bnc" id="L2966" title="All 2 branches missed.">    if (m_UserComponentsInXML)</span>
<span class="nc" id="L2967">      ext = USERCOMPONENTS_XML_EXTENSION;</span>
<span class="nc" id="L2968">    File sFile = new File(System.getProperty(&quot;user.home&quot;) + File.separator</span>
<span class="nc" id="L2969">        + &quot;.knowledgeFlow&quot; + File.separator + &quot;userComponents&quot; + ext);</span>
<span class="nc bnc" id="L2970" title="All 2 branches missed.">    if (sFile.exists()) {</span>
      try {
<span class="nc bnc" id="L2972" title="All 2 branches missed.">        if (m_UserComponentsInXML) {</span>
<span class="nc" id="L2973">          XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport,</span>
<span class="nc" id="L2974">              XMLBeans.DATATYPE_USERCOMPONENTS);</span>
<span class="nc" id="L2975">          tempV = (Vector) xml.read(sFile);</span>
        } else {
<span class="nc" id="L2977">          InputStream is = new FileInputStream(sFile);</span>
<span class="nc" id="L2978">          ObjectInputStream ois = new ObjectInputStream(is);</span>
<span class="nc" id="L2979">          tempV = (Vector) ois.readObject();</span>
<span class="nc" id="L2980">          ois.close();</span>
        }
<span class="nc" id="L2982">      } catch (Exception ex) {</span>
<span class="nc" id="L2983">        System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L2984">            &quot;KnowledgeFlowApp_LoadUserComponents_Error_Text&quot;));</span>
<span class="nc" id="L2985">        ex.printStackTrace();</span>
<span class="nc" id="L2986">        return;</span>
      }
<span class="nc bnc" id="L2988" title="All 2 branches missed.">      if (tempV.size() &gt; 0) {</span>
        // create the user tab and add the components
<span class="nc bnc" id="L2990" title="All 2 branches missed.">        for (int i = 0; i &lt; tempV.size(); i++) {</span>
<span class="nc" id="L2991">          MetaBean tempB = (MetaBean) tempV.elementAt(i);</span>
<span class="nc" id="L2992">          addToUserToolBar(tempB, false);</span>
        }
      }
    }
<span class="nc" id="L2996">  }</span>

  private void installWindowListenerForSavingUserBeans() {
<span class="nc" id="L2999">    ((java.awt.Window) getTopLevelAncestor())</span>
<span class="nc" id="L3000">        .addWindowListener(new java.awt.event.WindowAdapter() {</span>
          @Override
          public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L3003">            System.out</span>
<span class="nc" id="L3004">                .println(Messages</span>
<span class="nc" id="L3005">                    .getInstance()</span>
<span class="nc" id="L3006">                    .getString(</span>
<span class="nc" id="L3007">                        &quot;KnowledgeFlowApp_InstallWindowListenerForSavingUserBeans_Text&quot;));</span>
<span class="nc" id="L3008">            File sFile = new File(System.getProperty(&quot;user.home&quot;)</span>
<span class="nc" id="L3009">                + File.separator + &quot;.knowledgeFlow&quot;);</span>
<span class="nc bnc" id="L3010" title="All 2 branches missed.">            if (!sFile.exists()) {</span>
<span class="nc bnc" id="L3011" title="All 2 branches missed.">              if (!sFile.mkdir()) {</span>
<span class="nc" id="L3012">                System.err</span>
<span class="nc" id="L3013">                    .println(Messages</span>
<span class="nc" id="L3014">                        .getInstance()</span>
<span class="nc" id="L3015">                        .getString(</span>
<span class="nc" id="L3016">                            &quot;KnowledgeFlowApp_InstallWindowListenerForSavingUserBeans_Error_Text_First&quot;));</span>
              } else {
                // make the plugins subdirectory for the user
<span class="nc" id="L3019">                sFile = new File(sFile.toString() + File.separator + &quot;plugins&quot;);</span>
<span class="nc" id="L3020">                sFile.mkdir();</span>
              }
            }
            try {
<span class="nc" id="L3024">              String ext = &quot;&quot;;</span>
<span class="nc bnc" id="L3025" title="All 2 branches missed.">              if (m_UserComponentsInXML)</span>
<span class="nc" id="L3026">                ext = USERCOMPONENTS_XML_EXTENSION;</span>
<span class="nc" id="L3027">              File sFile2 = new File(sFile.getAbsolutePath() + File.separator</span>
<span class="nc" id="L3028">                  + &quot;userComponents&quot; + ext);</span>

<span class="nc bnc" id="L3030" title="All 2 branches missed.">              if (m_UserComponentsInXML) {</span>
<span class="nc" id="L3031">                XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport,</span>
<span class="nc" id="L3032">                    XMLBeans.DATATYPE_USERCOMPONENTS);</span>
<span class="nc" id="L3033">                xml.write(sFile2, m_userComponents);</span>
              } else {
<span class="nc" id="L3035">                OutputStream os = new FileOutputStream(sFile2);</span>
<span class="nc" id="L3036">                ObjectOutputStream oos = new ObjectOutputStream(os);</span>
<span class="nc" id="L3037">                oos.writeObject(m_userComponents);</span>
<span class="nc" id="L3038">                oos.flush();</span>
<span class="nc" id="L3039">                oos.close();</span>
              }
<span class="nc" id="L3041">            } catch (Exception ex) {</span>
<span class="nc" id="L3042">              System.err</span>
<span class="nc" id="L3043">                  .println(Messages</span>
<span class="nc" id="L3044">                      .getInstance()</span>
<span class="nc" id="L3045">                      .getString(</span>
<span class="nc" id="L3046">                          &quot;KnowledgeFlowApp_InstallWindowListenerForSavingUserBeans_Error_Text_Second&quot;));</span>
<span class="nc" id="L3047">              ex.printStackTrace();</span>
            }

<span class="nc" id="L3050">          }</span>
        });
<span class="nc" id="L3052">  }</span>

  /**
   * Utility method for grabbing the global info help (if it exists) from an
   * arbitrary object
   * 
   * @param tempBean the object to grab global info from
   * @return the global help info or null if global info does not exist
   */
  public static String getGlobalInfo(Object tempBean) {
    // set tool tip text from global info if supplied
<span class="nc" id="L3063">    String gi = null;</span>
    try {
<span class="nc" id="L3065">      BeanInfo bi = Introspector.getBeanInfo(tempBean.getClass());</span>
<span class="nc" id="L3066">      MethodDescriptor[] methods = bi.getMethodDescriptors();</span>
<span class="nc bnc" id="L3067" title="All 2 branches missed.">      for (int i = 0; i &lt; methods.length; i++) {</span>
<span class="nc" id="L3068">        String name = methods[i].getDisplayName();</span>
<span class="nc" id="L3069">        Method meth = methods[i].getMethod();</span>
<span class="nc bnc" id="L3070" title="All 2 branches missed.">        if (name.equals(&quot;globalInfo&quot;)) {</span>
<span class="nc bnc" id="L3071" title="All 2 branches missed.">          if (meth.getReturnType().equals(String.class)) {</span>
<span class="nc" id="L3072">            Object args[] = {};</span>
<span class="nc" id="L3073">            String globalInfo = (String) (meth.invoke(tempBean, args));</span>
<span class="nc" id="L3074">            gi = globalInfo;</span>
<span class="nc" id="L3075">            break;</span>
          }
        }
      }
<span class="nc" id="L3079">    } catch (Exception ex) {</span>

    }
<span class="nc" id="L3082">    return gi;</span>
  }

  /**
   * variable for the KnowLedgeFlow class which would be set to null by the
   * memory monitoring thread to free up some memory if we running out of
   * memory.
   */
  private static KnowledgeFlowApp m_knowledgeFlow;

  /** for monitoring the Memory consumption */
<span class="nc" id="L3093">  private static Memory m_Memory = new Memory(true);</span>

  // list of things to be notified when the startup process of
  // the KnowledgeFlow is complete
<span class="nc" id="L3097">  public static Vector s_startupListeners = new Vector();</span>

  // modifications by Zerbetto
  // If showFileMenu is true, the file menu (open file, new file, save file
  // buttons) is showed
<span class="nc" id="L3102">  private boolean m_showFileMenu = true;</span>

  /**
   * Create the singleton instance of the KnowledgeFlow
   * 
   * @param args can contain a file argument for loading a flow layout (format:
   *          &quot;file=[path to layout file]&quot;) Modified by Zerbetto: you can
   *          specify the path of a knowledge flow layout file at input
   */
  public static void createSingleton(String[] args) {
    // modifications by Zerbetto 05-12-2007
<span class="nc" id="L3113">    String fileName = null;</span>
<span class="nc" id="L3114">    boolean showFileMenu = true;</span>

<span class="nc bnc" id="L3116" title="All 4 branches missed.">    if ((args != null) &amp;&amp; (args.length &gt; 0)) {</span>
<span class="nc bnc" id="L3117" title="All 2 branches missed.">      for (int i = 0; i &lt; args.length; i++) {</span>
<span class="nc" id="L3118">        String arg = args[i];</span>

<span class="nc bnc" id="L3120" title="All 2 branches missed.">        if (arg.startsWith(&quot;file=&quot;)) {</span>
<span class="nc" id="L3121">          fileName = arg.substring(&quot;file=&quot;.length());</span>
<span class="nc bnc" id="L3122" title="All 2 branches missed.">        } else if (arg.startsWith(&quot;showFileMenu=&quot;)) {</span>
<span class="nc" id="L3123">          showFileMenu = Boolean.parseBoolean(arg.substring(&quot;showFileMenu=&quot;</span>
<span class="nc" id="L3124">              .length()));</span>
        }
      }
    }

<span class="nc bnc" id="L3129" title="All 2 branches missed.">    if (m_knowledgeFlow == null) {</span>
<span class="nc" id="L3130">      m_knowledgeFlow = new KnowledgeFlowApp(showFileMenu);</span>
    }

    // end modifications by Zerbetto

    // notify listeners (if any)
<span class="nc bnc" id="L3136" title="All 2 branches missed.">    for (int i = 0; i &lt; s_startupListeners.size(); i++) {</span>
<span class="nc" id="L3137">      ((StartUpListener) s_startupListeners.elementAt(i)).startUpComplete();</span>
    }

    // modifications by Zerbetto 05-12-2007
<span class="nc bnc" id="L3141" title="All 2 branches missed.">    if (fileName != null) {</span>
<span class="nc" id="L3142">      m_knowledgeFlow.loadInitialLayout(fileName);</span>
    }

    // end modifications
<span class="nc" id="L3146">  }</span>

  /**
   * Return the singleton instance of the KnowledgeFlow
   * 
   * @return the singleton instance
   */
  public static KnowledgeFlowApp getSingleton() {
<span class="nc" id="L3154">    return m_knowledgeFlow;</span>
  }

  /**
   * Add a listener to be notified when startup is complete
   * 
   * @param s a listener to add
   */
  public static void addStartupListener(StartUpListener s) {
<span class="nc" id="L3163">    s_startupListeners.add(s);</span>
<span class="nc" id="L3164">  }</span>

  /**
   * Loads the specified file at input
   * 
   * Added by Zerbetto
   */
  // modifications by Zerbetto 05-12-2007
  public void loadInitialLayout(String fileName) {
<span class="nc" id="L3173">    stopFlow();</span>

<span class="nc" id="L3175">    File oFile = new File(fileName);</span>

<span class="nc bnc" id="L3177" title="All 4 branches missed.">    if (oFile.exists() &amp;&amp; oFile.isFile()) {</span>
<span class="nc" id="L3178">      m_FileChooser.setSelectedFile(oFile);</span>

<span class="nc" id="L3180">      int index = fileName.lastIndexOf('.');</span>

<span class="nc bnc" id="L3182" title="All 2 branches missed.">      if (index != -1) {</span>
<span class="nc" id="L3183">        String extension = fileName.substring(index);</span>

<span class="nc bnc" id="L3185" title="All 2 branches missed.">        if (FILE_EXTENSION_XML.equalsIgnoreCase(extension)) {</span>
<span class="nc" id="L3186">          m_FileChooser.setFileFilter(m_knowledgeFlow.m_XMLFilter);</span>
<span class="nc bnc" id="L3187" title="All 2 branches missed.">        } else if (FILE_EXTENSION.equalsIgnoreCase(extension)) {</span>
<span class="nc" id="L3188">          m_FileChooser.setFileFilter(m_knowledgeFlow.m_KfFilter);</span>
        }
      }
    } else {
<span class="nc" id="L3192">      System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L3193">          &quot;KnowledgeFlowApp_LoadInitialLayout_Error_Text_First&quot;)</span>
<span class="nc" id="L3194">          + fileName</span>
<span class="nc" id="L3195">          + Messages.getInstance().getString(</span>
<span class="nc" id="L3196">              &quot;KnowledgeFlowApp_LoadInitialLayout_Error_Text_Second&quot;));</span>
    }

    try {
<span class="nc" id="L3200">      Vector beans = new Vector();</span>
<span class="nc" id="L3201">      Vector connections = new Vector();</span>

      // KOML?
<span class="nc bnc" id="L3204" title="All 2 branches missed.">      if ((KOML.isPresent())</span>
<span class="nc" id="L3205">          &amp;&amp; (oFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L3206" title="All 2 branches missed.">              .endsWith(KOML.FILE_EXTENSION))) {</span>
<span class="nc" id="L3207">        Vector v = (Vector) KOML.read(oFile.getAbsolutePath());</span>
<span class="nc" id="L3208">        beans = (Vector) v.get(XMLBeans.INDEX_BEANINSTANCES);</span>
<span class="nc" id="L3209">        connections = (Vector) v.get(XMLBeans.INDEX_BEANCONNECTIONS);</span>
<span class="nc" id="L3210">      } /* XML? */else if (oFile.getAbsolutePath().toLowerCase()</span>
<span class="nc bnc" id="L3211" title="All 2 branches missed.">          .endsWith(FILE_EXTENSION_XML)) {</span>
<span class="nc" id="L3212">        XMLBeans xml = new XMLBeans(m_beanLayout, m_bcSupport);</span>
<span class="nc" id="L3213">        Vector v = (Vector) xml.read(oFile);</span>
<span class="nc" id="L3214">        beans = (Vector) v.get(XMLBeans.INDEX_BEANINSTANCES);</span>
<span class="nc" id="L3215">        connections = (Vector) v.get(XMLBeans.INDEX_BEANCONNECTIONS);</span>

        // connections = new Vector();
      } /* binary */else {
<span class="nc" id="L3219">        InputStream is = new FileInputStream(oFile);</span>
<span class="nc" id="L3220">        ObjectInputStream ois = new ObjectInputStream(is);</span>
<span class="nc" id="L3221">        beans = (Vector) ois.readObject();</span>
<span class="nc" id="L3222">        connections = (Vector) ois.readObject();</span>
<span class="nc" id="L3223">        ois.close();</span>
      }

<span class="nc" id="L3226">      java.awt.Color bckC = getBackground();</span>
<span class="nc" id="L3227">      m_bcSupport = new BeanContextSupport();</span>
<span class="nc" id="L3228">      m_bcSupport.setDesignTime(true);</span>

      // register this panel as a property change listener with each
      // bean
<span class="nc bnc" id="L3232" title="All 2 branches missed.">      for (int i = 0; i &lt; beans.size(); i++) {</span>
<span class="nc" id="L3233">        BeanInstance tempB = (BeanInstance) beans.elementAt(i);</span>

<span class="nc bnc" id="L3235" title="All 2 branches missed.">        if (tempB.getBean() instanceof Visible) {</span>
<span class="nc" id="L3236">          ((Visible) (tempB.getBean())).getVisual().addPropertyChangeListener(</span>
<span class="nc" id="L3237">              this);</span>

          // A workaround to account for JPanel's with their default
          // background colour not being serializable in Apple's JRE
<span class="nc" id="L3241">          ((Visible) (tempB.getBean())).getVisual().setBackground(bckC);</span>
<span class="nc" id="L3242">          ((JComponent) (tempB.getBean())).setBackground(bckC);</span>
        }

<span class="nc bnc" id="L3245" title="All 2 branches missed.">        if (tempB.getBean() instanceof BeanCommon) {</span>
<span class="nc" id="L3246">          ((BeanCommon) (tempB.getBean())).setLog(m_logPanel);</span>
        }

<span class="nc bnc" id="L3249" title="All 2 branches missed.">        if (tempB.getBean() instanceof BeanContextChild) {</span>
<span class="nc" id="L3250">          m_bcSupport.add(tempB.getBean());</span>
        }
      }

<span class="nc" id="L3254">      BeanInstance.setBeanInstances(beans, m_beanLayout);</span>
<span class="nc" id="L3255">      BeanConnection.setConnections(connections);</span>
<span class="nc" id="L3256">      File fullPath = new File(oFile.getAbsolutePath().toString());</span>
<span class="nc" id="L3257">      m_flowEnvironment.addVariable(&quot;Internal.knowledgeflow.directory&quot;,</span>
<span class="nc" id="L3258">          fullPath.getParent());</span>
<span class="nc" id="L3259">      setEnvironment();</span>

<span class="nc" id="L3261">      m_beanLayout.revalidate();</span>
<span class="nc" id="L3262">      m_beanLayout.repaint();</span>
<span class="nc" id="L3263">    } catch (Exception ex) {</span>
<span class="nc" id="L3264">      ex.printStackTrace();</span>
    }
<span class="nc" id="L3266">  }</span>

  // end modifications

  /**
   * Notifies to the parent swt that the layout is dirty
   * 
   * Added by Zerbetto
   */
  private void notifyIsDirty() {
    // this.firePropertyChange(new Integer(IEditorPart.PROP_DIRTY).toString(),
    // null, null);
<span class="nc" id="L3278">    this.firePropertyChange(&quot;PROP_DIRTY&quot;, null, null);</span>
<span class="nc" id="L3279">  }</span>

  /**
   * Main method.
   * 
   * @param args a &lt;code&gt;String[]&lt;/code&gt; value
   */
  public static void main(String[] args) {

<span class="nc" id="L3288">    LookAndFeel.setLookAndFeel();</span>

    try {
      // uncomment to disable the memory management:
      // m_Memory.setEnabled(false);

<span class="nc" id="L3294">      final javax.swing.JFrame jf = new javax.swing.JFrame();</span>
<span class="nc" id="L3295">      jf.getContentPane().setLayout(new java.awt.BorderLayout());</span>
      // final KnowledgeFlowApp tm = new KnowledgeFlowApp();
      // m_knowledgeFlow = new KnowledgeFlowApp(true);

<span class="nc bnc" id="L3299" title="All 2 branches missed.">      for (int i = 0; i &lt; args.length; i++) {</span>
<span class="nc bnc" id="L3300" title="All 2 branches missed.">        if (args[i].toLowerCase().endsWith(&quot;.kf&quot;)</span>
<span class="nc bnc" id="L3301" title="All 2 branches missed.">            || args[i].toLowerCase().endsWith(&quot;.kfml&quot;)) {</span>
<span class="nc" id="L3302">          args[i] = &quot;file=&quot; + args[i];</span>
        }
      }

<span class="nc" id="L3306">      KnowledgeFlowApp.createSingleton(args);</span>

<span class="nc" id="L3308">      Image icon = Toolkit.getDefaultToolkit().getImage(</span>
<span class="nc" id="L3309">          m_knowledgeFlow.getClass().getClassLoader()</span>
<span class="nc" id="L3310">              .getResource(&quot;weka/gui/weka_icon_new_48.png&quot;));</span>
<span class="nc" id="L3311">      jf.setIconImage(icon);</span>

<span class="nc" id="L3313">      jf.getContentPane().add(m_knowledgeFlow, java.awt.BorderLayout.CENTER);</span>
<span class="nc" id="L3314">      jf.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>

<span class="nc" id="L3316">      jf.setSize(1000, 750);</span>
<span class="nc" id="L3317">      jf.setVisible(true);</span>

<span class="nc" id="L3319">      Thread memMonitor = new Thread() {</span>
        @Override
        public void run() {
<span class="nc" id="L3322">          while (true) {</span>
            try {
              // System.out.println(&quot;Before sleeping&quot;);
<span class="nc" id="L3325">              this.sleep(4000);</span>

<span class="nc" id="L3327">              System.gc();</span>

<span class="nc bnc" id="L3329" title="All 2 branches missed.">              if (m_Memory.isOutOfMemory()) {</span>
                // clean up
<span class="nc" id="L3331">                jf.dispose();</span>
<span class="nc" id="L3332">                m_knowledgeFlow = null;</span>
<span class="nc" id="L3333">                System.gc();</span>

                // display error
<span class="nc" id="L3336">                System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L3337">                    &quot;KnowledgeFlowApp_Main_Error_Text_First&quot;));</span>
<span class="nc" id="L3338">                m_Memory.showOutOfMemory();</span>
<span class="nc" id="L3339">                System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L3340">                    &quot;KnowledgeFlowApp_Main_Error_Text_Second&quot;));</span>
<span class="nc" id="L3341">                System.exit(-1);</span>
              }

<span class="nc" id="L3344">            } catch (InterruptedException ex) {</span>
<span class="nc" id="L3345">              ex.printStackTrace();</span>
            }
          }
        }
      };

<span class="nc" id="L3351">      memMonitor.setPriority(Thread.NORM_PRIORITY);</span>
<span class="nc" id="L3352">      memMonitor.start();</span>
<span class="nc" id="L3353">    } catch (Exception ex) {</span>
<span class="nc" id="L3354">      ex.printStackTrace();</span>
<span class="nc" id="L3355">      System.err.println(ex.getMessage());</span>
    }
<span class="nc" id="L3357">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (Nov 28, 2015 2:34:31 PM)</div></body></html>