<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>ClustererPanel.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Nov 28, 2015 2:34:31 PM)</a> &gt; <a href="../../index.html" class="el_group">wekaproject</a> &gt; <a href="../index.html" class="el_bundle">src/src/main/java</a> &gt; <a href="index.source.html" class="el_package">weka.gui.explorer</a> &gt; <span class="el_source">ClustererPanel.java</span></div><h1>ClustererPanel.java</h1><pre class="source lang-java linenums"><span class="nc" id="L1">/*</span>
 *    This program is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program; if not, write to the Free Software
 *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

/*
 *    ClustererPanel.java
 *    Copyright (C) 1999 University of Waikato, Hamilton, New Zealand
 *
 */

package weka.gui.explorer;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Insets;
import java.awt.Point;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.InputEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Random;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import javax.swing.BorderFactory;
import javax.swing.ButtonGroup;
import javax.swing.DefaultComboBoxModel;
import javax.swing.DefaultListModel;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JRadioButton;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.JViewport;
import javax.swing.SwingConstants;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.filechooser.FileFilter;

import weka.clusterers.ClusterEvaluation;
import weka.clusterers.Clusterer;
import weka.core.Attribute;
import weka.core.Capabilities;
import weka.core.CapabilitiesHandler;
import weka.core.Drawable;
import weka.core.FastVector;
import weka.core.Instance;
import weka.core.Instances;
import weka.core.OptionHandler;
import weka.core.SerializedObject;
import weka.core.Utils;
import weka.filters.Filter;
import weka.filters.unsupervised.attribute.Remove;
import weka.gui.ExtensionFileFilter;
import weka.gui.GenericObjectEditor;
import weka.gui.InstancesSummaryPanel;
import weka.gui.ListSelectorDialog;
import weka.gui.Logger;
import weka.gui.PropertyPanel;
import weka.gui.ResultHistoryPanel;
import weka.gui.SaveBuffer;
import weka.gui.SetInstancesPanel;
import weka.gui.SysErrLog;
import weka.gui.TaskLogger;
import weka.gui.explorer.Explorer.CapabilitiesFilterChangeEvent;
import weka.gui.explorer.Explorer.CapabilitiesFilterChangeListener;
import weka.gui.explorer.Explorer.ExplorerPanel;
import weka.gui.explorer.Explorer.LogHandler;
import weka.gui.hierarchyvisualizer.HierarchyVisualizer;
import weka.gui.treevisualizer.PlaceNode2;
import weka.gui.treevisualizer.TreeVisualizer;
import weka.gui.visualize.Plot2D;
import weka.gui.visualize.PlotData2D;
import weka.gui.visualize.VisualizePanel;

/**
 * This panel allows the user to select and configure a clusterer, and evaluate
 * the clusterer using a number of testing modes (test on the training data,
 * train/test on a percentage split, test on a separate split). The results of
 * clustering runs are stored in a result history so that previous results are
 * accessible.
 * 
 * @author Mark Hall (mhall@cs.waikato.ac.nz)
 * @author Richard Kirkby (rkirkby@cs.waikato.ac.nz)
 * @version $Revision: 9728 $
 */
<span class="nc" id="L125">public class ClustererPanel extends JPanel implements</span>
    CapabilitiesFilterChangeListener, ExplorerPanel, LogHandler {

  /** for serialization */
  static final long serialVersionUID = -2474932792950820990L;

  /** the parent frame */
<span class="nc" id="L132">  protected Explorer m_Explorer = null;</span>

  /** The filename extension that should be used for model files */
<span class="nc" id="L135">  public static String MODEL_FILE_EXTENSION = &quot;.model&quot;;</span>

  /** Lets the user configure the clusterer */
<span class="nc" id="L138">  protected GenericObjectEditor m_ClustererEditor = new GenericObjectEditor();</span>

  /** The panel showing the current clusterer selection */
<span class="nc" id="L141">  protected PropertyPanel m_CLPanel = new PropertyPanel(m_ClustererEditor);</span>

  /** The output area for classification results */
<span class="nc" id="L144">  protected JTextArea m_OutText = new JTextArea(20, 40);</span>

  /** The destination for log/status messages */
<span class="nc" id="L147">  protected Logger m_Log = new SysErrLog();</span>

  /** The buffer saving object for saving output */
<span class="nc" id="L150">  SaveBuffer m_SaveOut = new SaveBuffer(m_Log, this);</span>

  /** A panel controlling results viewing */
<span class="nc" id="L153">  protected ResultHistoryPanel m_History = new ResultHistoryPanel(m_OutText);</span>

  /** Click to set test mode to generate a % split */
<span class="nc" id="L156">  protected JRadioButton m_PercentBut = new JRadioButton(Messages.getInstance()</span>
<span class="nc" id="L157">      .getString(&quot;ClustererPanel_PercentBut_JRadioButton_Text&quot;));</span>

  /** Click to set test mode to test on training data */
<span class="nc" id="L160">  protected JRadioButton m_TrainBut = new JRadioButton(Messages.getInstance()</span>
<span class="nc" id="L161">      .getString(&quot;ClustererPanel_TrainBut_JRadioButton_Text&quot;));</span>

  /** Click to set test mode to a user-specified test set */
<span class="nc" id="L164">  protected JRadioButton m_TestSplitBut = new JRadioButton(Messages</span>
<span class="nc" id="L165">      .getInstance().getString(&quot;ClustererPanel_TestSplitBut_JRadioButton_Text&quot;));</span>

  /** Click to set test mode to classes to clusters based evaluation */
<span class="nc" id="L168">  protected JRadioButton m_ClassesToClustersBut = new JRadioButton(Messages</span>
<span class="nc" id="L169">      .getInstance().getString(</span>
<span class="nc" id="L170">          &quot;ClustererPanel_ClassesToClustersBut_JRadioButton_Text&quot;));</span>

  /**
   * Lets the user select the class column for classes to clusters based
   * evaluation
   */
<span class="nc" id="L176">  protected JComboBox m_ClassCombo = new JComboBox();</span>

  /** Label by where the % split is entered */
<span class="nc" id="L179">  protected JLabel m_PercentLab = new JLabel(&quot;%&quot;, SwingConstants.RIGHT);</span>

  /** The field where the % split is entered */
<span class="nc" id="L182">  protected JTextField m_PercentText = new JTextField(&quot;66&quot;);</span>

  /** The button used to open a separate test dataset */
<span class="nc" id="L185">  protected JButton m_SetTestBut = new JButton(Messages.getInstance()</span>
<span class="nc" id="L186">      .getString(&quot;ClustererPanel_SetTestBut_JButton_Text&quot;));</span>

  /** The frame used to show the test set selection panel */
  protected JFrame m_SetTestFrame;

  /**
   * The button used to popup a list for choosing attributes to ignore while
   * clustering
   */
<span class="nc" id="L195">  protected JButton m_ignoreBut = new JButton(Messages.getInstance().getString(</span>
<span class="nc" id="L196">      &quot;ClustererPanel_IgnoreBut_JButton_Text&quot;));</span>

<span class="nc" id="L198">  protected DefaultListModel m_ignoreKeyModel = new DefaultListModel();</span>
<span class="nc" id="L199">  protected JList m_ignoreKeyList = new JList(m_ignoreKeyModel);</span>

  // protected Remove m_ignoreFilter = null;

  /**
   * Alters the enabled/disabled status of elements associated with each radio
   * button
   */
<span class="nc" id="L207">  ActionListener m_RadioListener = new ActionListener() {</span>
    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L209">      updateRadioLinks();</span>
<span class="nc" id="L210">    }</span>
  };

  /** Click to start running the clusterer */
<span class="nc" id="L214">  protected JButton m_StartBut = new JButton(Messages.getInstance().getString(</span>
<span class="nc" id="L215">      &quot;ClustererPanel_StartBut_JButton_Text&quot;));</span>

  /** Stop the class combo from taking up to much space */
<span class="nc" id="L218">  private final Dimension COMBO_SIZE = new Dimension(250,</span>
<span class="nc" id="L219">      m_StartBut.getPreferredSize().height);</span>

  /** Click to stop a running clusterer */
<span class="nc" id="L222">  protected JButton m_StopBut = new JButton(Messages.getInstance().getString(</span>
<span class="nc" id="L223">      &quot;ClustererPanel_StopBut_JButton_Text&quot;));</span>

  /** The main set of instances we're playing with */
  protected Instances m_Instances;

  /** The user-supplied test set (if any) */
  protected Instances m_TestInstances;

  /** The current visualization object */
<span class="nc" id="L232">  protected VisualizePanel m_CurrentVis = null;</span>

  /**
   * Check to save the predictions in the results list for visualizing later on
   */
<span class="nc" id="L237">  protected JCheckBox m_StorePredictionsBut = new JCheckBox(Messages</span>
<span class="nc" id="L238">      .getInstance().getString(&quot;ClustererPanel_StopBut_JCheckBox_Text&quot;));</span>

  /** A thread that clustering runs in */
  protected Thread m_RunThread;

  /** The instances summary panel displayed by m_SetTestFrame */
  protected InstancesSummaryPanel m_Summary;

  /** Filter to ensure only model files are selected */
<span class="nc" id="L247">  protected FileFilter m_ModelFilter = new ExtensionFileFilter(</span>
<span class="nc" id="L248">      MODEL_FILE_EXTENSION, Messages.getInstance().getString(</span>
<span class="nc" id="L249">          &quot;ClustererPanel_ModelFilter_ExtensionFileFilter_Text&quot;));</span>

  /** The file chooser for selecting model files */
<span class="nc" id="L252">  protected JFileChooser m_FileChooser = new JFileChooser(new File(</span>
<span class="nc" id="L253">      System.getProperty(&quot;user.dir&quot;)));</span>

  /* Register the property editors we need */
  static {
<span class="nc" id="L257">    GenericObjectEditor.registerEditors();</span>
  }

  /**
   * Creates the clusterer panel
   */
<span class="nc" id="L263">  public ClustererPanel() {</span>

    // Connect / configure the components
<span class="nc" id="L266">    m_OutText.setEditable(false);</span>
<span class="nc" id="L267">    m_OutText.setFont(new Font(&quot;Monospaced&quot;, Font.PLAIN, 12));</span>
<span class="nc" id="L268">    m_OutText.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));</span>
<span class="nc" id="L269">    m_OutText.addMouseListener(new MouseAdapter() {</span>
      @Override
      public void mouseClicked(MouseEvent e) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if ((e.getModifiers() &amp; InputEvent.BUTTON1_MASK) != InputEvent.BUTTON1_MASK) {</span>
<span class="nc" id="L273">          m_OutText.selectAll();</span>
        }
<span class="nc" id="L275">      }</span>
    });
<span class="nc" id="L277">    m_History.setBorder(BorderFactory.createTitledBorder(Messages.getInstance()</span>
<span class="nc" id="L278">        .getString(</span>
<span class="nc" id="L279">            &quot;ClustererPanel_History_BorderFactoryCreateTitledBorder_Text&quot;)));</span>
<span class="nc" id="L280">    m_ClustererEditor.setClassType(Clusterer.class);</span>
<span class="nc" id="L281">    m_ClustererEditor.setValue(ExplorerDefaults.getClusterer());</span>
<span class="nc" id="L282">    m_ClustererEditor.addPropertyChangeListener(new PropertyChangeListener() {</span>
      public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L284">        m_StartBut.setEnabled(true);</span>
<span class="nc" id="L285">        Capabilities currentFilter = m_ClustererEditor.getCapabilitiesFilter();</span>
<span class="nc" id="L286">        Clusterer clusterer = (Clusterer) m_ClustererEditor.getValue();</span>
<span class="nc" id="L287">        Capabilities currentSchemeCapabilities = null;</span>
<span class="nc bnc" id="L288" title="All 4 branches missed.">        if (clusterer != null &amp;&amp; currentFilter != null</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            &amp;&amp; (clusterer instanceof CapabilitiesHandler)) {</span>
<span class="nc" id="L290">          currentSchemeCapabilities = ((CapabilitiesHandler) clusterer)</span>
<span class="nc" id="L291">              .getCapabilities();</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">          if (!currentSchemeCapabilities.supportsMaybe(currentFilter)</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">              &amp;&amp; !currentSchemeCapabilities.supports(currentFilter)) {</span>
<span class="nc" id="L295">            m_StartBut.setEnabled(false);</span>
          }
        }
<span class="nc" id="L298">        repaint();</span>
<span class="nc" id="L299">      }</span>
    });

<span class="nc" id="L302">    m_TrainBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L303">        &quot;ClustererPanel_TrainBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L304">    m_PercentBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L305">        &quot;ClustererPanel_PercentBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L306">    m_TestSplitBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L307">        &quot;ClustererPanel_TestSplitBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L308">    m_ClassesToClustersBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L309">        &quot;ClustererPanel_ClassesToClustersBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L310">    m_ClassCombo.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L311">        &quot;ClustererPanel_ClassCombo_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L312">    m_StartBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L313">        &quot;ClustererPanel_StartBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L314">    m_StopBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L315">        &quot;ClustererPanel_StartBut_StopBut_Text&quot;));</span>
<span class="nc" id="L316">    m_StorePredictionsBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L317">        &quot;ClustererPanel_StorePredictionsBut_SetToolTipText_Text&quot;));</span>
<span class="nc" id="L318">    m_ignoreBut.setToolTipText(Messages.getInstance().getString(</span>
<span class="nc" id="L319">        &quot;ClustererPanel_IgnoreBut_SetToolTipText_Text&quot;));</span>

<span class="nc" id="L321">    m_FileChooser.setFileFilter(m_ModelFilter);</span>
<span class="nc" id="L322">    m_FileChooser.setFileSelectionMode(JFileChooser.FILES_ONLY);</span>

<span class="nc" id="L324">    m_ClassCombo.setPreferredSize(COMBO_SIZE);</span>
<span class="nc" id="L325">    m_ClassCombo.setMaximumSize(COMBO_SIZE);</span>
<span class="nc" id="L326">    m_ClassCombo.setMinimumSize(COMBO_SIZE);</span>
<span class="nc" id="L327">    m_ClassCombo.setEnabled(false);</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">    m_PercentBut.setSelected(ExplorerDefaults.getClustererTestMode() == 2);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">    m_TrainBut.setSelected(ExplorerDefaults.getClustererTestMode() == 3);</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">    m_TestSplitBut.setSelected(ExplorerDefaults.getClustererTestMode() == 4);</span>
<span class="nc" id="L332">    m_ClassesToClustersBut</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        .setSelected(ExplorerDefaults.getClustererTestMode() == 5);</span>
<span class="nc" id="L334">    m_StorePredictionsBut.setSelected(ExplorerDefaults</span>
<span class="nc" id="L335">        .getClustererStoreClustersForVis());</span>
<span class="nc" id="L336">    updateRadioLinks();</span>
<span class="nc" id="L337">    ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L338">    bg.add(m_TrainBut);</span>
<span class="nc" id="L339">    bg.add(m_PercentBut);</span>
<span class="nc" id="L340">    bg.add(m_TestSplitBut);</span>
<span class="nc" id="L341">    bg.add(m_ClassesToClustersBut);</span>
<span class="nc" id="L342">    m_TrainBut.addActionListener(m_RadioListener);</span>
<span class="nc" id="L343">    m_PercentBut.addActionListener(m_RadioListener);</span>
<span class="nc" id="L344">    m_TestSplitBut.addActionListener(m_RadioListener);</span>
<span class="nc" id="L345">    m_ClassesToClustersBut.addActionListener(m_RadioListener);</span>
<span class="nc" id="L346">    m_SetTestBut.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L348">        setTestSet();</span>
<span class="nc" id="L349">      }</span>
    });

<span class="nc" id="L352">    m_StartBut.setEnabled(false);</span>
<span class="nc" id="L353">    m_StopBut.setEnabled(false);</span>
<span class="nc" id="L354">    m_ignoreBut.setEnabled(false);</span>
<span class="nc" id="L355">    m_StartBut.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L357">        boolean proceed = true;</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (Explorer.m_Memory.memoryIsLow()) {</span>
<span class="nc" id="L359">          proceed = Explorer.m_Memory.showMemoryIsLow();</span>
        }

<span class="nc bnc" id="L362" title="All 2 branches missed.">        if (proceed) {</span>
<span class="nc" id="L363">          startClusterer();</span>
        }
<span class="nc" id="L365">      }</span>
    });
<span class="nc" id="L367">    m_StopBut.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L369">        stopClusterer();</span>
<span class="nc" id="L370">      }</span>
    });

<span class="nc" id="L373">    m_ignoreBut.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L375">        setIgnoreColumns();</span>
<span class="nc" id="L376">      }</span>
    });

<span class="nc" id="L379">    m_History.setHandleRightClicks(false);</span>
    // see if we can popup a menu for the selected result
<span class="nc" id="L381">    m_History.getList().addMouseListener(new MouseAdapter() {</span>
      @Override
      public void mouseClicked(MouseEvent e) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (((e.getModifiers() &amp; InputEvent.BUTTON1_MASK) != InputEvent.BUTTON1_MASK)</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">            || e.isAltDown()) {</span>
<span class="nc" id="L386">          int index = m_History.getList().locationToIndex(e.getPoint());</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">          if (index != -1) {</span>
<span class="nc" id="L388">            String name = m_History.getNameAtIndex(index);</span>
<span class="nc" id="L389">            visualizeClusterer(name, e.getX(), e.getY());</span>
          } else {
<span class="nc" id="L391">            visualizeClusterer(null, e.getX(), e.getY());</span>
          }
        }
<span class="nc" id="L394">      }</span>
    });

<span class="nc" id="L397">    m_ClassCombo.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L399">        updateCapabilitiesFilter(m_ClustererEditor.getCapabilitiesFilter());</span>
<span class="nc" id="L400">      }</span>
    });

    // Layout the GUI
<span class="nc" id="L404">    JPanel p1 = new JPanel();</span>
<span class="nc" id="L405">    p1.setBorder(BorderFactory.createCompoundBorder(</span>
<span class="nc" id="L406">        BorderFactory.createTitledBorder(Messages.getInstance().getString(</span>
<span class="nc" id="L407">            &quot;ClustererPanel_P1_BorderFactoryCreateTitledBorder_Text&quot;)),</span>
<span class="nc" id="L408">        BorderFactory.createEmptyBorder(0, 5, 5, 5)));</span>
<span class="nc" id="L409">    p1.setLayout(new BorderLayout());</span>
<span class="nc" id="L410">    p1.add(m_CLPanel, BorderLayout.NORTH);</span>

<span class="nc" id="L412">    JPanel p2 = new JPanel();</span>
<span class="nc" id="L413">    GridBagLayout gbL = new GridBagLayout();</span>
<span class="nc" id="L414">    p2.setLayout(gbL);</span>
<span class="nc" id="L415">    p2.setBorder(BorderFactory.createCompoundBorder(</span>
<span class="nc" id="L416">        BorderFactory.createTitledBorder(Messages.getInstance().getString(</span>
<span class="nc" id="L417">            &quot;ClustererPanel_P2_BorderFactoryCreateTitledBorder_Text&quot;)),</span>
<span class="nc" id="L418">        BorderFactory.createEmptyBorder(0, 5, 5, 5)));</span>
<span class="nc" id="L419">    GridBagConstraints gbC = new GridBagConstraints();</span>
<span class="nc" id="L420">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L421">    gbC.gridy = 0;</span>
<span class="nc" id="L422">    gbC.gridx = 0;</span>
<span class="nc" id="L423">    gbL.setConstraints(m_TrainBut, gbC);</span>
<span class="nc" id="L424">    p2.add(m_TrainBut);</span>

<span class="nc" id="L426">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L427">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L428">    gbC.gridy = 1;</span>
<span class="nc" id="L429">    gbC.gridx = 0;</span>
<span class="nc" id="L430">    gbL.setConstraints(m_TestSplitBut, gbC);</span>
<span class="nc" id="L431">    p2.add(m_TestSplitBut);</span>

<span class="nc" id="L433">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L434">    gbC.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L435">    gbC.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L436">    gbC.gridy = 1;</span>
<span class="nc" id="L437">    gbC.gridx = 1;</span>
<span class="nc" id="L438">    gbC.gridwidth = 2;</span>
<span class="nc" id="L439">    gbC.insets = new Insets(2, 10, 2, 0);</span>
<span class="nc" id="L440">    gbL.setConstraints(m_SetTestBut, gbC);</span>
<span class="nc" id="L441">    p2.add(m_SetTestBut);</span>

<span class="nc" id="L443">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L444">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L445">    gbC.gridy = 2;</span>
<span class="nc" id="L446">    gbC.gridx = 0;</span>
<span class="nc" id="L447">    gbL.setConstraints(m_PercentBut, gbC);</span>
<span class="nc" id="L448">    p2.add(m_PercentBut);</span>

<span class="nc" id="L450">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L451">    gbC.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L452">    gbC.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L453">    gbC.gridy = 2;</span>
<span class="nc" id="L454">    gbC.gridx = 1;</span>
<span class="nc" id="L455">    gbC.insets = new Insets(2, 10, 2, 10);</span>
<span class="nc" id="L456">    gbL.setConstraints(m_PercentLab, gbC);</span>
<span class="nc" id="L457">    p2.add(m_PercentLab);</span>

<span class="nc" id="L459">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L460">    gbC.anchor = GridBagConstraints.EAST;</span>
<span class="nc" id="L461">    gbC.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L462">    gbC.gridy = 2;</span>
<span class="nc" id="L463">    gbC.gridx = 2;</span>
<span class="nc" id="L464">    gbC.weightx = 100;</span>
<span class="nc" id="L465">    gbC.ipadx = 20;</span>
<span class="nc" id="L466">    gbL.setConstraints(m_PercentText, gbC);</span>
<span class="nc" id="L467">    p2.add(m_PercentText);</span>

<span class="nc" id="L469">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L470">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L471">    gbC.gridy = 3;</span>
<span class="nc" id="L472">    gbC.gridx = 0;</span>
<span class="nc" id="L473">    gbC.gridwidth = 2;</span>
<span class="nc" id="L474">    gbL.setConstraints(m_ClassesToClustersBut, gbC);</span>
<span class="nc" id="L475">    p2.add(m_ClassesToClustersBut);</span>

<span class="nc" id="L477">    m_ClassCombo.setBorder(BorderFactory.createEmptyBorder(0, 20, 0, 0));</span>
<span class="nc" id="L478">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L479">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L480">    gbC.gridy = 4;</span>
<span class="nc" id="L481">    gbC.gridx = 0;</span>
<span class="nc" id="L482">    gbC.gridwidth = 2;</span>
<span class="nc" id="L483">    gbL.setConstraints(m_ClassCombo, gbC);</span>
<span class="nc" id="L484">    p2.add(m_ClassCombo);</span>

<span class="nc" id="L486">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L487">    gbC.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L488">    gbC.gridy = 5;</span>
<span class="nc" id="L489">    gbC.gridx = 0;</span>
<span class="nc" id="L490">    gbC.gridwidth = 2;</span>
<span class="nc" id="L491">    gbL.setConstraints(m_StorePredictionsBut, gbC);</span>
<span class="nc" id="L492">    p2.add(m_StorePredictionsBut);</span>

<span class="nc" id="L494">    JPanel buttons = new JPanel();</span>
<span class="nc" id="L495">    buttons.setLayout(new GridLayout(2, 1));</span>
<span class="nc" id="L496">    JPanel ssButs = new JPanel();</span>
<span class="nc" id="L497">    ssButs.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));</span>
<span class="nc" id="L498">    ssButs.setLayout(new GridLayout(1, 2, 5, 5));</span>
<span class="nc" id="L499">    ssButs.add(m_StartBut);</span>
<span class="nc" id="L500">    ssButs.add(m_StopBut);</span>

<span class="nc" id="L502">    JPanel ib = new JPanel();</span>
<span class="nc" id="L503">    ib.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));</span>
<span class="nc" id="L504">    ib.setLayout(new GridLayout(1, 1, 5, 5));</span>
<span class="nc" id="L505">    ib.add(m_ignoreBut);</span>
<span class="nc" id="L506">    buttons.add(ib);</span>
<span class="nc" id="L507">    buttons.add(ssButs);</span>

<span class="nc" id="L509">    JPanel p3 = new JPanel();</span>
<span class="nc" id="L510">    p3.setBorder(BorderFactory.createTitledBorder(Messages.getInstance()</span>
<span class="nc" id="L511">        .getString(&quot;ClustererPanel_P3_BorderFactoryCreateTitledBorder_Text&quot;)));</span>
<span class="nc" id="L512">    p3.setLayout(new BorderLayout());</span>
<span class="nc" id="L513">    final JScrollPane js = new JScrollPane(m_OutText);</span>
<span class="nc" id="L514">    p3.add(js, BorderLayout.CENTER);</span>
<span class="nc" id="L515">    js.getViewport().addChangeListener(new ChangeListener() {</span>
      private int lastHeight;

      public void stateChanged(ChangeEvent e) {
<span class="nc" id="L519">        JViewport vp = (JViewport) e.getSource();</span>
<span class="nc" id="L520">        int h = vp.getViewSize().height;</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (h != lastHeight) { // i.e. an addition not just a user scrolling</span>
<span class="nc" id="L522">          lastHeight = h;</span>
<span class="nc" id="L523">          int x = h - vp.getExtentSize().height;</span>
<span class="nc" id="L524">          vp.setViewPosition(new Point(0, x));</span>
        }
<span class="nc" id="L526">      }</span>
    });

<span class="nc" id="L529">    JPanel mondo = new JPanel();</span>
<span class="nc" id="L530">    gbL = new GridBagLayout();</span>
<span class="nc" id="L531">    mondo.setLayout(gbL);</span>
<span class="nc" id="L532">    gbC = new GridBagConstraints();</span>
    // gbC.anchor = GridBagConstraints.WEST;
<span class="nc" id="L534">    gbC.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L535">    gbC.gridy = 0;</span>
<span class="nc" id="L536">    gbC.gridx = 0;</span>
<span class="nc" id="L537">    gbL.setConstraints(p2, gbC);</span>
<span class="nc" id="L538">    mondo.add(p2);</span>
<span class="nc" id="L539">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L540">    gbC.anchor = GridBagConstraints.NORTH;</span>
<span class="nc" id="L541">    gbC.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L542">    gbC.gridy = 1;</span>
<span class="nc" id="L543">    gbC.gridx = 0;</span>
<span class="nc" id="L544">    gbL.setConstraints(buttons, gbC);</span>
<span class="nc" id="L545">    mondo.add(buttons);</span>
<span class="nc" id="L546">    gbC = new GridBagConstraints();</span>
    // gbC.anchor = GridBagConstraints.NORTH;
<span class="nc" id="L548">    gbC.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L549">    gbC.gridy = 2;</span>
<span class="nc" id="L550">    gbC.gridx = 0;</span>
<span class="nc" id="L551">    gbC.weightx = 0;</span>
<span class="nc" id="L552">    gbL.setConstraints(m_History, gbC);</span>
<span class="nc" id="L553">    mondo.add(m_History);</span>
<span class="nc" id="L554">    gbC = new GridBagConstraints();</span>
<span class="nc" id="L555">    gbC.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L556">    gbC.gridy = 0;</span>
<span class="nc" id="L557">    gbC.gridx = 1;</span>
<span class="nc" id="L558">    gbC.gridheight = 3;</span>
<span class="nc" id="L559">    gbC.weightx = 100;</span>
<span class="nc" id="L560">    gbC.weighty = 100;</span>
<span class="nc" id="L561">    gbL.setConstraints(p3, gbC);</span>
<span class="nc" id="L562">    mondo.add(p3);</span>

<span class="nc" id="L564">    setLayout(new BorderLayout());</span>
<span class="nc" id="L565">    add(p1, BorderLayout.NORTH);</span>
<span class="nc" id="L566">    add(mondo, BorderLayout.CENTER);</span>
<span class="nc" id="L567">  }</span>

  /**
   * Updates the enabled status of the input fields and labels.
   */
  protected void updateRadioLinks() {

<span class="nc" id="L574">    m_SetTestBut.setEnabled(m_TestSplitBut.isSelected());</span>
<span class="nc bnc" id="L575" title="All 4 branches missed.">    if ((m_SetTestFrame != null) &amp;&amp; (!m_TestSplitBut.isSelected())) {</span>
<span class="nc" id="L576">      m_SetTestFrame.setVisible(false);</span>
    }
<span class="nc" id="L578">    m_PercentText.setEnabled(m_PercentBut.isSelected());</span>
<span class="nc" id="L579">    m_PercentLab.setEnabled(m_PercentBut.isSelected());</span>
<span class="nc" id="L580">    m_ClassCombo.setEnabled(m_ClassesToClustersBut.isSelected());</span>

<span class="nc" id="L582">    updateCapabilitiesFilter(m_ClustererEditor.getCapabilitiesFilter());</span>
<span class="nc" id="L583">  }</span>

  /**
   * Sets the Logger to receive informational messages
   * 
   * @param newLog the Logger that will now get info messages
   */
  public void setLog(Logger newLog) {

<span class="nc" id="L592">    m_Log = newLog;</span>
<span class="nc" id="L593">  }</span>

  /**
   * Tells the panel to use a new set of instances.
   * 
   * @param inst a set of Instances
   */
  public void setInstances(Instances inst) {

<span class="nc" id="L602">    m_Instances = inst;</span>

<span class="nc" id="L604">    m_ignoreKeyModel.removeAllElements();</span>

<span class="nc" id="L606">    String[] attribNames = new String[m_Instances.numAttributes()];</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">    for (int i = 0; i &lt; m_Instances.numAttributes(); i++) {</span>
<span class="nc" id="L608">      String name = m_Instances.attribute(i).name();</span>
<span class="nc" id="L609">      m_ignoreKeyModel.addElement(name);</span>

<span class="nc" id="L611">      String type = &quot;&quot;;</span>
<span class="nc bnc" id="L612" title="All 6 branches missed.">      switch (m_Instances.attribute(i).type()) {</span>
      case Attribute.NOMINAL:
<span class="nc" id="L614">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L615">            &quot;ClustererPanel_SetInstances_Type_AttributeNOMINAL_Text&quot;);</span>
<span class="nc" id="L616">        break;</span>
      case Attribute.NUMERIC:
<span class="nc" id="L618">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L619">            &quot;ClustererPanel_SetInstances_Type_AttributeNUMERIC_Text&quot;);</span>
<span class="nc" id="L620">        break;</span>
      case Attribute.STRING:
<span class="nc" id="L622">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L623">            &quot;ClustererPanel_SetInstances_Type_AttributeSTRING_Text&quot;);</span>
<span class="nc" id="L624">        break;</span>
      case Attribute.DATE:
<span class="nc" id="L626">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L627">            &quot;ClustererPanel_SetInstances_Type_AttributeDATE_Text&quot;);</span>
<span class="nc" id="L628">        break;</span>
      case Attribute.RELATIONAL:
<span class="nc" id="L630">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L631">            &quot;ClustererPanel_SetInstances_Type_AttributeRELATIONAL_Text&quot;);</span>
<span class="nc" id="L632">        break;</span>
      default:
<span class="nc" id="L634">        type = Messages.getInstance().getString(</span>
<span class="nc" id="L635">            &quot;ClustererPanel_SetInstances_Type_AttributeDEFAULT_Text&quot;);</span>
      }
<span class="nc" id="L637">      String attnm = m_Instances.attribute(i).name();</span>

<span class="nc" id="L639">      attribNames[i] = type + attnm;</span>
    }

<span class="nc bnc" id="L642" title="All 2 branches missed.">    m_StartBut.setEnabled(m_RunThread == null);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">    m_StopBut.setEnabled(m_RunThread != null);</span>
<span class="nc" id="L644">    m_ignoreBut.setEnabled(true);</span>
<span class="nc" id="L645">    m_ClassCombo.setModel(new DefaultComboBoxModel(attribNames));</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">    if (inst.classIndex() == -1)</span>
<span class="nc" id="L647">      m_ClassCombo.setSelectedIndex(attribNames.length - 1);</span>
    else
<span class="nc" id="L649">      m_ClassCombo.setSelectedIndex(inst.classIndex());</span>
<span class="nc" id="L650">    updateRadioLinks();</span>
<span class="nc" id="L651">  }</span>

  /**
   * Sets the user test set. Information about the current test set is displayed
   * in an InstanceSummaryPanel and the user is given the ability to load
   * another set from a file or url.
   * 
   */
  protected void setTestSet() {

<span class="nc bnc" id="L661" title="All 2 branches missed.">    if (m_SetTestFrame == null) {</span>
<span class="nc" id="L662">      final SetInstancesPanel sp = new SetInstancesPanel();</span>
<span class="nc" id="L663">      sp.setReadIncrementally(false);</span>
<span class="nc" id="L664">      m_Summary = sp.getSummary();</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">      if (m_TestInstances != null) {</span>
<span class="nc" id="L666">        sp.setInstances(m_TestInstances);</span>
      }
<span class="nc" id="L668">      sp.addPropertyChangeListener(new PropertyChangeListener() {</span>
        public void propertyChange(PropertyChangeEvent e) {
<span class="nc" id="L670">          m_TestInstances = sp.getInstances();</span>
<span class="nc" id="L671">          m_TestInstances.setClassIndex(-1); // make sure that no class</span>
                                             // attribute is set!
<span class="nc" id="L673">        }</span>
      });
      // Add propertychangelistener to update m_TestInstances whenever
      // it changes in the settestframe
<span class="nc" id="L677">      m_SetTestFrame = new JFrame(Messages.getInstance().getString(</span>
<span class="nc" id="L678">          &quot;ClustererPanel_SetUpVisualizableInstances_JFrame_Text&quot;));</span>
<span class="nc" id="L679">      sp.setParentFrame(m_SetTestFrame); // enable Close-Button</span>
<span class="nc" id="L680">      m_SetTestFrame.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L681">      m_SetTestFrame.getContentPane().add(sp, BorderLayout.CENTER);</span>
<span class="nc" id="L682">      m_SetTestFrame.pack();</span>
    }
<span class="nc" id="L684">    m_SetTestFrame.setVisible(true);</span>
<span class="nc" id="L685">  }</span>

  /**
   * Sets up the structure for the visualizable instances. This dataset contains
   * the original attributes plus the clusterer's cluster assignments
   * 
   * @param testInstances the instances that the clusterer has clustered
   * @param eval the evaluation to use
   * @return a PlotData2D object encapsulating the visualizable instances. The
   *         instances contain one more attribute (predicted cluster) than the
   *         testInstances
   */
  public static PlotData2D setUpVisualizableInstances(Instances testInstances,
      ClusterEvaluation eval) throws Exception {

<span class="nc" id="L700">    int numClusters = eval.getNumClusters();</span>
<span class="nc" id="L701">    double[] clusterAssignments = eval.getClusterAssignments();</span>

<span class="nc" id="L703">    FastVector hv = new FastVector();</span>
    Instances newInsts;

    Attribute predictedCluster;
<span class="nc" id="L707">    FastVector clustVals = new FastVector();</span>

<span class="nc bnc" id="L709" title="All 2 branches missed.">    for (int i = 0; i &lt; numClusters; i++) {</span>
<span class="nc" id="L710">      clustVals.addElement(Messages.getInstance().getString(</span>
<span class="nc" id="L711">          &quot;ClustererPanel_SetUpVisualizableInstances_ClustVals_Text&quot;)</span>
<span class="nc" id="L712">          + i);</span>
    }
<span class="nc" id="L714">    predictedCluster = new Attribute(Messages.getInstance().getString(</span>
<span class="nc" id="L715">        &quot;ClustererPanel_SetUpVisualizableInstances_PredictedCluster_Text&quot;),</span>
<span class="nc" id="L716">        clustVals);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">    for (int i = 0; i &lt; testInstances.numAttributes(); i++) {</span>
<span class="nc" id="L718">      hv.addElement(testInstances.attribute(i).copy());</span>
    }
<span class="nc" id="L720">    hv.addElement(predictedCluster);</span>

<span class="nc" id="L722">    newInsts = new Instances(testInstances.relationName() + &quot;_clustered&quot;, hv,</span>
<span class="nc" id="L723">        testInstances.numInstances());</span>

    double[] values;
    int j;
<span class="nc" id="L727">    int[] pointShapes = null;</span>
<span class="nc" id="L728">    int[] classAssignments = null;</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">    if (testInstances.classIndex() &gt;= 0) {</span>
<span class="nc" id="L730">      classAssignments = eval.getClassesToClusters();</span>
<span class="nc" id="L731">      pointShapes = new int[testInstances.numInstances()];</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">      for (int i = 0; i &lt; testInstances.numInstances(); i++) {</span>
<span class="nc" id="L733">        pointShapes[i] = Plot2D.CONST_AUTOMATIC_SHAPE;</span>
      }
    }

<span class="nc bnc" id="L737" title="All 2 branches missed.">    for (int i = 0; i &lt; testInstances.numInstances(); i++) {</span>
<span class="nc" id="L738">      values = new double[newInsts.numAttributes()];</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">      for (j = 0; j &lt; testInstances.numAttributes(); j++) {</span>
<span class="nc" id="L740">        values[j] = testInstances.instance(i).value(j);</span>
      }
<span class="nc bnc" id="L742" title="All 2 branches missed.">      if (clusterAssignments[i] &lt; 0) {</span>
<span class="nc" id="L743">        values[j] = Instance.missingValue();</span>
      } else {
<span class="nc" id="L745">        values[j] = clusterAssignments[i];</span>
      }
<span class="nc" id="L747">      newInsts.add(new Instance(1.0, values));</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">      if (pointShapes != null) {</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if (clusterAssignments[i] &gt;= 0) {</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">          if ((int) testInstances.instance(i).classValue() != classAssignments[(int) clusterAssignments[i]]) {</span>
<span class="nc" id="L751">            pointShapes[i] = Plot2D.ERROR_SHAPE;</span>
          }
        } else {
<span class="nc" id="L754">          pointShapes[i] = Plot2D.MISSING_SHAPE;</span>
        }
      }
    }
<span class="nc" id="L758">    PlotData2D plotData = new PlotData2D(newInsts);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">    if (pointShapes != null) {</span>
<span class="nc" id="L760">      plotData.setShapeType(pointShapes);</span>
    }
<span class="nc" id="L762">    plotData.addInstanceNumberAttribute();</span>
<span class="nc" id="L763">    return plotData;</span>
  }

  /**
   * Starts running the currently configured clusterer with the current
   * settings. This is run in a separate thread, and will only start if there is
   * no clusterer already running. The clusterer output is sent to the results
   * history panel.
   */
  protected void startClusterer() {

<span class="nc bnc" id="L774" title="All 2 branches missed.">    if (m_RunThread == null) {</span>
<span class="nc" id="L775">      m_StartBut.setEnabled(false);</span>
<span class="nc" id="L776">      m_StopBut.setEnabled(true);</span>
<span class="nc" id="L777">      m_ignoreBut.setEnabled(false);</span>
<span class="nc" id="L778">      m_RunThread = new Thread() {</span>
        @Override
        public void run() {
          // for timing
<span class="nc" id="L782">          long trainTimeStart = 0, trainTimeElapsed = 0;</span>

          // Copy the current state of things
<span class="nc" id="L785">          m_Log</span>
<span class="nc" id="L786">              .statusMessage(Messages</span>
<span class="nc" id="L787">                  .getInstance()</span>
<span class="nc" id="L788">                  .getString(</span>
<span class="nc" id="L789">                      &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Text_First&quot;));</span>
<span class="nc" id="L790">          Instances inst = new Instances(m_Instances);</span>
<span class="nc" id="L791">          inst.setClassIndex(-1);</span>
<span class="nc" id="L792">          Instances userTest = null;</span>
<span class="nc" id="L793">          PlotData2D predData = null;</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">          if (m_TestInstances != null) {</span>
<span class="nc" id="L795">            userTest = new Instances(m_TestInstances);</span>
          }

<span class="nc" id="L798">          boolean saveVis = m_StorePredictionsBut.isSelected();</span>
<span class="nc" id="L799">          String grph = null;</span>
<span class="nc" id="L800">          int[] ignoredAtts = null;</span>

<span class="nc" id="L802">          int testMode = 0;</span>
<span class="nc" id="L803">          int percent = 66;</span>
<span class="nc" id="L804">          Clusterer clusterer = (Clusterer) m_ClustererEditor.getValue();</span>
<span class="nc" id="L805">          Clusterer fullClusterer = null;</span>
<span class="nc" id="L806">          StringBuffer outBuff = new StringBuffer();</span>
<span class="nc" id="L807">          String name = (new SimpleDateFormat(&quot;HH:mm:ss - &quot;))</span>
<span class="nc" id="L808">              .format(new Date());</span>
<span class="nc" id="L809">          String cname = clusterer.getClass().getName();</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">          if (cname.startsWith(&quot;weka.clusterers.&quot;)) {</span>
<span class="nc" id="L811">            name += cname.substring(&quot;weka.clusterers.&quot;.length());</span>
          } else {
<span class="nc" id="L813">            name += cname;</span>
          }
<span class="nc" id="L815">          String cmd = m_ClustererEditor.getValue().getClass().getName();</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">          if (m_ClustererEditor.getValue() instanceof OptionHandler)</span>
<span class="nc" id="L817">            cmd += &quot; &quot;</span>
<span class="nc" id="L818">                + Utils.joinOptions(((OptionHandler) m_ClustererEditor</span>
<span class="nc" id="L819">                    .getValue()).getOptions());</span>
          try {
<span class="nc" id="L821">            m_Log.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L822">                &quot;ClustererPanel_StartClusterer_Run_Log_LogMessage_Text_First&quot;)</span>
<span class="nc" id="L823">                + cname);</span>
<span class="nc" id="L824">            m_Log.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L825">                &quot;ClustererPanel_StartClusterer_Run_Log_LogMessage_Text_Second&quot;)</span>
<span class="nc" id="L826">                + cmd);</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">            if (m_Log instanceof TaskLogger) {</span>
<span class="nc" id="L828">              ((TaskLogger) m_Log).taskStarted();</span>
            }
<span class="nc bnc" id="L830" title="All 2 branches missed.">            if (m_PercentBut.isSelected()) {</span>
<span class="nc" id="L831">              testMode = 2;</span>
<span class="nc" id="L832">              percent = Integer.parseInt(m_PercentText.getText());</span>
<span class="nc bnc" id="L833" title="All 4 branches missed.">              if ((percent &lt;= 0) || (percent &gt;= 100)) {</span>
<span class="nc" id="L834">                throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L835">                    &quot;ClustererPanel_StartClusterer_Run_Exception_Text_First&quot;));</span>
              }
<span class="nc bnc" id="L837" title="All 2 branches missed.">            } else if (m_TrainBut.isSelected()) {</span>
<span class="nc" id="L838">              testMode = 3;</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">            } else if (m_TestSplitBut.isSelected()) {</span>
<span class="nc" id="L840">              testMode = 4;</span>
              // Check the test instance compatibility
<span class="nc bnc" id="L842" title="All 2 branches missed.">              if (userTest == null) {</span>
<span class="nc" id="L843">                throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L844">                    &quot;ClustererPanel_StartClusterer_Run_Exception_Text_Second&quot;));</span>
              }
<span class="nc bnc" id="L846" title="All 2 branches missed.">              if (!inst.equalHeaders(userTest)) {</span>
<span class="nc" id="L847">                throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L848">                    &quot;ClustererPanel_StartClusterer_Run_Exception_Text_Third&quot;));</span>
              }
<span class="nc bnc" id="L850" title="All 2 branches missed.">            } else if (m_ClassesToClustersBut.isSelected()) {</span>
<span class="nc" id="L851">              testMode = 5;</span>
            } else {
<span class="nc" id="L853">              throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L854">                  &quot;ClustererPanel_StartClusterer_Run_Exception_Text_Fourth&quot;));</span>
            }

<span class="nc" id="L857">            Instances trainInst = new Instances(inst);</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">            if (m_ClassesToClustersBut.isSelected()) {</span>
<span class="nc" id="L859">              trainInst.setClassIndex(m_ClassCombo.getSelectedIndex());</span>
<span class="nc" id="L860">              inst.setClassIndex(m_ClassCombo.getSelectedIndex());</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">              if (inst.classAttribute().isNumeric()) {</span>
<span class="nc" id="L862">                throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L863">                    &quot;ClustererPanel_StartClusterer_Run_Exception_Text_Fifth&quot;));</span>
              }
            }
<span class="nc bnc" id="L866" title="All 2 branches missed.">            if (!m_ignoreKeyList.isSelectionEmpty()) {</span>
<span class="nc" id="L867">              trainInst = removeIgnoreCols(trainInst);</span>
            }

            // Output some header information
<span class="nc" id="L871">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L872">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_First&quot;));</span>
<span class="nc" id="L873">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L874">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Second&quot;)</span>
<span class="nc" id="L875">                + cname);</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">            if (clusterer instanceof OptionHandler) {</span>
<span class="nc" id="L877">              String[] o = ((OptionHandler) clusterer).getOptions();</span>
<span class="nc" id="L878">              outBuff.append(&quot; &quot; + Utils.joinOptions(o));</span>
            }
<span class="nc" id="L880">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L881">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Third&quot;));</span>
<span class="nc" id="L882">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L883">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Fourth&quot;)</span>
<span class="nc" id="L884">                + inst.relationName() + '\n');</span>
<span class="nc" id="L885">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L886">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Sixth&quot;)</span>
<span class="nc" id="L887">                + inst.numInstances() + '\n');</span>
<span class="nc" id="L888">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L889">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Eighth&quot;)</span>
<span class="nc" id="L890">                + inst.numAttributes() + '\n');</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">            if (inst.numAttributes() &lt; 100) {</span>
<span class="nc" id="L892">              boolean[] selected = new boolean[inst.numAttributes()];</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">              for (int i = 0; i &lt; inst.numAttributes(); i++) {</span>
<span class="nc" id="L894">                selected[i] = true;</span>
              }
<span class="nc bnc" id="L896" title="All 2 branches missed.">              if (!m_ignoreKeyList.isSelectionEmpty()) {</span>
<span class="nc" id="L897">                int[] indices = m_ignoreKeyList.getSelectedIndices();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                for (int i = 0; i &lt; indices.length; i++) {</span>
<span class="nc" id="L899">                  selected[indices[i]] = false;</span>
                }
              }
<span class="nc bnc" id="L902" title="All 2 branches missed.">              if (m_ClassesToClustersBut.isSelected()) {</span>
<span class="nc" id="L903">                selected[m_ClassCombo.getSelectedIndex()] = false;</span>
              }
<span class="nc bnc" id="L905" title="All 2 branches missed.">              for (int i = 0; i &lt; inst.numAttributes(); i++) {</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">                if (selected[i]) {</span>
<span class="nc" id="L907">                  outBuff.append(&quot;              &quot; + inst.attribute(i).name()</span>
<span class="nc" id="L908">                      + '\n');</span>
                }
              }
<span class="nc bnc" id="L911" title="All 2 branches missed.">              if (!m_ignoreKeyList.isSelectionEmpty()</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">                  || m_ClassesToClustersBut.isSelected()) {</span>
<span class="nc" id="L913">                outBuff</span>
<span class="nc" id="L914">                    .append(Messages</span>
<span class="nc" id="L915">                        .getInstance()</span>
<span class="nc" id="L916">                        .getString(</span>
<span class="nc" id="L917">                            &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Eleventh&quot;));</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">                for (int i = 0; i &lt; inst.numAttributes(); i++) {</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                  if (!selected[i]) {</span>
<span class="nc" id="L920">                    outBuff.append(&quot;              &quot; + inst.attribute(i).name()</span>
<span class="nc" id="L921">                        + '\n');</span>
                  }
                }
              }
            } else {
<span class="nc" id="L926">              outBuff</span>
<span class="nc" id="L927">                  .append(Messages</span>
<span class="nc" id="L928">                      .getInstance()</span>
<span class="nc" id="L929">                      .getString(</span>
<span class="nc" id="L930">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Thirteenth&quot;));</span>
            }

<span class="nc bnc" id="L933" title="All 2 branches missed.">            if (!m_ignoreKeyList.isSelectionEmpty()) {</span>
<span class="nc" id="L934">              ignoredAtts = m_ignoreKeyList.getSelectedIndices();</span>
            }

<span class="nc bnc" id="L937" title="All 2 branches missed.">            if (m_ClassesToClustersBut.isSelected()) {</span>
              // add class to ignored list
<span class="nc bnc" id="L939" title="All 2 branches missed.">              if (ignoredAtts == null) {</span>
<span class="nc" id="L940">                ignoredAtts = new int[1];</span>
<span class="nc" id="L941">                ignoredAtts[0] = m_ClassCombo.getSelectedIndex();</span>
              } else {
<span class="nc" id="L943">                int[] newIgnoredAtts = new int[ignoredAtts.length + 1];</span>
<span class="nc" id="L944">                System.arraycopy(ignoredAtts, 0, newIgnoredAtts, 0,</span>
<span class="nc" id="L945">                    ignoredAtts.length);</span>
<span class="nc" id="L946">                newIgnoredAtts[ignoredAtts.length] = m_ClassCombo</span>
<span class="nc" id="L947">                    .getSelectedIndex();</span>
<span class="nc" id="L948">                ignoredAtts = newIgnoredAtts;</span>
              }
            }

<span class="nc" id="L952">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L953">                &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Fourteenth&quot;));</span>
<span class="nc bnc" id="L954" title="All 5 branches missed.">            switch (testMode) {</span>
            case 3: // Test on training
<span class="nc" id="L956">              outBuff</span>
<span class="nc" id="L957">                  .append(Messages</span>
<span class="nc" id="L958">                      .getInstance()</span>
<span class="nc" id="L959">                      .getString(</span>
<span class="nc" id="L960">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Fifteenth&quot;));</span>
<span class="nc" id="L961">              break;</span>
            case 2: // Percent split
<span class="nc" id="L963">              outBuff</span>
<span class="nc" id="L964">                  .append(Messages</span>
<span class="nc" id="L965">                      .getInstance()</span>
<span class="nc" id="L966">                      .getString(</span>
<span class="nc" id="L967">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Sixteenth&quot;)</span>
<span class="nc" id="L968">                      + percent</span>
<span class="nc" id="L969">                      + Messages</span>
<span class="nc" id="L970">                          .getInstance()</span>
<span class="nc" id="L971">                          .getString(</span>
<span class="nc" id="L972">                              &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Seventeenth&quot;));</span>
<span class="nc" id="L973">              break;</span>
            case 4: // Test on user split
<span class="nc" id="L975">              outBuff</span>
<span class="nc" id="L976">                  .append(Messages</span>
<span class="nc" id="L977">                      .getInstance()</span>
<span class="nc" id="L978">                      .getString(</span>
<span class="nc" id="L979">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Eighteenth&quot;)</span>
<span class="nc" id="L980">                      + userTest.numInstances()</span>
<span class="nc" id="L981">                      + Messages</span>
<span class="nc" id="L982">                          .getInstance()</span>
<span class="nc" id="L983">                          .getString(</span>
<span class="nc" id="L984">                              &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Nineteenth&quot;));</span>
<span class="nc" id="L985">              break;</span>
            case 5: // Classes to clusters evaluation on training
<span class="nc" id="L987">              outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L988">                  &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_Twentyth&quot;));</span>

              break;
            }
<span class="nc" id="L992">            outBuff.append(&quot;\n&quot;);</span>
<span class="nc" id="L993">            m_History.addResult(name, outBuff);</span>
<span class="nc" id="L994">            m_History.setSingle(name);</span>

            // Build the model and output it.
<span class="nc" id="L997">            m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L998">                &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Second&quot;));</span>

<span class="nc" id="L1000">            trainTimeStart = System.currentTimeMillis();</span>
            // remove the class attribute (if set) and build the clusterer
<span class="nc" id="L1002">            clusterer.buildClusterer(removeClass(trainInst));</span>
<span class="nc" id="L1003">            trainTimeElapsed = System.currentTimeMillis() - trainTimeStart;</span>

            // if (testMode == 2) {
<span class="nc" id="L1006">            outBuff</span>
<span class="nc" id="L1007">                .append(Messages</span>
<span class="nc" id="L1008">                    .getInstance()</span>
<span class="nc" id="L1009">                    .getString(</span>
<span class="nc" id="L1010">                        &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TwentySecond&quot;));</span>

<span class="nc" id="L1012">            outBuff.append(clusterer.toString() + '\n');</span>
<span class="nc" id="L1013">            outBuff</span>
<span class="nc" id="L1014">                .append(Messages</span>
<span class="nc" id="L1015">                    .getInstance()</span>
<span class="nc" id="L1016">                    .getString(</span>
<span class="nc" id="L1017">                        &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TimeTakenFull&quot;)</span>
<span class="nc" id="L1018">                    + Utils.doubleToString(trainTimeElapsed / 1000.0, 2)</span>
<span class="nc" id="L1019">                    + &quot; &quot;</span>
<span class="nc" id="L1020">                    + Messages</span>
<span class="nc" id="L1021">                        .getInstance()</span>
<span class="nc" id="L1022">                        .getString(</span>
<span class="nc" id="L1023">                            &quot;ClassifierPanel_StartClassifier_OutBuffer_Text_TwentyNineth&quot;));</span>
            // }
<span class="nc" id="L1025">            m_History.updateResult(name);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">            if (clusterer instanceof Drawable) {</span>
              try {
<span class="nc" id="L1028">                grph = ((Drawable) clusterer).graph();</span>
<span class="nc" id="L1029">              } catch (Exception ex) {</span>
              }
            }
            // copy full model for output
<span class="nc" id="L1033">            SerializedObject so = new SerializedObject(clusterer);</span>
<span class="nc" id="L1034">            fullClusterer = (Clusterer) so.getObject();</span>

<span class="nc" id="L1036">            ClusterEvaluation eval = new ClusterEvaluation();</span>
<span class="nc" id="L1037">            eval.setClusterer(clusterer);</span>
<span class="nc bnc" id="L1038" title="All 4 branches missed.">            switch (testMode) {</span>
            case 3:
            case 5: // Test on training
<span class="nc" id="L1041">              m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1042">                  &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Third&quot;));</span>
<span class="nc" id="L1043">              eval.evaluateClusterer(trainInst, &quot;&quot;, false);</span>
<span class="nc" id="L1044">              predData = setUpVisualizableInstances(inst, eval);</span>
<span class="nc" id="L1045">              outBuff</span>
<span class="nc" id="L1046">                  .append(Messages</span>
<span class="nc" id="L1047">                      .getInstance()</span>
<span class="nc" id="L1048">                      .getString(</span>
<span class="nc" id="L1049">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TwentySecond&quot;));</span>
<span class="nc" id="L1050">              break;</span>

            case 2: // Percent split
<span class="nc" id="L1053">              m_Log</span>
<span class="nc" id="L1054">                  .statusMessage(Messages</span>
<span class="nc" id="L1055">                      .getInstance()</span>
<span class="nc" id="L1056">                      .getString(</span>
<span class="nc" id="L1057">                          &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Fourth&quot;));</span>
<span class="nc" id="L1058">              inst.randomize(new Random(1));</span>
<span class="nc" id="L1059">              trainInst.randomize(new Random(1));</span>
<span class="nc" id="L1060">              int trainSize = trainInst.numInstances() * percent / 100;</span>
<span class="nc" id="L1061">              int testSize = trainInst.numInstances() - trainSize;</span>
<span class="nc" id="L1062">              Instances train = new Instances(trainInst, 0, trainSize);</span>
<span class="nc" id="L1063">              Instances test = new Instances(trainInst, trainSize, testSize);</span>
<span class="nc" id="L1064">              Instances testVis = new Instances(inst, trainSize, testSize);</span>
<span class="nc" id="L1065">              m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1066">                  &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Fifth&quot;));</span>
<span class="nc" id="L1067">              trainTimeStart = System.currentTimeMillis();</span>
<span class="nc" id="L1068">              clusterer.buildClusterer(train);</span>
<span class="nc" id="L1069">              trainTimeElapsed = System.currentTimeMillis() - trainTimeStart;</span>

<span class="nc" id="L1071">              m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1072">                  &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Sixth&quot;));</span>
<span class="nc" id="L1073">              eval.evaluateClusterer(test, &quot;&quot;, false);</span>
<span class="nc" id="L1074">              predData = setUpVisualizableInstances(testVis, eval);</span>
<span class="nc" id="L1075">              outBuff</span>
<span class="nc" id="L1076">                  .append(Messages</span>
<span class="nc" id="L1077">                      .getInstance()</span>
<span class="nc" id="L1078">                      .getString(</span>
<span class="nc" id="L1079">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TwentyThird&quot;));</span>
<span class="nc" id="L1080">              outBuff.append(clusterer.toString() + '\n');</span>
<span class="nc" id="L1081">              outBuff</span>
<span class="nc" id="L1082">                  .append(Messages</span>
<span class="nc" id="L1083">                      .getInstance()</span>
<span class="nc" id="L1084">                      .getString(</span>
<span class="nc" id="L1085">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TimeTakenPercentage&quot;)</span>
<span class="nc" id="L1086">                      + Utils.doubleToString(trainTimeElapsed / 1000.0, 2)</span>
<span class="nc" id="L1087">                      + &quot; &quot;</span>
<span class="nc" id="L1088">                      + Messages</span>
<span class="nc" id="L1089">                          .getInstance()</span>
<span class="nc" id="L1090">                          .getString(</span>
<span class="nc" id="L1091">                              &quot;ClassifierPanel_StartClassifier_OutBuffer_Text_TwentyNineth&quot;));</span>
<span class="nc" id="L1092">              break;</span>

            case 4: // Test on user split
<span class="nc" id="L1095">              m_Log</span>
<span class="nc" id="L1096">                  .statusMessage(Messages</span>
<span class="nc" id="L1097">                      .getInstance()</span>
<span class="nc" id="L1098">                      .getString(</span>
<span class="nc" id="L1099">                          &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Seventh&quot;));</span>
<span class="nc" id="L1100">              Instances userTestT = new Instances(userTest);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">              if (!m_ignoreKeyList.isSelectionEmpty()) {</span>
<span class="nc" id="L1102">                userTestT = removeIgnoreCols(userTestT);</span>
              }
<span class="nc" id="L1104">              eval.evaluateClusterer(userTestT, &quot;&quot;, false);</span>
<span class="nc" id="L1105">              predData = setUpVisualizableInstances(userTest, eval);</span>
<span class="nc" id="L1106">              outBuff</span>
<span class="nc" id="L1107">                  .append(Messages</span>
<span class="nc" id="L1108">                      .getInstance()</span>
<span class="nc" id="L1109">                      .getString(</span>
<span class="nc" id="L1110">                          &quot;ClustererPanel_StartClusterer_Run_OutBuffer_Text_TwentyFourth&quot;));</span>
<span class="nc" id="L1111">              break;</span>

            default:
<span class="nc" id="L1114">              throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L1115">                  &quot;ClustererPanel_StartClusterer_Run_Exception_Text_Sixth&quot;));</span>
            }
<span class="nc" id="L1117">            outBuff.append(eval.clusterResultsToString());</span>
<span class="nc" id="L1118">            outBuff.append(&quot;\n&quot;);</span>
<span class="nc" id="L1119">            m_History.updateResult(name);</span>
<span class="nc" id="L1120">            m_Log.logMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1121">                &quot;ClustererPanel_StartClusterer_Run_Log_LogMessage_Text_Third&quot;)</span>
<span class="nc" id="L1122">                + cname);</span>
<span class="nc" id="L1123">            m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1124">                &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Eighth&quot;));</span>
<span class="nc" id="L1125">          } catch (Exception ex) {</span>
<span class="nc" id="L1126">            ex.printStackTrace();</span>
<span class="nc" id="L1127">            m_Log.logMessage(ex.getMessage());</span>
            JOptionPane
<span class="nc" id="L1129">                .showMessageDialog(</span>
<span class="nc" id="L1130">                    ClustererPanel.this,</span>
<span class="nc" id="L1131">                    Messages</span>
<span class="nc" id="L1132">                        .getInstance()</span>
<span class="nc" id="L1133">                        .getString(</span>
<span class="nc" id="L1134">                            &quot;ClustererPanel_StartClusterer_Run_JOptionPaneShowMessageDialog_Text_First&quot;)</span>
<span class="nc" id="L1135">                        + ex.getMessage(),</span>
                    Messages
<span class="nc" id="L1137">                        .getInstance()</span>
<span class="nc" id="L1138">                        .getString(</span>
<span class="nc" id="L1139">                            &quot;ClustererPanel_StartClusterer_Run_JOptionPaneShowMessageDialog_Text_Second&quot;),</span>
<span class="nc" id="L1140">                    JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L1141">            m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1142">                &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Nineth&quot;));</span>
<span class="nc" id="L1143">          } finally {</span>
<span class="nc bnc" id="L1144" title="All 6 branches missed.">            if (predData != null) {</span>
<span class="nc" id="L1145">              m_CurrentVis = new VisualizePanel();</span>
<span class="nc" id="L1146">              m_CurrentVis.setName(name + &quot; (&quot; + inst.relationName() + &quot;)&quot;);</span>
<span class="nc" id="L1147">              m_CurrentVis.setLog(m_Log);</span>
<span class="nc" id="L1148">              predData.setPlotName(name + &quot; (&quot; + inst.relationName() + &quot;)&quot;);</span>

              try {
<span class="nc" id="L1151">                m_CurrentVis.addPlot(predData);</span>
<span class="nc" id="L1152">              } catch (Exception ex) {</span>
<span class="nc" id="L1153">                System.err.println(ex);</span>
              }

<span class="nc" id="L1156">              FastVector vv = new FastVector();</span>
<span class="nc" id="L1157">              vv.addElement(fullClusterer);</span>
<span class="nc" id="L1158">              Instances trainHeader = new Instances(m_Instances, 0);</span>
<span class="nc" id="L1159">              vv.addElement(trainHeader);</span>
<span class="nc bnc" id="L1160" title="All 6 branches missed.">              if (ignoredAtts != null)</span>
<span class="nc" id="L1161">                vv.addElement(ignoredAtts);</span>
<span class="nc bnc" id="L1162" title="All 6 branches missed.">              if (saveVis) {</span>
<span class="nc" id="L1163">                vv.addElement(m_CurrentVis);</span>
<span class="nc bnc" id="L1164" title="All 6 branches missed.">                if (grph != null) {</span>
<span class="nc" id="L1165">                  vv.addElement(grph);</span>
                }

              }
<span class="nc" id="L1169">              m_History.addObject(name, vv);</span>
            }
<span class="nc bnc" id="L1171" title="All 6 branches missed.">            if (isInterrupted()) {</span>
<span class="nc" id="L1172">              m_Log</span>
<span class="nc" id="L1173">                  .logMessage(Messages</span>
<span class="nc" id="L1174">                      .getInstance()</span>
<span class="nc" id="L1175">                      .getString(</span>
<span class="nc" id="L1176">                          &quot;ClustererPanel_StartClusterer_Run_Log_LogMessage_Text_Fourth&quot;)</span>
<span class="nc" id="L1177">                      + cname);</span>
<span class="nc" id="L1178">              m_Log.statusMessage(Messages.getInstance().getString(</span>
<span class="nc" id="L1179">                  &quot;ClustererPanel_StartClusterer_Run_Log_StatusMessage_Tenth&quot;));</span>
            }
<span class="nc" id="L1181">            m_RunThread = null;</span>
<span class="nc" id="L1182">            m_StartBut.setEnabled(true);</span>
<span class="nc" id="L1183">            m_StopBut.setEnabled(false);</span>
<span class="nc" id="L1184">            m_ignoreBut.setEnabled(true);</span>
<span class="nc bnc" id="L1185" title="All 6 branches missed.">            if (m_Log instanceof TaskLogger) {</span>
<span class="nc" id="L1186">              ((TaskLogger) m_Log).taskFinished();</span>
            }
<span class="nc" id="L1188">          }</span>
<span class="nc" id="L1189">        }</span>
      };
<span class="nc" id="L1191">      m_RunThread.setPriority(Thread.MIN_PRIORITY);</span>
<span class="nc" id="L1192">      m_RunThread.start();</span>
    }
<span class="nc" id="L1194">  }</span>

  private Instances removeClass(Instances inst) {
<span class="nc" id="L1197">    Remove af = new Remove();</span>
<span class="nc" id="L1198">    Instances retI = null;</span>

    try {
<span class="nc bnc" id="L1201" title="All 2 branches missed.">      if (inst.classIndex() &lt; 0) {</span>
<span class="nc" id="L1202">        retI = inst;</span>
      } else {
<span class="nc" id="L1204">        af.setAttributeIndices(&quot;&quot; + (inst.classIndex() + 1));</span>
<span class="nc" id="L1205">        af.setInvertSelection(false);</span>
<span class="nc" id="L1206">        af.setInputFormat(inst);</span>
<span class="nc" id="L1207">        retI = Filter.useFilter(inst, af);</span>
      }
<span class="nc" id="L1209">    } catch (Exception e) {</span>
<span class="nc" id="L1210">      e.printStackTrace();</span>
    }
<span class="nc" id="L1212">    return retI;</span>
  }

  private Instances removeIgnoreCols(Instances inst) {

    // If the user is doing classes to clusters evaluation and
    // they have opted to ignore the class, then unselect the class in
    // the ignore list
<span class="nc bnc" id="L1220" title="All 2 branches missed.">    if (m_ClassesToClustersBut.isSelected()) {</span>
<span class="nc" id="L1221">      int classIndex = m_ClassCombo.getSelectedIndex();</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">      if (m_ignoreKeyList.isSelectedIndex(classIndex)) {</span>
<span class="nc" id="L1223">        m_ignoreKeyList.removeSelectionInterval(classIndex, classIndex);</span>
      }
    }
<span class="nc" id="L1226">    int[] selected = m_ignoreKeyList.getSelectedIndices();</span>
<span class="nc" id="L1227">    Remove af = new Remove();</span>
<span class="nc" id="L1228">    Instances retI = null;</span>

    try {
<span class="nc" id="L1231">      af.setAttributeIndicesArray(selected);</span>
<span class="nc" id="L1232">      af.setInvertSelection(false);</span>
<span class="nc" id="L1233">      af.setInputFormat(inst);</span>
<span class="nc" id="L1234">      retI = Filter.useFilter(inst, af);</span>
<span class="nc" id="L1235">    } catch (Exception e) {</span>
<span class="nc" id="L1236">      e.printStackTrace();</span>
    }

<span class="nc" id="L1239">    return retI;</span>
  }

  private Instances removeIgnoreCols(Instances inst, int[] toIgnore) {

<span class="nc" id="L1244">    Remove af = new Remove();</span>
<span class="nc" id="L1245">    Instances retI = null;</span>

    try {
<span class="nc" id="L1248">      af.setAttributeIndicesArray(toIgnore);</span>
<span class="nc" id="L1249">      af.setInvertSelection(false);</span>
<span class="nc" id="L1250">      af.setInputFormat(inst);</span>
<span class="nc" id="L1251">      retI = Filter.useFilter(inst, af);</span>
<span class="nc" id="L1252">    } catch (Exception e) {</span>
<span class="nc" id="L1253">      e.printStackTrace();</span>
    }

<span class="nc" id="L1256">    return retI;</span>
  }

  /**
   * Stops the currently running clusterer (if any).
   */
  protected void stopClusterer() {

<span class="nc bnc" id="L1264" title="All 2 branches missed.">    if (m_RunThread != null) {</span>
<span class="nc" id="L1265">      m_RunThread.interrupt();</span>

      // This is deprecated (and theoretically the interrupt should do).
<span class="nc" id="L1268">      m_RunThread.stop();</span>

    }
<span class="nc" id="L1271">  }</span>

  /**
   * Pops up a TreeVisualizer for the clusterer from the currently selected item
   * in the results list
   * 
   * @param graphString the description of the tree in dotty format
   * @param treeName the title to assign to the display
   */
  protected void visualizeTree(String graphString, String treeName) {
<span class="nc" id="L1281">    final javax.swing.JFrame jf = new javax.swing.JFrame(Messages.getInstance()</span>
<span class="nc" id="L1282">        .getString(&quot;ClustererPanel_VisualizeTree_JFrame_Text&quot;) + treeName);</span>
<span class="nc" id="L1283">    jf.setSize(500, 400);</span>
<span class="nc" id="L1284">    jf.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">    if (graphString.contains(&quot;digraph&quot;)) {</span>
<span class="nc" id="L1286">      TreeVisualizer tv = new TreeVisualizer(null, graphString,</span>
<span class="nc" id="L1287">          new PlaceNode2());</span>
<span class="nc" id="L1288">      jf.getContentPane().add(tv, BorderLayout.CENTER);</span>
<span class="nc" id="L1289">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L1292">          jf.dispose();</span>
<span class="nc" id="L1293">        }</span>
      });

<span class="nc" id="L1296">      jf.setVisible(true);</span>
<span class="nc" id="L1297">      tv.fitToScreen();</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">    } else if (graphString.startsWith(Messages.getInstance().getString(</span>
<span class="nc" id="L1299">        &quot;ClustererPanel_VisualizeTree_GraphStringStartsWith_Text&quot;))) {</span>
<span class="nc" id="L1300">      HierarchyVisualizer tv = new HierarchyVisualizer(graphString.substring(7));</span>
<span class="nc" id="L1301">      jf.getContentPane().add(tv, BorderLayout.CENTER);</span>
<span class="nc" id="L1302">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L1305">          jf.dispose();</span>
<span class="nc" id="L1306">        }</span>
      });
<span class="nc" id="L1308">      jf.setVisible(true);</span>
<span class="nc" id="L1309">      tv.fitToScreen();</span>
    }
<span class="nc" id="L1311">  }</span>

  /**
   * Pops up a visualize panel to display cluster assignments
   * 
   * @param sp the visualize panel to display
   */
  protected void visualizeClusterAssignments(VisualizePanel sp) {
<span class="nc bnc" id="L1319" title="All 2 branches missed.">    if (sp != null) {</span>
<span class="nc" id="L1320">      String plotName = sp.getName();</span>
<span class="nc" id="L1321">      final javax.swing.JFrame jf = new javax.swing.JFrame(Messages</span>
<span class="nc" id="L1322">          .getInstance().getString(</span>
<span class="nc" id="L1323">              &quot;ClustererPanel_VisualizeClusterAssignments_JFrame_Text&quot;)</span>
<span class="nc" id="L1324">          + plotName);</span>
<span class="nc" id="L1325">      jf.setSize(500, 400);</span>
<span class="nc" id="L1326">      jf.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L1327">      jf.getContentPane().add(sp, BorderLayout.CENTER);</span>
<span class="nc" id="L1328">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L1331">          jf.dispose();</span>
<span class="nc" id="L1332">        }</span>
      });

<span class="nc" id="L1335">      jf.setVisible(true);</span>
    }
<span class="nc" id="L1337">  }</span>

  /**
   * Handles constructing a popup menu with visualization options
   * 
   * @param name the name of the result history list entry clicked on by the
   *          user
   * @param x the x coordinate for popping up the menu
   * @param y the y coordinate for popping up the menu
   */
  protected void visualizeClusterer(String name, int x, int y) {
<span class="nc" id="L1348">    final String selectedName = name;</span>
<span class="nc" id="L1349">    JPopupMenu resultListMenu = new JPopupMenu();</span>

<span class="nc" id="L1351">    JMenuItem visMainBuffer = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1352">        &quot;ClustererPanel_VisualizeClusterer_VisMainBuffer_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">    if (selectedName != null) {</span>
<span class="nc" id="L1354">      visMainBuffer.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1356">          m_History.setSingle(selectedName);</span>
<span class="nc" id="L1357">        }</span>
      });
    } else {
<span class="nc" id="L1360">      visMainBuffer.setEnabled(false);</span>
    }
<span class="nc" id="L1362">    resultListMenu.add(visMainBuffer);</span>

<span class="nc" id="L1364">    JMenuItem visSepBuffer = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1365">        &quot;ClustererPanel_VisualizeClusterer_VisSepBuffer_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">    if (selectedName != null) {</span>
<span class="nc" id="L1367">      visSepBuffer.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1369">          m_History.openFrame(selectedName);</span>
<span class="nc" id="L1370">        }</span>
      });
    } else {
<span class="nc" id="L1373">      visSepBuffer.setEnabled(false);</span>
    }
<span class="nc" id="L1375">    resultListMenu.add(visSepBuffer);</span>

<span class="nc" id="L1377">    JMenuItem saveOutput = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1378">        &quot;ClustererPanel_VisualizeClusterer_SaveOutput_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">    if (selectedName != null) {</span>
<span class="nc" id="L1380">      saveOutput.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1382">          saveBuffer(selectedName);</span>
<span class="nc" id="L1383">        }</span>
      });
    } else {
<span class="nc" id="L1386">      saveOutput.setEnabled(false);</span>
    }
<span class="nc" id="L1388">    resultListMenu.add(saveOutput);</span>

<span class="nc" id="L1390">    JMenuItem deleteOutput = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1391">        &quot;ClustererPanel_VisualizeClusterer_DeleteOutput_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">    if (selectedName != null) {</span>
<span class="nc" id="L1393">      deleteOutput.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1395">          m_History.removeResult(selectedName);</span>
<span class="nc" id="L1396">        }</span>
      });
    } else {
<span class="nc" id="L1399">      deleteOutput.setEnabled(false);</span>
    }
<span class="nc" id="L1401">    resultListMenu.add(deleteOutput);</span>

<span class="nc" id="L1403">    resultListMenu.addSeparator();</span>

<span class="nc" id="L1405">    JMenuItem loadModel = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1406">        &quot;ClustererPanel_VisualizeClusterer_LoadModel_JMenuItem_Text&quot;));</span>
<span class="nc" id="L1407">    loadModel.addActionListener(new ActionListener() {</span>
      public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1409">        loadClusterer();</span>
<span class="nc" id="L1410">      }</span>
    });
<span class="nc" id="L1412">    resultListMenu.add(loadModel);</span>

<span class="nc" id="L1414">    FastVector o = null;</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">    if (selectedName != null) {</span>
<span class="nc" id="L1416">      o = (FastVector) m_History.getNamedObject(selectedName);</span>
    }

<span class="nc" id="L1419">    VisualizePanel temp_vp = null;</span>
<span class="nc" id="L1420">    String temp_grph = null;</span>
<span class="nc" id="L1421">    Clusterer temp_clusterer = null;</span>
<span class="nc" id="L1422">    Instances temp_trainHeader = null;</span>
<span class="nc" id="L1423">    int[] temp_ignoreAtts = null;</span>

<span class="nc bnc" id="L1425" title="All 2 branches missed.">    if (o != null) {</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">      for (int i = 0; i &lt; o.size(); i++) {</span>
<span class="nc" id="L1427">        Object temp = o.elementAt(i);</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">        if (temp instanceof Clusterer) {</span>
<span class="nc" id="L1429">          temp_clusterer = (Clusterer) temp;</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">        } else if (temp instanceof Instances) { // training header</span>
<span class="nc" id="L1431">          temp_trainHeader = (Instances) temp;</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">        } else if (temp instanceof int[]) { // ignored attributes</span>
<span class="nc" id="L1433">          temp_ignoreAtts = (int[]) temp;</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">        } else if (temp instanceof VisualizePanel) { // normal errors</span>
<span class="nc" id="L1435">          temp_vp = (VisualizePanel) temp;</span>
<span class="nc bnc" id="L1436" title="All 2 branches missed.">        } else if (temp instanceof String) { // graphable output</span>
<span class="nc" id="L1437">          temp_grph = (String) temp;</span>
        }
      }
    }

<span class="nc" id="L1442">    final VisualizePanel vp = temp_vp;</span>
<span class="nc" id="L1443">    final String grph = temp_grph;</span>
<span class="nc" id="L1444">    final Clusterer clusterer = temp_clusterer;</span>
<span class="nc" id="L1445">    final Instances trainHeader = temp_trainHeader;</span>
<span class="nc" id="L1446">    final int[] ignoreAtts = temp_ignoreAtts;</span>

<span class="nc" id="L1448">    JMenuItem saveModel = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1449">        &quot;ClustererPanel_VisualizeClusterer_SaveModel_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">    if (clusterer != null) {</span>
<span class="nc" id="L1451">      saveModel.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1453">          saveClusterer(selectedName, clusterer, trainHeader, ignoreAtts);</span>
<span class="nc" id="L1454">        }</span>
      });
    } else {
<span class="nc" id="L1457">      saveModel.setEnabled(false);</span>
    }
<span class="nc" id="L1459">    resultListMenu.add(saveModel);</span>

<span class="nc" id="L1461">    JMenuItem reEvaluate = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1462">        &quot;ClustererPanel_VisualizeClusterer_ReEvaluate_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1463" title="All 4 branches missed.">    if (clusterer != null &amp;&amp; m_TestInstances != null) {</span>
<span class="nc" id="L1464">      reEvaluate.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1466">          reevaluateModel(selectedName, clusterer, trainHeader, ignoreAtts);</span>
<span class="nc" id="L1467">        }</span>
      });
    } else {
<span class="nc" id="L1470">      reEvaluate.setEnabled(false);</span>
    }
<span class="nc" id="L1472">    resultListMenu.add(reEvaluate);</span>

<span class="nc" id="L1474">    resultListMenu.addSeparator();</span>

<span class="nc" id="L1476">    JMenuItem visClusts = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1477">        &quot;ClustererPanel_VisualizeClusterer_VisClusts_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">    if (vp != null) {</span>
<span class="nc" id="L1479">      visClusts.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc" id="L1481">          visualizeClusterAssignments(vp);</span>
<span class="nc" id="L1482">        }</span>
      });

    } else {
<span class="nc" id="L1486">      visClusts.setEnabled(false);</span>
    }
<span class="nc" id="L1488">    resultListMenu.add(visClusts);</span>

<span class="nc" id="L1490">    JMenuItem visTree = new JMenuItem(Messages.getInstance().getString(</span>
<span class="nc" id="L1491">        &quot;ClustererPanel_VisualizeClusterer_VisTree_JMenuItem_Text&quot;));</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">    if (grph != null) {</span>
<span class="nc" id="L1493">      visTree.addActionListener(new ActionListener() {</span>
        public void actionPerformed(ActionEvent e) {
          String title;
<span class="nc bnc" id="L1496" title="All 2 branches missed.">          if (vp != null)</span>
<span class="nc" id="L1497">            title = vp.getName();</span>
          else
<span class="nc" id="L1499">            title = selectedName;</span>
<span class="nc" id="L1500">          visualizeTree(grph, title);</span>
<span class="nc" id="L1501">        }</span>
      });
    } else {
<span class="nc" id="L1504">      visTree.setEnabled(false);</span>
    }
<span class="nc" id="L1506">    resultListMenu.add(visTree);</span>

<span class="nc" id="L1508">    resultListMenu.show(m_History.getList(), x, y);</span>
<span class="nc" id="L1509">  }</span>

  /**
   * Save the currently selected clusterer output to a file.
   * 
   * @param name the name of the buffer to save
   */
  protected void saveBuffer(String name) {
<span class="nc" id="L1517">    StringBuffer sb = m_History.getNamedBuffer(name);</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">    if (sb != null) {</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">      if (m_SaveOut.save(sb)) {</span>
<span class="nc" id="L1520">        m_Log</span>
<span class="nc" id="L1521">            .logMessage(Messages</span>
<span class="nc" id="L1522">                .getInstance()</span>
<span class="nc" id="L1523">                .getString(</span>
<span class="nc" id="L1524">                    &quot;ClustererPanel_VisualizeClusterer_SaveBuffer_Log_LohMessage_Text&quot;));</span>
      }
    }
<span class="nc" id="L1527">  }</span>

  private void setIgnoreColumns() {
<span class="nc" id="L1530">    ListSelectorDialog jd = new ListSelectorDialog(null, m_ignoreKeyList);</span>

    // Open the dialog
<span class="nc" id="L1533">    int result = jd.showDialog();</span>

<span class="nc bnc" id="L1535" title="All 2 branches missed.">    if (result != ListSelectorDialog.APPROVE_OPTION) {</span>
      // clear selected indices
<span class="nc" id="L1537">      m_ignoreKeyList.clearSelection();</span>
    }
<span class="nc" id="L1539">    updateCapabilitiesFilter(m_ClustererEditor.getCapabilitiesFilter());</span>
<span class="nc" id="L1540">  }</span>

  /**
   * Saves the currently selected clusterer
   */
  protected void saveClusterer(String name, Clusterer clusterer,
      Instances trainHeader, int[] ignoredAtts) {

<span class="nc" id="L1548">    File sFile = null;</span>
<span class="nc" id="L1549">    boolean saveOK = true;</span>

<span class="nc" id="L1551">    int returnVal = m_FileChooser.showSaveDialog(this);</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">    if (returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L1553">      sFile = m_FileChooser.getSelectedFile();</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">      if (!sFile.getName().toLowerCase().endsWith(MODEL_FILE_EXTENSION)) {</span>
<span class="nc" id="L1555">        sFile = new File(sFile.getParent(), sFile.getName()</span>
<span class="nc" id="L1556">            + MODEL_FILE_EXTENSION);</span>
      }
<span class="nc" id="L1558">      m_Log</span>
<span class="nc" id="L1559">          .statusMessage(Messages</span>
<span class="nc" id="L1560">              .getInstance()</span>
<span class="nc" id="L1561">              .getString(</span>
<span class="nc" id="L1562">                  &quot;ClustererPanel_VisualizeClusterer_SaveBuffer_Log_LohMessage_Text_Alpha&quot;));</span>

      try {
<span class="nc" id="L1565">        OutputStream os = new FileOutputStream(sFile);</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">        if (sFile.getName().endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1567">          os = new GZIPOutputStream(os);</span>
        }
<span class="nc" id="L1569">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(os);</span>
<span class="nc" id="L1570">        objectOutputStream.writeObject(clusterer);</span>
<span class="nc bnc" id="L1571" title="All 2 branches missed.">        if (trainHeader != null)</span>
<span class="nc" id="L1572">          objectOutputStream.writeObject(trainHeader);</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">        if (ignoredAtts != null)</span>
<span class="nc" id="L1574">          objectOutputStream.writeObject(ignoredAtts);</span>
<span class="nc" id="L1575">        objectOutputStream.flush();</span>
<span class="nc" id="L1576">        objectOutputStream.close();</span>
<span class="nc" id="L1577">      } catch (Exception e) {</span>

        JOptionPane
<span class="nc" id="L1580">            .showMessageDialog(</span>
<span class="nc" id="L1581">                null,</span>
<span class="nc" id="L1582">                e,</span>
                Messages
<span class="nc" id="L1584">                    .getInstance()</span>
<span class="nc" id="L1585">                    .getString(</span>
<span class="nc" id="L1586">                        &quot;ClustererPanel_VisualizeClusterer_SaveCluster_JOptionPaneShowMessageDialog_Text&quot;),</span>
<span class="nc" id="L1587">                JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L1588">        saveOK = false;</span>
      }
<span class="nc bnc" id="L1590" title="All 2 branches missed.">      if (saveOK)</span>
<span class="nc" id="L1591">        m_Log</span>
<span class="nc" id="L1592">            .logMessage(Messages</span>
<span class="nc" id="L1593">                .getInstance()</span>
<span class="nc" id="L1594">                .getString(</span>
<span class="nc" id="L1595">                    &quot;ClustererPanel_VisualizeClusterer_SaveCluster_Log_LogMessage_Text&quot;)</span>
<span class="nc" id="L1596">                + name</span>

<span class="nc" id="L1598">                + Messages</span>
<span class="nc" id="L1599">                    .getInstance()</span>
<span class="nc" id="L1600">                    .getString(</span>
<span class="nc" id="L1601">                        &quot;ClustererPanel_VisualizeClusterer_SaveCluster_Log_LogMessage_Text_Alpha&quot;)</span>
<span class="nc" id="L1602">                + sFile.getName() + &quot;'&quot;);</span>
<span class="nc" id="L1603">      m_Log</span>
<span class="nc" id="L1604">          .statusMessage(Messages</span>
<span class="nc" id="L1605">              .getInstance()</span>
<span class="nc" id="L1606">              .getString(</span>
<span class="nc" id="L1607">                  &quot;ClustererPanel_VisualizeClusterer_SaveCluster_Log_StatusMessage_Text&quot;));</span>
    }
<span class="nc" id="L1609">  }</span>

  /**
   * Loads a clusterer
   */
  protected void loadClusterer() {

<span class="nc" id="L1616">    int returnVal = m_FileChooser.showOpenDialog(this);</span>
<span class="nc bnc" id="L1617" title="All 2 branches missed.">    if (returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L1618">      File selected = m_FileChooser.getSelectedFile();</span>
<span class="nc" id="L1619">      Clusterer clusterer = null;</span>
<span class="nc" id="L1620">      Instances trainHeader = null;</span>
<span class="nc" id="L1621">      int[] ignoredAtts = null;</span>

<span class="nc" id="L1623">      m_Log</span>
<span class="nc" id="L1624">          .statusMessage(Messages</span>
<span class="nc" id="L1625">              .getInstance()</span>
<span class="nc" id="L1626">              .getString(</span>
<span class="nc" id="L1627">                  &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_Log_StatusSessage_Text_First&quot;));</span>

      try {
<span class="nc" id="L1630">        InputStream is = new FileInputStream(selected);</span>
<span class="nc bnc" id="L1631" title="All 2 branches missed.">        if (selected.getName().endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1632">          is = new GZIPInputStream(is);</span>
        }
<span class="nc" id="L1634">        ObjectInputStream objectInputStream = new ObjectInputStream(is);</span>
<span class="nc" id="L1635">        clusterer = (Clusterer) objectInputStream.readObject();</span>
        try { // see if we can load the header &amp; ignored attribute info
<span class="nc" id="L1637">          trainHeader = (Instances) objectInputStream.readObject();</span>
<span class="nc" id="L1638">          ignoredAtts = (int[]) objectInputStream.readObject();</span>
<span class="nc" id="L1639">        } catch (Exception e) {</span>
        } // don't fuss if we can't
<span class="nc" id="L1641">        objectInputStream.close();</span>
<span class="nc" id="L1642">      } catch (Exception e) {</span>

        JOptionPane
<span class="nc" id="L1645">            .showMessageDialog(</span>
<span class="nc" id="L1646">                null,</span>
<span class="nc" id="L1647">                e,</span>
                Messages
<span class="nc" id="L1649">                    .getInstance()</span>
<span class="nc" id="L1650">                    .getString(</span>
<span class="nc" id="L1651">                        &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_JOptionPaneShowMessageDialog_Text&quot;),</span>
<span class="nc" id="L1652">                JOptionPane.ERROR_MESSAGE);</span>
      }

<span class="nc" id="L1655">      m_Log</span>
<span class="nc" id="L1656">          .statusMessage(Messages</span>
<span class="nc" id="L1657">              .getInstance()</span>
<span class="nc" id="L1658">              .getString(</span>
<span class="nc" id="L1659">                  &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_Log_StatusMessage_Text_Second&quot;));</span>

<span class="nc bnc" id="L1661" title="All 2 branches missed.">      if (clusterer != null) {</span>
<span class="nc" id="L1662">        m_Log</span>
<span class="nc" id="L1663">            .logMessage(Messages</span>
<span class="nc" id="L1664">                .getInstance()</span>
<span class="nc" id="L1665">                .getString(</span>
<span class="nc" id="L1666">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_Log_LogMessage_Text_First&quot;)</span>
<span class="nc" id="L1667">                + selected.getName() + &quot;'&quot;);</span>
<span class="nc" id="L1668">        String name = (new SimpleDateFormat(&quot;HH:mm:ss - &quot;)).format(new Date());</span>
<span class="nc" id="L1669">        String cname = clusterer.getClass().getName();</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">        if (cname.startsWith(&quot;weka.clusterers.&quot;))</span>
<span class="nc" id="L1671">          cname = cname.substring(&quot;weka.clusterers.&quot;.length());</span>
<span class="nc" id="L1672">        name += cname</span>
<span class="nc" id="L1673">            + Messages</span>
<span class="nc" id="L1674">                .getInstance()</span>
<span class="nc" id="L1675">                .getString(</span>
<span class="nc" id="L1676">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_CNAme_Text_First&quot;)</span>
<span class="nc" id="L1677">            + selected.getName() + &quot;'&quot;;</span>
<span class="nc" id="L1678">        StringBuffer outBuff = new StringBuffer();</span>

<span class="nc" id="L1680">        outBuff</span>
<span class="nc" id="L1681">            .append(Messages</span>
<span class="nc" id="L1682">                .getInstance()</span>
<span class="nc" id="L1683">                .getString(</span>
<span class="nc" id="L1684">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_First&quot;));</span>
<span class="nc" id="L1685">        outBuff</span>
<span class="nc" id="L1686">            .append(Messages</span>
<span class="nc" id="L1687">                .getInstance()</span>
<span class="nc" id="L1688">                .getString(</span>
<span class="nc" id="L1689">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Second&quot;)</span>
<span class="nc" id="L1690">                + selected.getName() + &quot;\n&quot;);</span>
<span class="nc" id="L1691">        outBuff</span>
<span class="nc" id="L1692">            .append(Messages</span>
<span class="nc" id="L1693">                .getInstance()</span>
<span class="nc" id="L1694">                .getString(</span>
<span class="nc" id="L1695">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Fourth&quot;)</span>
<span class="nc" id="L1696">                + clusterer.getClass().getName());</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">        if (clusterer instanceof OptionHandler) {</span>
<span class="nc" id="L1698">          String[] o = ((OptionHandler) clusterer).getOptions();</span>
<span class="nc" id="L1699">          outBuff.append(&quot; &quot; + Utils.joinOptions(o));</span>
        }
<span class="nc" id="L1701">        outBuff.append(&quot;\n&quot;);</span>

<span class="nc bnc" id="L1703" title="All 2 branches missed.">        if (trainHeader != null) {</span>

<span class="nc" id="L1705">          outBuff</span>
<span class="nc" id="L1706">              .append(Messages</span>
<span class="nc" id="L1707">                  .getInstance()</span>
<span class="nc" id="L1708">                  .getString(</span>
<span class="nc" id="L1709">                      &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Sixth&quot;)</span>
<span class="nc" id="L1710">                  + trainHeader.relationName() + '\n');</span>
<span class="nc" id="L1711">          outBuff</span>
<span class="nc" id="L1712">              .append(Messages</span>
<span class="nc" id="L1713">                  .getInstance()</span>
<span class="nc" id="L1714">                  .getString(</span>
<span class="nc" id="L1715">                      &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Eighth&quot;)</span>
<span class="nc" id="L1716">                  + trainHeader.numAttributes() + '\n');</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">          if (trainHeader.numAttributes() &lt; 100) {</span>
<span class="nc" id="L1718">            boolean[] selectedAtts = new boolean[trainHeader.numAttributes()];</span>
<span class="nc bnc" id="L1719" title="All 2 branches missed.">            for (int i = 0; i &lt; trainHeader.numAttributes(); i++) {</span>
<span class="nc" id="L1720">              selectedAtts[i] = true;</span>
            }

<span class="nc bnc" id="L1723" title="All 2 branches missed.">            if (ignoredAtts != null)</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">              for (int i = 0; i &lt; ignoredAtts.length; i++)</span>
<span class="nc" id="L1725">                selectedAtts[ignoredAtts[i]] = false;</span>

<span class="nc bnc" id="L1727" title="All 2 branches missed.">            for (int i = 0; i &lt; trainHeader.numAttributes(); i++) {</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">              if (selectedAtts[i]) {</span>
<span class="nc" id="L1729">                outBuff.append(&quot;              &quot;</span>
<span class="nc" id="L1730">                    + trainHeader.attribute(i).name() + '\n');</span>
              }
            }
<span class="nc bnc" id="L1733" title="All 2 branches missed.">            if (ignoredAtts != null) {</span>
<span class="nc" id="L1734">              outBuff</span>
<span class="nc" id="L1735">                  .append(Messages</span>
<span class="nc" id="L1736">                      .getInstance()</span>
<span class="nc" id="L1737">                      .getString(</span>
<span class="nc" id="L1738">                          &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Eleventh&quot;));</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">              for (int i = 0; i &lt; ignoredAtts.length; i++)</span>
<span class="nc" id="L1740">                outBuff.append(&quot;              &quot;</span>
<span class="nc" id="L1741">                    + trainHeader.attribute(ignoredAtts[i]).name() + '\n');</span>
            }
          } else {
<span class="nc" id="L1744">            outBuff</span>
<span class="nc" id="L1745">                .append(Messages</span>
<span class="nc" id="L1746">                    .getInstance()</span>
<span class="nc" id="L1747">                    .getString(</span>
<span class="nc" id="L1748">                        &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Twelveth&quot;));</span>
          }
        } else {
<span class="nc" id="L1751">          outBuff</span>
<span class="nc" id="L1752">              .append(Messages</span>
<span class="nc" id="L1753">                  .getInstance()</span>
<span class="nc" id="L1754">                  .getString(</span>
<span class="nc" id="L1755">                      &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Thirteenth&quot;));</span>
        }

<span class="nc" id="L1758">        outBuff</span>
<span class="nc" id="L1759">            .append(Messages</span>
<span class="nc" id="L1760">                .getInstance()</span>
<span class="nc" id="L1761">                .getString(</span>
<span class="nc" id="L1762">                    &quot;ClustererPanel_VisualizeClusterer_LoadClusterer_OutBuffer_Text_Fourteenth&quot;));</span>
<span class="nc" id="L1763">        outBuff.append(clusterer.toString() + &quot;\n&quot;);</span>

<span class="nc" id="L1765">        m_History.addResult(name, outBuff);</span>
<span class="nc" id="L1766">        m_History.setSingle(name);</span>
<span class="nc" id="L1767">        FastVector vv = new FastVector();</span>
<span class="nc" id="L1768">        vv.addElement(clusterer);</span>
<span class="nc bnc" id="L1769" title="All 2 branches missed.">        if (trainHeader != null)</span>
<span class="nc" id="L1770">          vv.addElement(trainHeader);</span>
<span class="nc bnc" id="L1771" title="All 2 branches missed.">        if (ignoredAtts != null)</span>
<span class="nc" id="L1772">          vv.addElement(ignoredAtts);</span>
        // allow visualization of graphable classifiers
<span class="nc" id="L1774">        String grph = null;</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">        if (clusterer instanceof Drawable) {</span>
          try {
<span class="nc" id="L1777">            grph = ((Drawable) clusterer).graph();</span>
<span class="nc" id="L1778">          } catch (Exception ex) {</span>
          }
        }
<span class="nc bnc" id="L1781" title="All 2 branches missed.">        if (grph != null)</span>
<span class="nc" id="L1782">          vv.addElement(grph);</span>

<span class="nc" id="L1784">        m_History.addObject(name, vv);</span>

      }
    }
<span class="nc" id="L1788">  }</span>

  /**
   * Re-evaluates the named clusterer with the current test set. Unpredictable
   * things will happen if the data set is not compatible with the clusterer.
   * 
   * @param name the name of the clusterer entry
   * @param clusterer the clusterer to evaluate
   * @param trainHeader the header of the training set
   * @param ignoredAtts ignored attributes
   */
  protected void reevaluateModel(final String name, final Clusterer clusterer,
      final Instances trainHeader, final int[] ignoredAtts) {

<span class="nc bnc" id="L1802" title="All 2 branches missed.">    if (m_RunThread == null) {</span>
<span class="nc" id="L1803">      m_StartBut.setEnabled(false);</span>
<span class="nc" id="L1804">      m_StopBut.setEnabled(true);</span>
<span class="nc" id="L1805">      m_ignoreBut.setEnabled(false);</span>
<span class="nc" id="L1806">      m_RunThread = new Thread() {</span>
        @Override
        public void run() {
          // Copy the current state of things
<span class="nc" id="L1810">          m_Log</span>
<span class="nc" id="L1811">              .statusMessage(Messages</span>
<span class="nc" id="L1812">                  .getInstance()</span>
<span class="nc" id="L1813">                  .getString(</span>
<span class="nc" id="L1814">                      &quot;ClustererPanel_ReEvaluateModel_Run_Log_StatusMessage_Text_First&quot;));</span>

<span class="nc" id="L1816">          StringBuffer outBuff = m_History.getNamedBuffer(name);</span>
<span class="nc" id="L1817">          Instances userTest = null;</span>

<span class="nc" id="L1819">          PlotData2D predData = null;</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">          if (m_TestInstances != null) {</span>
<span class="nc" id="L1821">            userTest = new Instances(m_TestInstances);</span>
          }

<span class="nc" id="L1824">          boolean saveVis = m_StorePredictionsBut.isSelected();</span>
<span class="nc" id="L1825">          String grph = null;</span>

          try {
<span class="nc bnc" id="L1828" title="All 2 branches missed.">            if (userTest == null) {</span>
<span class="nc" id="L1829">              throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L1830">                  &quot;ClustererPanel_ReEvaluateModel_Run_Exception_Text_First&quot;));</span>
            }
<span class="nc bnc" id="L1832" title="All 4 branches missed.">            if (trainHeader != null &amp;&amp; !trainHeader.equalHeaders(userTest)) {</span>
<span class="nc" id="L1833">              throw new Exception(Messages.getInstance().getString(</span>
<span class="nc" id="L1834">                  &quot;ClustererPanel_ReEvaluateModel_Run_Exception_Text_Second&quot;));</span>
            }

<span class="nc" id="L1837">            m_Log</span>
<span class="nc" id="L1838">                .statusMessage(Messages</span>
<span class="nc" id="L1839">                    .getInstance()</span>
<span class="nc" id="L1840">                    .getString(</span>
<span class="nc" id="L1841">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_StatusMessage_Text_Second&quot;));</span>
<span class="nc" id="L1842">            m_Log</span>
<span class="nc" id="L1843">                .logMessage(Messages</span>
<span class="nc" id="L1844">                    .getInstance()</span>
<span class="nc" id="L1845">                    .getString(</span>
<span class="nc" id="L1846">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_LogMessage_Text_First&quot;)</span>
<span class="nc" id="L1847">                    + name</span>
<span class="nc" id="L1848">                    + Messages</span>
<span class="nc" id="L1849">                        .getInstance()</span>
<span class="nc" id="L1850">                        .getString(</span>
<span class="nc" id="L1851">                            &quot;ClustererPanel_ReEvaluateModel_Run_Log_LogMessage_Text_Second&quot;));</span>

<span class="nc" id="L1853">            m_Log</span>
<span class="nc" id="L1854">                .logMessage(Messages</span>
<span class="nc" id="L1855">                    .getInstance()</span>
<span class="nc" id="L1856">                    .getString(</span>
<span class="nc" id="L1857">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_LogMessage_Text_Third&quot;));</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">            if (m_Log instanceof TaskLogger) {</span>
<span class="nc" id="L1859">              ((TaskLogger) m_Log).taskStarted();</span>
            }
<span class="nc" id="L1861">            ClusterEvaluation eval = new ClusterEvaluation();</span>
<span class="nc" id="L1862">            eval.setClusterer(clusterer);</span>

<span class="nc" id="L1864">            Instances userTestT = new Instances(userTest);</span>
<span class="nc bnc" id="L1865" title="All 2 branches missed.">            if (ignoredAtts != null) {</span>
<span class="nc" id="L1866">              userTestT = removeIgnoreCols(userTestT, ignoredAtts);</span>
            }

<span class="nc" id="L1869">            eval.evaluateClusterer(userTestT);</span>

<span class="nc" id="L1871">            predData = setUpVisualizableInstances(userTest, eval);</span>

<span class="nc" id="L1873">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L1874">                &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_First&quot;));</span>
<span class="nc" id="L1875">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L1876">                &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Second&quot;));</span>
<span class="nc" id="L1877">            outBuff</span>
<span class="nc" id="L1878">                .append(Messages.getInstance().getString(</span>
<span class="nc" id="L1879">                    &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Third&quot;)</span>
<span class="nc" id="L1880">                    + userTest.relationName()</span>
<span class="nc" id="L1881">                    + Messages</span>
<span class="nc" id="L1882">                        .getInstance()</span>
<span class="nc" id="L1883">                        .getString(</span>
<span class="nc" id="L1884">                            &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Fourth&quot;));</span>
<span class="nc" id="L1885">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L1886">                &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Fifth&quot;)</span>
<span class="nc" id="L1887">                + userTest.numInstances()</span>
<span class="nc" id="L1888">                + Messages.getInstance().getString(</span>
<span class="nc" id="L1889">                    &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Sixth&quot;));</span>
<span class="nc" id="L1890">            outBuff</span>
<span class="nc" id="L1891">                .append(Messages</span>
<span class="nc" id="L1892">                    .getInstance()</span>
<span class="nc" id="L1893">                    .getString(</span>
<span class="nc" id="L1894">                        &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Seventh&quot;)</span>
<span class="nc" id="L1895">                    + userTest.numAttributes()</span>
<span class="nc" id="L1896">                    + Messages</span>
<span class="nc" id="L1897">                        .getInstance()</span>
<span class="nc" id="L1898">                        .getString(</span>
<span class="nc" id="L1899">                            &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Eighth&quot;));</span>
<span class="nc bnc" id="L1900" title="All 2 branches missed.">            if (trainHeader == null)</span>
<span class="nc" id="L1901">              outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L1902">                  &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Nineth&quot;));</span>

<span class="nc" id="L1904">            outBuff.append(eval.clusterResultsToString());</span>
<span class="nc" id="L1905">            outBuff.append(Messages.getInstance().getString(</span>
<span class="nc" id="L1906">                &quot;ClustererPanel_ReEvaluateModel_Run_OutBuffer_Text_Tenth&quot;));</span>
<span class="nc" id="L1907">            m_History.updateResult(name);</span>
<span class="nc" id="L1908">            m_Log</span>
<span class="nc" id="L1909">                .logMessage(Messages</span>
<span class="nc" id="L1910">                    .getInstance()</span>
<span class="nc" id="L1911">                    .getString(</span>
<span class="nc" id="L1912">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_LogMessage_Text_Fourth&quot;));</span>
<span class="nc" id="L1913">            m_Log</span>
<span class="nc" id="L1914">                .statusMessage(Messages</span>
<span class="nc" id="L1915">                    .getInstance()</span>
<span class="nc" id="L1916">                    .getString(</span>
<span class="nc" id="L1917">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_StatusMessage_Text_Third&quot;));</span>
<span class="nc" id="L1918">          } catch (Exception ex) {</span>
<span class="nc" id="L1919">            ex.printStackTrace();</span>
<span class="nc" id="L1920">            m_Log.logMessage(ex.getMessage());</span>
            JOptionPane
<span class="nc" id="L1922">                .showMessageDialog(</span>
<span class="nc" id="L1923">                    ClustererPanel.this,</span>
<span class="nc" id="L1924">                    Messages</span>
<span class="nc" id="L1925">                        .getInstance()</span>
<span class="nc" id="L1926">                        .getString(</span>
<span class="nc" id="L1927">                            &quot;ClustererPanel_ReEvaluateModel_Run_JOptionPaneShowMessageDialog_Text_First&quot;)</span>
<span class="nc" id="L1928">                        + ex.getMessage(),</span>
                    Messages
<span class="nc" id="L1930">                        .getInstance()</span>
<span class="nc" id="L1931">                        .getString(</span>
<span class="nc" id="L1932">                            &quot;ClustererPanel_ReEvaluateModel_Run_JOptionPaneShowMessageDialog_Text_Second&quot;),</span>
<span class="nc" id="L1933">                    JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L1934">            m_Log</span>
<span class="nc" id="L1935">                .statusMessage(Messages</span>
<span class="nc" id="L1936">                    .getInstance()</span>
<span class="nc" id="L1937">                    .getString(</span>
<span class="nc" id="L1938">                        &quot;ClustererPanel_ReEvaluateModel_Run_Log_StatusMessage_Text_Fourth&quot;));</span>

<span class="nc" id="L1940">          } finally {</span>
<span class="nc bnc" id="L1941" title="All 6 branches missed.">            if (predData != null) {</span>
<span class="nc" id="L1942">              m_CurrentVis = new VisualizePanel();</span>
<span class="nc" id="L1943">              m_CurrentVis.setName(name + &quot; (&quot; + userTest.relationName() + &quot;)&quot;);</span>
<span class="nc" id="L1944">              m_CurrentVis.setLog(m_Log);</span>
<span class="nc" id="L1945">              predData.setPlotName(name + &quot; (&quot; + userTest.relationName() + &quot;)&quot;);</span>

              try {
<span class="nc" id="L1948">                m_CurrentVis.addPlot(predData);</span>
<span class="nc" id="L1949">              } catch (Exception ex) {</span>
<span class="nc" id="L1950">                System.err.println(ex);</span>
              }

<span class="nc" id="L1953">              FastVector vv = new FastVector();</span>
<span class="nc" id="L1954">              vv.addElement(clusterer);</span>
<span class="nc bnc" id="L1955" title="All 6 branches missed.">              if (trainHeader != null)</span>
<span class="nc" id="L1956">                vv.addElement(trainHeader);</span>
<span class="nc bnc" id="L1957" title="All 6 branches missed.">              if (ignoredAtts != null)</span>
<span class="nc" id="L1958">                vv.addElement(ignoredAtts);</span>
<span class="nc bnc" id="L1959" title="All 6 branches missed.">              if (saveVis) {</span>
<span class="nc" id="L1960">                vv.addElement(m_CurrentVis);</span>
<span class="nc bnc" id="L1961" title="All 6 branches missed.">                if (grph != null) {</span>
<span class="nc" id="L1962">                  vv.addElement(grph);</span>
                }

              }
<span class="nc" id="L1966">              m_History.addObject(name, vv);</span>

            }
<span class="nc bnc" id="L1969" title="All 6 branches missed.">            if (isInterrupted()) {</span>
<span class="nc" id="L1970">              m_Log</span>
<span class="nc" id="L1971">                  .logMessage(Messages</span>
<span class="nc" id="L1972">                      .getInstance()</span>
<span class="nc" id="L1973">                      .getString(</span>
<span class="nc" id="L1974">                          &quot;ClustererPanel_ReEvaluateModel_Run_Log_LogMessage_Text_Fifth&quot;));</span>
<span class="nc" id="L1975">              m_Log</span>
<span class="nc" id="L1976">                  .statusMessage(Messages</span>
<span class="nc" id="L1977">                      .getInstance()</span>
<span class="nc" id="L1978">                      .getString(</span>
<span class="nc" id="L1979">                          &quot;ClustererPanel_ReEvaluateModel_Run_Log_StatusMessage_Text_Fifth&quot;));</span>
            }
<span class="nc" id="L1981">            m_RunThread = null;</span>
<span class="nc" id="L1982">            m_StartBut.setEnabled(true);</span>
<span class="nc" id="L1983">            m_StopBut.setEnabled(false);</span>
<span class="nc" id="L1984">            m_ignoreBut.setEnabled(true);</span>
<span class="nc bnc" id="L1985" title="All 6 branches missed.">            if (m_Log instanceof TaskLogger) {</span>
<span class="nc" id="L1986">              ((TaskLogger) m_Log).taskFinished();</span>
            }
<span class="nc" id="L1988">          }</span>
<span class="nc" id="L1989">        }</span>

      };
<span class="nc" id="L1992">      m_RunThread.setPriority(Thread.MIN_PRIORITY);</span>
<span class="nc" id="L1993">      m_RunThread.start();</span>
    }
<span class="nc" id="L1995">  }</span>

  /**
   * updates the capabilities filter of the GOE
   * 
   * @param filter the new filter to use
   */
  protected void updateCapabilitiesFilter(Capabilities filter) {
    Instances tempInst;
    Capabilities filterClass;

<span class="nc bnc" id="L2006" title="All 2 branches missed.">    if (filter == null) {</span>
<span class="nc" id="L2007">      m_ClustererEditor.setCapabilitiesFilter(new Capabilities(null));</span>
<span class="nc" id="L2008">      return;</span>
    }

<span class="nc bnc" id="L2011" title="All 2 branches missed.">    if (!ExplorerDefaults.getInitGenericObjectEditorFilter())</span>
<span class="nc" id="L2012">      tempInst = new Instances(m_Instances, 0);</span>
    else
<span class="nc" id="L2014">      tempInst = new Instances(m_Instances);</span>
<span class="nc" id="L2015">    tempInst.setClassIndex(-1);</span>

<span class="nc bnc" id="L2017" title="All 2 branches missed.">    if (!m_ignoreKeyList.isSelectionEmpty()) {</span>
<span class="nc" id="L2018">      tempInst = removeIgnoreCols(tempInst);</span>
    }

<span class="nc bnc" id="L2021" title="All 2 branches missed.">    if (m_ClassesToClustersBut.isSelected()) {</span>
      // remove the class too
<span class="nc" id="L2023">      String classSelection = m_ClassCombo.getSelectedItem().toString();</span>
<span class="nc" id="L2024">      classSelection = classSelection</span>
<span class="nc" id="L2025">          .substring(classSelection.indexOf(&quot;)&quot;) + 1).trim();</span>
<span class="nc" id="L2026">      int classIndex = tempInst.attribute(classSelection).index();</span>

<span class="nc" id="L2028">      Remove rm = new Remove();</span>
<span class="nc" id="L2029">      rm.setAttributeIndices(&quot;&quot; + (classIndex + 1));</span>
      try {
<span class="nc" id="L2031">        rm.setInputFormat(tempInst);</span>
<span class="nc" id="L2032">        tempInst = Filter.useFilter(tempInst, rm);</span>
<span class="nc" id="L2033">      } catch (Exception e) {</span>
<span class="nc" id="L2034">        e.printStackTrace();</span>
      }
    }

    try {
<span class="nc" id="L2039">      filterClass = Capabilities.forInstances(tempInst);</span>
<span class="nc" id="L2040">    } catch (Exception e) {</span>
<span class="nc" id="L2041">      filterClass = new Capabilities(null);</span>
    }

<span class="nc" id="L2044">    m_ClustererEditor.setCapabilitiesFilter(filterClass);</span>

    // check capabilities
<span class="nc" id="L2047">    m_StartBut.setEnabled(true);</span>
<span class="nc" id="L2048">    Capabilities currentFilter = m_ClustererEditor.getCapabilitiesFilter();</span>
<span class="nc" id="L2049">    Clusterer clusterer = (Clusterer) m_ClustererEditor.getValue();</span>
<span class="nc" id="L2050">    Capabilities currentSchemeCapabilities = null;</span>
<span class="nc bnc" id="L2051" title="All 4 branches missed.">    if (clusterer != null &amp;&amp; currentFilter != null</span>
<span class="nc bnc" id="L2052" title="All 2 branches missed.">        &amp;&amp; (clusterer instanceof CapabilitiesHandler)) {</span>
<span class="nc" id="L2053">      currentSchemeCapabilities = ((CapabilitiesHandler) clusterer)</span>
<span class="nc" id="L2054">          .getCapabilities();</span>

<span class="nc bnc" id="L2056" title="All 2 branches missed.">      if (!currentSchemeCapabilities.supportsMaybe(currentFilter)</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">          &amp;&amp; !currentSchemeCapabilities.supports(currentFilter)) {</span>
<span class="nc" id="L2058">        m_StartBut.setEnabled(false);</span>
      }
    }
<span class="nc" id="L2061">  }</span>

  /**
   * method gets called in case of a change event
   * 
   * @param e the associated change event
   */
  public void capabilitiesFilterChanged(CapabilitiesFilterChangeEvent e) {
<span class="nc bnc" id="L2069" title="All 2 branches missed.">    if (e.getFilter() == null)</span>
<span class="nc" id="L2070">      updateCapabilitiesFilter(null);</span>
    else
<span class="nc" id="L2072">      updateCapabilitiesFilter((Capabilities) e.getFilter().clone());</span>
<span class="nc" id="L2073">  }</span>

  /**
   * Sets the Explorer to use as parent frame (used for sending notifications
   * about changes in the data)
   * 
   * @param parent the parent frame
   */
  public void setExplorer(Explorer parent) {
<span class="nc" id="L2082">    m_Explorer = parent;</span>
<span class="nc" id="L2083">  }</span>

  /**
   * returns the parent Explorer frame
   * 
   * @return the parent
   */
  public Explorer getExplorer() {
<span class="nc" id="L2091">    return m_Explorer;</span>
  }

  /**
   * Returns the title for the tab in the Explorer
   * 
   * @return the title of this tab
   */
  public String getTabTitle() {
<span class="nc" id="L2100">    return Messages.getInstance().getString(&quot;ClustererPanel_GetTabTitle_Text&quot;);</span>
  }

  /**
   * Returns the tooltip for the tab in the Explorer
   * 
   * @return the tooltip of this tab
   */
  public String getTabTitleToolTip() {
<span class="nc" id="L2109">    return Messages.getInstance().getString(</span>
<span class="nc" id="L2110">        &quot;ClustererPanel_GetTabTitleToolTip_Text&quot;);</span>
  }

  /**
   * Tests out the clusterer panel from the command line.
   * 
   * @param args may optionally contain the name of a dataset to load.
   */
  public static void main(String[] args) {

    try {
<span class="nc" id="L2121">      final javax.swing.JFrame jf = new javax.swing.JFrame(Messages</span>
<span class="nc" id="L2122">          .getInstance().getString(&quot;ClustererPanel_Main_JFrame_Text&quot;));</span>
<span class="nc" id="L2123">      jf.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L2124">      final ClustererPanel sp = new ClustererPanel();</span>
<span class="nc" id="L2125">      jf.getContentPane().add(sp, BorderLayout.CENTER);</span>
<span class="nc" id="L2126">      weka.gui.LogPanel lp = new weka.gui.LogPanel();</span>
<span class="nc" id="L2127">      sp.setLog(lp);</span>
<span class="nc" id="L2128">      jf.getContentPane().add(lp, BorderLayout.SOUTH);</span>
<span class="nc" id="L2129">      jf.addWindowListener(new java.awt.event.WindowAdapter() {</span>
        @Override
        public void windowClosing(java.awt.event.WindowEvent e) {
<span class="nc" id="L2132">          jf.dispose();</span>
<span class="nc" id="L2133">          System.exit(0);</span>
<span class="nc" id="L2134">        }</span>
      });
<span class="nc" id="L2136">      jf.pack();</span>
<span class="nc" id="L2137">      jf.setSize(800, 600);</span>
<span class="nc" id="L2138">      jf.setVisible(true);</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">      if (args.length == 1) {</span>
<span class="nc" id="L2140">        System.err.println(Messages.getInstance().getString(</span>
<span class="nc" id="L2141">            &quot;ClustererPanel_Main_Error_Text_First&quot;)</span>
<span class="nc" id="L2142">            + args[0]);</span>
<span class="nc" id="L2143">        java.io.Reader r = new java.io.BufferedReader(new java.io.FileReader(</span>
<span class="nc" id="L2144">            args[0]));</span>
<span class="nc" id="L2145">        Instances i = new Instances(r);</span>
<span class="nc" id="L2146">        sp.setInstances(i);</span>
      }
<span class="nc" id="L2148">    } catch (Exception ex) {</span>
<span class="nc" id="L2149">      ex.printStackTrace();</span>
<span class="nc" id="L2150">      System.err.println(ex.getMessage());</span>
    }
<span class="nc" id="L2152">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (Nov 28, 2015 2:34:31 PM)</div></body></html>