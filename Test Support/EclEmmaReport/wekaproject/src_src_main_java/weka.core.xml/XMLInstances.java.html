<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../.resources/report.gif" type="image/gif"/><title>XMLInstances.java</title><link rel="stylesheet" href="../../../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../.sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">AllTests (Nov 28, 2015 2:34:31 PM)</a> &gt; <a href="../../index.html" class="el_group">wekaproject</a> &gt; <a href="../index.html" class="el_bundle">src/src/main/java</a> &gt; <a href="index.source.html" class="el_package">weka.core.xml</a> &gt; <span class="el_source">XMLInstances.java</span></div><h1>XMLInstances.java</h1><pre class="source lang-java linenums">/*
 *    This program is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    This program is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *    GNU General Public License for more details.
 *
 *    You should have received a copy of the GNU General Public License
 *    along with this program; if not, write to the Free Software
 *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */

/*
 * XMLInstances.java
 * Copyright (C) 2006 University of Waikato, Hamilton, New Zealand
 */

package weka.core.xml;

import weka.core.Attribute;
import weka.core.FastVector;
import weka.core.Instance;
import weka.core.Instances;
import weka.core.ProtectedProperties;
import weka.core.RevisionUtils;
import weka.core.SparseInstance;
import weka.core.Utils;
import weka.core.Version;

import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.io.Serializable;
import java.util.Enumeration;
import java.util.Properties;
import java.util.Vector;
import java.util.zip.GZIPInputStream;

import org.w3c.dom.Element;

/**
 * XML representation of the Instances class.
 * 
 * @author  fracpete (fracpete at waikato dot ac dot nz)
 * @version $Revision: 1.4 $
 */
<span class="fc" id="L53">public class XMLInstances</span>
  extends XMLDocument
  implements Serializable {

  /** for serialization */
  private static final long serialVersionUID = 3626821327547416099L;
  
  /** The filename extension that should be used for xrff files */
<span class="fc" id="L61">  public static String FILE_EXTENSION = &quot;.xrff&quot;;</span>
  
  // tags
  /** the root element */
  public final static String TAG_DATASET = &quot;dataset&quot;;

  /** the header element */
  public final static String TAG_HEADER = &quot;header&quot;;

  /** the body element */
  public final static String TAG_BODY = &quot;body&quot;;

  /** the notes element */
  public final static String TAG_NOTES = &quot;notes&quot;;

  /** the attributes element */
  public final static String TAG_ATTRIBUTES = &quot;attributes&quot;;

  /** the attribute element */
  public final static String TAG_ATTRIBUTE = &quot;attribute&quot;;

  /** the labels element */
  public final static String TAG_LABELS = &quot;labels&quot;;

  /** the label element */
  public final static String TAG_LABEL = &quot;label&quot;;

  /** the meta-data element */
  public final static String TAG_METADATA = &quot;metadata&quot;;

  /** the property element */
  public final static String TAG_PROPERTY = &quot;property&quot;;

  /** the data element */
  public final static String TAG_INSTANCES = &quot;instances&quot;;

  /** the instance element */
  public final static String TAG_INSTANCE = &quot;instance&quot;;

  /** the value element */
  public final static String TAG_VALUE = &quot;value&quot;;
  
  // attributes
  /** the version attribute */
  public final static String ATT_VERSION = &quot;version&quot;;
  
  /** the type attribute */
  public final static String ATT_TYPE = &quot;type&quot;;
  
  /** the format attribute (for date attributes) */
  public final static String ATT_FORMAT = &quot;format&quot;;
  
  /** the class attribute */
  public final static String ATT_CLASS = &quot;class&quot;;
  
  /** the index attribute */
  public final static String ATT_INDEX = &quot;index&quot;;
  
  /** the weight attribute */
  public final static String ATT_WEIGHT = &quot;weight&quot;;
  
  /** the missing attribute */
  public final static String ATT_MISSING = &quot;missing&quot;;
  
  // values
  /** the value for numeric */
  public final static String VAL_NUMERIC = &quot;numeric&quot;;
  
  /** the value for date */
  public final static String VAL_DATE = &quot;date&quot;;
  
  /** the value for nominal */
  public final static String VAL_NOMINAL = &quot;nominal&quot;;
  
  /** the value for string */
  public final static String VAL_STRING = &quot;string&quot;;
  
  /** the value for relational */
  public final static String VAL_RELATIONAL = &quot;relational&quot;;
  
  /** the value for normal */
  public final static String VAL_NORMAL = &quot;normal&quot;;
  
  /** the value for sparse */
  public final static String VAL_SPARSE = &quot;sparse&quot;;
  
  /** the DTD */
<span class="fc" id="L148">  public final static String DOCTYPE = </span>
<span class="fc" id="L149">      &quot;&lt;!&quot; + DTD_DOCTYPE + &quot; &quot; + TAG_DATASET + &quot;\n&quot;</span>
    + &quot;[\n&quot;
    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_DATASET + &quot; (&quot; + TAG_HEADER + &quot;,&quot; + TAG_BODY + &quot;)&quot; + &quot;&gt;\n&quot;
    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_DATASET + &quot; &quot; + ATT_NAME + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_REQUIRED + &quot;&gt;\n&quot;
<span class="fc" id="L153">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_DATASET + &quot; &quot; + ATT_VERSION + &quot; &quot; + DTD_CDATA + &quot; \&quot;&quot; + Version.VERSION + &quot;\&quot;&gt;\n&quot;</span>
<span class="fc" id="L154">    + &quot;\n&quot;</span>
<span class="fc" id="L155">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_HEADER + &quot; (&quot; + TAG_NOTES + DTD_OPTIONAL + &quot;,&quot; + TAG_ATTRIBUTES + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L156">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_BODY   + &quot; (&quot; + TAG_INSTANCES  + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L157">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_NOTES + &quot; &quot; + DTD_ANY + &quot;&gt;   &lt;!--  comments, information, copyright, etc. --&gt;\n&quot;</span>
<span class="fc" id="L158">    + &quot;\n&quot;</span>
<span class="fc" id="L159">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_ATTRIBUTES + &quot; (&quot; + TAG_ATTRIBUTE + DTD_AT_LEAST_ONE + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L160">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_ATTRIBUTE + &quot; (&quot; + TAG_LABELS + DTD_OPTIONAL + &quot;,&quot; + TAG_METADATA + DTD_OPTIONAL + &quot;,&quot; + TAG_ATTRIBUTES + DTD_OPTIONAL + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L161">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_ATTRIBUTE + &quot; &quot; + ATT_NAME + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_REQUIRED + &quot;&gt;\n&quot;</span>
<span class="fc" id="L162">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_ATTRIBUTE + &quot; &quot; + ATT_TYPE + &quot; (&quot; + VAL_NUMERIC + DTD_SEPARATOR + VAL_DATE + DTD_SEPARATOR + VAL_NOMINAL + DTD_SEPARATOR + VAL_STRING + DTD_SEPARATOR + VAL_RELATIONAL + &quot;) &quot; + DTD_REQUIRED + &quot;&gt;\n&quot;</span>
<span class="fc" id="L163">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_ATTRIBUTE + &quot; &quot; + ATT_FORMAT + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_IMPLIED + &quot;&gt;\n&quot;</span>
<span class="fc" id="L164">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_ATTRIBUTE + &quot; &quot; + ATT_CLASS + &quot; (&quot; + VAL_YES + DTD_SEPARATOR + VAL_NO + &quot;) \&quot;&quot; + VAL_NO + &quot;\&quot;&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L165">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_LABELS + &quot; (&quot; + TAG_LABEL + DTD_ZERO_OR_MORE + &quot;)&quot; + &quot;&gt;   &lt;!-- only for type \&quot;nominal\&quot; --&gt;\n&quot;</span>
<span class="fc" id="L166">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_LABEL + &quot; &quot; + DTD_ANY + &quot;&gt;\n&quot;</span>
<span class="fc" id="L167">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_METADATA + &quot; (&quot; + TAG_PROPERTY + DTD_ZERO_OR_MORE + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L168">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_PROPERTY + &quot; &quot; + DTD_ANY + &quot;&gt;\n&quot;</span>
<span class="fc" id="L169">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_PROPERTY + &quot; &quot; + ATT_NAME + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_REQUIRED + &quot;&gt;\n&quot;</span>
<span class="fc" id="L170">    + &quot;\n&quot;</span>
<span class="fc" id="L171">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_INSTANCES + &quot; (&quot; + TAG_INSTANCE + DTD_ZERO_OR_MORE + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L172">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_INSTANCE + &quot; (&quot; + TAG_VALUE + DTD_ZERO_OR_MORE + &quot;)&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L173">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_INSTANCE + &quot; &quot; + ATT_TYPE + &quot; (&quot; + VAL_NORMAL + DTD_SEPARATOR + VAL_SPARSE + &quot;) \&quot;&quot; + VAL_NORMAL + &quot;\&quot;&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L174">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_INSTANCE + &quot; &quot; + ATT_WEIGHT + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_IMPLIED + &quot;&gt;\n&quot;</span>
<span class="fc" id="L175">    + &quot;   &lt;!&quot; + DTD_ELEMENT + &quot; &quot; + TAG_VALUE + &quot; (&quot; + DTD_PCDATA + DTD_SEPARATOR + TAG_INSTANCES + &quot;)&quot; + DTD_ZERO_OR_MORE + &quot;&gt;\n&quot;</span>
<span class="fc" id="L176">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_VALUE + &quot; &quot; + ATT_INDEX + &quot; &quot; + DTD_CDATA + &quot; &quot; + DTD_IMPLIED + &quot;&gt;   &lt;!-- 1-based index (only used for instance format \&quot;sparse\&quot;) --&gt;\n&quot;</span>
<span class="fc" id="L177">    + &quot;   &lt;!&quot; + DTD_ATTLIST + &quot; &quot; + TAG_VALUE + &quot; &quot; + ATT_MISSING + &quot; (&quot; + VAL_YES + DTD_SEPARATOR + VAL_NO + &quot;) \&quot;&quot; + VAL_NO + &quot;\&quot;&quot; + &quot;&gt;\n&quot;</span>
<span class="fc" id="L178">    + &quot;]\n&quot;</span>
<span class="fc" id="L179">    + &quot;&gt;&quot;;</span>

  /** the precision for numbers */
<span class="fc" id="L182">  protected int m_Precision = 6;</span>
  
  /** the underlying Instances */
  protected Instances m_Instances;
  
  /**
   * the default constructor
   * 
   * @throws Exception	if XML initialization fails
   */
  public XMLInstances() throws Exception {
<span class="fc" id="L193">    super();</span>
    
<span class="fc" id="L195">    m_Instances = null;</span>

<span class="fc" id="L197">    setDocType(DOCTYPE);</span>
<span class="fc" id="L198">    setRootNode(TAG_DATASET);</span>
<span class="fc" id="L199">    setValidating(true);</span>
<span class="fc" id="L200">  }</span>
  
  /**
   * generates the XML structure based on the given data
   * 
   * @param data	the data to build the XML structure from
   * @throws Exception	if initialization/generation fails
   */
  public XMLInstances(Instances data) throws Exception {
<span class="nc" id="L209">    this();</span>
    
<span class="nc" id="L211">    setInstances(data);</span>
<span class="nc" id="L212">  }</span>
  
  /**
   * generates the Instances directly from the reader containing the
   * XML data.
   * 
   * @param reader	the reader for the XML data
   * @throws Exception	if something goes wrong
   */
  public XMLInstances(Reader reader) throws Exception {
<span class="nc" id="L222">    this();</span>
    
<span class="nc" id="L224">    setXML(reader);</span>
<span class="nc" id="L225">  }</span>
  
  /**
   * adds the attribute to the XML structure
   * 
   * @param parent	the parent node to add the attribute node as child
   * @param att		the attribute to add
   */
  protected void addAttribute(Element parent, Attribute att) {
    Element		node;
    Element		child;
    Element		property;
    Element		label;
    String		tmpStr;
    Enumeration		enm;
    int			i;
    
<span class="nc" id="L242">    node = m_Document.createElement(TAG_ATTRIBUTE);</span>
<span class="nc" id="L243">    parent.appendChild(node);</span>
    
    // XML attributes
    // name
<span class="nc" id="L247">    node.setAttribute(ATT_NAME, validContent(att.name()));</span>
    
    // type
<span class="nc bnc" id="L250" title="All 6 branches missed.">    switch (att.type()) {</span>
      case Attribute.NUMERIC:
<span class="nc" id="L252">	node.setAttribute(ATT_TYPE, VAL_NUMERIC);</span>
<span class="nc" id="L253">	break;</span>
	
      case Attribute.DATE:
<span class="nc" id="L256">	node.setAttribute(ATT_TYPE, VAL_DATE);</span>
<span class="nc" id="L257">	break;</span>
	
      case Attribute.NOMINAL:
<span class="nc" id="L260">	node.setAttribute(ATT_TYPE, VAL_NOMINAL);</span>
<span class="nc" id="L261">	break;</span>
	
      case Attribute.STRING:
<span class="nc" id="L264">	node.setAttribute(ATT_TYPE, VAL_STRING);</span>
<span class="nc" id="L265">	break;</span>
	
      case Attribute.RELATIONAL:
<span class="nc" id="L268">	node.setAttribute(ATT_TYPE, VAL_RELATIONAL);</span>
<span class="nc" id="L269">	break;</span>
	
      default:
<span class="nc" id="L272">	node.setAttribute(ATT_TYPE, &quot;???&quot;);</span>
    }
    
    // labels
<span class="nc bnc" id="L276" title="All 2 branches missed.">    if (att.isNominal()) {</span>
<span class="nc" id="L277">      child = m_Document.createElement(TAG_LABELS);</span>
<span class="nc" id="L278">      node.appendChild(child);</span>
<span class="nc" id="L279">      enm = att.enumerateValues();</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">      while (enm.hasMoreElements()) {</span>
<span class="nc" id="L281">	tmpStr = enm.nextElement().toString();</span>
<span class="nc" id="L282">	label = m_Document.createElement(TAG_LABEL);</span>
<span class="nc" id="L283">	child.appendChild(label);</span>
<span class="nc" id="L284">	label.appendChild(m_Document.createTextNode(validContent(tmpStr)));</span>
      }
    }
    
    // format
<span class="nc bnc" id="L289" title="All 2 branches missed.">    if (att.isDate())</span>
<span class="nc" id="L290">      node.setAttribute(ATT_FORMAT, validContent(att.getDateFormat()));</span>
    
    // class
<span class="nc bnc" id="L293" title="All 2 branches missed.">    if (m_Instances.classIndex() &gt; -1) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">      if (att == m_Instances.classAttribute())</span>
<span class="nc" id="L295">	node.setAttribute(ATT_CLASS, VAL_YES);</span>
    }
    
    // add meta-data
<span class="nc bnc" id="L299" title="All 4 branches missed.">    if ( (att.getMetadata() != null) &amp;&amp; (att.getMetadata().size() &gt; 0) ) {</span>
<span class="nc" id="L300">      child = m_Document.createElement(TAG_METADATA);</span>
<span class="nc" id="L301">      node.appendChild(child);</span>
<span class="nc" id="L302">      enm = att.getMetadata().propertyNames();</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">      while (enm.hasMoreElements()) {</span>
<span class="nc" id="L304">	tmpStr = enm.nextElement().toString();</span>
<span class="nc" id="L305">	property = m_Document.createElement(TAG_PROPERTY);</span>
<span class="nc" id="L306">	child.appendChild(property);</span>
<span class="nc" id="L307">	property.setAttribute(ATT_NAME, validContent(tmpStr));</span>
<span class="nc" id="L308">	property.appendChild(m_Document.createTextNode(validContent(att.getMetadata().getProperty(tmpStr, &quot;&quot;))));</span>
      }
    }
    
    // relational attribute?
<span class="nc bnc" id="L313" title="All 2 branches missed.">    if (att.isRelationValued()) {</span>
<span class="nc" id="L314">      child = m_Document.createElement(TAG_ATTRIBUTES);</span>
<span class="nc" id="L315">      node.appendChild(child);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">      for (i = 0; i &lt; att.relation().numAttributes(); i++)</span>
<span class="nc" id="L317">	addAttribute(child, att.relation().attribute(i));</span>
    }
<span class="nc" id="L319">  }</span>

  /**
   * turns all &amp;lt;, &amp;gt; and &amp;amp;into character entities and returns that 
   * string. Necessary for TextNodes.
   * 
   * @param content	string to convert
   * @return		the valid content string
   */
  protected String validContent(String content) {
    String	result;
    
<span class="nc" id="L331">    result = content;</span>
    
    // these five entities are recognized by every XML processor
    // see http://www.xml.com/pub/a/2001/03/14/trxml10.html
<span class="nc" id="L335">    result = result.replaceAll(&quot;&amp;&quot;, &quot;&amp;amp;&quot;)</span>
<span class="nc" id="L336">                   .replaceAll(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;)</span>
<span class="nc" id="L337">                   .replaceAll(&quot;'&quot;, &quot;&amp;apos;&quot;)</span>
<span class="nc" id="L338">                   .replaceAll(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)</span>
<span class="nc" id="L339">                   .replaceAll(&quot;&gt;&quot;, &quot;&amp;gt;&quot;);</span>
    // in addition, replace some other entities as well
<span class="nc" id="L341">    result = result.replaceAll(&quot;\n&quot;, &quot;&amp;#10;&quot;)</span>
<span class="nc" id="L342">                   .replaceAll(&quot;\r&quot;, &quot;&amp;#13;&quot;)</span>
<span class="nc" id="L343">                   .replaceAll(&quot;\t&quot;, &quot;&amp;#9;&quot;);</span>
    
<span class="nc" id="L345">    return result;</span>
  }
  
  /**
   * adds the instance to the XML structure
   * 
   * @param parent	the parent node to add the instance node as child
   * @param inst	the instance to add
   */
  protected void addInstance(Element parent, Instance inst) {
    Element		node;
    Element		value;
    Element		child;
    boolean		sparse;
    int			i;
    int			n;
    int			index;
    
<span class="nc" id="L363">    node = m_Document.createElement(TAG_INSTANCE);</span>
<span class="nc" id="L364">    parent.appendChild(node);</span>
    
    // sparse?
<span class="nc" id="L367">    sparse = (inst instanceof SparseInstance);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">    if (sparse)</span>
<span class="nc" id="L369">      node.setAttribute(ATT_TYPE, VAL_SPARSE);</span>
    
    // weight
<span class="nc bnc" id="L372" title="All 2 branches missed.">    if (inst.weight() != 1.0)</span>
<span class="nc" id="L373">      node.setAttribute(ATT_WEIGHT, Utils.doubleToString(inst.weight(), m_Precision));</span>
    
    // values
<span class="nc bnc" id="L376" title="All 2 branches missed.">    for (i = 0; i &lt; inst.numValues(); i++) {</span>
<span class="nc" id="L377">      index = inst.index(i);</span>
      
<span class="nc" id="L379">      value = m_Document.createElement(TAG_VALUE);</span>
<span class="nc" id="L380">      node.appendChild(value);</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">      if (inst.isMissing(index)) {</span>
<span class="nc" id="L383">	value.setAttribute(ATT_MISSING, VAL_YES);</span>
      }
      else {
<span class="nc bnc" id="L386" title="All 2 branches missed.">	if (inst.attribute(index).isRelationValued()) {</span>
<span class="nc" id="L387">	  child = m_Document.createElement(TAG_INSTANCES);</span>
<span class="nc" id="L388">	  value.appendChild(child);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">	  for (n = 0; n &lt; inst.relationalValue(i).numInstances(); n++)</span>
<span class="nc" id="L390">	    addInstance(child, inst.relationalValue(i).instance(n));</span>
	}
	else {
<span class="nc bnc" id="L393" title="All 2 branches missed.">	  if (inst.attribute(index).type() == Attribute.NUMERIC)</span>
<span class="nc" id="L394">	    value.appendChild(m_Document.createTextNode(Utils.doubleToString(inst.value(index), m_Precision)));</span>
	  else
<span class="nc" id="L396">	    value.appendChild(m_Document.createTextNode(validContent(inst.stringValue(index))));</span>
	}
      }
      
<span class="nc bnc" id="L400" title="All 2 branches missed.">      if (sparse)</span>
<span class="nc" id="L401">	value.setAttribute(ATT_INDEX, &quot;&quot; + (index+1));</span>
    }
<span class="nc" id="L403">  }</span>
  
  /**
   * generates the XML structure for the header
   */
  protected void headerToXML() {
    Element	root;
    Element	node;
    Element	child;
    int		i;
    
<span class="nc" id="L414">    root = m_Document.getDocumentElement();</span>
<span class="nc" id="L415">    root.setAttribute(ATT_NAME, validContent(m_Instances.relationName()));</span>
<span class="nc" id="L416">    root.setAttribute(ATT_VERSION, Version.VERSION);</span>
    
    // create &quot;header&quot; node
<span class="nc" id="L419">    node = m_Document.createElement(TAG_HEADER);</span>
<span class="nc" id="L420">    root.appendChild(node);</span>

    // add all attributes
<span class="nc" id="L423">    child = m_Document.createElement(TAG_ATTRIBUTES);</span>
<span class="nc" id="L424">    node.appendChild(child);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">    for (i = 0; i &lt; m_Instances.numAttributes(); i++)</span>
<span class="nc" id="L426">      addAttribute(child, m_Instances.attribute(i));</span>
<span class="nc" id="L427">  }</span>
  
  /**
   * generates the XML structure from the rows
   */
  protected void dataToXML() {
    Element	root;
    Element	node;
    Element	child;
    int		i;
    
<span class="nc" id="L438">    root = m_Document.getDocumentElement();</span>
    
    // create &quot;body&quot; node
<span class="nc" id="L441">    node = m_Document.createElement(TAG_BODY);</span>
<span class="nc" id="L442">    root.appendChild(node);</span>

    // add all instances
<span class="nc" id="L445">    child = m_Document.createElement(TAG_INSTANCES);</span>
<span class="nc" id="L446">    node.appendChild(child);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">    for (i = 0; i &lt; m_Instances.numInstances(); i++)</span>
<span class="nc" id="L448">      addInstance(child, m_Instances.instance(i));</span>
<span class="nc" id="L449">  }</span>
  
  /**
   * builds up the XML structure based on the given data
   * 
   * @param data	data to generate the XML from
   */
  public void setInstances(Instances data) {
<span class="nc" id="L457">    m_Instances = new Instances(data);</span>
<span class="nc" id="L458">    clear();</span>
<span class="nc" id="L459">    headerToXML();</span>
<span class="nc" id="L460">    dataToXML();</span>
<span class="nc" id="L461">  }</span>
  
  /**
   * returns the current instances, either the ones that were set or the ones
   * that were generated from the XML structure.
   * 
   * @return		the current instances
   */
  public Instances getInstances() {
<span class="nc" id="L470">    return m_Instances;</span>
  }

  /**
   * returns the metadata, if any available underneath this node, otherwise
   * just null
   * 
   * @param parent	the attribute node
   * @return		the metadata, or null if none found
   * @throws Exception	if generation fails
   */
  protected ProtectedProperties createMetadata(Element parent) throws Exception {
    ProtectedProperties	result;
    Properties		props;
    Vector		list;
    Element		node;
    Element		metanode;
    int			i;
    
<span class="nc" id="L489">    result = null;</span>
    
    // find metadata node directly underneath this attribute, but not in
    // deeper nested attributes (e.g., within relational attributes)
<span class="nc" id="L493">    metanode = null;</span>
<span class="nc" id="L494">    list     = getChildTags(parent, TAG_METADATA);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">    if (list.size() &gt; 0)</span>
<span class="nc" id="L496">      metanode = (Element) list.get(0);</span>
    
    // generate properties
<span class="nc bnc" id="L499" title="All 2 branches missed.">    if (metanode != null) {</span>
<span class="nc" id="L500">      props = new Properties();</span>
<span class="nc" id="L501">      list  = getChildTags(metanode, TAG_PROPERTY);</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">      for (i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L503">	node = (Element) list.get(i);</span>
<span class="nc" id="L504">	props.setProperty(node.getAttribute(ATT_NAME), getContent(node));</span>
      }
<span class="nc" id="L506">      result = new ProtectedProperties(props);</span>
    }
    
<span class="nc" id="L509">    return result;</span>
  }

  /**
   * returns the labels listed underneath this (nominal) attribute in a 
   * FastVector
   * 
   * @param parent	the (nominal) attribute node
   * @return		the label vector
   * @throws Exception	if generation fails
   */
  protected FastVector createLabels(Element parent) throws Exception {
    FastVector		result;
    Vector		list;
    Element		node;
    Element		labelsnode;
    int			i;
    
<span class="nc" id="L527">    result = new FastVector();</span>
    
    // find labels node directly underneath this attribute, but not in
    // deeper nested attributes (e.g., within relational attributes)
<span class="nc" id="L531">    labelsnode = null;</span>
<span class="nc" id="L532">    list     = getChildTags(parent, TAG_LABELS);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">    if (list.size() &gt; 0)</span>
<span class="nc" id="L534">      labelsnode = (Element) list.get(0);</span>
    
    // retrieve all labels
<span class="nc bnc" id="L537" title="All 2 branches missed.">    if (labelsnode != null) {</span>
<span class="nc" id="L538">      list  = getChildTags(labelsnode, TAG_LABEL);</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">      for (i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L540">	node = (Element) list.get(i);</span>
<span class="nc" id="L541">	result.addElement(getContent(node));</span>
      }
    }
    
<span class="nc" id="L545">    return result;</span>
  }
  
  /**
   * creates an Attribute from the given XML node
   * 
   * @param node	the node with the setup
   * @return		the configured Attribute
   * @throws Exception	if generation fails, e.g., due to unknown attribute type
   */
  protected Attribute createAttribute(Element node) throws Exception {
    String		typeStr;
    String		name;
    int			type;
    Attribute		result;
    FastVector		values;
    ProtectedProperties	metadata;
    Vector		list;
    FastVector		atts;
    
<span class="nc" id="L565">    result = null;</span>
    
    // name
<span class="nc" id="L568">    name = node.getAttribute(ATT_NAME);</span>

    // type
<span class="nc" id="L571">    typeStr = node.getAttribute(ATT_TYPE);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">    if (typeStr.equals(VAL_NUMERIC))</span>
<span class="nc" id="L573">      type = Attribute.NUMERIC;</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">    else if (typeStr.equals(VAL_DATE))</span>
<span class="nc" id="L575">      type = Attribute.DATE;</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">    else if (typeStr.equals(VAL_NOMINAL))</span>
<span class="nc" id="L577">      type = Attribute.NOMINAL;</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">    else if (typeStr.equals(VAL_STRING))</span>
<span class="nc" id="L579">      type = Attribute.STRING;</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">    else if (typeStr.equals(VAL_RELATIONAL))</span>
<span class="nc" id="L581">      type = Attribute.RELATIONAL;</span>
    else
<span class="nc" id="L583">      throw new Exception(</span>
<span class="nc" id="L584">	  &quot;Attribute type '&quot; + typeStr + &quot;' is not supported!&quot;);</span>

    // metadata
<span class="nc" id="L587">    metadata = createMetadata(node);</span>
    
<span class="nc bnc" id="L589" title="All 6 branches missed.">    switch (type) {</span>
      case Attribute.NUMERIC:
<span class="nc bnc" id="L591" title="All 2 branches missed.">	if (metadata == null)</span>
<span class="nc" id="L592">	  result = new Attribute(name);</span>
	else
<span class="nc" id="L594">	  result = new Attribute(name, metadata);</span>
<span class="nc" id="L595">	break;</span>

      case Attribute.DATE:
<span class="nc bnc" id="L598" title="All 2 branches missed.">	if (metadata == null)</span>
<span class="nc" id="L599">	  result = new Attribute(name, node.getAttribute(ATT_FORMAT));</span>
	else
<span class="nc" id="L601">	  result = new Attribute(name, node.getAttribute(ATT_FORMAT), metadata);</span>
<span class="nc" id="L602">	break;</span>
	
      case Attribute.NOMINAL:
<span class="nc" id="L605">	values = createLabels(node);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">	if (metadata == null)</span>
<span class="nc" id="L607">	  result = new Attribute(name, values);</span>
	else
<span class="nc" id="L609">	  result = new Attribute(name, values, metadata);</span>
<span class="nc" id="L610">	break;</span>
	
      case Attribute.STRING:
<span class="nc bnc" id="L613" title="All 2 branches missed.">	if (metadata == null)</span>
<span class="nc" id="L614">	  result = new Attribute(name, (FastVector) null);</span>
	else
<span class="nc" id="L616">	  result = new Attribute(name, (FastVector) null, metadata);</span>
<span class="nc" id="L617">	break;</span>
	
      case Attribute.RELATIONAL:
<span class="nc" id="L620">	list = getChildTags(node, TAG_ATTRIBUTES);</span>
<span class="nc" id="L621">	node = (Element) list.get(0);</span>
<span class="nc" id="L622">	atts = createAttributes(node, new int[1]);</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">	if (metadata == null)</span>
<span class="nc" id="L624">	  result = new Attribute(name, new Instances(name, atts, 0));</span>
	else
<span class="nc" id="L626">	  result = new Attribute(name, new Instances(name, atts, 0), metadata);</span>
	break;
    }
    
<span class="nc" id="L630">    return result;</span>
  }
  
  /**
   * returns a list of generated attributes
   * 
   * @param parent	the attributes node
   * @param classIndex	array of length 1 to return the class index, if any
   * @return		the vector with the generated attributes
   * @throws Exception	if generation fails, e.g., due to unknown attribute type
   */
  protected FastVector createAttributes(Element parent, int[] classIndex) throws Exception {
    Vector	list;
    FastVector	result;
    int		i;
    Element	node;
    Attribute	att;

<span class="nc" id="L648">    result        = new FastVector();</span>
<span class="nc" id="L649">    classIndex[0] = -1;</span>
    
<span class="nc" id="L651">    list = getChildTags(parent, TAG_ATTRIBUTE);</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">    for (i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L653">      node = (Element) list.get(i);</span>
<span class="nc" id="L654">      att = createAttribute(node);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">      if (node.getAttribute(ATT_CLASS).equals(VAL_YES))</span>
<span class="nc" id="L656">	classIndex[0] = i;</span>
<span class="nc" id="L657">      result.addElement(att);</span>
    }
    
<span class="nc" id="L660">    return result;</span>
  }
  
  /**
   * creates an Instance from the given XML node
   * 
   * @param header	the data this instance will belong to
   * @param parent	the instance node
   * @return		the configured Instance
   * @throws Exception	if generation fails, e.g., due to unknown attribute type
   */
  protected Instance createInstance(Instances header, Element parent) throws Exception {
    Instance	result;
    Element	node;
    Element	child;
    boolean	sparse;
    int		i;
    int		index;
    Vector	list;
    Vector	subList;
    double[]	values;
    String	content;
    double	weight;
    Instances	data;
    
<span class="nc" id="L685">    result = null;</span>

    // sparse?
<span class="nc" id="L688">    sparse = (parent.getAttribute(ATT_TYPE).equals(VAL_SPARSE));</span>
<span class="nc" id="L689">    values = new double[header.numAttributes()];</span>
    
    // weight
<span class="nc bnc" id="L692" title="All 2 branches missed.">    if (parent.getAttribute(ATT_WEIGHT).length() != 0)</span>
<span class="nc" id="L693">      weight = Double.parseDouble(parent.getAttribute(ATT_WEIGHT));</span>
    else
<span class="nc" id="L695">      weight = 1.0;</span>
    
<span class="nc" id="L697">    list = getChildTags(parent, TAG_VALUE);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">    for (i = 0; i &lt; list.size(); i++) {</span>
<span class="nc" id="L699">      node = (Element) list.get(i);</span>
      
      // determine index
<span class="nc bnc" id="L702" title="All 2 branches missed.">      if (sparse)</span>
<span class="nc" id="L703">	index = Integer.parseInt(node.getAttribute(ATT_INDEX)) - 1;</span>
      else
<span class="nc" id="L705">	index = i;</span>

      // set value
<span class="nc bnc" id="L708" title="All 2 branches missed.">      if (node.getAttribute(ATT_MISSING).equals(VAL_YES)) {</span>
<span class="nc" id="L709">	values[index] = Instance.missingValue();</span>
      }
      else {
<span class="nc" id="L712">	content = getContent(node);</span>
<span class="nc bnc" id="L713" title="All 6 branches missed.">	switch (header.attribute(index).type()) {</span>
	  case Attribute.NUMERIC:
<span class="nc" id="L715">	    values[index] = Double.parseDouble(content);</span>
<span class="nc" id="L716">	    break;</span>
	    
	  case Attribute.DATE:
<span class="nc" id="L719">	    values[index] = header.attribute(index).parseDate(content);</span>
<span class="nc" id="L720">	    break;</span>
	    
	  case Attribute.NOMINAL:
<span class="nc" id="L723">	    values[index] = header.attribute(index).indexOfValue(content);</span>
<span class="nc" id="L724">	    break;</span>
	    
	  case Attribute.STRING:
<span class="nc" id="L727">	    values[index] = header.attribute(index).addStringValue(content);</span>
<span class="nc" id="L728">	    break;</span>
	    
	  case Attribute.RELATIONAL:
<span class="nc" id="L731">	    subList       = getChildTags(node, TAG_INSTANCES);</span>
<span class="nc" id="L732">	    child         = (Element) subList.get(0);</span>
<span class="nc" id="L733">	    data          = createInstances(header.attribute(index).relation(), child);</span>
<span class="nc" id="L734">	    values[index] = header.attribute(index).addRelation(data);</span>
<span class="nc" id="L735">	    break;</span>
	    
	  default:
<span class="nc" id="L738">	    throw new Exception(</span>
<span class="nc" id="L739">		&quot;Attribute type &quot; + header.attribute(index).type() </span>
<span class="nc" id="L740">		+ &quot; is not supported!&quot;);  </span>
	}
      }
    }
    
    // create instance
<span class="nc bnc" id="L746" title="All 2 branches missed.">    if (sparse)</span>
<span class="nc" id="L747">      result = new SparseInstance(weight, values);</span>
    else
<span class="nc" id="L749">      result = new Instance(weight, values);</span>
    
<span class="nc" id="L751">    return result;</span>
  }
  
  /**
   * creates Instances from the given XML node
   * 
   * @param header	the header of this data
   * @param parent	the instances node
   * @return		the generated Instances
   * @throws Exception	if generation fails, e.g., due to unknown attribute type
   */
  protected Instances createInstances(Instances header, Element parent) throws Exception {
    Instances	result;
    Vector	list;
    int		i;
    
<span class="nc" id="L767">    result = new Instances(header, 0);</span>
    
<span class="nc" id="L769">    list = getChildTags(parent, TAG_INSTANCE);</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">    for (i = 0; i &lt; list.size(); i++)</span>
<span class="nc" id="L771">      result.add(createInstance(result, (Element) list.get(i)));</span>
    
<span class="nc" id="L773">    return result;</span>
  }
  
  /**
   * generates the header from the XML document
   * 
   * @return		the generated header
   * @throws Exception	if generation fails
   */
  protected Instances headerFromXML() throws Exception {
    Instances	result;
    Element	root;
    Element	node;
    Vector	list;
    FastVector	atts;
    Version	version;
    int[]	classIndex;

<span class="nc" id="L791">    root = m_Document.getDocumentElement();</span>
    
    // check version
<span class="nc" id="L794">    version = new Version();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">    if (version.isOlder(root.getAttribute(ATT_VERSION)))</span>
<span class="nc" id="L796">      System.out.println(</span>
<span class="nc" id="L797">	  &quot;WARNING: loading data of version &quot; + root.getAttribute(ATT_VERSION)</span>
<span class="nc" id="L798">	  + &quot; with version &quot; + Version.VERSION);</span>
    
    // attributes
<span class="nc" id="L801">    list       = getChildTags(root, TAG_HEADER);</span>
<span class="nc" id="L802">    node       = (Element) list.get(0);</span>
<span class="nc" id="L803">    list       = getChildTags(node, TAG_ATTRIBUTES);</span>
<span class="nc" id="L804">    node       = (Element) list.get(0);</span>
<span class="nc" id="L805">    classIndex = new int[1];</span>
<span class="nc" id="L806">    atts       = createAttributes(node, classIndex);</span>

    // generate header
<span class="nc" id="L809">    result = new Instances(root.getAttribute(ATT_NAME), atts, 0);</span>
<span class="nc" id="L810">    result.setClassIndex(classIndex[0]);</span>
    
<span class="nc" id="L812">    return result;</span>
  }
  
  /**
   * generates the complete dataset from the XML document
   * 
   * @param header	the header structure
   * @return		the complete dataset
   * @throws Exception	if generation fails
   */
  protected Instances dataFromXML(Instances header) throws Exception {
    Instances	result;
    Element	node;
    Vector	list;

<span class="nc" id="L827">    list   = getChildTags(m_Document.getDocumentElement(), TAG_BODY);</span>
<span class="nc" id="L828">    node   = (Element) list.get(0);</span>
<span class="nc" id="L829">    list   = getChildTags(node, TAG_INSTANCES);</span>
<span class="nc" id="L830">    node   = (Element) list.get(0);</span>
<span class="nc" id="L831">    result = createInstances(header, node);</span>
    
<span class="nc" id="L833">    return result;</span>
  }
  
  /**
   * reads the XML structure from the given reader
   * 
   * @param reader	the reader to get the XML from
   * @throws Exception	if 
   */
  public void setXML(Reader reader) throws Exception {
<span class="nc" id="L843">    read(reader);</span>
    
    // interprete XML structure
<span class="nc" id="L846">    m_Instances = dataFromXML(headerFromXML());</span>
<span class="nc" id="L847">  }</span>
  
  /**
   * Returns the revision string.
   * 
   * @return		the revision
   */
  public String getRevision() {
<span class="nc" id="L855">    return RevisionUtils.extract(&quot;$Revision: 1.4 $&quot;);</span>
  }
  
  /**
   * takes an XML document as first argument and then outputs the Instances
   * statistics
   * 
   * @param args	the commandline options
   */
  public static void main(String[] args) {
    try {
<span class="nc" id="L866">      Reader r = null;</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">      if (args.length != 1) {</span>
<span class="nc" id="L868">	throw (new Exception(&quot;Usage: XMLInstances &lt;filename&gt;&quot;));</span>
      }
      else {
<span class="nc" id="L871">	InputStream in = new FileInputStream(args[0]);</span>
	// compressed file?
<span class="nc bnc" id="L873" title="All 2 branches missed.">	if (args[0].endsWith(&quot;.gz&quot;))</span>
<span class="nc" id="L874">	  in = new GZIPInputStream(in);</span>
<span class="nc" id="L875">        r = new BufferedReader(new InputStreamReader(in));</span>
     }
      
<span class="nc bnc" id="L878" title="All 2 branches missed.">      if (args[0].endsWith(Instances.FILE_EXTENSION)) {</span>
<span class="nc" id="L879">	XMLInstances i = new XMLInstances(new Instances(r));</span>
<span class="nc" id="L880">	System.out.println(i.toString());</span>
      }
      else {
<span class="nc" id="L883">	Instances i = new XMLInstances(r).getInstances();</span>
<span class="nc" id="L884">	System.out.println(i.toSummaryString());</span>
      }
    }
<span class="nc" id="L887">    catch (Exception ex) {</span>
<span class="nc" id="L888">      ex.printStackTrace();</span>
<span class="nc" id="L889">      System.err.println(ex.getMessage());</span>
    }
<span class="nc" id="L891">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span>AllTests (Nov 28, 2015 2:34:31 PM)</div></body></html>